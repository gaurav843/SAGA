Project Code Dump generated on: 2026-02-20 15:02:02
==================================================
46 files included:
--------------------
backend/app/api/v1/meta.py
backend/app/api/v1/resource.py
backend/app/api/v1/workflow.py
backend/app/core/database/base.py
backend/app/core/kernel/actions.py
backend/app/core/kernel/registry/__init__.py
backend/app/core/meta/constants.py
backend/app/core/meta/engine.py
backend/app/core/meta/features/groups/router.py
backend/app/core/meta/features/groups/service.py
backend/app/core/meta/features/states/logic/enforcer.py
backend/app/core/meta/features/states/models.py
backend/app/core/meta/features/states/service.py
backend/app/core/meta/features/views/service.py
backend/app/core/meta/features/widgets/models.py
backend/app/core/meta/models.py
backend/app/core/meta/registry.py
backend/app/core/meta/schemas.py
backend/app/core/meta/service.py
backend/app/domains/auth/features/preferences/seeds.py
backend/app/domains/auth/seeds.py
backend/app/domains/meta_v2/features/governance/enforcer.py
backend/app/domains/system/features/domain_types/models.py
backend/app/domains/system/features/navigation/models.py
backend/app/domains/system/features/navigation/service.py
backend/app/domains/system/models.py
backend/app/domains/system/seeds.py
backend/trigger_meta.py
backend\SYSTEM_ATLAS.md
frontend/src/api/services/MetaKernelService.ts
frontend/src/domains/meta/_kernel/MetaContext.tsx
frontend/src/domains/meta/features/governance/hooks/usePolicyBindings.ts
frontend/src/domains/meta/features/policy_groups/PolicyGroupsView.tsx
frontend/src/domains/meta/features/policy_groups/types.ts
frontend/src/domains/meta/features/switchboard/SwitchboardView.tsx
frontend/src/domains/meta/features/switchboard/components/AssignmentModal.tsx
frontend/src/domains/meta/features/switchboard/hooks/useSwitchboard.ts
frontend/src/domains/meta/features/switchboard/types.ts
frontend/src/domains/meta/types/index.ts
frontend/src/platform/hooks/useUrlState.ts
frontend/src/platform/logging/Narrator.ts
frontend/src/platform/logging/index.ts
frontend/src/platform/routing/RouterFactory.tsx
frontend/src/platform/ui/animation/FadeIn.tsx
frontend\FRONTEND_ATLAS.md
main_prompt.txt

==================================================
CONTEXT ANALYSIS REPORT
==================================================
Target: backend\app\core\meta\models.py
  - Direct Deps: 4
  - Used By:     16
  - Cross-Stack: 0
------------------------------
Target: backend\app\core\meta\schemas.py
  - Direct Deps: 1
  - Used By:     4
  - Cross-Stack: 0
------------------------------
Target: backend\app\core\meta\service.py
  - Direct Deps: 6
  - Used By:     1
  - Cross-Stack: 0
------------------------------
Target: frontend\src\domains\meta\features\switchboard\SwitchboardView.tsx
  - Direct Deps: 6
  - Used By:     1
  - Cross-Stack: 0
------------------------------
Target: frontend\src\domains\meta\features\switchboard\hooks\useSwitchboard.ts
  - Direct Deps: 2
  - Used By:     2
  - Cross-Stack: 1
------------------------------
Target (Auto-Generated): frontend\FRONTEND_ATLAS.md
Target (Auto-Generated): backend\SYSTEM_ATLAS.md
Target (Instruction): main_prompt.txt
==================================================

==================================================

# Source code from: backend\app\api\v1\meta.py
------------------------------------------------
   1 | # FILEPATH: backend/app/api/v1/meta.py
   2 | # @file: Meta-Kernel API Endpoints
   3 | # @author: The Engineer (ansav8@gmail.com)
   4 | # @description: Exposes the Definition & Binding Management API.
   5 | # @security-level: LEVEL 1 (Domain Access)
   6 | 
   7 | from typing import List, Optional
   8 | from fastapi import APIRouter, Depends, HTTPException, Query
   9 | 
  10 | from sqlalchemy.ext.asyncio import AsyncSession
  11 | from sqlalchemy import select, distinct
  12 | 
  13 | from app.core.database.session import get_db
  14 | from app.core.meta.service import MetaService
  15 | from app.core.meta.schemas import (
  16 |     PolicyCreate, PolicyRead, PolicyUpdate,
  17 |     PolicyBindingCreate, PolicyBindingRead, PolicyBindingUpdate,
  18 |     AttributeCreate, AttributeRead, AttributeUpdate,
  19 |     RuleCreate, RuleRead,
  20 |     DryRunRequest, DryRunResult
  21 | )
  22 | from app.core.kernel.registry import domain_registry
  23 | from app.core.meta.models import AttributeDefinition
  24 | 
  25 | # ‚ö° IMPORT FEATURE ROUTERS
  26 | from app.core.meta.features.groups.router import router as groups_router
  27 | from app.core.meta.features.states.router import router as states_router
  28 | from app.core.meta.features.topology.router import router as topology_router # ‚ö° NEW
  29 | 
  30 | router = APIRouter()
  31 | 
  32 | # ‚ö° MOUNT FEATURE ROUTERS
  33 | router.include_router(groups_router, prefix="/groups", tags=["Policy Groups"])
  34 | router.include_router(states_router, prefix="/states", tags=["Workflows"])
  35 | router.include_router(topology_router, prefix="/topology", tags=["System Topology"]) # ‚ö° MOUNT
  36 | 
  37 | # ==============================================================================
  38 | #  1. POLICIES (GOVERNANCE)
  39 | # ==============================================================================
  40 | 
  41 | @router.get("/policies", response_model=List[PolicyRead])
  42 | async def list_policies(db: AsyncSession = Depends(get_db)):
  43 |     return await MetaService.get_policies(db)
  44 | 
  45 | @router.post("/policies", response_model=PolicyRead, status_code=201)
  46 | async def create_policy(payload: PolicyCreate, db: AsyncSession = Depends(get_db)):
  47 |     try:
  48 |         return await MetaService.create_policy(db, payload)
  49 |     except ValueError as e:
  50 |         raise HTTPException(status_code=400, detail=str(e))
  51 | 
  52 | @router.patch("/policies/{id}", response_model=PolicyRead)
  53 | async def update_policy(id: int, payload: PolicyUpdate, db: AsyncSession = Depends(get_db)):
  54 |     try:
  55 |         updated = await MetaService.update_policy(db, id, payload)
  56 |         if not updated:
  57 |             raise HTTPException(status_code=404, detail="Policy not found")
  58 |         return updated
  59 |     except Exception as e:
  60 |         raise HTTPException(status_code=400, detail=str(e))
  61 | 
  62 | @router.post("/policies/dry-run", response_model=DryRunResult)
  63 | async def dry_run_policy(payload: DryRunRequest, db: AsyncSession = Depends(get_db)):
  64 |     return MetaService.dry_run_policy(
  65 |         policy_data={"rules": [r.model_dump() for r in payload.policy.rules]},
  66 |         context=payload.context
  67 |     )
  68 | 
  69 | @router.get("/policies/{key}/history", response_model=List[PolicyRead])
  70 | async def get_policy_history(key: str, db: AsyncSession = Depends(get_db)):
  71 |     return await MetaService.get_policy_history(db, key)
  72 | 
  73 | @router.post("/policies/{version_id}/restore", response_model=PolicyRead)
  74 | async def restore_policy_version(version_id: int, db: AsyncSession = Depends(get_db)):
  75 |     try:
  76 |         return await MetaService.restore_policy(db, version_id)
  77 |     except Exception as e:
  78 |         raise HTTPException(status_code=400, detail=str(e))
  79 | 
  80 | # ==============================================================================
  81 | #  2. BINDINGS (SWITCHBOARD)
  82 | # ==============================================================================
  83 | 
  84 | @router.get("/bindings", response_model=List[PolicyBindingRead])
  85 | async def list_bindings(
  86 |     domain: Optional[str] = Query(None, description="Filter by Domain Key"),
  87 |     scope: Optional[str] = Query(None, description="Filter by Scope"),
  88 |     search: Optional[str] = Query(None, description="Search by Name or Tag"),
  89 |     db: AsyncSession = Depends(get_db)
  90 | ):
  91 |     return await MetaService.get_bindings(db, domain=domain, scope=scope, search=search)
  92 | 
  93 | @router.post("/bindings", response_model=PolicyBindingRead, status_code=201)
  94 | async def create_binding(payload: PolicyBindingCreate, db: AsyncSession = Depends(get_db)):
  95 |     try:
  96 |         return await MetaService.create_binding(db, payload)
  97 |     except Exception as e:
  98 |         raise HTTPException(status_code=400, detail=str(e))
  99 | 
 100 | @router.patch("/bindings/{id}", response_model=PolicyBindingRead)
 101 | async def update_binding(id: int, payload: PolicyBindingUpdate, db: AsyncSession = Depends(get_db)):
 102 |     updated = await MetaService.update_binding(db, id, payload)
 103 |     if not updated:
 104 |         raise HTTPException(status_code=404, detail="Binding not found")
 105 |     return updated
 106 | 
 107 | @router.delete("/bindings/{id}")
 108 | async def delete_binding(id: int, db: AsyncSession = Depends(get_db)):
 109 |     status = await MetaService.delete_binding(db, id)
 110 |     if not status:
 111 |         raise HTTPException(status_code=404, detail="Binding not found")
 112 |     return {"message": "Binding removed", "status": status}
 113 | 
 114 | # ==============================================================================
 115 | #  3. ATTRIBUTES (DICTIONARY)
 116 | # ==============================================================================
 117 | 
 118 | @router.post("/attributes", response_model=AttributeRead, status_code=201)
 119 | async def create_attribute(payload: AttributeCreate, db: AsyncSession = Depends(get_db)):
 120 |     try:
 121 |         return await MetaService.create_attribute(db, payload)
 122 |     except ValueError as e:
 123 |         raise HTTPException(status_code=400, detail=str(e))
 124 | 
 125 | @router.patch("/attributes/{id}", response_model=AttributeRead)
 126 | async def update_attribute(id: int, payload: AttributeUpdate, db: AsyncSession = Depends(get_db)):
 127 |     updated = await MetaService.update_attribute(db, id, payload)
 128 |     if not updated:
 129 |         raise HTTPException(status_code=404, detail="Attribute not found")
 130 |     return updated
 131 | 
 132 | @router.delete("/attributes/{id}")
 133 | async def delete_attribute(id: int, db: AsyncSession = Depends(get_db)):
 134 |     try:
 135 |         success = await MetaService.delete_attribute(db, id)
 136 |         if not success:
 137 |             raise HTTPException(status_code=404, detail="Attribute not found")
 138 |         return {"status": "success"}
 139 |     except ValueError as e:
 140 |         raise HTTPException(status_code=400, detail=str(e))
 141 | 
 142 | # ==============================================================================
 143 | #  4. RULES (LEGACY / SIMPLE)
 144 | # ==============================================================================
 145 | 
 146 | @router.get("/rules", response_model=List[RuleRead])
 147 | async def list_rules(
 148 |     domain: str, 
 149 |     event_type: Optional[str] = None,
 150 |     scope: Optional[str] = None,
 151 |     db: AsyncSession = Depends(get_db)
 152 | ):
 153 |     return await MetaService.get_rules(db, domain, event_type, scope)
 154 | 
 155 | @router.post("/rules", response_model=RuleRead, status_code=201)
 156 | async def create_rule(payload: RuleCreate, db: AsyncSession = Depends(get_db)):
 157 |     return await MetaService.create_rule(db, payload)
 158 | 
 159 | # ==============================================================================
 160 | #  5. SYSTEM & REFLECTION
 161 | # ==============================================================================
 162 | 
 163 | @router.get("/schema/{domain}")
 164 | async def get_domain_schema(
 165 |     domain: str, 
 166 |     active_only: bool = Query(True), 
 167 |     db: AsyncSession = Depends(get_db)
 168 | ):
 169 |     """
 170 |     SCHEMA FUSION ENDPOINT.
 171 |     Delegates all logic to MetaService.get_fused_schema.
 172 |     """
 173 |     return await MetaService.get_fused_schema(db, domain, active_only=active_only)
 174 | 
 175 | @router.get("/domains")
 176 | async def list_domains(db: AsyncSession = Depends(get_db)):
 177 |     # 1. Dynamic Domains from DB (The "Wild" Ones)
 178 |     # Allows discovery of domains that exist only via custom attributes
 179 |     result = await db.execute(select(distinct(AttributeDefinition.domain)))
 180 |     dynamic_domains = result.scalars().all()
 181 |     
 182 |     # 2. System Domains from Registry (The "Official" Ones)
 183 |     # ‚ö° FIX: Passing 'db' session as required by the new Manager to fetch Type Defs
 184 |     registered_domains = await domain_registry.get_all_summaries(db)
 185 |     
 186 |     # 3. Merge Strategy
 187 |     domain_map = {}
 188 |     
 189 |     # A. Add Registered Domains (Source of Truth)
 190 |     for d in registered_domains:
 191 |         # Pydantic model dump to dictionary for mutability
 192 |         data = d.model_dump()
 193 |         domain_map[data["key"]] = {
 194 |             "key": data["key"],
 195 |             "label": data["label"],
 196 |             "type": data["type"],
 197 |             "type_def": data["type_def"], # ‚ö° Handshake Payload (Color/Icon)
 198 |             "system_module": data.get("system_module", "GENERAL"),
 199 |             "module_label": data.get("module_label", "General"),
 200 |             "module_icon": data.get("module_icon", "antd:AppstoreOutlined"),
 201 |             "icon": data.get("icon"),
 202 |             "parent": data.get("parent_domain"),
 203 |             "scopes": data["scopes"]
 204 |         }
 205 |         
 206 |     # B. Add Dynamic Domains (if any found that aren't registered)
 207 |     for d_key in dynamic_domains:
 208 |         if d_key not in domain_map:
 209 |             domain_map[d_key] = {
 210 |                 "key": d_key,
 211 |                 "label": d_key.replace('_', ' ').title(),
 212 |                 "type": "STANDARD", # Default assumption for wild domains
 213 |                 "system_module": "DYNAMIC", 
 214 |                 "module_label": "Dynamic Data",
 215 |                 "module_icon": "antd:DatabaseOutlined",
 216 |                 "icon": "antd:DatabaseOutlined",
 217 |                 "parent": None,
 218 |                 "scopes": [{"key": "DEFAULT", "label": "Default Scope", "type": "CONTAINER"}]
 219 |             }
 220 | 
 221 |     return list(domain_map.values())
 222 | 

================================================================================

# Source code from: backend\app\api\v1\resource.py
----------------------------------------------------
   1 | # FILEPATH: backend/app/api/v1/resource.py
   2 | # @file: Universal Resource Router (Polymorphic v3.0)
   3 | # @author: The Engineer
   4 | # @description: A Generic CRUD Controller that manages ANY registered Domain Entity.
   5 | # UPDATED: Now supports 'DomainType.CONFIG' to handle Global Settings via SystemConfig.
   6 | # @security-level: LEVEL 9 (Instrumented)
   7 | 
   8 | from typing import Any, Dict, List, Optional, Union
   9 | from fastapi import APIRouter, Depends, HTTPException, status, Path, Query, Body, Request
  10 | from sqlalchemy.ext.asyncio import AsyncSession
  11 | from sqlalchemy import select, update, insert, delete, func, inspect, text, or_
  12 | from sqlalchemy.exc import IntegrityError, SQLAlchemyError
  13 | from datetime import datetime, date
  14 | 
  15 | from app.core.database.session import get_db
  16 | from app.core.kernel.registry import domain_registry
  17 | from app.core.kernel.registry.base import DomainType # ‚ö° NEW: Type Discrimination
  18 | from app.core.meta.models import AttributeDefinition
  19 | from app.core.meta.constants import AttributeType
  20 | from app.core.security import get_password_hash 
  21 | 
  22 | # ‚ö° CONFIG SUPPORT
  23 | from app.domains.system.models import SystemConfig
  24 | from app.core.kernel.context.config import ConfigProvider
  25 | 
  26 | import logging
  27 | import traceback
  28 | 
  29 | logger = logging.getLogger("api.resource")
  30 | 
  31 | router = APIRouter()
  32 | 
  33 | # --- HELPER: Deep Merge ---
  34 | def deep_merge(target: Dict[str, Any], source: Dict[str, Any]) -> Dict[str, Any]:
  35 |     """Recursively merges dictionaries to preserve nested data."""
  36 |     for key, value in source.items():
  37 |         if isinstance(value, dict) and key in target and isinstance(target[key], dict):
  38 |             deep_merge(target[key], value)
  39 |         else:
  40 |             target[key] = value
  41 |     return target
  42 | 
  43 | # --- HELPER: Resolve Domain Context ---
  44 | def get_domain_context(domain_key: str):
  45 |     """
  46 |     Retrieves the full Registry Contract for a domain.
  47 |     """
  48 |     ctx = domain_registry.get_domain(domain_key.upper())
  49 |     if not ctx:
  50 |         raise HTTPException(
  51 |             status_code=status.HTTP_404_NOT_FOUND, 
  52 |             detail=f"Domain '{domain_key}' is not registered."
  53 |         )
  54 |     return ctx
  55 | 
  56 | # --- HELPER: Type Caster & Validator ---
  57 | def validate_and_cast(value: Any, expected_type: str, field_label: str) -> Any:
  58 |     """
  59 |     Enforces Strict Typing for Dynamic Fields based on AttributeDefinition.
  60 |     """
  61 |     if value is None or value == "":
  62 |         return None
  63 | 
  64 |     try:
  65 |         if expected_type == AttributeType.NUMBER:
  66 |             if isinstance(value, (int, float)): return value
  67 |             return float(value) 
  68 |             
  69 |         elif expected_type == AttributeType.BOOLEAN:
  70 |             if isinstance(value, bool): return value
  71 |             return str(value).lower() in ('true', '1', 'yes', 'on')
  72 |             
  73 |         elif expected_type == AttributeType.DATE:
  74 |             return str(value).split("T")[0] 
  75 |             
  76 |         elif expected_type == AttributeType.DATETIME:
  77 |             datetime.fromisoformat(str(value).replace('Z', '+00:00'))
  78 |             return str(value)
  79 |             
  80 |         elif expected_type == AttributeType.JSON:
  81 |             if not isinstance(value, (dict, list)):
  82 |                 raise ValueError("Expected JSON object or list.")
  83 |             return value
  84 | 
  85 |         return str(value)
  86 | 
  87 |     except Exception:
  88 |         raise HTTPException(
  89 |             status_code=400, 
  90 |             detail=f"Invalid format for field '{field_label}'. Expected {expected_type}."
  91 |         )
  92 | 
  93 | # --- HELPER: Input Sanitizer (The Packer & Validator) ---
  94 | async def sanitize_payload(
  95 |     db: AsyncSession, 
  96 |     domain: str, 
  97 |     model_class: Any, 
  98 |     payload: Dict[str, Any], 
  99 |     container_key: str = "custom_attributes",
 100 |     is_update: bool = False
 101 | ) -> Dict[str, Any]:
 102 |     """
 103 |     1. Splits payload into Columns vs Extras.
 104 |     2. Validates Extras against AttributeDefinition (Dynamic Schema).
 105 |     3. Packs Extras into the 'container_key' (e.g. 'custom_attributes' or 'preferences').
 106 |     4. ‚ö° TRANSFORMS 'password' inputs into 'hashed_password'.
 107 |     5. ‚ö° ENFORCES System Field Protection via Model Metadata.
 108 |     """
 109 |     clean_data = {}
 110 |     extras = {}
 111 |     mapper = inspect(model_class)
 112 |     
 113 |     # Check if the model actually has the configured container
 114 |     has_dynamic_container = hasattr(model_class, container_key)
 115 | 
 116 |     # 1. Fetch Dynamic Definitions (The Law)
 117 |     stmt = select(AttributeDefinition).where(
 118 |         AttributeDefinition.domain == domain,
 119 |         AttributeDefinition.is_active == True
 120 |     )
 121 |     result = await db.execute(stmt)
 122 |     dynamic_defs = {attr.key: attr for attr in result.scalars().all()}
 123 | 
 124 |     for key, value in payload.items():
 125 |         
 126 |         # ‚ö° SECURITY: Transformation Pipeline
 127 |         if key == "password" and value:
 128 |             if "hashed_password" in mapper.columns:
 129 |                 logger.info(f"üîê [Security] Auto-Hashing '{key}' -> 'hashed_password'")
 130 |                 clean_data["hashed_password"] = get_password_hash(value)
 131 |                 continue 
 132 |         
 133 |         # --- A. STATIC COLUMNS ---
 134 |         if key in mapper.columns:
 135 |             col = mapper.columns[key]
 136 |             col_info = col.info or {}
 137 | 
 138 |             if col.primary_key: continue
 139 |             
 140 |             # ‚ö° METADATA DRIVEN PROTECTION
 141 |             # If the Model says "is_system", we skip it. No magic strings.
 142 |             is_system = col_info.get("is_system")
 143 |             if is_system is True: 
 144 |                 continue
 145 |             
 146 |             # Fallback: If DB controls the default (e.g. auto-increment, triggers), skip unless explicit.
 147 |             if is_system is None and col.server_default is not None: 
 148 |                 continue
 149 | 
 150 |             if col_info.get("secret"): continue
 151 | 
 152 |             clean_data[key] = value
 153 |             continue
 154 | 
 155 |         # --- B. DYNAMIC ATTRIBUTES ---
 156 |         if has_dynamic_container:
 157 |             if key in dynamic_defs:
 158 |                 attr_def = dynamic_defs[key]
 159 |                 # Dynamic Attributes marked as system are also protected
 160 |                 if attr_def.is_system:
 161 |                     continue
 162 |                     
 163 |                 validated_val = validate_and_cast(value, attr_def.data_type, attr_def.label)
 164 |                 extras[key] = validated_val
 165 |             
 166 |             # Allow bulk update of the container itself if passed directly
 167 |             elif key == container_key and isinstance(value, dict):
 168 |                 extras.update(value)
 169 |             
 170 |             # If strict mode is off, we might allow ad-hoc extras, but for now we only allow defined attributes
 171 |             # or explicit updates to the container.
 172 |             else:
 173 |                 # Store unknown fields in extras? 
 174 |                 # Policy: If it's not a column and not in dictionary, we treat it as ad-hoc extra.
 175 |                 extras[key] = value
 176 | 
 177 |     if extras:
 178 |         clean_data[container_key] = extras
 179 | 
 180 |     return clean_data
 181 | 
 182 | # --- HELPER: Output Serializer (The Flattener) ---
 183 | def serialize_model(instance: Any, container_key: str = "custom_attributes") -> Dict[str, Any]:
 184 |     if not instance: return None
 185 |     data = {}
 186 |     mapper = inspect(instance.__class__)
 187 |     
 188 |     # 1. Flatten Columns
 189 |     for col in mapper.columns:
 190 |         key = col.key
 191 |         if "password" in key or "secret" in key: continue
 192 |         val = getattr(instance, key)
 193 |         data[key] = val
 194 |         
 195 |     # 2. Flatten Dynamic Container (e.g. preferences)
 196 |     dynamic_data = getattr(instance, container_key, {})
 197 |     if dynamic_data:
 198 |         for k, v in dynamic_data.items():
 199 |             # Columns take precedence, so only add if not already present
 200 |             if k not in data:
 201 |                 data[k] = v
 202 |                 
 203 |     return data
 204 | 
 205 | # ==============================================================================
 206 | #  UNIVERSAL CRUD OPERATIONS
 207 | # ==============================================================================
 208 | 
 209 | @router.get("/{domain}/availability", response_model=Dict[str, Any])
 210 | async def check_availability(
 211 |     domain: str = Path(...), 
 212 |     field: str = Query(..., description="The column name to check"),
 213 |     value: str = Query(..., description="The value to validate"),
 214 |     db: AsyncSession = Depends(get_db)
 215 | ) -> Any:
 216 |     """
 217 |     Checks if a value exists in the database.
 218 |     üõë GUARDRAIL: Only allows checks on INDEXED or UNIQUE columns to prevent Table Scans.
 219 |     """
 220 |     logger.info(f"üîç [Availability] Checking {domain}.{field} = '{value}'")
 221 |     
 222 |     ctx = get_domain_context(domain)
 223 |     
 224 |     # ‚ö° META-TYPE CHECK: Availability not supported for CONFIG
 225 |     if ctx.domain_type == DomainType.CONFIG:
 226 |         # Config keys are unique, so we check SystemConfig
 227 |         if field == "key":
 228 |             stmt = select(SystemConfig).where(SystemConfig.key == value)
 229 |             exists = (await db.execute(stmt)).scalar() is not None
 230 |             return {"available": not exists, "reason": "Config key exists" if exists else "Available"}
 231 |         return {"available": True, "reason": "Config values not constrained"}
 232 | 
 233 |     Model = ctx.model_class
 234 |     mapper = inspect(Model)
 235 |     
 236 |     # 1. Column Existence Check
 237 |     if field not in mapper.columns:
 238 |         raise HTTPException(
 239 |             status_code=status.HTTP_400_BAD_REQUEST, 
 240 |             detail=f"Field '{field}' does not exist on domain '{domain}'."
 241 |         )
 242 | 
 243 |     col = mapper.columns[field]
 244 |     
 245 |     # 2. PERFORMANCE GUARDRAIL
 246 |     is_safe = col.primary_key or col.unique or col.index
 247 |     
 248 |     if not is_safe:
 249 |         logger.warning(f"üõ°Ô∏è [Guardrail] Blocked availability check on non-indexed field: {domain}.{field}")
 250 |         raise HTTPException(
 251 |             status_code=status.HTTP_400_BAD_REQUEST,
 252 |             detail=f"Performance Guardrail Violation: Field '{field}' is not indexed. Availability checks are forbidden."
 253 |         )
 254 | 
 255 |     # 3. Execution
 256 |     try:
 257 |         # Case-insensitive check for emails/strings
 258 |         if str(col.type).startswith("VARCHAR") or str(col.type).startswith("TEXT") or str(col.type).startswith("STRING"):
 259 |             stmt = select(func.count()).select_from(Model).where(col.ilike(value))
 260 |         else:
 261 |             stmt = select(func.count()).select_from(Model).where(col == value)
 262 | 
 263 |         count = (await db.execute(stmt)).scalar()
 264 |         
 265 |         logger.info(f"   ‚Ü≥ Found {count} matches.")
 266 |         
 267 |         return {
 268 |             "available": count == 0,
 269 |             "reason": "Already exists" if count > 0 else "Available",
 270 |             "debug_count": count # Exposed for debugging
 271 |         }
 272 |     except Exception as e:
 273 |         logger.error(f"Availability check failed: {e}")
 274 |         raise HTTPException(status_code=500, detail="Internal Query Error")
 275 | 
 276 | @router.get("/{domain}", response_model=Dict[str, Any])
 277 | async def list_resources(
 278 |     request: Request, # ‚ö° INJECTED for Dynamic Query Params
 279 |     domain: str = Path(...), 
 280 |     page: int = Query(1, ge=1), 
 281 |     size: int = Query(20, ge=1),
 282 |     db: AsyncSession = Depends(get_db)
 283 | ) -> Any:
 284 |     """
 285 |     UNIVERSAL SEARCH ENGINE.
 286 |     Supports filtering by any Column OR Custom Attribute (Dynamic Container).
 287 |     ‚ö° POLYMORPHIC: Adapts to DomainType (STANDARD vs CONFIG).
 288 |     """
 289 |     ctx = get_domain_context(domain)
 290 |     
 291 |     # ‚ö° BRANCH 1: CONFIG DOMAIN (Global)
 292 |     if ctx.domain_type == DomainType.CONFIG:
 293 |         # Return list of SystemConfig items, potentially filtered by category
 294 |         stmt = select(SystemConfig).where(SystemConfig.is_active == True)
 295 |         
 296 |         # Simple filter support for Config
 297 |         category = request.query_params.get("category")
 298 |         if category:
 299 |             stmt = stmt.where(SystemConfig.category == category)
 300 |             
 301 |         result = await db.execute(stmt)
 302 |         items = result.scalars().all()
 303 |         
 304 |         # Serializer for Config
 305 |         serialized = []
 306 |         for item in items:
 307 |             serialized.append({
 308 |                 "id": item.id,
 309 |                 "key": item.key,
 310 |                 "label": item.label,
 311 |                 "value": item.typed_value, # Use the computed property
 312 |                 "category": item.category,
 313 |                 "description": item.description,
 314 |                 "updated_at": item.updated_at
 315 |             })
 316 |             
 317 |         return {
 318 |             "items": serialized,
 319 |             "total": len(serialized),
 320 |             "page": 1,
 321 |             "size": len(serialized),
 322 |             "domain": domain.upper()
 323 |         }
 324 | 
 325 |     # ‚ö° BRANCH 2: STANDARD DOMAIN (Entity)
 326 |     try:
 327 |         Model = ctx.model_class
 328 |         container_key = ctx.dynamic_container # ‚ö° DYNAMIC RESOLUTION
 329 |         mapper = inspect(Model)
 330 |         
 331 |         columns = {c.key: c for c in mapper.columns}
 332 | 
 333 |         # 1. Start with Base Query
 334 |         stmt = select(Model)
 335 |         
 336 |         # 2. Extract Filters (Exclude Control Params)
 337 |         filters = {
 338 |             k: v for k, v in request.query_params.items() 
 339 |             if k not in ["page", "size", "sort", "domain"] and v != ""
 340 |         }
 341 |         
 342 |         applied_filters = []
 343 | 
 344 |         # 3. Apply Tri-Layer Filtering logic
 345 |         for key, value in filters.items():
 346 |             
 347 |             # LAYER 1: Physical Column
 348 |             if key in columns:
 349 |                 col = columns[key]
 350 |                 
 351 |                 col_type_str = str(col.type).upper()
 352 |                 is_string_type = "CHAR" in col_type_str or "TEXT" in col_type_str or "STRING" in col_type_str
 353 |                 
 354 |                 if is_string_type:
 355 |                     stmt = stmt.where(col.expression.ilike(f"%{value}%"))
 356 |                     applied_filters.append(f"{key} ~= '{value}'")
 357 |                 else:
 358 |                     stmt = stmt.where(col.expression == value)
 359 |                     applied_filters.append(f"{key} == '{value}'")
 360 |                     
 361 |             # LAYER 2: Dynamic Attribute (JSONB)
 362 |             # ‚ö° Checks the configured container (custom_attributes OR preferences)
 363 |             elif container_key in columns:
 364 |                 # Safe JSONB lookup using SQLAlchemy text
 365 |                 stmt = stmt.where(text(f"{container_key}->>'{key}' ILIKE :val_{key}"))
 366 |                 stmt = stmt.params({f"val_{key}": f"%{value}%"})
 367 |                 applied_filters.append(f"meta.{key} ~= '{value}'")
 368 | 
 369 |             # LAYER 3: Ignore unknown params (Safety)
 370 | 
 371 |         if applied_filters:
 372 |             logger.info(f"üîç [Resource] Filtering {domain}: {', '.join(applied_filters)}")
 373 | 
 374 |         # 4. Calculate Total (Filtered)
 375 |         count_stmt = select(func.count()).select_from(stmt.subquery())
 376 |         total = (await db.execute(count_stmt)).scalar()
 377 | 
 378 |         # 5. Apply Pagination
 379 |         offset = (page - 1) * size
 380 |         paginated_stmt = stmt.offset(offset).limit(size)
 381 |         
 382 |         result = await db.execute(paginated_stmt)
 383 |         items = result.scalars().all()
 384 |         
 385 |         return {
 386 |             "items": [serialize_model(item, container_key) for item in items],
 387 |             "total": total,
 388 |             "page": page, 
 389 |             "size": size, 
 390 |             "domain": domain.upper()
 391 |         }
 392 |     except Exception as e:
 393 |         logger.error(f"List failed for {domain}")
 394 |         traceback.print_exc()
 395 |         raise HTTPException(status_code=500, detail=f"Search Error: {str(e)}")
 396 | 
 397 | @router.get("/{domain}/{id}")
 398 | async def get_resource(
 399 |     domain: str = Path(...), id: int = Path(...), db: AsyncSession = Depends(get_db)
 400 | ) -> Any:
 401 |     ctx = get_domain_context(domain)
 402 |     
 403 |     # ‚ö° META-TYPE CHECK
 404 |     if ctx.domain_type == DomainType.CONFIG:
 405 |         # Config items usually accessed by Key, but if ID provided:
 406 |         item = await db.get(SystemConfig, id)
 407 |         if not item: raise HTTPException(status_code=404, detail="Config not found")
 408 |         return {
 409 |             "id": item.id,
 410 |             "key": item.key,
 411 |             "value": item.typed_value,
 412 |             "label": item.label
 413 |         }
 414 | 
 415 |     Model = ctx.model_class
 416 |     container_key = ctx.dynamic_container
 417 |     
 418 |     item = (await db.execute(select(Model).where(Model.id == id))).scalars().first()
 419 |     if not item: raise HTTPException(status_code=404, detail="Resource not found")
 420 |     return serialize_model(item, container_key)
 421 | 
 422 | @router.post("/{domain}", status_code=201)
 423 | async def create_resource(
 424 |     domain: str = Path(...), payload: Dict[str, Any] = Body(...), db: AsyncSession = Depends(get_db)
 425 | ) -> Any:
 426 |     ctx = get_domain_context(domain)
 427 |     
 428 |     # ‚ö° BRANCH 1: CONFIG DOMAIN
 429 |     if ctx.domain_type == DomainType.CONFIG:
 430 |         # Create a new SystemConfig Entry
 431 |         # Payload expected: { key, value, label, category, type }
 432 |         key = payload.get("key")
 433 |         if not key: raise HTTPException(400, "Config Key required")
 434 |         
 435 |         # Check existence
 436 |         existing = await db.execute(select(SystemConfig).where(SystemConfig.key == key))
 437 |         if existing.scalars().first():
 438 |             raise HTTPException(409, f"Config '{key}' already exists.")
 439 |             
 440 |         new_config = SystemConfig(
 441 |             key=key,
 442 |             label=payload.get("label", key),
 443 |             description=payload.get("description"),
 444 |             value_raw=str(payload.get("value", "")),
 445 |             value_type=payload.get("type", "STRING"), # Default to String
 446 |             category=payload.get("category", "GENERAL"),
 447 |             is_active=True
 448 |         )
 449 |         db.add(new_config)
 450 |         await db.commit()
 451 |         await db.refresh(new_config)
 452 |         
 453 |         # ‚ö° HOT SWAP TRIGGER
 454 |         ConfigProvider.invalidate()
 455 |         
 456 |         return {
 457 |             "id": new_config.id,
 458 |             "key": new_config.key,
 459 |             "value": new_config.typed_value
 460 |         }
 461 | 
 462 |     # ‚ö° BRANCH 2: STANDARD DOMAIN
 463 |     Model = ctx.model_class
 464 |     container_key = ctx.dynamic_container
 465 |     
 466 |     clean_payload = await sanitize_payload(db, domain.upper(), Model, payload, container_key)
 467 |     
 468 |     try:
 469 |         instance = Model(**clean_payload)
 470 |         db.add(instance)
 471 |         await db.commit()
 472 |         await db.refresh(instance)
 473 |         return serialize_model(instance, container_key)
 474 |     except Exception as e:
 475 |         await db.rollback()
 476 |         if "IntegrityError" in str(e):
 477 |             raise HTTPException(status_code=400, detail="Duplicate or Invalid Data. Check constraints.")
 478 |         raise HTTPException(status_code=500, detail=str(e))
 479 | 
 480 | @router.patch("/{domain}/{id}")
 481 | async def update_resource(
 482 |     domain: str = Path(...), id: int = Path(...), payload: Dict[str, Any] = Body(...),
 483 |     db: AsyncSession = Depends(get_db)
 484 | ) -> Any:
 485 |     ctx = get_domain_context(domain)
 486 |     
 487 |     # ‚ö° BRANCH 1: CONFIG DOMAIN
 488 |     if ctx.domain_type == DomainType.CONFIG:
 489 |         config_item = await db.get(SystemConfig, id)
 490 |         if not config_item: raise HTTPException(404, "Config not found")
 491 |         
 492 |         if "value" in payload:
 493 |             config_item.value_raw = str(payload["value"])
 494 |         if "label" in payload:
 495 |             config_item.label = payload["label"]
 496 |         if "description" in payload:
 497 |             config_item.description = payload["description"]
 498 |             
 499 |         await db.commit()
 500 |         await db.refresh(config_item)
 501 |         
 502 |         # ‚ö° HOT SWAP TRIGGER
 503 |         ConfigProvider.invalidate()
 504 |         
 505 |         return {
 506 |             "id": config_item.id,
 507 |             "key": config_item.key,
 508 |             "value": config_item.typed_value
 509 |         }
 510 | 
 511 |     # ‚ö° BRANCH 2: STANDARD DOMAIN
 512 |     Model = ctx.model_class
 513 |     container_key = ctx.dynamic_container
 514 |     
 515 |     result = await db.execute(select(Model).where(Model.id == id))
 516 |     instance = result.scalars().first()
 517 |     if not instance: raise HTTPException(status_code=404, detail="Resource not found")
 518 |     
 519 |     clean_payload = await sanitize_payload(db, domain.upper(), Model, payload, container_key, is_update=True)
 520 |     if not clean_payload: return serialize_model(instance, container_key)
 521 | 
 522 |     logger.info(f"üìù [Resource] Patching {domain}:{id} Keys: {list(clean_payload.keys())}")
 523 | 
 524 |     try:
 525 |         # ‚ö° DYNAMIC CONTAINER MERGE LOGIC
 526 |         if container_key in clean_payload and hasattr(instance, container_key):
 527 |             current_extras = dict(getattr(instance, container_key, {}) or {})
 528 |             new_extras = clean_payload.pop(container_key)
 529 |             merged_extras = deep_merge(current_extras, new_extras)
 530 |             setattr(instance, container_key, merged_extras)
 531 |         
 532 |         for key, value in clean_payload.items():
 533 |             setattr(instance, key, value)
 534 |             
 535 |         await db.commit()
 536 |         await db.refresh(instance)
 537 |         return serialize_model(instance, container_key)
 538 |     except Exception as e:
 539 |         await db.rollback()
 540 |         logger.error(f"Update failed: {e}")
 541 |         raise HTTPException(status_code=500, detail=str(e))
 542 | 
 543 | @router.delete("/{domain}/{id}", status_code=204)
 544 | async def delete_resource(
 545 |     domain: str = Path(...), id: int = Path(...), db: AsyncSession = Depends(get_db)
 546 | ) -> None:
 547 |     ctx = get_domain_context(domain)
 548 |     
 549 |     # ‚ö° META-TYPE CHECK: Config Deletion
 550 |     if ctx.domain_type == DomainType.CONFIG:
 551 |         config_item = await db.get(SystemConfig, id)
 552 |         if not config_item: raise HTTPException(404, "Config not found")
 553 |         await db.delete(config_item)
 554 |         await db.commit()
 555 |         
 556 |         # ‚ö° HOT SWAP TRIGGER
 557 |         ConfigProvider.invalidate()
 558 |         return
 559 | 
 560 |     Model = ctx.model_class
 561 |     
 562 |     instance = (await db.execute(select(Model).where(Model.id == id))).scalars().first()
 563 |     if not instance: raise HTTPException(status_code=404, detail="Resource not found")
 564 |     
 565 |     if getattr(instance, 'is_system', False) or getattr(instance, 'is_system_user', False):
 566 |         raise HTTPException(status_code=403, detail="Cannot delete System Resource.")
 567 | 
 568 |     try:
 569 |         await db.delete(instance)
 570 |         await db.commit()
 571 |     except Exception as e:
 572 |         await db.rollback()
 573 |         raise HTTPException(status_code=500, detail=str(e))
 574 | 

================================================================================

# Source code from: backend\app\api\v1\workflow.py
----------------------------------------------------
   1 | # FILEPATH: backend/app/api/v1/workflow.py
   2 | # @file: Universal Workflow API (Dumb UI Controller v2.0)
   3 | # @role: üîå API Controller
   4 | # @author: The Engineer (ansav8@gmail.com)
   5 | # @description: The "Smart Backend" router. Evaluates UI Options via Governance and executes Transitions.
   6 | # @security-level: LEVEL 9 (Dynamic Protected Fields & Preliminary Dry Runs)
   7 | # @invariant: Must evaluate Transition Guards BEFORE returning options AND BEFORE committing transactions.
   8 | # @narrator: Logs API requests, payload applications, and transition outcomes.
   9 | 
  10 | import logging
  11 | from typing import Dict, Any, Optional, List
  12 | from pydantic import BaseModel
  13 | 
  14 | from fastapi import APIRouter, Depends, HTTPException, Path, Body
  15 | from sqlalchemy.ext.asyncio import AsyncSession
  16 | from sqlalchemy import select
  17 | from sqlalchemy.inspection import inspect
  18 | 
  19 | from app.core.database.session import get_db
  20 | from app.core.kernel.registry import domain_registry
  21 | from app.core.meta.models import StateDefinition
  22 | from app.core.meta.features.states.logic.machine import StateMachine
  23 | 
  24 | # ‚ö° THE DECOUPLED ENGINES
  25 | from app.core.kernel.interceptor import LogicInterceptor
  26 | from app.domains.meta_v2.features.governance.enforcer import GovernanceEnforcer
  27 | from app.core.meta.constants import RuleEventType
  28 | 
  29 | logger = logging.getLogger("api.workflow")
  30 | 
  31 | router = APIRouter()
  32 | 
  33 | # --- SCHEMAS (The Dumb UI Contract) ---
  34 | class UIConfig(BaseModel):
  35 |     icon: Optional[str] = None
  36 |     type: Optional[str] = "default"
  37 |     danger: Optional[bool] = False
  38 | 
  39 | class TransitionOption(BaseModel):
  40 |     name: str
  41 |     target: str
  42 |     allowed: bool = True
  43 |     reason: Optional[str] = None
  44 |     ui_config: Optional[UIConfig] = None
  45 | 
  46 | class TransitionRequest(BaseModel):
  47 |     event: str
  48 |     context_data: Dict[str, Any] = {}
  49 | 
  50 | class TransitionResponse(BaseModel):
  51 |     success: bool
  52 |     previous_state: Optional[str]
  53 |     new_state: str
  54 |     message: str
  55 | 
  56 | 
  57 | # --- HELPER ---
  58 | async def _load_machine_and_entity(db: AsyncSession, domain: str, scope: str, id: int):
  59 |     """Shared logic to hydrate context with Scope support."""
  60 |     domain_key = domain.upper()
  61 |     scope_key = scope.upper()
  62 |     
  63 |     # 1. Resolve Model
  64 |     domain_ctx = domain_registry.get_domain(domain_key)
  65 |     if not domain_ctx or not domain_ctx.model_class:
  66 |         raise HTTPException(status_code=404, detail=f"Domain '{domain_key}' not registered.")
  67 |     
  68 |     # 2. Fetch Entity
  69 |     entity = await db.get(domain_ctx.model_class, id)
  70 |     if not entity:
  71 |         raise HTTPException(status_code=404, detail="Entity not found.")
  72 | 
  73 |     # 3. Fetch Definition
  74 |     stmt = select(StateDefinition).where(
  75 |         StateDefinition.entity_key == domain_key,
  76 |         StateDefinition.scope == scope_key,
  77 |         StateDefinition.is_active == True
  78 |     )
  79 |     result = await db.execute(stmt)
  80 |     definition = result.scalars().first()
  81 | 
  82 |     if not definition:
  83 |         raise HTTPException(status_code=400, detail=f"No active workflow found for {domain_key}:{scope_key}.")
  84 | 
  85 |     return entity, StateMachine(definition.transitions), domain_ctx
  86 | 
  87 | 
  88 | # --- ENDPOINTS ---
  89 | 
  90 | @router.get("/workflow/{domain}/{scope}/{id}/options", response_model=List[TransitionOption])
  91 | async def get_transition_options(
  92 |     domain: str = Path(...),
  93 |     scope: str = Path(...),
  94 |     id: int = Path(...),
  95 |     db: AsyncSession = Depends(get_db)
  96 | ):
  97 |     """
  98 |     Menu Builder. Evaluates Governance Rules and returns the strictly formatted Dumb UI manifest.
  99 |     """
 100 |     logger.info(f"üîç [Workflow API] Calculating UI Options for {domain}:{id} in scope {scope}")
 101 |     entity, machine, domain_ctx = await _load_machine_and_entity(db, domain, scope, id)
 102 |     
 103 |     current_state = getattr(entity, "status", None)
 104 |     if not current_state:
 105 |         return []
 106 | 
 107 |     possible_moves = machine._transition_map.get(current_state, {})
 108 |     options = []
 109 | 
 110 |     # Prepare Context Envelope for Governance Check
 111 |     container_key = domain_ctx.dynamic_container if domain_ctx else None
 112 |     meta_data = getattr(entity, container_key, {}) if container_key and hasattr(entity, container_key) else {}
 113 |     
 114 |     context_envelope = {
 115 |         "host": LogicInterceptor._serialize_entity(entity),
 116 |         "meta": meta_data,
 117 |         "session": { "discriminator": "OPTIONS_CHECK", "event": RuleEventType.LOAD }
 118 |     }
 119 | 
 120 |     for event_name, config in possible_moves.items():
 121 |         allowed = True
 122 |         reason = None
 123 |         
 124 |         # 1. üõ°Ô∏è GOVERNANCE CHECK (The Handshake)
 125 |         guard_expr = config.get("guard")
 126 |         if guard_expr:
 127 |             try:
 128 |                 verdict = GovernanceEnforcer.evaluate_guard_sync(entity, guard_expr, context_envelope)
 129 |                 if not verdict.is_valid:
 130 |                     allowed = False
 131 |                     reason = ", ".join(verdict.blocking_errors)
 132 |             except Exception as e:
 133 |                 logger.error(f"‚ö†Ô∏è [Workflow API] Governance crash on guard '{guard_expr}': {e}")
 134 |                 allowed = False
 135 |                 reason = "Governance Engine Error"
 136 | 
 137 |         # 2. üé® VISUAL HEURISTICS (Backend drives the UI)
 138 |         ui_config = {}
 139 |         lower_name = event_name.lower()
 140 |         if "approve" in lower_name or "pass" in lower_name:
 141 |             ui_config = {"icon": "antd:CheckCircleOutlined", "type": "primary", "danger": False}
 142 |         elif "reject" in lower_name or "cancel" in lower_name:
 143 |             ui_config = {"icon": "antd:CloseCircleOutlined", "type": "default", "danger": True}
 144 |         elif "publish" in lower_name or "activate" in lower_name:
 145 |             ui_config = {"icon": "antd:RocketOutlined", "type": "primary", "danger": False}
 146 |         else:
 147 |             ui_config = {"icon": "antd:ArrowRightOutlined", "type": "default", "danger": False}
 148 |             
 149 |         # Override with explicit XState metadata if available
 150 |         xstate_meta = config.get("meta", {}).get("ui", {})
 151 |         if xstate_meta:
 152 |             ui_config.update(xstate_meta)
 153 | 
 154 |         # 3. BUILD OPTION
 155 |         options.append(TransitionOption(
 156 |             name=event_name,
 157 |             target=config.get("target"),
 158 |             allowed=allowed,
 159 |             reason=reason,
 160 |             ui_config=UIConfig(**ui_config)
 161 |         ))
 162 | 
 163 |     return options
 164 | 
 165 | 
 166 | @router.post("/workflow/{domain}/{scope}/{id}/transition", response_model=TransitionResponse)
 167 | async def execute_transition(
 168 |     domain: str = Path(...),
 169 |     scope: str = Path(...),
 170 |     id: int = Path(...),
 171 |     body: TransitionRequest = Body(...),
 172 |     db: AsyncSession = Depends(get_db)
 173 | ):
 174 |     """
 175 |     Executes a State Transition with Context.
 176 |     Features: Dynamic Protected Fields & Preliminary Governance Dry-Run.
 177 |     """
 178 |     logger.info(f"‚ö° [Workflow API] Execution requested: {body.event} on {domain}:{id}")
 179 |     entity, machine, domain_ctx = await _load_machine_and_entity(db, domain, scope, id)
 180 |     
 181 |     current_state = getattr(entity, "status", None)
 182 |     state_transitions = machine._transition_map.get(current_state, {})
 183 |     transition_config = state_transitions.get(body.event)
 184 | 
 185 |     if not transition_config:
 186 |         raise HTTPException(status_code=400, detail=f"Event '{body.event}' not valid from '{current_state}'.")
 187 | 
 188 |     next_state = transition_config.get("target")
 189 | 
 190 |     # 1. üõ°Ô∏è PRELIMINARY DRY RUN (Governance Validation before DB touch)
 191 |     guard_expr = transition_config.get("guard")
 192 |     if guard_expr:
 193 |         container_key = domain_ctx.dynamic_container if domain_ctx else None
 194 |         meta_data = getattr(entity, container_key, {}) if container_key and hasattr(entity, container_key) else {}
 195 |         
 196 |         # Simulate the payload being applied to the context envelope for evaluation
 197 |         simulated_host = LogicInterceptor._serialize_entity(entity)
 198 |         simulated_host.update(body.context_data) 
 199 | 
 200 |         context_envelope = {
 201 |             "host": simulated_host,
 202 |             "meta": meta_data,
 203 |             "session": { "discriminator": "TRANSITION_EXECUTE", "event": RuleEventType.TRANSITION }
 204 |         }
 205 |         
 206 |         try:
 207 |             verdict = GovernanceEnforcer.evaluate_guard_sync(entity, guard_expr, context_envelope)
 208 |             if not verdict.is_valid:
 209 |                 logger.warning(f"‚õî [Workflow API] Preliminary Guard Failed: {verdict.blocking_errors}")
 210 |                 # We return a List of errors so the frontend Array.isArray(detail) parsing works
 211 |                 raise HTTPException(status_code=422, detail=verdict.blocking_errors)
 212 |         except HTTPException as he:
 213 |             raise he
 214 |         except Exception as e:
 215 |             logger.error(f"üí• [Workflow API] Governance Engine Failure during execution: {e}")
 216 |             raise HTTPException(status_code=500, detail=["Internal Governance Error."])
 217 | 
 218 |     # 2. üíæ DYNAMIC DATA PERSISTENCE LAYER
 219 |     if body.context_data:
 220 |         # A. Dynamically fetch Primary Keys
 221 |         mapper = inspect(domain_ctx.model_class)
 222 |         pk_columns = {column.key for column in mapper.primary_key}
 223 |         
 224 |         # B. Combine PKs with standard system fields
 225 |         PROTECTED_FIELDS = pk_columns.union({"created_at", "updated_at", "hashed_password", "salt", "password"})
 226 |         
 227 |         updated_count = 0
 228 |         for key, value in body.context_data.items():
 229 |             if key not in PROTECTED_FIELDS and hasattr(entity, key):
 230 |                 setattr(entity, key, value)
 231 |                 updated_count += 1
 232 |         
 233 |         if updated_count > 0:
 234 |             logger.info(f"üíæ [Workflow API] Applied {updated_count} field updates from payload.")
 235 | 
 236 |     # 3. üõ°Ô∏è ATTACH SIDECAR (For Interceptor & CDC Events)
 237 |     setattr(entity, "_runtime_context", body.context_data)
 238 | 
 239 |     try:
 240 |         # Trigger the status change (marks object as dirty for SQLAlchemy)
 241 |         entity.status = next_state
 242 |         
 243 |         # ‚ö° COMMITTING THE DB TRIGGERS THE INTERCEPTOR (Final Logic Pass & Outbox)
 244 |         await db.commit()
 245 |         await db.refresh(entity)
 246 |         
 247 |         logger.info(f"‚úÖ [Workflow API] Transition Success: {current_state} -> {next_state}")
 248 |         return TransitionResponse(
 249 |             success=True,
 250 |             previous_state=current_state,
 251 |             new_state=next_state,
 252 |             message="Transition successful."
 253 |         )
 254 | 
 255 |     except ValueError as ve:
 256 |         await db.rollback()
 257 |         error_str = str(ve).replace("‚õî Policy Blocked Save: ", "").replace("‚õî [Governance] Guard Blocked Transition: ", "")
 258 |         raise HTTPException(status_code=422, detail=error_str.split(", "))
 259 |     except Exception as e:
 260 |         await db.rollback()
 261 |         logger.error(f"üí• [Workflow API] System Error during DB commit: {e}")
 262 |         raise HTTPException(status_code=500, detail=["Internal Database Engine Failure"])

================================================================================

# Source code from: backend\app\core\database\base.py
-------------------------------------------------------
   1 | # @file Shared Database Base Class
   2 | # @author The Engineer
   3 | # @description The Common Ancestor for all SQLAlchemy models.
   4 | #              UPDATED: Removed explicit model imports to fix Circular Dependency.
   5 | 
   6 | from sqlalchemy.orm import DeclarativeBase
   7 | 
   8 | class Base(DeclarativeBase):
   9 |     """
  10 |     The shared registry for all database models.
  11 |     All Domain Models and Kernel Models must inherit from this.
  12 |     """
  13 |     pass
  14 | 
  15 | # --- NOTE ON MIGRATIONS ---
  16 | # Alembic's env.py handles the discovery of models dynamically.
  17 | # We do NOT need to import them here. Doing so causes circular imports
  18 | # because models need to import 'Base' from this file first.
  19 | 

================================================================================

# Source code from: backend\app\core\kernel\actions.py
--------------------------------------------------------
   1 | # FILEPATH: backend/app/core/kernel/actions.py
   2 | # @file Logic Actions & Result Contracts
   3 | # @author The Engineer (ansav8@gmail.com)
   4 | # @description Defines the output structure of the Logic Engine.
   5 | #              This decouples "Calculation" from "Enforcement".
   6 | #              UPDATED: Added 'TRIGGER_EVENT' and 'TRANSITION' for Async Event Loop.
   7 | 
   8 | from enum import Enum
   9 | from dataclasses import dataclass, field
  10 | from typing import List, Dict, Any, Optional
  11 | 
  12 | class ActionType(Enum):
  13 |     """
  14 |     The available effects a Rule can trigger.
  15 |     """
  16 |     BLOCK = "BLOCK"           # Stop the transaction immediately (Raise Error).
  17 |     WARN = "WARN"             # Log a warning but allow the transaction.
  18 |     
  19 |     # Data Mutation
  20 |     MUTATE = "MUTATE"         # Change a value in the payload/entity automatically.
  21 |     
  22 |     # Async/Event Driven
  23 |     NOTIFY = "NOTIFY"         # Send a simple alert (Legacy, moving to TRIGGER_EVENT).
  24 |     TRIGGER_EVENT = "TRIGGER_EVENT" # Fire a System Event (e.g. WEBHOOK, WORKFLOW_START).
  25 |     
  26 |     # State Machine
  27 |     TRANSITION = "TRANSITION" # Attempt to move the entity to a new State (XState Guard).
  28 | 
  29 | @dataclass
  30 | class LogicResult:
  31 |     """
  32 |     The 'Report Card' returned by the Logic Engine after checking all rules.
  33 |     """
  34 |     is_valid: bool = True
  35 |     blocking_errors: List[str] = field(default_factory=list)
  36 |     warnings: List[str] = field(default_factory=list)
  37 |     
  38 |     # Mutations to apply: [{"target": "field_name", "value": "new_value"}]
  39 |     mutations: List[Dict[str, Any]] = field(default_factory=list)
  40 |     
  41 |     # Async side effects (Notifications, Webhooks, State Transitions)
  42 |     # Structure: [{"type": "TRIGGER_EVENT", "value": {...}}, {"type": "TRANSITION", "value": "APPROVED"}]
  43 |     side_effects: List[Dict[str, Any]] = field(default_factory=list)
  44 | 
  45 |     def merge(self, other: 'LogicResult'):
  46 |         """
  47 |         Helper to combine results from multiple rule checks.
  48 |         """
  49 |         if not other.is_valid:
  50 |             self.is_valid = False
  51 |         
  52 |         self.blocking_errors.extend(other.blocking_errors)
  53 |         self.warnings.extend(other.warnings)
  54 |         self.mutations.extend(other.mutations)
  55 |         self.side_effects.extend(other.side_effects)
  56 | 

================================================================================

# Source code from: backend\app\core\kernel\registry\__init__.py
------------------------------------------------------------------
   1 | # C:\Pythonproject\P2\core\kernel\registry\__init__.py
   2 | # @file Registry Package Initialization
   3 | # @author ansav8@gmail.com
   4 | # @description Exposes the registries to the rest of the application.
   5 | 
   6 | # 1. The Domain Registry (The Phonebook for Modules)
   7 | from .base import DomainContext
   8 | from .manager import domain_registry
   9 | 
  10 | # 2. The Event Registry (The Catalog of Signals)
  11 | # We import 'Signals' from our new explicit file 'event_registry.py'
  12 | from .event_registry import Signals
  13 | 

================================================================================

# Source code from: backend\app\core\meta\constants.py
--------------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/constants.py
   2 | # @file: Meta-Kernel Constants (The Vocabulary)
   3 | # @author: The Engineer (ansav8@gmail.com)
   4 | # @description: Defines the Immutable Truths for the Adaptive Data Engine.
   5 | # UPDATED: Injected ACTION_METADATA to enable "Dumb UI" rendering.
   6 | # @security-level: LEVEL 0 (Kernel)
   7 | 
   8 | from enum import Enum, unique
   9 | 
  10 | @unique
  11 | class BindingType(str, Enum):
  12 |     """The Jurisdiction Class. Defines WHAT we are binding to."""
  13 |     ENTITY = "ENTITY"       # A physical Database Table (e.g. USER, CONTAINER)
  14 |     GROUP = "GROUP"         # A virtual Tag or Job ID (e.g. NIGHTLY_SYNC, VIP_TIER)
  15 | 
  16 | @unique
  17 | class AttributeType(str, Enum):
  18 |     """The Data Type. Defines how the value is stored and validated."""
  19 |     TEXT = "TEXT"
  20 |     TEXTAREA = "TEXTAREA"
  21 |     RICH_TEXT = "RICH_TEXT"
  22 |     NUMBER = "NUMBER"
  23 |     BOOLEAN = "BOOLEAN"
  24 |     SELECT = "SELECT"
  25 |     MULTI_SELECT = "MULTI_SELECT"
  26 |     DATE = "DATE"
  27 |     DATETIME = "DATETIME"
  28 |     TIME = "TIME"
  29 |     REFERENCE = "REFERENCE"
  30 |     FILE = "FILE"
  31 |     JSON = "JSON"
  32 |     FORMULA = "FORMULA"
  33 | 
  34 | @unique
  35 | class WidgetType(str, Enum):
  36 |     """The Interface Hint. Defines how the field is rendered."""
  37 |     # Text
  38 |     INPUT = "INPUT"
  39 |     TEXTAREA = "TEXTAREA"
  40 |     RICH_TEXT = "RICH_TEXT"
  41 |     EMAIL = "EMAIL"
  42 |     PHONE = "PHONE"
  43 |     COLOR = "COLOR"
  44 |     
  45 |     # Numeric
  46 |     NUMBER = "NUMBER"
  47 |     SLIDER = "SLIDER"
  48 |     CURRENCY = "CURRENCY"
  49 |     PERCENTAGE = "PERCENTAGE"
  50 |     
  51 |     # Choice
  52 |     DROPDOWN = "DROPDOWN"
  53 |     AUTOCOMPLETE = "AUTOCOMPLETE"
  54 |     RADIO_GROUP = "RADIO_GROUP"
  55 |     CHECKBOX_GROUP = "CHECKBOX_GROUP"
  56 |     TAGS = "TAGS"
  57 |     
  58 |     # Boolean
  59 |     SWITCH = "SWITCH"
  60 |     CHECKBOX = "CHECKBOX"
  61 |     
  62 |     # Date
  63 |     DATE_PICKER = "DATE_PICKER"
  64 |     DATETIME_PICKER = "DATETIME_PICKER"
  65 |     TIME_PICKER = "TIME_PICKER"
  66 |     
  67 |     # Advanced
  68 |     FILE_UPLOAD = "FILE_UPLOAD"
  69 |     REFERENCE_LOOKUP = "REFERENCE_LOOKUP"
  70 |     JSON_EDITOR = "JSON_EDITOR"
  71 | 
  72 | @unique
  73 | class RuleEventType(str, Enum):
  74 |     """The Trigger."""
  75 |     SAVE = "SAVE"
  76 |     DELETE = "DELETE"
  77 |     LOAD = "LOAD"
  78 |     CHANGE = "CHANGE"
  79 |     TRANSITION = "TRANSITION"
  80 | 
  81 | @unique
  82 | class RuleActionType(str, Enum):
  83 |     """The Consequence."""
  84 |     BLOCK = "BLOCK"
  85 |     WARN = "WARN"
  86 |     SHOW = "SHOW"
  87 |     HIDE = "HIDE"
  88 |     ENABLE = "ENABLE"
  89 |     DISABLE = "DISABLE"
  90 |     REQUIRE = "REQUIRE"
  91 |     OPTIONAL = "OPTIONAL"
  92 |     SET_VALUE = "SET_VALUE"
  93 |     CALCULATE = "CALCULATE"
  94 |     TRIGGER_EVENT = "TRIGGER_EVENT"
  95 |     TRANSITION = "TRANSITION"
  96 | 
  97 | # ‚ö° RICH METADATA (For Dumb Frontend Rendering)
  98 | ACTION_METADATA = {
  99 |     RuleActionType.BLOCK: {"group": "Integrity (Gatekeepers)", "label": "Block Transaction", "icon": "antd:StopOutlined", "color": "#ff4d4f", "desc": "Stops the save completely."},
 100 |     RuleActionType.WARN: {"group": "Integrity (Gatekeepers)", "label": "Warning Toast", "icon": "antd:SafetyCertificateOutlined", "color": "#faad14", "desc": "Shows a warning but allows save."},
 101 |     RuleActionType.REQUIRE: {"group": "Integrity (Gatekeepers)", "label": "Mark Required", "icon": "antd:EditOutlined", "color": None, "desc": "Field becomes mandatory."},
 102 |     RuleActionType.OPTIONAL: {"group": "Integrity (Gatekeepers)", "label": "Mark Optional", "icon": "antd:BorderOutlined", "color": None, "desc": "Field becomes optional."},
 103 |     
 104 |     RuleActionType.HIDE: {"group": "Interface (Shapeshifters)", "label": "Hide Field", "icon": "antd:EyeInvisibleOutlined", "color": None, "desc": "Removes field from the form."},
 105 |     RuleActionType.SHOW: {"group": "Interface (Shapeshifters)", "label": "Show Field", "icon": "antd:AppstoreOutlined", "color": None, "desc": "Reveals a hidden field."},
 106 |     RuleActionType.DISABLE: {"group": "Interface (Shapeshifters)", "label": "Disable Input", "icon": "antd:StopOutlined", "color": None, "desc": "Makes field read-only."},
 107 |     RuleActionType.ENABLE: {"group": "Interface (Shapeshifters)", "label": "Enable Input", "icon": "antd:EditOutlined", "color": None, "desc": "Unlocks a read-only field."},
 108 |     
 109 |     RuleActionType.SET_VALUE: {"group": "Automation (Robots)", "label": "Set Value", "icon": "antd:EditOutlined", "color": "#1890ff", "desc": "Overwrites field value."},
 110 |     RuleActionType.TRIGGER_EVENT: {"group": "Automation (Robots)", "label": "Trigger Event", "icon": "antd:ThunderboltOutlined", "color": "#52c41a", "desc": "Fires a system webhook/event."},
 111 |     RuleActionType.CALCULATE: {"group": "Automation (Robots)", "label": "Calculate", "icon": "antd:FunctionOutlined", "color": None, "desc": "Applies a formula."},
 112 |     RuleActionType.TRANSITION: {"group": "Automation (Robots)", "label": "State Transition", "icon": "antd:SwapOutlined", "color": "#722ed1", "desc": "Forces a workflow transition."}
 113 | }
 114 | 
 115 | @unique
 116 | class PolicyResolutionStrategy(str, Enum):
 117 |     """The Governance Logic."""
 118 |     ALL_MUST_PASS = "ALL_MUST_PASS"
 119 |     AT_LEAST_ONE = "AT_LEAST_ONE"
 120 |     PRIORITY_OVERRIDE = "PRIORITY_OVERRIDE"
 121 |     WEIGHTED_SCORE = "WEIGHTED_SCORE"
 122 | 
 123 | @unique
 124 | class ViewEngineType(str, Enum):
 125 |     """The Renderer."""
 126 |     FORM_IO = "FORM_IO"
 127 |     TANSTACK_TABLE = "TANSTACK_TABLE"
 128 |     RECHARTS = "RECHARTS"
 129 |     MARKDOWN = "MARKDOWN"
 130 | 
 131 | @unique
 132 | class ScopeType(str, Enum):
 133 |     """The Context Hierarchy. Defines the 'Type' of a KernelScope."""
 134 |     GLOBAL = "GLOBAL"
 135 |     DOMAIN = "DOMAIN"
 136 |     PROCESS = "PROCESS"
 137 |     TRANSITION = "TRANSITION"
 138 |     FIELD = "FIELD"
 139 |     
 140 |     # ‚ö° SYSTEM BRICKS (The "App" Types)
 141 |     WIZARD = "WIZARD"       # Interactive Form Flow
 142 |     VIEW = "VIEW"           # Read-Only Dashboard/List
 143 |     JOB = "JOB"             # Background Task
 144 |     CONTAINER = "CONTAINER" # Visual Grouping (Menu Group)
 145 |     DASHBOARD = "DASHBOARD" # Analytical View
 146 | 

================================================================================

# Source code from: backend\app\core\meta\engine.py
-----------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/engine.py
   2 | # @file Meta-Kernel Policy Engine (The Brain)
   3 | # @author The Engineer (ansav8@gmail.com)
   4 | # @description The Runtime Processor for Level 5 Policy Enforcement.
   5 | #              UPDATED: Added 'Value Resolution' for SET_VALUE and TRIGGER_EVENT.
   6 | #              This allows policies to use variables (e.g. actor.id) instead of just static strings.
   7 | 
   8 | import jmespath
   9 | import logging
  10 | from typing import List, Dict, Any, Optional
  11 | from datetime import datetime
  12 | 
  13 | from app.core.kernel.actions import LogicResult
  14 | from app.core.meta.models import PolicyDefinition
  15 | from app.core.meta.constants import PolicyResolutionStrategy, RuleActionType
  16 | 
  17 | logger = logging.getLogger("core.meta.engine")
  18 | 
  19 | class PolicyEngine:
  20 |     """
  21 |     The Universal Logic Executor.
  22 |     Input: Data + Policies
  23 |     Output: LogicResult (Pass/Fail + Messages)
  24 |     """
  25 | 
  26 |     def evaluate(
  27 |         self, 
  28 |         entity: Dict[str, Any], 
  29 |         policies: List[PolicyDefinition], 
  30 |         strategy: str = PolicyResolutionStrategy.ALL_MUST_PASS,
  31 |         context_override: Optional[Dict[str, Any]] = None
  32 |     ) -> LogicResult:
  33 |         """
  34 |         The Main Entry Point.
  35 |         Evaluates a set of policies against an entity.
  36 |         """
  37 |         start_time = datetime.now()
  38 |         
  39 |         # 1. Prepare Data Context (Sandbox Envelope)
  40 |         # We wrap the data to allow 'context.meta' or 'context.actor' access if needed later.
  41 |         data_context = context_override or {}
  42 |         if not data_context:
  43 |             data_context = entity if isinstance(entity, dict) else self._serialize(entity)
  44 |         
  45 |         # Strategy: Pass object directly. Rules should be written as `host.weight > 10`.
  46 |         
  47 |         combined_result = LogicResult(is_valid=True)
  48 |         executed_count = 0
  49 |         violation_count = 0
  50 | 
  51 |         # 2. Iterate Policies
  52 |         for policy in policies:
  53 |             if not policy.is_active:
  54 |                 continue
  55 | 
  56 |             policy_result = self._evaluate_single_policy(policy, data_context)
  57 |             executed_count += 1
  58 | 
  59 |             # 3. Merge Results based on Governance Strategy
  60 |             if not policy_result.is_valid:
  61 |                 violation_count += 1
  62 |                 combined_result.blocking_errors.extend(policy_result.blocking_errors)
  63 |                 combined_result.is_valid = False # Temporarily mark false, Strategy decides final
  64 |             
  65 |             combined_result.warnings.extend(policy_result.warnings)
  66 |             combined_result.mutations.extend(policy_result.mutations)
  67 |             combined_result.side_effects.extend(policy_result.side_effects)
  68 | 
  69 |         # 4. Apply Resolution Strategy ( The Judge )
  70 |         final_verdict = self._apply_strategy(strategy, combined_result, executed_count, violation_count)
  71 |         
  72 |         duration = (datetime.now() - start_time).total_seconds() * 1000
  73 |         self._log_summary(final_verdict, executed_count, duration)
  74 |         
  75 |         return final_verdict
  76 | 
  77 |     def _evaluate_single_policy(self, policy: PolicyDefinition, data: Any) -> LogicResult:
  78 |         """
  79 |         Executes one Policy Bundle (which may contain multiple Rules).
  80 |         """
  81 |         result = LogicResult(is_valid=True)
  82 |         
  83 |         # Policies store rules as a JSONB list: [{ "logic": "...", "action": "BLOCK", ... }]
  84 |         rules = policy.rules if isinstance(policy.rules, list) else []
  85 |         
  86 |         for rule in rules:
  87 |             try:
  88 |                 logic_expr = rule.get("logic", "")
  89 |                 action = rule.get("action", RuleActionType.BLOCK)
  90 |                 message = rule.get("message", f"Policy '{policy.key}' violation.")
  91 |                 
  92 |                 # A. Execute JMESPath
  93 |                 # Boolean expressions: `host.age > 18` returns True/False.
  94 |                 is_match = jmespath.search(logic_expr, data)
  95 |                 
  96 |                 # B. Handle Match (Triggered)
  97 |                 if is_match:
  98 |                     # ‚ö° RESOLVE DYNAMIC VALUES
  99 |                     # If action involves data, we must check if the value is a reference (e.g. actor.id)
 100 |                     raw_value = rule.get("value")
 101 |                     resolved_value = self._resolve_value(raw_value, data)
 102 | 
 103 |                     if action == RuleActionType.BLOCK:
 104 |                         result.is_valid = False
 105 |                         result.blocking_errors.append(message)
 106 |                     
 107 |                     elif action == RuleActionType.WARN:
 108 |                         result.warnings.append(message)
 109 |                     
 110 |                     elif action == RuleActionType.SET_VALUE:
 111 |                         result.mutations.append({
 112 |                             "target": rule.get("target"),
 113 |                             "value": resolved_value # üëà NOW RESOLVED
 114 |                         })
 115 | 
 116 |                     elif action == RuleActionType.TRIGGER_EVENT:
 117 |                         result.side_effects.append({
 118 |                             "type": "TRIGGER_EVENT",
 119 |                             "value": {
 120 |                                 "event": rule.get("value", {}).get("event"),
 121 |                                 "payload": rule.get("value", {}).get("payload") # TODO: recursive resolve here if needed
 122 |                             }
 123 |                         })
 124 |                         
 125 |                     elif action == RuleActionType.TRANSITION:
 126 |                         result.side_effects.append({
 127 |                             "type": "TRANSITION",
 128 |                             "value": resolved_value
 129 |                         })
 130 | 
 131 |             except Exception as e:
 132 |                 # SAFEGUARD: Bad rule syntax should not crash the system.
 133 |                 logger.error(f"üî• [PolicyEngine] Rule Crash in '{policy.key}': {e}")
 134 |                 
 135 |                 # ‚ö° FAIL OPEN: Treat crash as WARNING, not BLOCK.
 136 |                 result.warnings.append(f"System Governance Warning: Rule crashed in '{policy.key}'. Logic ignored.")
 137 |         
 138 |         return result
 139 | 
 140 |     def _resolve_value(self, value: Any, context: Dict[str, Any]) -> Any:
 141 |         """
 142 |         Detects if a value is a reference (e.g. 'actor.id') and resolves it against the context.
 143 |         """
 144 |         if not isinstance(value, str):
 145 |             return value
 146 |         
 147 |         # Heuristic: If it looks like a known context path, try to resolve it.
 148 |         # This matches the 'Value Source' logic in the Frontend Policy Editor.
 149 |         KNOWN_ROOTS = ['host.', 'meta.', 'system.', 'actor.', 'session.', 'context.']
 150 |         
 151 |         if any(value.startswith(root) for root in KNOWN_ROOTS):
 152 |             try:
 153 |                 resolved = jmespath.search(value, context)
 154 |                 # If resolution works, return it. If it returns None, it might mean the field is missing,
 155 |                 # but we return None rather than the string literal "actor.id".
 156 |                 return resolved
 157 |             except Exception:
 158 |                 # If JMESPath crashes, fallback to the string literal
 159 |                 return value
 160 |         
 161 |         return value
 162 | 
 163 |     def _apply_strategy(self, strategy: str, result: LogicResult, total: int, violations: int) -> LogicResult:
 164 |         """
 165 |         Decides the final outcome based on the strategy.
 166 |         """
 167 |         if total == 0:
 168 |             return result # No policies = Pass
 169 | 
 170 |         if strategy == PolicyResolutionStrategy.ALL_MUST_PASS:
 171 |             # Default: Any violation kills the transaction
 172 |             if violations > 0:
 173 |                 result.is_valid = False
 174 |             else:
 175 |                 result.is_valid = True
 176 | 
 177 |         elif strategy == PolicyResolutionStrategy.AT_LEAST_ONE:
 178 |             # If (Total - Violations) > 0, then Pass.
 179 |             if (total - violations) > 0:
 180 |                 result.is_valid = True
 181 |                 result.blocking_errors = [] # Clear errors if we passed via override
 182 |             else:
 183 |                 result.is_valid = False
 184 | 
 185 |         return result
 186 | 
 187 |     def _serialize(self, entity: Any) -> Dict[str, Any]:
 188 |         """Helper to convert SQLAlchemy objects to Dict for JMESPath."""
 189 |         if hasattr(entity, "to_dict"):
 190 |             return entity.to_dict()
 191 |         if hasattr(entity, "__dict__"):
 192 |             return {c.name: getattr(entity, c.name) for c in entity.__table__.columns}
 193 |         return str(entity)
 194 | 
 195 |     def _log_summary(self, result: LogicResult, count: int, duration: float):
 196 |         if not result.is_valid:
 197 |             logger.info(f"üö´ [PolicyEngine] BLOCKED ({len(result.blocking_errors)} errors) | {count} Policies | {duration:.2f}ms")
 198 |         elif result.warnings:
 199 |             logger.info(f"‚ö†Ô∏è [PolicyEngine] WARNED ({len(result.warnings)} warnings) | {count} Policies | {duration:.2f}ms")
 200 |         else:
 201 |             logger.debug(f"‚úÖ [PolicyEngine] ALLOWED | {count} Policies | {duration:.2f}ms")
 202 | 
 203 | # Singleton
 204 | policy_engine = PolicyEngine()
 205 | 

================================================================================

# Source code from: backend\app\core\meta\features\groups\router.py
---------------------------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/features/groups/router.py
   2 | # @file: Policy Group API
   3 | # @author: The Engineer (ansav8@gmail.com)
   4 | # @description: REST Controller for Policy Bundles.
   5 | # Exposes the 'GroupService' to the Frontend.
   6 | 
   7 | from typing import List, Optional
   8 | from fastapi import APIRouter, Depends, HTTPException, status, Path, Query
   9 | from sqlalchemy.ext.asyncio import AsyncSession
  10 | 
  11 | from app.core.database.session import get_db
  12 | from app.core.meta.schemas import PolicyGroupCreate, PolicyGroupRead, PolicyGroupUpdate
  13 | from app.core.meta.features.groups.service import GroupService
  14 | 
  15 | # ‚ö° Fractal Router (Isolated)
  16 | router = APIRouter()
  17 | 
  18 | @router.post(
  19 |     "",
  20 |     response_model=PolicyGroupRead,
  21 |     status_code=status.HTTP_201_CREATED,
  22 |     summary="Create Policy Group"
  23 | )
  24 | async def create_group(
  25 |     payload: PolicyGroupCreate,
  26 |     db: AsyncSession = Depends(get_db)
  27 | ):
  28 |     try:
  29 |         return await GroupService.create_group(db, payload)
  30 |     except ValueError as e:
  31 |         raise HTTPException(status_code=409, detail=str(e))
  32 |     except Exception as e:
  33 |         raise HTTPException(status_code=500, detail=str(e))
  34 | 
  35 | @router.get(
  36 |     "", # ‚ö° FIX: Removed trailing slash to prevent 307 Redirect
  37 |     response_model=List[PolicyGroupRead],
  38 |     summary="List Groups"
  39 | )
  40 | async def list_groups(
  41 |     active: bool = Query(True, description="Filter active groups"),
  42 |     db: AsyncSession = Depends(get_db)
  43 | ):
  44 |     return await GroupService.get_groups(db, active_only=active)
  45 | 
  46 | @router.get(
  47 |     "/{id}",
  48 |     response_model=PolicyGroupRead,
  49 |     summary="Get Group Details"
  50 | )
  51 | async def get_group(
  52 |     id: int = Path(..., description="Group ID"),
  53 |     db: AsyncSession = Depends(get_db)
  54 | ):
  55 |     group = await GroupService.get_group_by_id(db, id)
  56 |     if not group:
  57 |         raise HTTPException(status_code=404, detail="Group not found")
  58 |     return group
  59 | 
  60 | 
  61 | @router.patch(
  62 |     "/{id}",
  63 |     response_model=PolicyGroupRead,
  64 |     summary="Update Group"
  65 | )
  66 | async def update_group(
  67 |     id: int = Path(...),
  68 |     payload: PolicyGroupUpdate = ...,
  69 |     db: AsyncSession = Depends(get_db)
  70 | ):
  71 |     updated = await GroupService.update_group(db, id, payload)
  72 |     if not updated:
  73 |         raise HTTPException(status_code=404, detail="Group not found")
  74 |     return updated
  75 | 
  76 | 
  77 | @router.delete(
  78 |     "/{id}",
  79 |     status_code=status.HTTP_204_NO_CONTENT,
  80 |     summary="Deactivate Group"
  81 | )
  82 | async def delete_group(
  83 |     id: int = Path(...),
  84 |     db: AsyncSession = Depends(get_db)
  85 | ):
  86 |     success = await GroupService.delete_group(db, id)
  87 |     if not success:
  88 |         raise HTTPException(status_code=404, detail="Group not found")
  89 |     return None
  90 | 

================================================================================

# Source code from: backend\app\core\meta\features\groups\service.py
----------------------------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/features/groups/service.py
   2 | # @file Policy Group Service
   3 | # @author The Engineer (ansav8@gmail.com)
   4 | # @description Business Logic for managing Policy Groups (Bundles).
   5 | #              Handles Creation, Member Management (Ordering), and Lifecycle.
   6 | 
   7 | import logging
   8 | from typing import List, Optional
   9 | from sqlalchemy import select, update, delete
  10 | from sqlalchemy.ext.asyncio import AsyncSession
  11 | from sqlalchemy.orm import selectinload
  12 | 
  13 | from app.core.meta.models import PolicyGroup, PolicyDefinition
  14 | from app.core.meta.schemas import PolicyGroupCreate, PolicyGroupUpdate
  15 | 
  16 | logger = logging.getLogger("core.meta.groups")
  17 | 
  18 | class GroupService:
  19 |     """
  20 |     The Librarian. Manages collections of Policies.
  21 |     """
  22 | 
  23 |     @staticmethod
  24 |     def _generate_key(name: str) -> str:
  25 |         """Auto-generates a system key from a human name if not provided."""
  26 |         return name.upper().replace(" ", "_").replace("-", "_")
  27 | 
  28 |     @staticmethod
  29 |     async def create_group(db: AsyncSession, payload: PolicyGroupCreate) -> PolicyGroup:
  30 |         """
  31 |         Creates a new Policy Group.
  32 |         Enforces Key Uniqueness.
  33 |         """
  34 |         # 1. Validate Key Uniqueness
  35 |         stmt = select(PolicyGroup).where(PolicyGroup.key == payload.key)
  36 |         existing = await db.execute(stmt)
  37 |         if existing.scalars().first():
  38 |             raise ValueError(f"Group with key '{payload.key}' already exists.")
  39 | 
  40 |         # 2. Validate Policy Keys (Optional but recommended)
  41 |         # We trust the user provided valid keys, or we could verify them here.
  42 |         
  43 |         # 3. Create Entity
  44 |         db_obj = PolicyGroup(
  45 |             key=payload.key,
  46 |             name=payload.name,
  47 |             description=payload.description,
  48 |             policy_keys=payload.policy_keys, # Stores order: ["SECURITY_V1", "LOGGING_V2"]
  49 |             is_active=payload.is_active
  50 |         )
  51 |         
  52 |         db.add(db_obj)
  53 |         
  54 |         try:
  55 |             await db.commit()
  56 |             await db.refresh(db_obj)
  57 |             logger.info(f"üì¶ [GroupService] Created Bundle: {db_obj.key}")
  58 |             return db_obj
  59 |         except Exception as e:
  60 |             await db.rollback()
  61 |             logger.error(f"üî• [GroupService] Creation Failed: {e}")
  62 |             raise e
  63 | 
  64 |     @staticmethod
  65 |     async def get_groups(db: AsyncSession, active_only: bool = True) -> List[PolicyGroup]:
  66 |         """
  67 |         Lists all Policy Groups.
  68 |         """
  69 |         query = select(PolicyGroup)
  70 |         if active_only:
  71 |             query = query.where(PolicyGroup.is_active == True)
  72 |             
  73 |         query = query.order_by(PolicyGroup.key)
  74 |         
  75 |         result = await db.execute(query)
  76 |         return result.scalars().all()
  77 | 
  78 |     @staticmethod
  79 |     async def get_group_by_id(db: AsyncSession, group_id: int) -> Optional[PolicyGroup]:
  80 |         """
  81 |         Fetches a single group.
  82 |         """
  83 |         return await db.get(PolicyGroup, group_id)
  84 | 
  85 |     @staticmethod
  86 |     async def update_group(db: AsyncSession, group_id: int, payload: PolicyGroupUpdate) -> Optional[PolicyGroup]:
  87 |         """
  88 |         Updates metadata or membership order.
  89 |         """
  90 |         group = await db.get(PolicyGroup, group_id)
  91 |         if not group:
  92 |             return None
  93 | 
  94 |         # Apply Updates
  95 |         update_data = payload.model_dump(exclude_unset=True)
  96 |         for key, value in update_data.items():
  97 |             setattr(group, key, value)
  98 | 
  99 |         try:
 100 |             await db.commit()
 101 |             await db.refresh(group)
 102 |             logger.info(f"üìù [GroupService] Updated Group: {group.key}")
 103 |             return group
 104 |         except Exception as e:
 105 |             await db.rollback()
 106 |             raise e
 107 | 
 108 |     @staticmethod
 109 |     async def delete_group(db: AsyncSession, group_id: int) -> bool:
 110 |         """
 111 |         Soft Delete (Deactivate) or Hard Delete if no dependencies.
 112 |         For now, we enforce Soft Delete to protect history.
 113 |         """
 114 |         group = await db.get(PolicyGroup, group_id)
 115 |         if not group:
 116 |             return False
 117 | 
 118 |         # TODO: Check if bound to any active PolicyBinding before deleting?
 119 |         # For Level 5 safety, we just Deactivate.
 120 |         group.is_active = False
 121 |         
 122 |         try:
 123 |             await db.commit()
 124 |             logger.info(f"üö´ [GroupService] Deactivated Group: {group.key}")
 125 |             return True
 126 |         except Exception as e:
 127 |             await db.rollback()
 128 |             raise e
 129 | 

================================================================================

# Source code from: backend\app\core\meta\features\states\logic\enforcer.py
-----------------------------------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/features/states/logic/enforcer.py
   2 | # @file: State Enforcer (Decoupled v3.0)
   3 | # @role: üß† Logic Container
   4 | # @author: The Engineer (ansav8@gmail.com)
   5 | # @description: Decoupled Workflow Enforcer. No longer imports Governance directly.
   6 | # @security-level: LEVEL 9 (Strict Decoupling)
   7 | 
   8 | import logging
   9 | from typing import List, Any, Optional, Dict
  10 | from sqlalchemy.orm import Session
  11 | from sqlalchemy.inspection import inspect
  12 | from sqlalchemy import select
  13 | from sqlalchemy.ext.asyncio import AsyncSession
  14 | 
  15 | from app.core.meta.models import StateDefinition
  16 | from app.core.kernel.models import SystemOutbox
  17 | from app.core.meta.features.states.logic.machine import StateMachine
  18 | 
  19 | logger = logging.getLogger("core.meta.states.enforcer")
  20 | 
  21 | class StateEnforcer:
  22 |     @staticmethod
  23 |     async def fetch_definitions(db: AsyncSession, domain: str) -> List[StateDefinition]:
  24 |         """‚ö° SIDECAR IO: Fetches active state machines for a domain."""
  25 |         stmt = select(StateDefinition).where(
  26 |             StateDefinition.entity_key == domain,
  27 |             StateDefinition.is_active == True
  28 |         )
  29 |         result = await db.execute(stmt)
  30 |         return result.scalars().all()
  31 | 
  32 |     @staticmethod
  33 |     def enforce_logic(obj: Any, definitions: List[StateDefinition], session_for_side_effects: Session):
  34 |         """
  35 |         @description: CPU LOGIC: Evaluates transitions. 
  36 |         Emits transition data into the object context for Signal Interception.
  37 |         """
  38 |         if not definitions:
  39 |             return 
  40 | 
  41 |         inspector = inspect(obj)
  42 |         domain = type(obj).__name__.upper()
  43 | 
  44 |         for definition in definitions:
  45 |             target_field = getattr(definition, 'governed_field', 'status')
  46 |             if not hasattr(obj, target_field):
  47 |                 continue
  48 | 
  49 |             attr = getattr(inspector.attrs, target_field)
  50 |             hist = attr.history
  51 |             if not hist.has_changes():
  52 |                 continue
  53 | 
  54 |             old_value = hist.deleted[0] if hist.deleted else None
  55 |             new_value = hist.added[0] if hist.added else None
  56 |             if old_value == new_value:
  57 |                 continue
  58 | 
  59 |             logger.info(f"üîÑ [Enforcer] Transition Request {domain} | {target_field}: '{old_value}' -> '{new_value}'")
  60 | 
  61 |             machine = StateMachine(definition.transitions)
  62 |             config = machine.get_transition_config(old_value, new_value)
  63 |             
  64 |             if not config:
  65 |                 raise ValueError(f"‚ùå [Workflow] Path '{old_value}' -> '{new_value}' is illegal in '{definition.name}'.")
  66 | 
  67 |             # ‚ö° DECOUPLING POINT:
  68 |             # We no longer evaluate the guard here. 
  69 |             # We attach the 'guard' and 'actions' to the object sidecar.
  70 |             # The Interceptor will see this and trigger the Governance Signal.
  71 |             if not hasattr(obj, "_pending_transition"):
  72 |                 obj._pending_transition = []
  73 |             
  74 |             obj._pending_transition.append({
  75 |                 "workflow": definition.name,
  76 |                 "scope": definition.scope,
  77 |                 "from": old_value,
  78 |                 "to": new_value,
  79 |                 "guard": config.get("guard"),
  80 |                 "actions": config.get("actions", [])
  81 |             })

================================================================================

# Source code from: backend\app\core\meta\features\states\models.py
---------------------------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/features/states/models.py
   2 | # @file: State Engine Data Models
   3 | # @author: The Engineer
   4 | # @description: Defines the 'Class' of a Workflow (e.g. WIZARD vs JOB).
   5 | # Replaces hardcoded Enums with Database Rows.
   6 | # @security-level: LEVEL 9 (Strict Schema)
   7 | 
   8 | from sqlalchemy import Column, String, DateTime, Text
   9 | from sqlalchemy.dialects.postgresql import JSONB
  10 | from sqlalchemy.sql import func, text
  11 | 
  12 | from app.core.database.base import Base
  13 | 
  14 | class WorkflowType(Base):
  15 |     """
  16 |     Defines a Category of State Machine.
  17 |     
  18 |     Acts as a Template/Class for 'StateDefinition'.
  19 |     - key: 'WIZARD', 'JOB'
  20 |     - validation_schema: JSON Schema used to validate the 'transitions' blob.
  21 |     - ui_config: Frontend hints (default icon, color, label).
  22 |     """
  23 |     __tablename__ = "meta_workflow_types"
  24 | 
  25 |     # Identity
  26 |     key = Column(String(50), primary_key=True, index=True) # WIZARD, JOB, GOVERNANCE
  27 |     label = Column(String(100), nullable=False)            # "Interactive Wizard"
  28 |     description = Column(String(500), nullable=True)
  29 | 
  30 |     # ‚ö° THE BRAIN: Dynamic Validation Logic
  31 |     # Instead of hardcoding "if type == WIZARD check form_schema",
  32 |     # we store the JSON Schema here and validate dynamically.
  33 |     validation_schema = Column(JSONB, nullable=False, server_default=text("'{}'::jsonb"))
  34 | 
  35 |     # ‚ö° UI HINTS (Future Proofing)
  36 |     # e.g. { "icon": "ant:RocketOutlined", "color": "blue" }
  37 |     ui_config = Column(JSONB, nullable=False, server_default=text("'{}'::jsonb"))
  38 | 
  39 |     # Audit
  40 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
  41 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now())
  42 | 
  43 |     def __repr__(self):
  44 |         return f"<WorkflowType(key='{self.key}')>"
  45 | 

================================================================================

# Source code from: backend\app\core\meta\features\states\service.py
----------------------------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/features/states/service.py
   2 | # @file: State Engine Service
   3 | # @author: The Engineer
   4 | # @description: Manages Lifecycle Flows.
   5 | # @security-level: LEVEL 9 (Safety Interlocks)
   6 | # @updated: Restored 'get_workflow_types' and wired 'ScopeValidator.validate'.
   7 | 
   8 | import logging
   9 | from typing import List, Optional
  10 | from sqlalchemy import select, update, desc
  11 | from sqlalchemy.ext.asyncio import AsyncSession
  12 | 
  13 | from app.core.meta.models import StateDefinition
  14 | from app.core.meta.features.states.models import WorkflowType # ‚ö° RESTORED IMPORT
  15 | from app.domains.system.models import KernelScope 
  16 | from app.core.meta.features.states.schemas import StateMachineCreate
  17 | from app.core.meta.features.states.logic.validator import ScopeValidator
  18 | 
  19 | logger = logging.getLogger("core.meta.states")
  20 | 
  21 | class StateService:
  22 | 
  23 |     @staticmethod
  24 |     async def get_workflow_types(db: AsyncSession) -> List[WorkflowType]:
  25 |         """
  26 |         Retrieves the catalogue of available Workflow "Animals" (e.g. WIZARD, JOB).
  27 |         Used by the Frontend to dynamically render the "Create New" menu.
  28 |         """
  29 |         # Order by key for consistent UI rendering
  30 |         stmt = select(WorkflowType).order_by(WorkflowType.key)
  31 |         result = await db.execute(stmt)
  32 |         return result.scalars().all()
  33 | 
  34 |     @staticmethod
  35 |     async def create_machine(db: AsyncSession, payload: StateMachineCreate) -> StateDefinition:
  36 |         """
  37 |         Registers a State Machine (Ledger Strategy).
  38 |         1. Validate against Kernel Registry (Level 7) - NOW DYNAMIC.
  39 |         2. Archive Old Versions.
  40 |         3. Insert New Version (Auto-SemVer).
  41 |         """
  42 |         logger.info(f"üß¨ [StateEngine] Ratifying Process: {payload.domain}/{payload.scope}")
  43 | 
  44 |         try:
  45 |             # --- 0. LEVEL 7 INTEGRITY CHECK ---
  46 |             scope_stmt = select(KernelScope).where(
  47 |                 KernelScope.domain_key == payload.domain,
  48 |                 KernelScope.key == payload.scope
  49 |             )
  50 |             scope_result = await db.execute(scope_stmt)
  51 |             kernel_scope = scope_result.scalars().first()
  52 | 
  53 |             if not kernel_scope:
  54 |                 logger.warning(f"‚ö†Ô∏è [StateEngine] Scope '{payload.scope}' not found in Registry. Skipping strict validation.")
  55 |             else:
  56 |                 logger.info(f"‚öñÔ∏è [StateEngine] Validating against Scope Type: {kernel_scope.type}")
  57 |                 
  58 |                 # ‚ö° UPDATE: Pass 'db' to allow dynamic rule lookup
  59 |                 await ScopeValidator.validate(db, payload.definition, kernel_scope.type)
  60 |                 
  61 |                 if kernel_scope.target_field and kernel_scope.target_field != payload.governed_field:
  62 |                     logger.warning(f"‚ö†Ô∏è [StateEngine] Payload target '{payload.governed_field}' differs from Registry '{kernel_scope.target_field}'.")
  63 | 
  64 |             # --- 1. Determine Next Version (SemVer + Legacy) ---
  65 |             # We fetch the absolute latest version to calculate the increment
  66 |             stmt = select(StateDefinition).where(
  67 |                 StateDefinition.entity_key == payload.domain,
  68 |                 StateDefinition.scope == payload.scope
  69 |             ).order_by(
  70 |                 desc(StateDefinition.version_major),
  71 |                 desc(StateDefinition.version_minor),
  72 |                 desc(StateDefinition.version_patch)
  73 |             ).limit(1)
  74 |             
  75 |             result = await db.execute(stmt)
  76 |             latest = result.scalars().first()
  77 |             
  78 |             if latest:
  79 |                 # Patch Increment Strategy (1.0.0 -> 1.0.1)
  80 |                 new_major = latest.version_major
  81 |                 new_minor = latest.version_minor
  82 |                 new_patch = latest.version_patch + 1
  83 |                 next_legacy_ver = (latest.version or 0) + 1
  84 |             else:
  85 |                 # Initialize at 1.0.0
  86 |                 new_major = 1
  87 |                 new_minor = 0
  88 |                 new_patch = 0
  89 |                 next_legacy_ver = 1
  90 | 
  91 |             # --- 2. Archive Old Versions ---
  92 |             if latest:
  93 |                 archive_stmt = update(StateDefinition).where(
  94 |                     StateDefinition.entity_key == payload.domain,
  95 |                     StateDefinition.scope == payload.scope,
  96 |                     StateDefinition.is_active == True
  97 |                 ).values(is_active=False)
  98 |                 await db.execute(archive_stmt)
  99 | 
 100 |             # --- 3. Create New Version ---
 101 |             db_obj = StateDefinition(
 102 |                 entity_key=payload.domain,
 103 |                 scope=payload.scope,
 104 |                 name=payload.name,
 105 |                 initial_state=payload.definition.get("initial"),
 106 |                 transitions=payload.definition, 
 107 |                 
 108 |                 # SemVer
 109 |                 version_major=new_major,
 110 |                 version_minor=new_minor,
 111 |                 version_patch=new_patch,
 112 |                 
 113 |                 # Legacy
 114 |                 version=next_legacy_ver,
 115 |                 
 116 |                 is_active=True,   
 117 |                 governed_field=payload.governed_field
 118 |             )
 119 |             
 120 |             db.add(db_obj)
 121 |             await db.commit()
 122 |             await db.refresh(db_obj)
 123 |             
 124 |             logger.info(f"‚úÖ [StateEngine] Ratified Version {new_major}.{new_minor}.{new_patch}: {payload.domain}/{payload.scope}")
 125 |             return db_obj
 126 | 
 127 |         except Exception as e:
 128 |             await db.rollback()
 129 |             logger.error(f"üî• [StateEngine] Ratification Failed: {str(e)}")
 130 |             raise e
 131 | 
 132 |     @staticmethod
 133 |     async def get_machines(db: AsyncSession, domain: Optional[str] = None) -> List[StateDefinition]:
 134 |         query = select(StateDefinition).where(StateDefinition.is_active == True)
 135 |         if domain:
 136 |             query = query.where(StateDefinition.entity_key == domain)
 137 |         result = await db.execute(query)
 138 |         return result.scalars().all()
 139 | 
 140 |     @staticmethod
 141 |     async def get_machine_by_scope(db: AsyncSession, domain: str, scope: str, version: Optional[int] = None) -> Optional[StateDefinition]:
 142 |         stmt = select(StateDefinition).where(
 143 |             StateDefinition.entity_key == domain,
 144 |             StateDefinition.scope == scope
 145 |         )
 146 |         if version:
 147 |             stmt = stmt.where(StateDefinition.version == version)
 148 |         else:
 149 |             stmt = stmt.where(StateDefinition.is_active == True)
 150 | 
 151 |         result = await db.execute(stmt)
 152 |         return result.scalars().first()
 153 | 
 154 |     @staticmethod
 155 |     async def get_machine_history(db: AsyncSession, domain: str, scope: str) -> List[StateDefinition]:
 156 |         stmt = select(StateDefinition).where(
 157 |             StateDefinition.entity_key == domain,
 158 |             StateDefinition.scope == scope
 159 |         ).order_by(
 160 |             desc(StateDefinition.version_major),
 161 |             desc(StateDefinition.version_minor),
 162 |             desc(StateDefinition.version_patch)
 163 |         )
 164 |         result = await db.execute(stmt)
 165 |         return result.scalars().all()
 166 | 
 167 |     @staticmethod
 168 |     async def delete_machine(db: AsyncSession, id: int) -> bool:
 169 |         """
 170 |         Safe Deletion Protocol.
 171 |         """
 172 |         workflow = await db.get(StateDefinition, id)
 173 |         if not workflow: 
 174 |             return False
 175 | 
 176 |         logger.info(f"üóëÔ∏è [StateEngine] Requesting deletion of {workflow.entity_key}/{workflow.scope}...")
 177 | 
 178 |         try:
 179 |             from app.domains.workspace.models import ActiveApp
 180 |             
 181 |             scope_stmt = select(KernelScope.id).where(
 182 |                 KernelScope.domain_key == workflow.entity_key,
 183 |                 KernelScope.key == workflow.scope
 184 |             )
 185 |             scope_id_res = await db.execute(scope_stmt)
 186 |             scope_id = scope_id_res.scalar()
 187 | 
 188 |             if scope_id:
 189 |                 usage_stmt = select(ActiveApp).where(
 190 |                     ActiveApp.scope_id == scope_id,
 191 |                     ActiveApp.is_active == True
 192 |                 )
 193 |                 usage_res = await db.execute(usage_stmt)
 194 |                 active_app = usage_res.scalars().first()
 195 | 
 196 |                 if active_app:
 197 |                     msg = f"‚õî Blocked: Workflow is used by App #{active_app.id} on Screen #{active_app.screen_id}."
 198 |                     logger.warning(msg)
 199 |                     raise ValueError(msg)
 200 |             
 201 |         except ValueError as ve:
 202 |             raise ve
 203 |         except ImportError:
 204 |             pass
 205 |         except Exception as e:
 206 |             logger.error(f"üî• [StateEngine] Dependency Check Failed: {e}")
 207 |             raise ValueError("System Error during dependency check.")
 208 | 
 209 |         await db.delete(workflow)
 210 |         await db.commit()
 211 |         return True
 212 | 

================================================================================

# Source code from: backend\app\core\meta\features\views\service.py
---------------------------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/features/views/service.py
   2 | # @file View Engine Service (The Resolution Logic)
   3 | # @author The Engineer (ansav8@gmail.com)
   4 | # @description Manages View Definitions and the "Best Match" Resolution Algorithm.
   5 | #              UPDATED: Implements "Auto-Live" Versioning Strategy (Fork & Promote).
   6 | 
   7 | import logging
   8 | from typing import List, Optional, Dict, Any
   9 | from sqlalchemy import select, desc, update
  10 | from sqlalchemy.orm import selectinload
  11 | from sqlalchemy.ext.asyncio import AsyncSession
  12 | 
  13 | from app.core.meta.models import ViewDefinition, ViewBinding
  14 | from app.core.meta.features.views.schemas import (
  15 |     ViewCreate, ViewUpdate, ViewBindingCreate, ViewBindingUpdate
  16 | )
  17 | 
  18 | logger = logging.getLogger("core.meta.views")
  19 | 
  20 | class ViewService:
  21 |     """
  22 |     The Orchestrator for the UI Backbone.
  23 |     """
  24 | 
  25 |     # ==========================================================================
  26 |     #  1. DEFINITION MANAGEMENT (CRUD)
  27 |     # ==========================================================================
  28 | 
  29 |     @staticmethod
  30 |     async def create_view_async(db: AsyncSession, payload: ViewCreate) -> ViewDefinition:
  31 |         # Check Uniqueness (Only check against LATEST)
  32 |         stmt = select(ViewDefinition).where(
  33 |             ViewDefinition.key == payload.key,
  34 |             ViewDefinition.is_latest == True
  35 |         )
  36 |         existing = await db.execute(stmt)
  37 |         if existing.scalars().first():
  38 |             raise ValueError(f"View with key '{payload.key}' already exists.")
  39 | 
  40 |         # Serialize - by_alias=True ensures 'schema' key is used for DB
  41 |         data = payload.model_dump(by_alias=True, mode='json')
  42 |         
  43 |         # Initial Version: 1.00
  44 |         db_obj = ViewDefinition(
  45 |             **data,
  46 |             version_major=1,
  47 |             version_minor=0,
  48 |             is_latest=True
  49 |         )
  50 |         db.add(db_obj)
  51 | 
  52 |         try:
  53 |             await db.commit()
  54 |             await db.refresh(db_obj)
  55 |             logger.info(f"üé® [ViewEngine] Created Layout: {payload.key} (v1.00)")
  56 |             return db_obj
  57 |         except Exception as e:
  58 |             await db.rollback()
  59 |             raise e
  60 | 
  61 |     @staticmethod
  62 |     async def update_view_async(db: AsyncSession, view_id: int, payload: ViewUpdate) -> ViewDefinition:
  63 |         """
  64 |         AUTO-LIVE STRATEGY:
  65 |         1. Fetch current view (Parent).
  66 |         2. Calculate next version (v1.05 -> v1.06).
  67 |         3. Fork (Create New).
  68 |         4. Deprecate Parent.
  69 |         5. Auto-Promote Bindings.
  70 |         """
  71 |         # 1. Fetch Parent
  72 |         parent_view = await db.get(ViewDefinition, view_id)
  73 |         if not parent_view:
  74 |             raise ValueError(f"View ID {view_id} not found.")
  75 | 
  76 |         # 2. Calculate Next Version
  77 |         major = parent_view.version_major
  78 |         minor = parent_view.version_minor + 1
  79 |         
  80 |         if minor >= 100: # Rollover Rule
  81 |             major += 1
  82 |             minor = 0
  83 | 
  84 |         # 3. Prepare New Data
  85 |         new_data = {
  86 |             "key": parent_view.key,
  87 |             "name": payload.name or parent_view.name,
  88 |             "engine": parent_view.engine,
  89 |             "schema": payload.schema_config or parent_view.schema, # Use existing if not updated
  90 |             "is_active": payload.is_active if payload.is_active is not None else parent_view.is_active,
  91 |             "version_major": major,
  92 |             "version_minor": minor,
  93 |             "is_latest": True
  94 |         }
  95 | 
  96 |         try:
  97 |             # 4. Create New Head
  98 |             new_view = ViewDefinition(**new_data)
  99 |             db.add(new_view)
 100 |             await db.flush() # Flush to get new_view.id
 101 | 
 102 |             # 5. Deprecate Parent (Mark as not latest)
 103 |             parent_view.is_latest = False
 104 |             
 105 |             # 6. AUTO-LIVE: Promote Bindings
 106 |             # Find all bindings pointing to the OLD view and move them to the NEW view
 107 |             binding_stmt = select(ViewBinding).where(ViewBinding.view_id == parent_view.id)
 108 |             binding_result = await db.execute(binding_stmt)
 109 |             bindings = binding_result.scalars().all()
 110 |             
 111 |             promoted_count = 0
 112 |             for binding in bindings:
 113 |                 binding.view_id = new_view.id
 114 |                 promoted_count += 1
 115 | 
 116 |             await db.commit()
 117 |             await db.refresh(new_view)
 118 |             
 119 |             logger.info(f"üé® [ViewEngine] Forked {parent_view.key}: v{parent_view.version_major}.{parent_view.version_minor} -> v{major}.{minor}")
 120 |             logger.info(f"üöÄ [Auto-Live] Promoted {promoted_count} bindings to v{major}.{minor}")
 121 |             
 122 |             return new_view
 123 | 
 124 |         except Exception as e:
 125 |             await db.rollback()
 126 |             raise e
 127 | 
 128 |     @staticmethod
 129 |     async def get_views(db: AsyncSession, engine: Optional[str] = None) -> List[ViewDefinition]:
 130 |         # Only return LATEST versions for the list
 131 |         query = select(ViewDefinition).where(ViewDefinition.is_latest == True)
 132 |         if engine:
 133 |             query = query.where(ViewDefinition.engine == engine)
 134 |         
 135 |         result = await db.execute(query.order_by(ViewDefinition.key))
 136 |         return result.scalars().all()
 137 | 
 138 |     # ==========================================================================
 139 |     #  2. BINDING MANAGEMENT (Association)
 140 |     # ==========================================================================
 141 | 
 142 |     @staticmethod
 143 |     async def create_binding(db: AsyncSession, payload: ViewBindingCreate) -> ViewBinding:
 144 |         view = await db.get(ViewDefinition, payload.view_id)
 145 |         if not view:
 146 |             raise ValueError(f"View ID {payload.view_id} not found.")
 147 | 
 148 |         data = payload.model_dump(mode='json')
 149 |         db_obj = ViewBinding(**data)
 150 |         db.add(db_obj)
 151 |         
 152 |         await db.commit()
 153 |         
 154 |         # ‚ö° FIX: Eager load the relationship
 155 |         stmt = select(ViewBinding).options(selectinload(ViewBinding.view)).where(ViewBinding.id == db_obj.id)
 156 |         result = await db.execute(stmt)
 157 |         return result.scalars().first()
 158 | 
 159 |     @staticmethod
 160 |     async def get_bindings(db: AsyncSession, domain: str, state: Optional[str] = None) -> List[ViewBinding]:
 161 |         """Retrieves all View Bindings for a given Domain."""
 162 |         stmt = select(ViewBinding).options(selectinload(ViewBinding.view))\
 163 |             .where(ViewBinding.target_domain == domain)
 164 | 
 165 |         if state:
 166 |             stmt = stmt.where(ViewBinding.target_state == state)
 167 |             
 168 |         stmt = stmt.order_by(desc(ViewBinding.priority), ViewBinding.target_state)
 169 |         result = await db.execute(stmt)
 170 |         return result.scalars().all()
 171 | 
 172 |     @staticmethod
 173 |     async def delete_binding(db: AsyncSession, binding_id: int) -> Optional[str]:
 174 |         """
 175 |         SMART UNBIND:
 176 |         1. If Active -> Set Inactive (Soft Delete / Safety Latch).
 177 |         2. If Inactive -> Hard Delete (Clean up).
 178 |         """
 179 |         query = select(ViewBinding).where(ViewBinding.id == binding_id)
 180 |         result = await db.execute(query)
 181 |         db_obj = result.scalars().first()
 182 | 
 183 |         if not db_obj:
 184 |             return None
 185 | 
 186 |         status_action = ""
 187 | 
 188 |         if db_obj.is_active:
 189 |             # PHASE 1: DEACTIVATE
 190 |             db_obj.is_active = False
 191 |             status_action = "DEACTIVATED"
 192 |             logger.info(f"üîå [ViewEngine] Binding #{binding_id} Deactivated (Safety Latch).")
 193 |         else:
 194 |             # PHASE 2: HARD DELETE
 195 |             await db.delete(db_obj)
 196 |             status_action = "DELETED"
 197 |             logger.info(f"üóëÔ∏è [ViewEngine] Binding #{binding_id} Permanently Removed.")
 198 | 
 199 |         await db.commit()
 200 |         return status_action
 201 | 
 202 |     # ==========================================================================
 203 |     #  3. THE RESOLUTION ALGORITHM (The Intelligence)
 204 |     # ==========================================================================
 205 | 
 206 |     @staticmethod
 207 |     async def resolve_view(
 208 |         db: AsyncSession, 
 209 |         domain: str, 
 210 |         state: Optional[str] = None, 
 211 |         role: Optional[str] = None
 212 |     ) -> Optional[ViewDefinition]:
 213 |         """Determines the BEST view for a given context using 'Weighted Specificity'."""
 214 |         logger.debug(f"üîç [ViewResolver] Resolving for Domain={domain}, State={state}, Role={role}")
 215 | 
 216 |         # 1. Fetch Candidates (All active bindings for this domain)
 217 |         stmt = select(ViewBinding).options(selectinload(ViewBinding.view))\
 218 |             .where(ViewBinding.target_domain == domain)\
 219 |             .where(ViewBinding.is_active == True)
 220 |             
 221 |         result = await db.execute(stmt)
 222 |         candidates = result.scalars().all()
 223 | 
 224 |         if not candidates:
 225 |             logger.warning(f"‚ö†Ô∏è [ViewResolver] No bindings found for {domain}")
 226 |             return None
 227 | 
 228 |         # 2. Score Candidates
 229 |         scored_candidates = []
 230 |         for binding in candidates:
 231 |             # Only consider bindings where the View itself is active
 232 |             if not binding.view or not binding.view.is_active:
 233 |                 continue
 234 | 
 235 |             score = 0
 236 |             # A. Role Check
 237 |             if binding.target_role:
 238 |                 if binding.target_role == role:
 239 |                     score += 1000
 240 |                 else:
 241 |                     continue
 242 |             else:
 243 |                 score += 1
 244 | 
 245 |             # B. State Check
 246 |             if binding.target_state:
 247 |                 if binding.target_state == state:
 248 |                     score += 100
 249 |                 else:
 250 |                     continue
 251 |             else:
 252 |                 score += 1 
 253 | 
 254 |             # C. Priority
 255 |             score += (binding.priority or 0)
 256 | 
 257 |             scored_candidates.append({"binding": binding, "score": score})
 258 | 
 259 |         if not scored_candidates:
 260 |             return None
 261 | 
 262 |         scored_candidates.sort(key=lambda x: x["score"], reverse=True)
 263 |         winner = scored_candidates[0]
 264 | 
 265 |         logger.info(f"‚úÖ [ViewResolver] Winner: {winner['binding'].view.key} (Score: {winner['score']})")
 266 |         return winner["binding"].view
 267 | 

================================================================================

# Source code from: backend\app\core\meta\features\widgets\models.py
----------------------------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/features/widgets/models.py
   2 | # @file: Widget Registry Models
   3 | # @author: The Engineer (ansav8@gmail.com)
   4 | # @description: Defines the "Legal Building Blocks" of the UI.
   5 | # @security-level: LEVEL 9 (Strict Schema)
   6 | # @invariant: Unique constraint on (key, version).
   7 | 
   8 | from sqlalchemy import Column, Integer, String, Boolean, DateTime, UniqueConstraint, text
   9 | from sqlalchemy.dialects.postgresql import JSONB
  10 | from sqlalchemy.sql import func
  11 | 
  12 | from app.core.database.base import Base
  13 | 
  14 | class WidgetDefinition(Base):
  15 |     """
  16 |     The 'App Store' entry for a UI Component.
  17 |     """
  18 |     __tablename__ = "meta_widget_definitions"
  19 | 
  20 |     id = Column(Integer, primary_key=True, index=True)
  21 |     
  22 |     # IDENTITY
  23 |     key = Column(String(100), nullable=False, index=True) # e.g., "SECURE_PASSWORD"
  24 |     name = Column(String(255), nullable=False)            # e.g., "Secure Password Input"
  25 |     description = Column(String(500), nullable=True)
  26 |     
  27 |     # CLASSIFICATION
  28 |     category = Column(String(50), default="INPUT", index=True) # INPUT, DISPLAY, CONTAINER
  29 |     icon = Column(String(50), nullable=True) # e.g., "antd:LockOutlined"
  30 |     
  31 |     # THE CONTRACT (JSON Schema)
  32 |     # Defines what 'config' props are valid for this widget.
  33 |     props_schema = Column(JSONB, nullable=False, server_default=text("'{}'::jsonb"))
  34 |     
  35 |     # THE SIGNALS
  36 |     # Defines what events this widget can emit (e.g. ["CHANGE", "BLUR", "GENERATE"])
  37 |     events = Column(JSONB, nullable=False, server_default=text("'[]'::jsonb"))
  38 | 
  39 |     # SEMVER (Ledger Strategy)
  40 |     version_major = Column(Integer, default=1, nullable=False)
  41 |     version_minor = Column(Integer, default=0, nullable=False)
  42 |     version_patch = Column(Integer, default=0, nullable=False)
  43 |     
  44 |     is_latest = Column(Boolean, default=True, index=True)
  45 |     is_active = Column(Boolean, default=True)
  46 |     
  47 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
  48 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now())
  49 | 
  50 |     __table_args__ = (
  51 |         UniqueConstraint('key', 'version_major', 'version_minor', 'version_patch', name='uq_widget_key_version'),
  52 |     )
  53 | 
  54 |     @property
  55 |     def version(self) -> str:
  56 |         return f"{self.version_major}.{self.version_minor}.{self.version_patch}"
  57 | 
  58 |     def __repr__(self):
  59 |         return f"<WidgetDef(key='{self.key}', v={self.version})>"
  60 | 

================================================================================

# Source code from: backend\app\core\meta\models.py
-----------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/models.py
   2 | # @file: Meta-Kernel Database Models (The Legislature)
   3 | # @author: The Engineer (ansav8@gmail.com)
   4 | # @description: Defines the Schema for Definitions (Classes) and Policies (Logic).
   5 | # @security-level: LEVEL 9 (Strict Schema)
   6 | # @invariant: Unique Constraints must enforce Version Integrity.
   7 | # @updated: Added 'WorkflowType' to Fractal Imports.
   8 | 
   9 | from sqlalchemy import Column, Integer, String, Boolean, DateTime, Index, text, ForeignKey, UniqueConstraint, CheckConstraint
  10 | from sqlalchemy.dialects.postgresql import JSONB
  11 | from sqlalchemy.sql import func
  12 | from sqlalchemy.orm import relationship
  13 | 
  14 | from app.core.database.base import Base
  15 | from app.core.meta.constants import AttributeType, WidgetType, RuleEventType, PolicyResolutionStrategy, ViewEngineType, ScopeType, BindingType
  16 | 
  17 | # ‚ö° FRACTAL IMPORTS (The Bridge)
  18 | # We import new Feature Models here so Alembic and the App can find them via 'app.core.meta.models'
  19 | from app.core.meta.features.widgets.models import WidgetDefinition
  20 | from app.core.meta.features.states.models import WorkflowType # ‚ö° NEW: State Engine v3
  21 | 
  22 | # ==============================================================================
  23 | #  1. ATTRIBUTE DEFINITION (The Data Shape)
  24 | # ==============================================================================
  25 | class AttributeDefinition(Base):
  26 |     __tablename__ = "meta_attribute_definitions"
  27 | 
  28 |     id = Column(Integer, primary_key=True, index=True)
  29 |     domain = Column(String(50), nullable=False, index=True)
  30 |     key = Column(String(100), nullable=False, index=True)
  31 |     label = Column(String(255), nullable=False)
  32 |     description = Column(String(500), nullable=True)
  33 |     
  34 |     data_type = Column(String(50), nullable=False, default=AttributeType.TEXT)
  35 |     widget_type = Column(String(50), nullable=False, default=WidgetType.INPUT)
  36 |     
  37 |     is_required = Column(Boolean, default=False)
  38 |     is_unique = Column(Boolean, default=False) 
  39 |     is_system = Column(Boolean, default=False) 
  40 |     is_active = Column(Boolean, default=True)  
  41 |     
  42 |     configuration = Column(JSONB, nullable=False, server_default=text("'{}'::jsonb"))
  43 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
  44 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now())
  45 | 
  46 |     __table_args__ = (
  47 |         Index('idx_meta_attr_domain_key', 'domain', 'key', unique=True),
  48 |         Index('idx_meta_attr_domain_active', 'domain', 'is_active'),
  49 |     )
  50 | 
  51 |     def __repr__(self):
  52 |         return f"<AttributeDef(domain={self.domain}, key={self.key}, type={self.data_type})>"
  53 | 
  54 | 
  55 | # ==============================================================================
  56 | #  2. POLICY ENGINE (The Law)
  57 | # ==============================================================================
  58 | class PolicyDefinition(Base):
  59 |     __tablename__ = "meta_policy_definitions"
  60 | 
  61 |     id = Column(Integer, primary_key=True, index=True)
  62 |     
  63 |     # IDENTITY
  64 |     key = Column(String(100), nullable=False, index=True) 
  65 |     name = Column(String(255), nullable=False)
  66 |     description = Column(String(500), nullable=True)
  67 |     
  68 |     # GOVERNANCE
  69 |     resolution = Column(String(50), default=PolicyResolutionStrategy.ALL_MUST_PASS)
  70 |     rules = Column(JSONB, nullable=False, server_default=text("'[]'::jsonb"))
  71 |     
  72 |     # METADATA
  73 |     tags = Column(JSONB, nullable=False, server_default=text("'[]'::jsonb"), index=True)
  74 | 
  75 |     # LEDGER METADATA (SemVer)
  76 |     version_major = Column(Integer, default=1, nullable=False, server_default=text("1"))
  77 |     version_minor = Column(Integer, default=0, nullable=False, server_default=text("0"))
  78 |     version_patch = Column(Integer, default=0, nullable=False, server_default=text("0"))
  79 |     
  80 |     is_latest = Column(Boolean, default=True, index=True) 
  81 |     is_active = Column(Boolean, default=True)
  82 |     
  83 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
  84 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now())
  85 | 
  86 |     __table_args__ = (
  87 |         UniqueConstraint('key', 'version_major', 'version_minor', 'version_patch', name='uq_policy_key_version_full'),
  88 |     )
  89 | 
  90 |     @property
  91 |     def version_display(self):
  92 |         return f"{self.version_major}.{self.version_minor}.{self.version_patch}"
  93 | 
  94 | 
  95 | class PolicyGroup(Base):
  96 |     """
  97 |     ‚ö° ENTERPRISE FEATURE: Explicit Policy Grouping.
  98 |     """
  99 |     __tablename__ = "meta_policy_groups"
 100 | 
 101 |     id = Column(Integer, primary_key=True, index=True)
 102 |     
 103 |     key = Column(String(100), nullable=False, unique=True, index=True)
 104 |     name = Column(String(255), nullable=False)
 105 |     description = Column(String(500), nullable=True)
 106 |     
 107 |     # Stores ordered list of Policy Keys: ["SECURITY_V1", "LOGGING_V2"]
 108 |     policy_keys = Column(JSONB, nullable=False, server_default=text("'[]'::jsonb"))
 109 |     
 110 |     is_active = Column(Boolean, default=True)
 111 |     
 112 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
 113 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now())
 114 | 
 115 | 
 116 | class PolicyBinding(Base):
 117 |     """
 118 |     The Switchboard. Connects a Policy OR a Group to a Context.
 119 |     """
 120 |     __tablename__ = "meta_policy_bindings"
 121 | 
 122 |     id = Column(Integer, primary_key=True, index=True)
 123 |     
 124 |     # ‚ö° The Discriminator
 125 |     binding_type = Column(String(20), default=BindingType.ENTITY, nullable=False, index=True)
 126 | 
 127 |     # ‚ö° STRICT SOURCE POLYMORPHISM
 128 |     policy_id = Column(Integer, ForeignKey("meta_policy_definitions.id"), nullable=True)
 129 |     policy_group_id = Column(Integer, ForeignKey("meta_policy_groups.id"), nullable=True)
 130 | 
 131 |     # TARGET POLYMORPHISM
 132 |     target_domain = Column(String(50), nullable=False, index=True)
 133 |     target_scope = Column(String(50), default=ScopeType.DOMAIN)
 134 |     target_context = Column(String(100), nullable=True)
 135 | 
 136 |     priority = Column(Integer, default=0)
 137 |     is_active = Column(Boolean, default=True)
 138 | 
 139 |     policy = relationship("PolicyDefinition")
 140 |     group = relationship("PolicyGroup")
 141 | 
 142 |     __table_args__ = (
 143 |         Index('idx_policy_binding_target', 'target_domain', 'target_scope', 'target_context'),
 144 |         CheckConstraint(
 145 |             '(policy_id IS NOT NULL) OR (policy_group_id IS NOT NULL)',
 146 |             name='check_binding_source'
 147 |         ),
 148 |     )
 149 | 
 150 | 
 151 | # ==============================================================================
 152 | #  3. STATE KERNEL (Process Flows)
 153 | # ==============================================================================
 154 | class StateDefinition(Base):
 155 |     __tablename__ = "meta_state_definitions"
 156 | 
 157 |     id = Column(Integer, primary_key=True, index=True)
 158 |     entity_key = Column(String(50), nullable=False)
 159 |     scope = Column(String(50), nullable=False, default="LIFECYCLE")
 160 | 
 161 |     # The Composite Column Target
 162 |     governed_field = Column(String(50), nullable=False, default="status", server_default="status", index=True)
 163 |     
 164 |     name = Column(String(255), nullable=True)
 165 |     initial_state = Column(String(50), nullable=False, default="DRAFT")
 166 |     transitions = Column(JSONB, nullable=False, server_default=text("'{}'::jsonb"))
 167 | 
 168 |     # ‚ö° SEMVER UPGRADE (Option B Implementation)
 169 |     version_major = Column(Integer, default=1, nullable=False, server_default=text("1"))
 170 |     version_minor = Column(Integer, default=0, nullable=False, server_default=text("0"))
 171 |     version_patch = Column(Integer, default=0, nullable=False, server_default=text("0"))
 172 |     
 173 |     # Legacy Support (Computed or Deprecated)
 174 |     # For Level 9 strictness, we prefer the new columns but will map 'version' to 'version_patch' in logic if needed.
 175 |     version = Column(Integer, nullable=True, default=1) # Deprecated but kept for safety
 176 | 
 177 |     is_active = Column(Boolean, default=True)
 178 |     
 179 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
 180 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now())
 181 | 
 182 |     __table_args__ = (
 183 |         # ‚ö° UPDATED CONSTRAINT: Include Patch in Uniqueness
 184 |         UniqueConstraint('entity_key', 'scope', 'version_major', 'version_minor', 'version_patch', name='uq_state_entity_scope_semver'),
 185 |     )
 186 | 
 187 |     @property
 188 |     def version_display(self):
 189 |         return f"{self.version_major}.{self.version_minor}.{self.version_patch}"
 190 | 
 191 | 
 192 | # ==============================================================================
 193 | #  4. VIEW ENGINE (Interfaces)
 194 | # ==============================================================================
 195 | class ViewDefinition(Base):
 196 |     __tablename__ = "meta_view_definitions"
 197 | 
 198 |     id = Column(Integer, primary_key=True, index=True)
 199 |     key = Column(String(100), nullable=False, index=True)
 200 |     name = Column(String(255), nullable=False)
 201 |     engine = Column(String(50), default=ViewEngineType.FORM_IO)
 202 |     schema = Column(JSONB, nullable=False, server_default=text("'{}'::jsonb"))
 203 |     
 204 |     # SemVer
 205 |     version_major = Column(Integer, default=1, nullable=False, server_default=text("1"))
 206 |     version_minor = Column(Integer, default=0, nullable=False, server_default=text("0"))
 207 |     version_patch = Column(Integer, default=0, nullable=False, server_default=text("0"))
 208 |     
 209 |     is_latest = Column(Boolean, default=True, index=True, server_default=text("true")) 
 210 |     is_active = Column(Boolean, default=True)
 211 |     
 212 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
 213 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now())
 214 | 
 215 |     __table_args__ = (
 216 |         UniqueConstraint('key', 'version_major', 'version_minor', 'version_patch', name='uq_view_key_version_full'),
 217 |     )
 218 | 
 219 | class ViewBinding(Base):
 220 |     __tablename__ = "meta_view_bindings"
 221 | 
 222 |     id = Column(Integer, primary_key=True, index=True)
 223 |     view_id = Column(Integer, ForeignKey("meta_view_definitions.id"), nullable=False)
 224 |     
 225 |     target_domain = Column(String(50), nullable=False)
 226 |     target_state = Column(String(50), nullable=True)
 227 |     target_role = Column(String(50), nullable=True)
 228 |     
 229 |     priority = Column(Integer, default=0)
 230 |     is_active = Column(Boolean, default=True)
 231 | 
 232 |     view = relationship("ViewDefinition")
 233 |     
 234 |     __table_args__ = (
 235 |         Index('idx_view_binding_lookup', 'target_domain', 'target_state', 'target_role'),
 236 |     )
 237 | 
 238 | class RuleDefinition(Base):
 239 |     __tablename__ = "meta_rule_definitions"
 240 | 
 241 |     id = Column(Integer, primary_key=True, index=True)
 242 |     target_domain = Column(String(50), nullable=False, index=True)
 243 |     scope = Column(String(50), nullable=True, index=True) 
 244 |     
 245 |     name = Column(String(100), nullable=False)
 246 |     description = Column(String(255), nullable=True)
 247 |     event_type = Column(String(50), default=RuleEventType.SAVE, index=True)
 248 | 
 249 |     logic = Column(JSONB, nullable=False) 
 250 |     effect = Column(JSONB, nullable=False)
 251 |     
 252 |     priority = Column(Integer, default=0)
 253 |     is_active = Column(Boolean, default=True)
 254 |     
 255 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
 256 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now())
 257 | 

================================================================================

# Source code from: backend\app\core\meta\registry.py
-------------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/registry.py
   2 | # @file: Meta-Kernel Registry
   3 | # @author: The Engineer (ansav8@gmail.com)
   4 | # @description: Registers the Meta-Kernel as a 'CORE' domain.
   5 | # This allows Policies, Views, and Rules to participate in the Event System (CDC).
   6 | # @security-level: LEVEL 9 (Core Infrastructure)
   7 | 
   8 | from app.core.kernel.registry import domain_registry, DomainContext
   9 | from app.core.kernel.registry.base import DomainType
  10 | from app.core.meta.models import PolicyDefinition
  11 | 
  12 | # ‚ö° THE META DOMAIN
  13 | # Acts as the "Hub" for all structural definitions.
  14 | # We map multiple models (Policy, View, Widget) to this single Domain Key.
  15 | meta_domain = DomainContext(
  16 |     domain_key="META",
  17 |     friendly_name="Meta Kernel",
  18 |     
  19 |     # ‚ö° CORE TYPE: Writable (CRUD) but Immutable Structure (No Custom Attributes)
  20 |     domain_type=DomainType.CORE,
  21 |     
  22 |     # Topology
  23 |     system_module="SYSTEM",
  24 |     module_label="System Core",
  25 |     module_icon="antd:AppstoreAddOutlined",
  26 |     
  27 |     # Anchor Model (Conceptually the primary entity, though Interceptor handles others)
  28 |     model_class=PolicyDefinition,
  29 |     
  30 |     # Providers (Standard/Empty for Core infra)
  31 |     schema_provider=lambda d: {},
  32 |     context_loader=lambda id, ctx: {"context": "meta_kernel"},
  33 |     
  34 |     supports_meta=False, # ‚ö° CRITICAL: Prevents "Meta-on-Meta" recursion
  35 |     is_active=True
  36 | )
  37 | 
  38 | # Register immediately
  39 | domain_registry.register(meta_domain)
  40 | 

================================================================================

# Source code from: backend\app\core\meta\schemas.py
------------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/schemas.py
   2 | # @file Meta-Kernel Contracts
   3 | # @author The Engineer (ansav8@gmail.com)
   4 | # @description Pydantic Schemas for the Adaptive Data Engine.
   5 | #              UPDATED: Removed 'policy_tag' support from Binding.
   6 | 
   7 | from typing import Optional, List, Dict, Any, Union
   8 | from datetime import datetime
   9 | from pydantic import BaseModel, Field, field_validator, model_validator, ConfigDict, computed_field
  10 | import re
  11 | 
  12 | from app.core.meta.constants import (
  13 |     AttributeType, WidgetType, RuleEventType, RuleActionType,
  14 |     PolicyResolutionStrategy, ViewEngineType, ScopeType, BindingType
  15 | )
  16 | 
  17 | # ... [Attribute Schemas Omitted - Same as Previous] ...
  18 | # (Assuming AttributeBase and related classes are unchanged)
  19 | class SelectOption(BaseModel):
  20 |     label: str
  21 |     value: str
  22 |     color: Optional[str] = None
  23 |     is_active: bool = True
  24 | 
  25 | class AttributeConfig(BaseModel):
  26 |     model_config = ConfigDict(extra='allow')
  27 |     min_length: Optional[int] = None
  28 |     max_length: Optional[int] = None
  29 |     regex_pattern: Optional[str] = None
  30 |     min: Optional[float] = None
  31 |     max: Optional[float] = None
  32 |     step: Optional[float] = None
  33 |     precision: Optional[int] = None
  34 |     currency_symbol: Optional[str] = None
  35 |     min_date: Optional[str] = None
  36 |     max_date: Optional[str] = None
  37 |     date_format: Optional[str] = None
  38 |     placeholder: Optional[str] = None
  39 |     rows: Optional[int] = None
  40 |     read_only: Optional[bool] = None
  41 |     options: Optional[List[SelectOption]] = None
  42 |     target_domain: Optional[str] = None
  43 |     allowed_extensions: Optional[List[str]] = None
  44 |     json_schema: Optional[Dict[str, Any]] = None
  45 |     default_value: Optional[Any] = None
  46 |     help_text: Optional[str] = None
  47 | 
  48 | class AttributeBase(BaseModel):
  49 |     domain: str
  50 |     key: str
  51 |     label: str
  52 |     description: Optional[str] = None
  53 |     data_type: AttributeType = AttributeType.TEXT
  54 |     widget_type: WidgetType = WidgetType.INPUT
  55 |     is_required: bool = False
  56 |     is_unique: bool = False
  57 |     is_system: bool = False
  58 |     is_active: bool = False
  59 |     configuration: AttributeConfig = Field(default_factory=AttributeConfig)
  60 | 
  61 | class AttributeCreate(AttributeBase): pass
  62 | class AttributeUpdate(BaseModel):
  63 |     label: Optional[str] = None
  64 |     description: Optional[str] = None
  65 |     widget_type: Optional[WidgetType] = None
  66 |     is_required: Optional[bool] = None
  67 |     is_active: Optional[bool] = None
  68 |     configuration: Optional[AttributeConfig] = None
  69 | class AttributeRead(AttributeBase):
  70 |     id: int
  71 |     created_at: datetime
  72 |     updated_at: Optional[datetime]
  73 |     class Config: from_attributes = True
  74 | 
  75 | # ==============================================================================
  76 | #  2. POLICY SCHEMAS
  77 | # ==============================================================================
  78 | 
  79 | class PolicyRule(BaseModel):
  80 |     logic: str
  81 |     action: RuleActionType = RuleActionType.BLOCK
  82 |     message: str = "Policy Violation"
  83 |     target: Optional[str] = None
  84 |     value: Optional[Any] = None
  85 | 
  86 | class PolicyBase(BaseModel):
  87 |     key: str
  88 |     name: str
  89 |     description: Optional[str] = None
  90 |     resolution: PolicyResolutionStrategy = PolicyResolutionStrategy.ALL_MUST_PASS
  91 |     rules: List[PolicyRule]
  92 |     tags: List[str] = []
  93 |     is_active: bool = True
  94 | 
  95 | class PolicyCreate(PolicyBase): pass
  96 | class PolicyUpdate(BaseModel):
  97 |     name: Optional[str] = None
  98 |     description: Optional[str] = None
  99 |     resolution: Optional[PolicyResolutionStrategy] = None
 100 |     rules: Optional[List[PolicyRule]] = None
 101 |     tags: Optional[List[str]] = None
 102 |     is_active: Optional[bool] = None
 103 | 
 104 | class PolicyRead(PolicyBase):
 105 |     id: int
 106 |     version_major: int
 107 |     version_minor: int
 108 |     is_latest: bool
 109 |     created_at: datetime
 110 |     updated_at: Optional[datetime]
 111 |     @computed_field
 112 |     @property
 113 |     def version_display(self) -> str:
 114 |         return f"{self.version_major}.{self.version_minor:02d}"
 115 |     class Config: from_attributes = True
 116 | 
 117 | # ==============================================================================
 118 | #  3. POLICY GROUPS (Enterprise)
 119 | # ==============================================================================
 120 | 
 121 | class PolicyGroupBase(BaseModel):
 122 |     key: str
 123 |     name: str
 124 |     description: Optional[str] = None
 125 |     policy_keys: List[str] = []
 126 |     is_active: bool = True
 127 |     
 128 |     @field_validator('key')
 129 |     @classmethod
 130 |     def validate_key(cls, v: str) -> str:
 131 |         if not re.match(r'^[A-Z0-9_]+$', v):
 132 |             raise ValueError("Group Key must be UPPERCASE_WITH_UNDERSCORES")
 133 |         return v
 134 | 
 135 | class PolicyGroupCreate(PolicyGroupBase): pass
 136 | class PolicyGroupUpdate(BaseModel):
 137 |     name: Optional[str] = None
 138 |     description: Optional[str] = None
 139 |     policy_keys: Optional[List[str]] = None
 140 |     is_active: Optional[bool] = None
 141 | 
 142 | class PolicyGroupRead(PolicyGroupBase):
 143 |     id: int
 144 |     created_at: datetime
 145 |     updated_at: Optional[datetime]
 146 |     class Config: from_attributes = True
 147 | 
 148 | # ==============================================================================
 149 | #  4. BINDINGS (The Jurisdiction)
 150 | # ==============================================================================
 151 | 
 152 | class PolicyBindingBase(BaseModel):
 153 |     policy_id: Optional[int] = None
 154 |     policy_group_id: Optional[int] = None
 155 |     
 156 |     binding_type: BindingType = BindingType.ENTITY
 157 |     target_domain: str
 158 |     target_scope: ScopeType = ScopeType.DOMAIN
 159 |     target_context: Optional[str] = None
 160 |     priority: int = 0
 161 |     is_active: bool = True
 162 | 
 163 |     @model_validator(mode='after')
 164 |     def check_source(self):
 165 |         if not self.policy_id and not self.policy_group_id:
 166 |             raise ValueError("Must provide either 'policy_id' OR 'policy_group_id'.")
 167 |         return self
 168 | 
 169 | class PolicyBindingCreate(PolicyBindingBase): pass
 170 | class PolicyBindingUpdate(BaseModel):
 171 |     priority: Optional[int] = None
 172 |     is_active: Optional[bool] = None
 173 | 
 174 | class PolicyBindingRead(PolicyBindingBase):
 175 |     id: int
 176 |     policy: Optional[PolicyRead] = None
 177 |     group: Optional[PolicyGroupRead] = None
 178 |     class Config: from_attributes = True
 179 | 
 180 | # ... [Rule/DryRun Schemas Preserved] ...
 181 | class RuleEffect(BaseModel):
 182 |     type: RuleActionType
 183 |     message: Optional[str] = None
 184 |     target: Optional[str] = None
 185 |     value: Optional[Any] = None
 186 | 
 187 | class RuleCreate(BaseModel):
 188 |     target_domain: str
 189 |     scope: Optional[str] = None
 190 |     name: str
 191 |     description: Optional[str] = None
 192 |     event_type: RuleEventType = RuleEventType.SAVE
 193 |     logic: Dict[str, Any]
 194 |     effect: RuleEffect
 195 |     priority: int = 0
 196 |     is_active: bool = True
 197 | 
 198 | class RuleRead(RuleCreate):
 199 |     id: int
 200 |     created_at: datetime
 201 |     updated_at: Optional[datetime]
 202 |     class Config: from_attributes = True
 203 | 
 204 | class DryRunRequest(BaseModel):
 205 |     policy: PolicyBase
 206 |     context: Dict[str, Any] = Field(default_factory=dict)
 207 | 
 208 | class DryRunResult(BaseModel):
 209 |     is_valid: bool
 210 |     blocking_errors: List[str] = []
 211 |     warnings: List[str] = []
 212 |     mutations: List[Dict[str, Any]] = []
 213 |     side_effects: List[Dict[str, Any]] = []
 214 | 

================================================================================

# Source code from: backend\app\core\meta\service.py
------------------------------------------------------
   1 | # FILEPATH: backend/app/core/meta/service.py
   2 | # @file: Meta-Kernel Service (The Librarian)
   3 | # @author: The Engineer (ansav8@gmail.com)
   4 | # @description: Orchestrates the Lifecycle of Definitions.
   5 | # @security-level: LEVEL 9 (Safety Interlocks)
   6 | # @updated: Added Tag-Driven Filtering to `get_policies`.
   7 | 
   8 | import logging
   9 | import jmespath
  10 | from typing import List, Optional, Dict, Any
  11 | 
  12 | from sqlalchemy import select, delete, or_, desc, update
  13 | from sqlalchemy.ext.asyncio import AsyncSession
  14 | from sqlalchemy.orm import selectinload
  15 | 
  16 | # ‚ö° CORE MODELS
  17 | from app.core.meta.models import (
  18 |     AttributeDefinition, 
  19 |     RuleDefinition, 
  20 |     PolicyDefinition, 
  21 |     PolicyGroup, 
  22 |     PolicyBinding
  23 | )
  24 | from app.core.meta.schemas import (
  25 |     AttributeCreate, AttributeUpdate, RuleCreate,
  26 |     PolicyCreate, PolicyUpdate, 
  27 |     PolicyGroupCreate, PolicyGroupUpdate, 
  28 |     PolicyBindingCreate, PolicyBindingUpdate
  29 | )
  30 | from app.core.meta.constants import ScopeType
  31 | from app.core.meta.engine import policy_engine
  32 | from app.core.kernel.registry import domain_registry 
  33 | 
  34 | # ‚ö° SYSTEM MODELS
  35 | from app.domains.system.models import KernelDomain
  36 | 
  37 | logger = logging.getLogger("core.meta.service")
  38 | 
  39 | class MetaService:
  40 |     
  41 |     @staticmethod
  42 |     def validate_rule_syntax(rules: List[Dict[str, Any]]):
  43 |         for i, rule in enumerate(rules):
  44 |             logic = rule.get("logic", "")
  45 |             if not logic: continue 
  46 |             try:
  47 |                 jmespath.compile(logic)
  48 |             except Exception as e:
  49 |                 raise ValueError(f"Rule #{i+1} has invalid syntax: {logic}. Error: {str(e)}")
  50 | 
  51 |     # ==============================================================================
  52 |     #  1. POLICY DEFINITIONS
  53 |     # ==============================================================================
  54 | 
  55 |     @staticmethod
  56 |     async def create_policy(db: AsyncSession, payload: PolicyCreate) -> PolicyDefinition:
  57 |         query = select(PolicyDefinition).where(
  58 |             PolicyDefinition.key == payload.key,
  59 |             PolicyDefinition.is_latest == True
  60 |         )
  61 |         result = await db.execute(query)
  62 |         if result.scalars().first():
  63 |             raise ValueError(f"Policy with key '{payload.key}' already exists.")
  64 | 
  65 |         rules_data = [r.model_dump(mode='json') for r in payload.rules]
  66 |         MetaService.validate_rule_syntax(rules_data)
  67 | 
  68 |         db_obj = PolicyDefinition(
  69 |             key=payload.key,
  70 |             name=payload.name,
  71 |             description=payload.description,
  72 |             resolution=payload.resolution,
  73 |             rules=rules_data,
  74 |             tags=payload.tags, 
  75 |             is_active=payload.is_active,
  76 |             version_major=1,
  77 |             version_minor=0,
  78 |             is_latest=True
  79 |         )
  80 |         db.add(db_obj)
  81 |         await db.commit()
  82 |         await db.refresh(db_obj)
  83 |         return db_obj
  84 | 
  85 |     @staticmethod
  86 |     async def update_policy(db: AsyncSession, id: int, payload: PolicyUpdate) -> Optional[PolicyDefinition]:
  87 |         parent_policy = await db.get(PolicyDefinition, id)
  88 |         if not parent_policy: return None
  89 | 
  90 |         new_major = parent_policy.version_major
  91 |         new_minor = parent_policy.version_minor + 1
  92 |         
  93 |         if new_minor >= 100:
  94 |             new_major += 1
  95 |             new_minor = 0
  96 | 
  97 |         update_data = payload.model_dump(exclude_unset=True, mode='json')
  98 |         if "rules" in update_data:
  99 |             MetaService.validate_rule_syntax(update_data["rules"])
 100 | 
 101 |         new_policy = PolicyDefinition(
 102 |             key=parent_policy.key,
 103 |             name=update_data.get("name", parent_policy.name),
 104 |             description=update_data.get("description", parent_policy.description),
 105 |             resolution=update_data.get("resolution", parent_policy.resolution),
 106 |             rules=update_data.get("rules", parent_policy.rules),
 107 |             tags=update_data.get("tags", parent_policy.tags),
 108 |             is_active=update_data.get("is_active", parent_policy.is_active),
 109 |             version_major=new_major,
 110 |             version_minor=new_minor,
 111 |             is_latest=True
 112 |         )
 113 | 
 114 |         try:
 115 |             db.add(new_policy)
 116 |             await db.flush() 
 117 | 
 118 |             parent_policy.is_latest = False
 119 | 
 120 |             stmt_promote = update(PolicyBinding).\
 121 |                 where(PolicyBinding.policy_id == parent_policy.id).\
 122 |                 values(policy_id=new_policy.id)
 123 |             
 124 |             await db.execute(stmt_promote)
 125 |             
 126 |             await db.commit()
 127 |             await db.refresh(new_policy)
 128 |             await MetaService.invalidate_cache("ALL") 
 129 |             return new_policy
 130 |         except Exception as e:
 131 |             await db.rollback()
 132 |             raise e
 133 | 
 134 |     @staticmethod
 135 |     def dry_run_policy(policy_data: Dict[str, Any], context: Dict[str, Any]) -> Dict[str, Any]:
 136 |         temp_policy = PolicyDefinition(
 137 |             key="dry_run_temp",
 138 |             rules=policy_data.get("rules", []),
 139 |             is_active=True
 140 |         )
 141 |         result = policy_engine.evaluate(entity={}, policies=[temp_policy], context_override=context)
 142 |         return {
 143 |             "is_valid": result.is_valid,
 144 |             "blocking_errors": result.blocking_errors,
 145 |             "warnings": result.warnings,
 146 |             "mutations": result.mutations,
 147 |             "side_effects": result.side_effects
 148 |         }
 149 | 
 150 |     @staticmethod
 151 |     async def get_policy_history(db: AsyncSession, key: str) -> List[PolicyDefinition]:
 152 |         stmt = select(PolicyDefinition).where(
 153 |             PolicyDefinition.key == key
 154 |         ).order_by(
 155 |             desc(PolicyDefinition.version_major), 
 156 |             desc(PolicyDefinition.version_minor)
 157 |         )
 158 |         result = await db.execute(stmt)
 159 |         return result.scalars().all()
 160 | 
 161 |     @staticmethod
 162 |     async def restore_policy(db: AsyncSession, version_id: int) -> Optional[PolicyDefinition]:
 163 |         target_version = await db.get(PolicyDefinition, version_id)
 164 |         if not target_version: return None
 165 | 
 166 |         stmt_head = select(PolicyDefinition).where(
 167 |             PolicyDefinition.key == target_version.key,
 168 |             PolicyDefinition.is_latest == True
 169 |         )
 170 |         result = await db.execute(stmt_head)
 171 |         current_head = result.scalars().first()
 172 | 
 173 |         if not current_head:
 174 |             raise ValueError("Corrupt Timeline: No active head found for this policy.")
 175 | 
 176 |         restore_payload = PolicyUpdate(
 177 |             name=target_version.name,
 178 |             description=f"Restored from v{target_version.version_major}.{target_version.version_minor:02d}. {target_version.description}",
 179 |             resolution=target_version.resolution,
 180 |             rules=target_version.rules, 
 181 |             tags=target_version.tags,
 182 |             is_active=True
 183 |         )
 184 | 
 185 |         return await MetaService.update_policy(db, current_head.id, restore_payload)
 186 | 
 187 |     @staticmethod
 188 |     async def get_policies(db: AsyncSession, domain: Optional[str] = None) -> List[PolicyDefinition]:
 189 |         """
 190 |         ‚ö° TAG-DRIVEN ARCHITECTURE: Filters policies by their domain tag.
 191 |         """
 192 |         query = select(PolicyDefinition).where(PolicyDefinition.is_latest == True)
 193 |         
 194 |         if domain and domain != "ALL":
 195 |             # JSONB contains check: tags @> '["domain:XYZ"]'
 196 |             query = query.where(PolicyDefinition.tags.contains([f"domain:{domain}"]))
 197 |             
 198 |         query = query.order_by(PolicyDefinition.key)
 199 |         result = await db.execute(query)
 200 |         return result.scalars().all()
 201 | 
 202 |     # ==============================================================================
 203 |     #  2. BINDINGS (SWITCHBOARD)
 204 |     # ==============================================================================
 205 |     
 206 |     @staticmethod
 207 |     async def create_binding(db: AsyncSession, payload: PolicyBindingCreate) -> PolicyBinding:
 208 |         if payload.policy_id:
 209 |             policy = await db.get(PolicyDefinition, payload.policy_id)
 210 |             if not policy: raise ValueError("Policy ID not found.")
 211 |         
 212 |         if payload.policy_group_id:
 213 |              group = await db.get(PolicyGroup, payload.policy_group_id)
 214 |              if not group: raise ValueError("Group ID not found.")
 215 | 
 216 |         binding_data = payload.model_dump(mode='json')
 217 |         db_obj = PolicyBinding(**binding_data)
 218 |         db.add(db_obj)
 219 |         try:
 220 |             await db.commit()
 221 |             
 222 |             stmt = select(PolicyBinding)\
 223 |                 .options(selectinload(PolicyBinding.policy))\
 224 |                 .options(selectinload(PolicyBinding.group))\
 225 |                 .where(PolicyBinding.id == db_obj.id)
 226 |                 
 227 |             result = await db.execute(stmt)
 228 |             loaded_obj = result.scalars().first()
 229 |             
 230 |             await MetaService.invalidate_cache(payload.target_domain)
 231 |             return loaded_obj
 232 | 
 233 |         except Exception as e:
 234 |             await db.rollback()
 235 |             raise e
 236 | 
 237 |     @staticmethod
 238 |     async def update_binding(db: AsyncSession, binding_id: int, payload: PolicyBindingUpdate) -> Optional[PolicyBinding]:
 239 |         query = select(PolicyBinding).where(PolicyBinding.id == binding_id)
 240 |         result = await db.execute(query)
 241 |         db_obj = result.scalars().first()
 242 |         if not db_obj: return None
 243 | 
 244 |         update_data = payload.model_dump(exclude_unset=True, mode='json')
 245 |         for field, value in update_data.items(): setattr(db_obj, field, value)
 246 |         await db.commit()
 247 |         
 248 |         query = select(PolicyBinding)\
 249 |             .options(selectinload(PolicyBinding.policy))\
 250 |             .options(selectinload(PolicyBinding.group))\
 251 |             .where(PolicyBinding.id == binding_id)
 252 |             
 253 |         result = await db.execute(query)
 254 |         loaded_obj = result.scalars().first()
 255 |         
 256 |         await MetaService.invalidate_cache(db_obj.target_domain)
 257 |         return loaded_obj
 258 | 
 259 |     @staticmethod
 260 |     async def delete_binding(db: AsyncSession, binding_id: int) -> Optional[str]:
 261 |         query = select(PolicyBinding).where(PolicyBinding.id == binding_id)
 262 |         result = await db.execute(query)
 263 |         db_obj = result.scalars().first()
 264 |         if not db_obj: return None
 265 | 
 266 |         status_action = ""
 267 |         if db_obj.is_active:
 268 |             db_obj.is_active = False
 269 |             status_action = "DEACTIVATED"
 270 |         else:
 271 |             await db.delete(db_obj)
 272 |             status_action = "DELETED"
 273 |         await db.commit()
 274 |         await MetaService.invalidate_cache(db_obj.target_domain)
 275 |         return status_action
 276 | 
 277 |     @staticmethod
 278 |     async def get_bindings(db: AsyncSession, domain: Optional[str] = None, scope: Optional[str] = None, search: Optional[str] = None) -> List[PolicyBinding]:
 279 |         stmt = select(PolicyBinding)\
 280 |             .options(selectinload(PolicyBinding.policy))\
 281 |             .options(selectinload(PolicyBinding.group))
 282 |         
 283 |         if domain and domain != "ALL": 
 284 |             stmt = stmt.where(PolicyBinding.target_domain == domain)
 285 |         if scope and scope != "ALL": 
 286 |             stmt = stmt.where(PolicyBinding.target_scope == scope)
 287 |             
 288 |         if search:
 289 |             stmt = stmt.join(PolicyDefinition, isouter=True) 
 290 |             stmt = stmt.where(PolicyDefinition.name.ilike(f"%{search}%"))
 291 |             
 292 |         result = await db.execute(stmt.order_by(desc(PolicyBinding.priority)))
 293 |         return result.scalars().all()
 294 | 
 295 |     # ==============================================================================
 296 |     #  3. ATTRIBUTES (DICTIONARY)
 297 |     # ==============================================================================
 298 |     
 299 |     @staticmethod
 300 |     async def create_attribute(db: AsyncSession, payload: AttributeCreate) -> AttributeDefinition:
 301 |         domain_query = select(KernelDomain).options(selectinload(KernelDomain.type_def)).where(KernelDomain.key == payload.domain)
 302 |         domain_result = await db.execute(domain_query)
 303 |         domain_obj = domain_result.scalars().first()
 304 | 
 305 |         if domain_obj:
 306 |             props = domain_obj.type_def.properties if domain_obj.type_def and domain_obj.type_def.properties else {}
 307 |             if not props.get("supports_meta", True): 
 308 |                  logger.warning(f"‚õî [Meta] Blocked attribute creation on locked domain: {payload.domain}")
 309 |                  raise ValueError(f"Domain '{payload.domain}' ({domain_obj.type_key}) is LOCKED. Custom attributes are forbidden.")
 310 | 
 311 |         query = select(AttributeDefinition).where(AttributeDefinition.domain == payload.domain, AttributeDefinition.key == payload.key)
 312 |         result = await db.execute(query)
 313 |         if result.scalars().first(): raise ValueError(f"Attribute '{payload.key}' already exists.")
 314 |         
 315 |         db_obj = AttributeDefinition(**payload.model_dump(mode='json'))
 316 |         db.add(db_obj)
 317 |         await db.commit()
 318 |         await db.refresh(db_obj)
 319 |         await MetaService.invalidate_cache(payload.domain)
 320 |         return db_obj
 321 | 
 322 |     @staticmethod
 323 |     async def get_attributes(db: AsyncSession, domain: str, active_only: bool = False) -> List[AttributeDefinition]:
 324 |         query = select(AttributeDefinition).where(AttributeDefinition.domain == domain)
 325 |         if active_only: query = query.where(AttributeDefinition.is_active == True)
 326 |         result = await db.execute(query)
 327 |         return result.scalars().all()
 328 | 
 329 |     @staticmethod
 330 |     async def update_attribute(db: AsyncSession, id: int, payload: AttributeUpdate) -> Optional[AttributeDefinition]:
 331 |         query = select(AttributeDefinition).where(AttributeDefinition.id == id)
 332 |         result = await db.execute(query)
 333 |         db_obj = result.scalars().first()
 334 |         if not db_obj: return None
 335 | 
 336 |         update_data = payload.model_dump(exclude_unset=True, mode='json')
 337 |         for field, value in update_data.items(): setattr(db_obj, field, value)
 338 |         await db.commit()
 339 |         await db.refresh(db_obj)
 340 |         await MetaService.invalidate_cache(db_obj.domain)
 341 |         return db_obj
 342 | 
 343 |     @staticmethod
 344 |     async def delete_attribute(db: AsyncSession, id: int) -> bool:
 345 |         query = select(AttributeDefinition).where(AttributeDefinition.id == id)
 346 |         result = await db.execute(query)
 347 |         db_obj = result.scalars().first()
 348 |         if not db_obj: return False
 349 | 
 350 |         if db_obj.is_system: raise ValueError("‚õî System Attributes cannot be deleted.")
 351 |         await db.delete(db_obj)
 352 |         await db.commit()
 353 |         await MetaService.invalidate_cache(db_obj.domain)
 354 |         return True
 355 | 
 356 |     # ==============================================================================
 357 |     #  4. RULES (SIMPLE)
 358 |     # ==============================================================================
 359 | 
 360 |     @staticmethod
 361 |     async def create_rule(db: AsyncSession, payload: RuleCreate) -> RuleDefinition:
 362 |         db_obj = RuleDefinition(**payload.model_dump(mode='json'))
 363 |         db.add(db_obj)
 364 |         await db.commit()
 365 |         return db_obj
 366 | 
 367 |     @staticmethod
 368 |     async def get_rules(db: AsyncSession, domain: str, event_type: Optional[str] = None, scope: Optional[str] = None) -> List[RuleDefinition]:
 369 |         query = select(RuleDefinition).where(RuleDefinition.target_domain == domain, RuleDefinition.is_active == True)
 370 |         if event_type: query = query.where(RuleDefinition.event_type == event_type)
 371 |         if scope: query = query.where(or_(RuleDefinition.scope == scope, RuleDefinition.scope == None))
 372 |         result = await db.execute(query.order_by(desc(RuleDefinition.priority)))
 373 |         return result.scalars().all()
 374 | 
 375 |     # ==============================================================================
 376 |     #  5. SYSTEM & REFLECTION (THE FIX)
 377 |     # ==============================================================================
 378 | 
 379 |     @staticmethod
 380 |     async def get_fused_schema(db: AsyncSession, domain: str, active_only: bool = True) -> Dict[str, Any]:
 381 |         """
 382 |         The Brain: Combines Immutable Code (Registry) with Flexible Data (DB).
 383 |         Returns a Frontend-Ready Schema Object.
 384 |         """
 385 |         try:
 386 |             # ‚ö° LOGGING: Trace the Fusion Step
 387 |             logger.info(f"üß© [Schema] Fusing domain: {domain}")
 388 | 
 389 |             fields = {}
 390 | 
 391 |             # 1. FETCH STATIC SCHEMA (The Bedrock)
 392 |             logger.debug(f"   ‚Ü≥ [Schema] Fetching Static Registry for {domain}...")
 393 |             static_schema = domain_registry.get_schema(domain)
 394 |             
 395 |             if static_schema:
 396 |                 for key, def_ in static_schema.items():
 397 |                     fields[key] = {
 398 |                         "id": 0, # Static fields don't have a DB ID
 399 |                         "key": key,
 400 |                         "label": def_.get("label", key),
 401 |                         "description": def_.get("description", "System Field"),
 402 |                         "data_type": def_.get("data_type", "TEXT"),
 403 |                         "widget_type": def_.get("widget_type", "INPUT"),
 404 |                         "is_required": def_.get("is_required", False),
 405 |                         "is_unique": def_.get("is_unique", False),
 406 |                         "is_system": True, # Always system
 407 |                         "is_active": True,
 408 |                         "read_only": True, # Immutable
 409 |                         "configuration": def_.get("configuration", {}),
 410 |                         "is_dynamic": False
 411 |                     }
 412 |                 logger.debug(f"   ‚Ü≥ [Schema] Static Fields Loaded: {len(fields)}")
 413 | 
 414 |             # 2. FETCH DYNAMIC SCHEMA (The Overlay)
 415 |             logger.debug(f"   ‚Ü≥ [Schema] Querying Dynamic Attributes...")
 416 | 
 417 |             # Use local method to avoid circular dependency issues
 418 |             dynamic_attributes = await MetaService.get_attributes(db, domain, active_only=active_only)
 419 |             
 420 |             for attr in dynamic_attributes:
 421 |                 # Dynamic overrides Static if key matches
 422 |                 fields[attr.key] = {
 423 |                     "id": attr.id,
 424 |                     "key": attr.key,
 425 |                     "label": attr.label,
 426 |                     "description": attr.description,
 427 |                     "data_type": attr.data_type,
 428 |                     "widget_type": attr.widget_type,
 429 |                     "is_required": attr.is_required,
 430 |                     "is_unique": attr.is_unique,
 431 |                     "is_system": attr.is_system,
 432 |                     "is_active": attr.is_active,
 433 |                     "read_only": attr.is_system, 
 434 |                     "configuration": attr.configuration,
 435 |                     "is_dynamic": True
 436 |                 }
 437 |             logger.debug(f"   ‚Ü≥ [Schema] Dynamic Attributes Merged: {len(dynamic_attributes)}")
 438 |                 
 439 |             return {"domain": domain, "fields": fields}
 440 | 
 441 |         except Exception as e:
 442 |             logger.error(f"üî• [Schema] CRASH in get_fused_schema({domain}): {e}", exc_info=True)
 443 |             # Return empty schema instead of crashing, allowing UI to recover
 444 |             return {"domain": domain, "fields": {}, "error": str(e)}
 445 | 
 446 |     @staticmethod
 447 |     async def invalidate_cache(domain: str):
 448 |         logger.info(f"üî• [CACHE] Invalidated for Domain: {domain}")
 449 | 

================================================================================

# Source code from: backend\app\domains\auth\features\preferences\seeds.py
----------------------------------------------------------------------------
   1 | # FILEPATH: backend/app/domains/auth/features/preferences/seeds.py
   2 | # @file: Preference Schema Seeder
   3 | # @role ‚öôÔ∏è Data Hydration
   4 | # @author: The Engineer
   5 | # @description: Registers the Virtual Attributes for User Preferences.
   6 | # These attributes map JSONB keys to Meta-Kernel Widgets.
   7 | # @security-level LEVEL 9 (System Locked)
   8 | # @updated Fixed Enum Attributes to match 'core.meta.constants.WidgetType'.
   9 | 
  10 | import logging
  11 | from sqlalchemy import select
  12 | from sqlalchemy.ext.asyncio import AsyncSession
  13 | 
  14 | from app.core.meta.models import AttributeDefinition
  15 | from app.core.meta.constants import AttributeType, WidgetType
  16 | 
  17 | logger = logging.getLogger("auth.features.preferences.seeds")
  18 | 
  19 | # ‚ö° THE CONTRACT: Defines the structure of the 'preferences' JSONB column
  20 | # These fields will appear in the Dictionary UI as locked system fields.
  21 | PREFERENCE_ATTRIBUTES = [
  22 |     # --- 1. VISUALS ---
  23 |     {
  24 |         "key": "theme.mode",
  25 |         "label": "Theme Mode",
  26 |         "data_type": AttributeType.SELECT,
  27 |         "widget_type": WidgetType.DROPDOWN, # ‚ö° FIX: Was SELECT
  28 |         "configuration": {
  29 |             "options": [
  30 |                 {"label": "System Sync", "value": "system"},
  31 |                 {"label": "Light Mode", "value": "light"},
  32 |                 {"label": "Dark Mode", "value": "dark"}
  33 |             ],
  34 |             "default_value": "system"
  35 |         },
  36 |         "description": "Controls the base brightness of the interface."
  37 |     },
  38 |     {
  39 |         "key": "theme.preset",
  40 |         "label": "Color Theme",
  41 |         "data_type": AttributeType.SELECT,
  42 |         "widget_type": WidgetType.DROPDOWN, # ‚ö° FIX: Was SELECT
  43 |         "configuration": {
  44 |             "options": [
  45 |                 {"label": "Void (Deep Dark)", "value": "void"},
  46 |                 {"label": "Polar (Clean Light)", "value": "polar"},
  47 |                 {"label": "Midnight (Developer)", "value": "midnight"},
  48 |                 {"label": "Enterprise (SaaS)", "value": "enterprise"},
  49 |                 {"label": "Cyberpunk (Neon)", "value": "cyberpunk"}
  50 |             ],
  51 |             "default_value": "void"
  52 |         },
  53 |         "description": "The color palette used across the application."
  54 |     },
  55 |     {
  56 |         "key": "theme.primary_color",
  57 |         "label": "Accent Color",
  58 |         "data_type": AttributeType.TEXT,
  59 |         "widget_type": WidgetType.COLOR, 
  60 |         "configuration": {
  61 |             "default_value": "#00e676"
  62 |         },
  63 |         "description": "The brand color used for buttons and active states."
  64 |     },
  65 |     {
  66 |         "key": "layout.density",
  67 |         "label": "Information Density",
  68 |         "data_type": AttributeType.SELECT,
  69 |         "widget_type": WidgetType.RADIO_GROUP, # ‚ö° FIX: SEGMENTED not in Python Enum
  70 |         "configuration": {
  71 |             "options": [
  72 |                 {"label": "Comfortable", "value": "comfortable"},
  73 |                 {"label": "Compact", "value": "compact"}
  74 |             ],
  75 |             "default_value": "comfortable"
  76 |         },
  77 |         "description": "Controls spacing and padding in lists and grids."
  78 |     },
  79 |     {
  80 |         "key": "layout.sidebar_collapsed",
  81 |         "label": "Default Sidebar State",
  82 |         "data_type": AttributeType.BOOLEAN,
  83 |         "widget_type": WidgetType.SWITCH,
  84 |         "configuration": {
  85 |             "default_value": False
  86 |         },
  87 |         "description": "If enabled, the sidebar starts collapsed."
  88 |     },
  89 | 
  90 |     # --- 2. REGIONAL / I18N ---
  91 |     {
  92 |         "key": "localization.timezone",
  93 |         "label": "Time Zone",
  94 |         "data_type": AttributeType.SELECT,
  95 |         "widget_type": WidgetType.AUTOCOMPLETE,
  96 |         "configuration": {
  97 |             # In a real app, we'd load this from a library like 'pytz'
  98 |             "options": [
  99 |                 {"label": "UTC (Universal)", "value": "UTC"},
 100 |                 {"label": "America/New_York (EST)", "value": "America/New_York"},
 101 |                 {"label": "America/Los_Angeles (EST)", "value": "America/Los_Angeles"},
 102 |                 {"label": "Europe/London (GMT)", "value": "Europe/London"},
 103 |                 {"label": "Asia/Kolkata (IST)", "value": "Asia/Kolkata"},
 104 |                 {"label": "Asia/Tokyo (JST)", "value": "Asia/Tokyo"}
 105 |             ],
 106 |             "default_value": "UTC"
 107 |         },
 108 |         "description": "Used to calculate local times for display."
 109 |     },
 110 |     {
 111 |         "key": "localization.language",
 112 |         "label": "Language (Locale)",
 113 |         "data_type": AttributeType.SELECT,
 114 |         "widget_type": WidgetType.DROPDOWN, # ‚ö° FIX: Was SELECT
 115 |         "configuration": {
 116 |             "options": [
 117 |                 {"label": "English (US)", "value": "en-US"},
 118 |                 {"label": "Spanish (ES)", "value": "es-ES"},
 119 |                 {"label": "German (DE)", "value": "de-DE"},
 120 |                 {"label": "French (FR)", "value": "fr-FR"}
 121 |             ],
 122 |             "default_value": "en-US"
 123 |         },
 124 |         "description": "The language for UI labels and messages."
 125 |     },
 126 |     {
 127 |         "key": "localization.date_format",
 128 |         "label": "Date Format",
 129 |         "data_type": AttributeType.SELECT,
 130 |         "widget_type": WidgetType.DROPDOWN, # ‚ö° FIX: Was SELECT
 131 |         "configuration": {
 132 |             "options": [
 133 |                 {"label": "ISO 8601 (YYYY-MM-DD)", "value": "YYYY-MM-DD"},
 134 |                 {"label": "European (DD/MM/YYYY)", "value": "DD/MM/YYYY"},
 135 |                 {"label": "American (MM/DD/YYYY)", "value": "MM/DD/YYYY"}
 136 |             ],
 137 |             "default_value": "YYYY-MM-DD"
 138 |         },
 139 |         "description": "Preferred format for displaying dates."
 140 |     },
 141 |     {
 142 |         "key": "localization.number_format",
 143 |         "label": "Number Format",
 144 |         "data_type": AttributeType.SELECT,
 145 |         "widget_type": WidgetType.DROPDOWN, # ‚ö° FIX: Was SELECT
 146 |         "configuration": {
 147 |             "options": [
 148 |                 {"label": "1,234.56 (Dot Decimal)", "value": "dot"},
 149 |                 {"label": "1.234,56 (Comma Decimal)", "value": "comma"}
 150 |             ],
 151 |             "default_value": "dot"
 152 |         },
 153 |         "description": "Decimal and thousands separators."
 154 |     },
 155 | 
 156 |     # --- 3. NOTIFICATIONS ---
 157 |     {
 158 |         "key": "notifications.email_digest",
 159 |         "label": "Daily Email Digest",
 160 |         "data_type": AttributeType.BOOLEAN,
 161 |         "widget_type": WidgetType.SWITCH,
 162 |         "configuration": {
 163 |             "default_value": True
 164 |         },
 165 |         "description": "Receive a summary of activity every morning."
 166 |     },
 167 |     {
 168 |         "key": "notifications.workflow_alerts",
 169 |         "label": "Workflow Alerts",
 170 |         "data_type": AttributeType.BOOLEAN,
 171 |         "widget_type": WidgetType.SWITCH,
 172 |         "configuration": {
 173 |             "default_value": True
 174 |         },
 175 |         "description": "Receive real-time alerts for assigned workflow steps."
 176 |     }
 177 | ]
 178 | 
 179 | async def seed_preferences_schema(db: AsyncSession):
 180 |     """
 181 |     Idempotent seeder for User Preference Attributes.
 182 |     """
 183 |     domain_key = "USER_PREFS"
 184 |     logger.info(f"üé® [Preferences] Seeding Virtual Schema for {domain_key}...")
 185 |     
 186 |     count = 0
 187 |     for attr in PREFERENCE_ATTRIBUTES:
 188 |         # Check existence
 189 |         stmt = select(AttributeDefinition).where(
 190 |             AttributeDefinition.domain == domain_key,
 191 |             AttributeDefinition.key == attr["key"]
 192 |         )
 193 |         existing = (await db.execute(stmt)).scalars().first()
 194 |         
 195 |         if not existing:
 196 |             new_attr = AttributeDefinition(
 197 |                 domain=domain_key,
 198 |                 key=attr["key"],
 199 |                 label=attr["label"],
 200 |                 description=attr["description"],
 201 |                 data_type=attr["data_type"],
 202 |                 widget_type=attr["widget_type"],
 203 |                 configuration=attr["configuration"],
 204 |                 is_system=True,   # üîí LOCK IT
 205 |                 is_required=False,
 206 |                 is_active=True
 207 |             )
 208 |             db.add(new_attr)
 209 |             count += 1
 210 |             logger.debug(f"   ‚Ü≥ Defined: {attr['key']}")
 211 |     
 212 |     if count > 0:
 213 |         await db.commit()
 214 |         logger.info(f"‚úÖ [Preferences] Created {count} System Attributes.")
 215 |     else:
 216 |         logger.info(f"‚ú® [Preferences] Schema up to date.")
 217 | 

================================================================================

# Source code from: backend\app\domains\auth\seeds.py
-------------------------------------------------------
   1 | # FILEPATH: backend/app/domains/auth/seeds.py
   2 | # @file: Auth Domain Seeder
   3 | # @role ‚öôÔ∏è Data Hydration
   4 | # @author: The Engineer
   5 | # @description: Initializes Users, Workflows, Preference Schemas, AND Governance Bindings.
   6 | # @updated: Excludes JOB/VIEW scopes from State Engine to prevent validation crashes. Added 'prefs_domain' recursion.
   7 | 
   8 | import logging
   9 | from sqlalchemy import select
  10 | from sqlalchemy.ext.asyncio import AsyncSession
  11 | 
  12 | from app.core.security import get_password_hash
  13 | from app.domains.auth.models import User
  14 | from app.domains.auth.registry import auth_domain, prefs_domain # ‚ö° ADDED: prefs_domain
  15 | 
  16 | # Meta Models for Governance
  17 | from app.core.meta.models import PolicyDefinition, PolicyBinding
  18 | 
  19 | # State Engine
  20 | from app.core.meta.features.states.service import StateService
  21 | from app.core.meta.features.states.schemas import StateMachineCreate
  22 | 
  23 | # Fractal Feature
  24 | from app.domains.auth.features.preferences.seeds import seed_preferences_schema
  25 | 
  26 | logger = logging.getLogger("flodock.domains.auth.seeds")
  27 | 
  28 | async def seed_assets(db: AsyncSession):
  29 |     """
  30 |     Wave 2: Core Assets
  31 |     1. Create Super Admin
  32 |     2. Register Workflows (Identity + Preferences)
  33 |     3. Seed Preference Schema
  34 |     4. Bind Governance (Compliance)
  35 |     """
  36 |     # --- 1. ADMIN USER ---
  37 |     admin_email = "anand@flodock.com"
  38 |     logger.info(f"   üîê [Auth] Verifying Super Admin identity ({admin_email})...")
  39 |     
  40 |     result = await db.execute(select(User).where(User.email == admin_email))
  41 |     if not result.scalars().first():
  42 |         logger.info(f"   üë§ Minting Super Admin ({admin_email})...")
  43 |         admin_user = User(
  44 |             email=admin_email,
  45 |             hashed_password=get_password_hash("password123"),
  46 |             full_name="Anand (System Architect)",
  47 |             role="admin",
  48 |             is_active=True,
  49 |             is_superuser=True,
  50 |             status="ACTIVE",
  51 |             approval_state="APPROVED"
  52 |         )
  53 |         db.add(admin_user)
  54 |         logger.info("   ‚ú® Admin user queued.")
  55 |     else:
  56 |         logger.info(f"   ‚úÖ Admin user ({admin_email}) active. Skipping.")
  57 | 
  58 |     # --- 2. WORKFLOW REGISTRATION (Refactored) ---
  59 |     logger.info("   üß¨ [Auth] Hydrating State Machines from Registry...")
  60 |     
  61 |     # ‚ö° CORE IDENTITY FLOWS (USER)
  62 |     await _register_domain_workflows(db, auth_domain)
  63 |     
  64 |     # ‚ö° SIDECAR FLOWS (USER_PREFS)
  65 |     # This fixes the missing "User Settings" workflow
  66 |     await _register_domain_workflows(db, prefs_domain)
  67 | 
  68 |     # --- 3. PREFERENCE SCHEMA ---
  69 |     await seed_preferences_schema(db)
  70 | 
  71 |     # --- 4. ‚ö° GOVERNANCE BINDING (Compliance) ---
  72 |     # The User Domain voluntarily accepts the System's Laws
  73 |     await seed_governance(db)
  74 | 
  75 |     logger.info("   ‚úÖ [Auth] Assets & Workflows Seeded.")
  76 | 
  77 | 
  78 | async def _register_domain_workflows(db: AsyncSession, domain_ctx):
  79 |     """
  80 |     Helper to register workflows for a specific Domain Context.
  81 |     Ensures the correct 'domain_key' is used and JOBS are skipped.
  82 |     """
  83 |     for raw_scope in domain_ctx.supported_scopes:
  84 |         # Handle Tuple vs Dict scopes (Legacy shim)
  85 |         if isinstance(raw_scope, tuple):
  86 |             scope = raw_scope[1]
  87 |         else:
  88 |             scope = raw_scope
  89 | 
  90 |         scope_type = scope.get("type")
  91 |         
  92 |         # ‚ö° CRITICAL FILTER: Only register State Machines (WIZARD, GOVERNANCE).
  93 |         # We EXCLUDE 'JOB' and 'VIEW' because they don't have XState definitions.
  94 |         if scope_type in ["WIZARD", "GOVERNANCE"] and scope.get("config"):
  95 |             logger.debug(f"      ‚Ü≥ Processing Workflow: [{domain_ctx.domain_key}] {scope['key']}...")
  96 |             
  97 |             payload = StateMachineCreate(
  98 |                 domain=domain_ctx.domain_key, # ‚ö° DYNAMIC KEY (USER or USER_PREFS)
  99 |                 scope=scope["key"],
 100 |                 name=scope["label"],
 101 |                 governed_field=scope.get("target_field") or "status",
 102 |                 definition=scope["config"]
 103 |             )
 104 | 
 105 |             try:
 106 |                 await StateService.create_machine(db, payload)
 107 |             except Exception as e:
 108 |                 logger.error(f"      ‚ùå Failed to seed workflow {scope['key']}: {e}")
 109 | 
 110 | 
 111 | async def seed_governance(db: AsyncSession):
 112 |     """
 113 |     Binds the USER domain to Global System Policies.
 114 |     """
 115 |     logger.info("   ‚öñÔ∏è [Auth] Binding to System Governance...")
 116 |     
 117 |     # ‚ö° THE COMPLIANCE LIST
 118 |     # "We agree to follow these System Policies"
 119 |     BINDINGS = [
 120 |         {
 121 |             "policy_key": "sys_root_integrity_v1",
 122 |             "target_domain": "USER",
 123 |             "priority": 100
 124 |         },
 125 |         {
 126 |             "policy_key": "sys_data_hygiene_v1",
 127 |             "target_domain": "USER",
 128 |             "priority": 10
 129 |         }
 130 |     ]
 131 | 
 132 |     for b_def in BINDINGS:
 133 |         # 1. Find the Law
 134 |         stmt = select(PolicyDefinition).where(PolicyDefinition.key == b_def["policy_key"])
 135 |         result = await db.execute(stmt)
 136 |         policy = result.scalars().first()
 137 |         
 138 |         if not policy:
 139 |             logger.warning(f"      ‚ö†Ô∏è Law '{b_def['policy_key']}' not found. Compliance skipped.")
 140 |             continue
 141 | 
 142 |         # 2. Check for existing Binding
 143 |         stmt_b = select(PolicyBinding).where(
 144 |             PolicyBinding.policy_id == policy.id,
 145 |             PolicyBinding.target_domain == b_def["target_domain"]
 146 |         )
 147 |         existing_b = await db.execute(stmt_b)
 148 |         if existing_b.scalars().first():
 149 |             continue
 150 | 
 151 |         # 3. Sign the Contract
 152 |         binding = PolicyBinding(
 153 |             policy_id=policy.id,
 154 |             target_domain=b_def["target_domain"],
 155 |             priority=b_def["priority"],
 156 |             is_active=True
 157 |         )
 158 |         db.add(binding)
 159 |         logger.info(f"      [COMPLIANCE] Bound '{b_def['policy_key']}' to this Domain.")
 160 |     
 161 |     await db.commit()
 162 | 

================================================================================

# Source code from: backend\app\domains\meta_v2\features\governance\enforcer.py
---------------------------------------------------------------------------------
   1 | # FILEPATH: backend/app/domains/meta_v2/features/governance/enforcer.py
   2 | # @file: Governance Enforcer (Decoupled v3.0)
   3 | # @role: üß† Logic Container
   4 | # @author: The Engineer (ansav8@gmail.com)
   5 | # @description: Decoupled Governance sidecar. Fetches and evaluates policies independently.
   6 | # @security-level: LEVEL 9 (Strict Decoupling)
   7 | 
   8 | import logging
   9 | from typing import Dict, Any, Tuple
  10 | from sqlalchemy import select, desc
  11 | from sqlalchemy.orm import selectinload
  12 | from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
  13 | 
  14 | from app.core.config import settings
  15 | from app.core.kernel.context.manager import context_manager
  16 | from app.core.meta.engine import policy_engine
  17 | from app.core.meta.models import PolicyBinding, PolicyDefinition
  18 | from app.core.kernel.actions import LogicResult
  19 | 
  20 | logger = logging.getLogger("meta_v2.governance.enforcer")
  21 | 
  22 | class GovernanceEnforcer:
  23 |     @staticmethod
  24 |     async def fetch_and_evaluate(frozen_obj: Any, obj: Any, domain_key: str, context_envelope: Dict[str, Any]) -> Tuple[LogicResult, Dict[str, Any]]:
  25 |         """
  26 |         ‚ö° SIDECAR IO: Spawns an independent DB session to fetch Policies, 
  27 |         resolves the context, and executes the Universal Logic Engine.
  28 |         """
  29 |         ephemeral_engine = create_async_engine(settings.DATABASE_URL, echo=False, pool_pre_ping=True)
  30 |         try:
  31 |             async with AsyncSession(ephemeral_engine) as sidecar_db:
  32 |                 # 1. Resolve Environment Context
  33 |                 env_ctx = await context_manager.resolve(sidecar_db, frozen_obj)
  34 |                 if env_ctx:
  35 |                     context_envelope.update(env_ctx)
  36 | 
  37 |                 # 2. Fetch Active Bindings
  38 |                 stmt = select(PolicyBinding).options(
  39 |                     selectinload(PolicyBinding.policy),
  40 |                     selectinload(PolicyBinding.group)
  41 |                 ).where(
  42 |                     PolicyBinding.target_domain == domain_key,
  43 |                     PolicyBinding.is_active == True
  44 |                 ).order_by(desc(PolicyBinding.priority))
  45 | 
  46 |                 bindings = (await sidecar_db.execute(stmt)).scalars().all()
  47 |                 
  48 |                 policies = []
  49 |                 for b in bindings:
  50 |                     if b.policy_id and b.policy and b.policy.is_active:
  51 |                         policies.append(b.policy)
  52 | 
  53 |                 # 3. Evaluate (Or Pass gracefully if no rules)
  54 |                 if not policies:
  55 |                     return LogicResult(is_valid=True), context_envelope
  56 | 
  57 |                 result = policy_engine.evaluate(entity=obj, policies=policies, context_override=context_envelope)
  58 |                 return result, context_envelope
  59 |         except Exception as e:
  60 |             logger.error(f"üî• [GovernanceEnforcer] Database or Context Failure: {e}")
  61 |             raise e
  62 |         finally:
  63 |             await ephemeral_engine.dispose()
  64 | 
  65 |     @staticmethod
  66 |     def evaluate_guard_sync(obj: Any, guard_expr: str, context_envelope: Dict[str, Any]) -> LogicResult:
  67 |         """
  68 |         Evaluates a single transition guard expression synchronously.
  69 |         """
  70 |         temp_policy = PolicyDefinition(
  71 |             key="transition_guard",
  72 |             rules=[{"logic": guard_expr, "action": "BLOCK", "message": "State Guard Failed"}],
  73 |             is_active=True
  74 |         )
  75 |         return policy_engine.evaluate(entity=obj, policies=[temp_policy], context_override=context_envelope)

================================================================================

# Source code from: backend\app\domains\system\features\domain_types\models.py
--------------------------------------------------------------------------------
   1 | # FILEPATH: backend/app/domains/system/features/domain_types/models.py
   2 | # @file: Domain Type Definition (The DNA)
   3 | # @role: üíæ Data Model
   4 | # @author: The Engineer (ansav8@gmail.com)
   5 | # @description: Defines the 'Class' of a Domain (e.g., STANDARD vs CONFIG).
   6 | # This allows the Kernel to behave differently based on the Domain's Type.
   7 | # @security-level: LEVEL 9 (Strict Schema)
   8 | # @invariant: 'key' must be uppercase ASCII (e.g., 'STANDARD').
   9 | 
  10 | from sqlalchemy import Column, String, DateTime, Text
  11 | from sqlalchemy.dialects.postgresql import JSONB
  12 | from sqlalchemy.sql import func, text
  13 | 
  14 | from app.core.database.base import Base
  15 | 
  16 | class KernelDomainType(Base):
  17 |     """
  18 |     The Meta-Definition for a Domain Category.
  19 |     Instead of hardcoding behavior in Python, we read 'properties' from this table.
  20 |     """
  21 |     __tablename__ = "kernel_domain_types"
  22 | 
  23 |     # Identity
  24 |     # e.g., "STANDARD", "CONFIG", "SYSTEM", "LEGACY"
  25 |     key = Column(String(50), primary_key=True, index=True)
  26 |     
  27 |     # Human Readable Label
  28 |     # e.g., "Business Entity", "Configuration Store"
  29 |     label = Column(String(100), nullable=False)
  30 |     
  31 |     # ‚ö° THE BRAIN (Behavioral Flags)
  32 |     # Controls how the Kernel interacts with domains of this type.
  33 |     # Schema:
  34 |     # {
  35 |     #   "storage_strategy": "TABLE" | "KV_STORE" | "NONE",
  36 |     #   "api_strategy": "CRUD" | "REFLECT" | "READ_ONLY",
  37 |     #   "supports_meta": bool,
  38 |     #   "supports_activity": bool
  39 |     # }
  40 |     properties = Column(JSONB, nullable=False, server_default=text("'{}'::jsonb"))
  41 |     
  42 |     # Documentation
  43 |     description = Column(String(500), nullable=True)
  44 |     
  45 |     # Audit
  46 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
  47 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now())
  48 | 
  49 |     def __repr__(self):
  50 |         """
  51 |         @description: String representation for logging.
  52 |         """
  53 |         return f"<KernelDomainType(key='{self.key}')>"
  54 | 

================================================================================

# Source code from: backend\app\domains\system\features\navigation\models.py
------------------------------------------------------------------------------
   1 | # FILEPATH: backend/app/domains/system/features/navigation/models.py
   2 | # @file: Navigation Data Models
   3 | # @role: üíæ Data Model
   4 | # @author: The Engineer (ansav8@gmail.com)
   5 | # @description: Persistent registry for the Global OS Shell layout.
   6 | # @security-level: LEVEL 9 (Strict Schema)
   7 | # @updated: Added 'search_tags' for Command-K discovery.
   8 | 
   9 | from sqlalchemy import Column, Integer, String, Boolean, ForeignKey, DateTime, text, UniqueConstraint
  10 | from sqlalchemy.dialects.postgresql import JSONB
  11 | from sqlalchemy.sql import func
  12 | from app.core.database.base import Base
  13 | 
  14 | class SystemMenuNode(Base):
  15 |     """
  16 |     The Global UI Shell Navigation Registry.
  17 |     Defines sidebars, top bars, and user menus at the OS level.
  18 |     """
  19 |     __tablename__ = "sys_menu_nodes"
  20 | 
  21 |     id = Column(Integer, primary_key=True, index=True)
  22 |     
  23 |     # ‚ö° UNIQUE IDENTITY
  24 |     # We use an explicit constraint in __table_args__ to ensure Postgres sees it before the FK.
  25 |     key = Column(String(100), nullable=False, index=True) # e.g. 'core.dashboard'
  26 |     
  27 |     zone = Column(String(50), nullable=False, index=True) # MAIN_SIDEBAR, AVATAR_DROPDOWN
  28 |     label = Column(String(100), nullable=False)
  29 |     icon = Column(String(100), nullable=True)
  30 |     
  31 |     # ‚ö° ROUTING (Frontend)
  32 |     path = Column(String(255), nullable=True) # The Browser URL (e.g. /dashboard)
  33 |     component_path = Column(String(255), nullable=True) # The Physical Source File
  34 |     
  35 |     # ‚ö° API BINDING (Backend)
  36 |     api_endpoint = Column(String(255), nullable=True) # The Primary Data Source
  37 | 
  38 |     # ‚ö° DISCOVERY (Search)
  39 |     search_tags = Column(JSONB, nullable=False, server_default=text("'[]'::jsonb"))
  40 | 
  41 |     weight = Column(Integer, default=0)
  42 |     
  43 |     # ‚ö° SELF-REFERENCE FIX
  44 |     # use_alter=True: Adds the FK constraint via ALTER TABLE *after* creation.
  45 |     # This prevents "no unique constraint" errors during the CREATE TABLE phase.
  46 |     parent_key = Column(
  47 |         String(100), 
  48 |         ForeignKey("sys_menu_nodes.key", use_alter=True, name="fk_sys_menu_parent"), 
  49 |         nullable=True
  50 |     )
  51 |     
  52 |     required_policy = Column(String(100), nullable=True) # Security lock key
  53 |     
  54 |     # ‚ö° The Escape Hatch for advanced UI configurations (Badges, hotkeys, etc)
  55 |     config = Column(JSONB, nullable=False, server_default=text("'{}'::jsonb"))
  56 |     
  57 |     is_active = Column(Boolean, default=True)
  58 | 
  59 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
  60 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now())
  61 | 
  62 |     # ‚ö° EXPLICIT CONSTRAINTS
  63 |     __table_args__ = (
  64 |         UniqueConstraint('key', name='uq_sys_menu_node_key'),
  65 |     )
  66 | 
  67 |     def __repr__(self):
  68 |         return f"<SystemMenuNode(key='{self.key}', zone='{self.zone}')>"
  69 | 

================================================================================

# Source code from: backend\app\domains\system\features\navigation\service.py
-------------------------------------------------------------------------------
   1 | # FILEPATH: backend/app/domains/system/features/navigation/service.py
   2 | # @file: Navigation Logic Service
   3 | # @role: üß† Logic Container
   4 | # @author: The Engineer (ansav8@gmail.com)
   5 | # @description: Generates secured, structured navigation payloads for the Shell.
   6 | # @security-level: LEVEL 9 (Governance-Aware)
   7 | 
   8 | import logging
   9 | from typing import Dict, List, Any
  10 | from sqlalchemy import select
  11 | from sqlalchemy.ext.asyncio import AsyncSession
  12 | 
  13 | from .models import SystemMenuNode
  14 | from app.core.meta.engine import policy_engine
  15 | from app.core.meta.models import PolicyDefinition
  16 | 
  17 | logger = logging.getLogger("system.navigation.service")
  18 | 
  19 | class NavigationService:
  20 |     """
  21 |     The Architect of the UI Shell.
  22 |     Filters the navigation topology based on active Governance Policies.
  23 |     """
  24 | 
  25 |     @staticmethod
  26 |     async def get_secured_navigation(db: AsyncSession, eval_context: Dict[str, Any]) -> Dict[str, List[Dict[str, Any]]]:
  27 |         """
  28 |         @description: Fetches all active nodes and filters them via the Policy Engine.
  29 |         @invariant: Unauthorized nodes must never enter the returned payload.
  30 |         """
  31 |         # 1. Fetch all active nodes
  32 |         stmt = select(SystemMenuNode).where(SystemMenuNode.is_active == True).order_by(SystemMenuNode.weight)
  33 |         result = await db.execute(stmt)
  34 |         menu_nodes = result.scalars().all()
  35 | 
  36 |         # 2. Extract unique policy requirements to minimize DB hits
  37 |         required_policy_keys = list(set([m.required_policy for m in menu_nodes if m.required_policy]))
  38 |         
  39 |         policies_map = {}
  40 |         if required_policy_keys:
  41 |             stmt_pol = select(PolicyDefinition).where(
  42 |                 PolicyDefinition.key.in_(required_policy_keys),
  43 |                 PolicyDefinition.is_latest == True
  44 |             )
  45 |             pol_res = await db.execute(stmt_pol)
  46 |             policies_map = {p.key: p for p in pol_res.scalars().all()}
  47 | 
  48 |         # 3. Assemble filtered structure
  49 |         navigation = {
  50 |             "sidebar": [],
  51 |             "user_menu": [],
  52 |             "top_bar": []
  53 |         }
  54 | 
  55 |         for node in menu_nodes:
  56 |             # üõ°Ô∏è SECURITY GATE
  57 |             if node.required_policy:
  58 |                 policy = policies_map.get(node.required_policy)
  59 |                 if policy:
  60 |                     eval_result = policy_engine.evaluate(entity={}, policies=[policy], context_override=eval_context)
  61 |                     if not eval_result.is_valid:
  62 |                         logger.debug(f"üõ°Ô∏è [Navigation] Cloaking Node '{node.key}': Policy Check Failed")
  63 |                         continue
  64 | 
  65 |             # üì¶ SERIALIZE
  66 |             node_payload = {
  67 |                 "key": node.key,
  68 |                 "label": node.label,
  69 |                 "icon": node.icon,
  70 |                 "path": node.path,
  71 |                 "component_path": node.component_path,
  72 |                 "api_endpoint": node.api_endpoint,
  73 |                 "search_tags": node.search_tags, # ‚ö° DISCOVERY
  74 |                 "config": node.config,
  75 |                 "parent_key": node.parent_key
  76 |             }
  77 | 
  78 |             if node.zone == "MAIN_SIDEBAR":
  79 |                 navigation["sidebar"].append(node_payload)
  80 |             elif node.zone == "AVATAR_DROPDOWN":
  81 |                 navigation["user_menu"].append(node_payload)
  82 |             elif node.zone == "TOP_BAR":
  83 |                 navigation["top_bar"].append(node_payload)
  84 | 
  85 |         return navigation
  86 | 

================================================================================

# Source code from: backend\app\domains\system\models.py
----------------------------------------------------------
   1 | # FILEPATH: backend/app/domains/system/models.py
   2 | # @file: System Domain Models (The Control Plane)
   3 | # @author: The Engineer (ansav8@gmail.com)
   4 | # @description: Defines the Persistent Store for the Operating System.
   5 | # @security-level: LEVEL 9 (Strict Relational Integrity)
   6 | # @updated: Added Fractal Import for 'SystemMenuNode' to ensure Alembic discovery.
   7 | 
   8 | from sqlalchemy import Column, Integer, String, Boolean, ForeignKey, DateTime, Text, UniqueConstraint
   9 | from sqlalchemy.dialects.postgresql import JSONB
  10 | from sqlalchemy.orm import relationship
  11 | from sqlalchemy.sql import func
  12 | from app.core.database.base import Base
  13 | 
  14 | # ‚ö° DIRECT CLASS IMPORT to fix mapper resolution error
  15 | from app.domains.system.features.domain_types.models import KernelDomainType
  16 | 
  17 | # ‚ö° FRACTAL FEATURE REGISTRATION
  18 | # We import feature models here so Alembic can find them via 'app.domains.system.models'
  19 | from app.domains.system.features.navigation.models import SystemMenuNode
  20 | 
  21 | # ==============================================================================
  22 | #  1. KERNEL REGISTRY (The Module Catalog)
  23 | # ==============================================================================
  24 | 
  25 | class KernelDomain(Base):
  26 |     """
  27 |     The Master Registry of all installed Modules.
  28 |     Maps to 'kernel_domains' table.
  29 |     """
  30 |     __tablename__ = "kernel_domains"
  31 | 
  32 |     # The Immutable Key (e.g., "USER", "SHIPPING")
  33 |     key = Column(String(50), primary_key=True, index=True)
  34 |     
  35 |     # ‚ö° META-TYPE LINK (The Classification)
  36 |     type_key = Column(String(50), ForeignKey("kernel_domain_types.key"), nullable=False, default="STANDARD")
  37 |     
  38 |     # Human Readable Identity
  39 |     label = Column(String(100), nullable=False)
  40 |     
  41 |     # ‚ö° TOPOLOGY METADATA
  42 |     system_module = Column(String(50), default="GENERAL", nullable=False, index=True) 
  43 |     module_label = Column(String(100), default="General", nullable=False)             
  44 |     module_icon = Column(String(50), default="antd:AppstoreOutlined")                 
  45 | 
  46 |     # ‚ö° HIERARCHY
  47 |     parent_domain = Column(String(50), nullable=True) 
  48 |     
  49 |     # Legacy Config
  50 |     config = Column(JSONB, default=dict)
  51 | 
  52 |     # Capability Flags
  53 |     is_active = Column(Boolean, default=True, index=True)
  54 |     is_virtual = Column(Boolean, default=False)
  55 | 
  56 |     # Audit
  57 |     created_at = Column(DateTime(timezone=True), server_default=func.now(), info={"is_system": True})
  58 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now(), info={"is_system": True})
  59 | 
  60 |     # Relations
  61 |     scopes = relationship("KernelScope", back_populates="domain", cascade="all, delete-orphan")
  62 |     entities = relationship("KernelEntity", back_populates="domain", cascade="all, delete-orphan") # ‚ö° NEW v3
  63 |     
  64 |     # ‚ö° FIX: Use Direct Class Reference to prevent "failed to locate name" error
  65 |     type_def = relationship(KernelDomainType)
  66 | 
  67 |     def __repr__(self):
  68 |         return f"<KernelDomain(key='{self.key}', type='{self.type_key}', active={self.is_active})>"
  69 | 
  70 | 
  71 | class KernelEntity(Base):
  72 |     """
  73 |     ‚ö° NEW v3: The Physical Table Registry (Aggregate Components).
  74 |     Maps internal logic keys (e.g. "PREFS") to physical tables ("user_preferences").
  75 |     """
  76 |     __tablename__ = "kernel_entities"
  77 | 
  78 |     id = Column(Integer, primary_key=True, index=True)
  79 |     
  80 |     # Identity
  81 |     domain_key = Column(String(50), ForeignKey("kernel_domains.key"), nullable=False, index=True)
  82 |     key = Column(String(50), nullable=False) # e.g. "PREFS"
  83 |     
  84 |     # Physical Mapping
  85 |     table_name = Column(String(100), nullable=False) # e.g. "user_preferences"
  86 |     model_path = Column(String(255), nullable=True)  # e.g. "app.domains.auth.features.preferences.models.UserPreferences"
  87 |     
  88 |     is_root = Column(Boolean, default=False) # Is this the Aggregate Root?
  89 |     is_active = Column(Boolean, default=True)
  90 | 
  91 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
  92 | 
  93 |     domain = relationship("KernelDomain", back_populates="entities")
  94 |     
  95 |     __table_args__ = (
  96 |         UniqueConstraint('domain_key', 'key', name='uq_kernel_entity_domain_key'),
  97 |     )
  98 | 
  99 |     def __repr__(self):
 100 |         return f"<KernelEntity({self.domain_key}.{self.key} -> {self.table_name})>"
 101 | 
 102 | 
 103 | class KernelScope(Base):
 104 |     """
 105 |     The Workflow Topology Definition.
 106 |     Maps to 'kernel_scopes' table.
 107 |     """
 108 |     __tablename__ = "kernel_scopes"
 109 | 
 110 |     id = Column(Integer, primary_key=True, index=True, info={"is_system": True})
 111 |     
 112 |     # The Parent Domain (e.g., "USER")
 113 |     domain_key = Column(String(50), ForeignKey("kernel_domains.key"), nullable=False, index=True)
 114 |     
 115 |     # The Scope Identity (e.g., "LIFECYCLE", "REGISTER")
 116 |     key = Column(String(50), nullable=False)
 117 | 
 118 |     # The Scope Behavior Type
 119 |     type = Column(String(20), nullable=False) # WIZARD, JOB, VIEW
 120 |     
 121 |     # ‚ö° BEHAVIORAL DISCRIMINATOR
 122 |     scope_mode = Column(String(20), nullable=True)
 123 | 
 124 |     # Human Readable Label
 125 |     label = Column(String(100), nullable=False)
 126 | 
 127 |     # ‚ö° TARGET BINDING (v3 Upgrade)
 128 |     # If null, targets the Aggregate Root.
 129 |     target_entity = Column(String(50), nullable=True) # e.g. "PREFS"
 130 |     
 131 |     # Legacy Support
 132 |     target_field = Column(String(50), nullable=True)
 133 |     
 134 |     # Wizard/View Configuration
 135 |     config = Column(JSONB, default=dict)
 136 | 
 137 |     # Audit
 138 |     created_at = Column(DateTime(timezone=True), server_default=func.now(), info={"is_system": True})
 139 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now(), info={"is_system": True})
 140 | 
 141 |     # Relations
 142 |     domain = relationship("KernelDomain", back_populates="scopes")
 143 |     impacts = relationship("KernelScopeImpact", back_populates="scope", cascade="all, delete-orphan") # ‚ö° NEW v3
 144 | 
 145 |     # ‚ö° FIX: Add Unique Constraint so upserts work (Registry Manager depends on this)
 146 |     __table_args__ = (
 147 |         UniqueConstraint('domain_key', 'key', name='uq_kernel_scope_domain_key'),
 148 |     )
 149 | 
 150 |     def __repr__(self):
 151 |         return f"<KernelScope(domain='{self.domain_key}', key='{self.key}')>"
 152 | 
 153 | 
 154 | class KernelScopeImpact(Base):
 155 |     """
 156 |     ‚ö° NEW v3: The Impact Graph (Dependency Map).
 157 |     Records which tables a workflow touches.
 158 |     """
 159 |     __tablename__ = "kernel_scope_impacts"
 160 | 
 161 |     id = Column(Integer, primary_key=True, index=True)
 162 |     scope_id = Column(Integer, ForeignKey("kernel_scopes.id"), nullable=False, index=True)
 163 |     
 164 |     # We link by string key to allow loose coupling during boot
 165 |     entity_key = Column(String(50), nullable=False) # e.g. "PREFS"
 166 |     
 167 |     operation = Column(String(20), nullable=False) # READ, WRITE, CREATE, DELETE
 168 |     
 169 |     scope = relationship("KernelScope", back_populates="impacts")
 170 | 
 171 | 
 172 | # ==============================================================================
 173 | #  2. SYSTEM CONFIGURATION (The Control Knobs)
 174 | # ==============================================================================
 175 | 
 176 | class SystemConfig(Base):
 177 |     """
 178 |     THE CONTROL KNOBS.
 179 |     A typed Key-Value store for Runtime Configuration (Feature Flags, Limits).
 180 |     """
 181 |     __tablename__ = "system_config"
 182 | 
 183 |     id = Column(Integer, primary_key=True, index=True)
 184 |     
 185 |     # Identity
 186 |     key = Column(String(100), nullable=False, unique=True, index=True)
 187 |     label = Column(String(255), nullable=False)
 188 |     description = Column(String(500), nullable=True)
 189 | 
 190 |     # Value Handling
 191 |     value_type = Column(String(20), nullable=False, default="STRING") # STRING, BOOLEAN, NUMBER, JSON
 192 |     value_raw = Column(Text, nullable=True) # Stores the actual value as string
 193 |     
 194 |     # Scope
 195 |     category = Column(String(50), default="GENERAL", index=True) # SECURITY, AI, UX
 196 |     is_encrypted = Column(Boolean, default=False) # If true, value is encrypted
 197 |     is_active = Column(Boolean, default=True)
 198 |     
 199 |     # Audit
 200 |     created_at = Column(DateTime(timezone=True), server_default=func.now())
 201 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now())
 202 | 
 203 |     def __repr__(self):
 204 |         return f"<SystemConfig(key='{self.key}', type='{self.value_type}')>"
 205 | 
 206 |     @property
 207 |     def typed_value(self):
 208 |         """
 209 |         @description: Auto-converts value_raw based on value_type.
 210 |         """
 211 |         if self.value_raw is None: return None
 212 |         
 213 |         if self.value_type == "BOOLEAN":
 214 |             return self.value_raw.lower() in ('true', '1', 'yes', 'on')
 215 |         if self.value_type == "NUMBER":
 216 |             try:
 217 |                 return float(self.value_raw) if '.' in self.value_raw else int(self.value_raw)
 218 |             except ValueError:
 219 |                 return 0
 220 |         if self.value_type == "JSON":
 221 |             import json
 222 |             try:
 223 |                 return json.loads(self.value_raw)
 224 |             except:
 225 |                 return {}
 226 |         return self.value_raw
 227 | 
 228 | 
 229 | # ==============================================================================
 230 | #  3. HYPERVISOR CONTROL CIRCUIT (The Level 9 Switchboard)
 231 | # ==============================================================================
 232 | 
 233 | class CircuitBreaker(Base):
 234 |     """
 235 |     The System Hypervisor's Memory.
 236 |     Controls the operational state of every moving part in the OS.
 237 |     """
 238 |     __tablename__ = "sys_circuit_breakers"
 239 | 
 240 |     id = Column(Integer, primary_key=True, index=True)
 241 | 
 242 |     # WHAT are we controlling? (The URI)
 243 |     # Format: "domain:USER", "scope:USER:SIGNUP", "system:MAINTENANCE"
 244 |     target = Column(String(150), nullable=False, index=True)
 245 | 
 246 |     # WHICH Plane? (The Aspect)
 247 |     # Values: 'UI', 'API', 'WORKER', 'DATA'
 248 |     plane = Column(String(20), nullable=False, index=True)
 249 | 
 250 |     # THE STATE
 251 |     # Values: 'NOMINAL' (On), 'HALTED' (Off), 'DEGRADED' (ReadOnly), 'MAINTENANCE'
 252 |     status = Column(String(20), nullable=False, default="NOMINAL")
 253 |     
 254 |     # EXTENSIBILITY: Links to Module Registry Types
 255 |     module_type = Column(String(50), nullable=True) # e.g. 'WIZARD', 'JOB'
 256 | 
 257 |     # AUDIT
 258 |     updated_by = Column(String(100), nullable=True)
 259 |     reason = Column(String(255), nullable=True)
 260 |     updated_at = Column(DateTime(timezone=True), onupdate=func.now(), server_default=func.now())
 261 | 
 262 |     # Constraints: One switch per plane per target
 263 |     __table_args__ = (
 264 |         UniqueConstraint('target', 'plane', name='uq_circuit_target_plane'),
 265 |     )
 266 | 
 267 |     def __repr__(self):
 268 |         return f"<CircuitBreaker(target='{self.target}', plane='{self.plane}', status='{self.status}')>"
 269 | 

================================================================================

# Source code from: backend\app\domains\system\seeds.py
---------------------------------------------------------
   1 | # FILEPATH: backend/app/domains/system/seeds.py
   2 | # @file: System Domain Seeder (The Constitution)
   3 | # @author: The Engineer (ansav8@gmail.com)
   4 | # @description: Seeds the "Immutable Laws", "Core Bricks", and "Navigation" of the OS.
   5 | # @security-level: LEVEL 9 (Registry Aligned)
   6 | # @invariant: Operations must be idempotent.
   7 | # @updated: Wired 'seed_navigation' to ensure UI Shell hydration.
   8 | 
   9 | import logging
  10 | from sqlalchemy import select
  11 | from sqlalchemy.ext.asyncio import AsyncSession
  12 | 
  13 | # Meta Models
  14 | from app.core.meta.models import PolicyDefinition
  15 | from app.core.meta.constants import PolicyResolutionStrategy, RuleActionType
  16 | 
  17 | # System Models (For Brick Registration)
  18 | from app.domains.system.models import KernelDomain, KernelScope
  19 | 
  20 | # ‚ö° META-KERNEL SEEDERS
  21 | from app.core.meta.features.states.seeds import seed_workflow_types
  22 | 
  23 | # ‚ö° FRACTAL SEEDERS (Feature Modules)
  24 | from app.domains.system.features.navigation.seeds import seed_navigation
  25 | 
  26 | logger = logging.getLogger("flodock.domains.system.seeds")
  27 | 
  28 | # ==============================================================================
  29 | #  THE LAWS (Policy Definitions)
  30 | #  The System defines these, but does NOT bind them to specific domains.
  31 | # ==============================================================================
  32 | CONST_POLICIES = [
  33 |     {
  34 |         "key": "sys_root_integrity_v1",
  35 |         "name": "Root Account Integrity Protocol",
  36 |         "description": "Enforces that all System Users (Bots) must possess Admin privileges.",
  37 |         "resolution": PolicyResolutionStrategy.ALL_MUST_PASS,
  38 |         "rules": [
  39 |             {
  40 |                 "logic": "host.is_system_user && host.role != 'admin'",
  41 |                 "action": RuleActionType.BLOCK,
  42 |                 "message": "[BLOCK] SECURITY VIOLATION: System Service Accounts must have 'admin' role."
  43 |             }
  44 |         ]
  45 |     },
  46 |     {
  47 |         "key": "sys_data_hygiene_v1",
  48 |         "name": "Global Data Hygiene",
  49 |         "description": "Ensures no critical entities are created with placeholder text.",
  50 |         "resolution": PolicyResolutionStrategy.AT_LEAST_ONE, 
  51 |         "rules": [
  52 |             {
  53 |                 "logic": "contains(host.email, '@example.com') || contains(host.email, 'test')",
  54 |                 "action": RuleActionType.WARN, 
  55 |                 "message": "[WARN] DATA QUALITY: Please use real corporate email addresses."
  56 |             }
  57 |         ]
  58 |     }
  59 | ]
  60 | 
  61 | # ==============================================================================
  62 | #  THE SYSTEM BRICKS (Core Scopes)
  63 | # ==============================================================================
  64 | CONST_SYSTEM_DOMAIN = {
  65 |     "key": "SYS",
  66 |     "label": "System Internals",
  67 |     "is_virtual": True,
  68 |     "module_icon": "antd:SettingOutlined" # ‚ö° THE FIX: Ensures DB is populated
  69 | }
  70 | 
  71 | CONST_SYSTEM_SCOPES = [
  72 |     {
  73 |         "key": "CONTAINER",
  74 |         "label": "Menu Group",
  75 |         "type": "CONTAINER",
  76 |         "target_field": None,
  77 |         "config": {
  78 |             "icon": "antd:FolderOutlined",
  79 |             "description": "A visual container for grouping other apps."
  80 |         }
  81 |     }
  82 | ]
  83 | 
  84 | # --- WAVE 1: STATIC DEFINITIONS ---
  85 | async def seed_static(db: AsyncSession):
  86 |     """
  87 |     @description: Writes the Constitution, Core Bricks, and UI Shell to the Meta-Kernel.
  88 |     """
  89 |     logger.info("   üìú [System] Ratifying the Constitution (Policies)...")
  90 |     
  91 |     # 1. Seed Policies
  92 |     for p_def in CONST_POLICIES:
  93 |         stmt = select(PolicyDefinition).where(PolicyDefinition.key == p_def["key"])
  94 |         existing = await db.execute(stmt)
  95 |         if existing.scalars().first():
  96 |             continue
  97 | 
  98 |         policy = PolicyDefinition(
  99 |             key=p_def["key"],
 100 |             name=p_def["name"],
 101 |             description=p_def["description"],
 102 |             resolution=p_def["resolution"],
 103 |             rules=p_def["rules"],
 104 |             is_active=True
 105 |         )
 106 |         db.add(policy)
 107 |         logger.info(f"      [LAW] Ratified: {p_def['key']}")
 108 | 
 109 |     await db.commit() 
 110 |     
 111 |     # 2. Seed System Domain & Bricks
 112 |     logger.info("   üß± [System] Registering Core Bricks...")
 113 |     
 114 |     # Ensure SYS Domain
 115 |     stmt_dom = select(KernelDomain).where(KernelDomain.key == CONST_SYSTEM_DOMAIN["key"])
 116 |     res_dom = await db.execute(stmt_dom)
 117 |     if not res_dom.scalars().first():
 118 |         sys_domain = KernelDomain(
 119 |             key=CONST_SYSTEM_DOMAIN["key"],
 120 |             label=CONST_SYSTEM_DOMAIN["label"],
 121 |             is_virtual=CONST_SYSTEM_DOMAIN["is_virtual"],
 122 |             module_icon=CONST_SYSTEM_DOMAIN["module_icon"],
 123 |             type_key="SYSTEM"
 124 |         )
 125 |         db.add(sys_domain)
 126 |         logger.info(f"      [DOMAIN] Registered: {CONST_SYSTEM_DOMAIN['key']}")
 127 |         await db.commit()
 128 | 
 129 |     # Ensure SYS Scopes
 130 |     for s_def in CONST_SYSTEM_SCOPES:
 131 |         stmt_scope = select(KernelScope).where(
 132 |             KernelScope.domain_key == CONST_SYSTEM_DOMAIN["key"],
 133 |             KernelScope.key == s_def["key"]
 134 |         )
 135 |         res_scope = await db.execute(stmt_scope)
 136 |         if not res_scope.scalars().first():
 137 |             scope = KernelScope(
 138 |                 domain_key=CONST_SYSTEM_DOMAIN["key"],
 139 |                 key=s_def["key"],
 140 |                 label=s_def["label"],
 141 |                 type=s_def["type"],
 142 |                 target_field=s_def["target_field"],
 143 |                 config=s_def["config"]
 144 |             )
 145 |             db.add(scope)
 146 |             logger.info(f"      [BRICK] Registered: {s_def['key']}")
 147 |     
 148 |     await db.commit()
 149 | 
 150 |     # 3. ‚ö° HYDRATE WORKFLOW TYPES (State Engine V3)
 151 |     try:
 152 |         await seed_workflow_types(db)
 153 |     except Exception as e:
 154 |         logger.error(f"üî• [System] Workflow Type Seeding Failed: {e}")
 155 | 
 156 |     # 4. ‚ö° HYDRATE NAVIGATION (Fractal UI Shell)
 157 |     # This ensures the Sidebar and Avatar Menu are populated on boot.
 158 |     try:
 159 |         await seed_navigation(db)
 160 |     except Exception as e:
 161 |         logger.error(f"üî• [System] Navigation Seeding Failed: {e}")
 162 | 
 163 | # --- WAVE 2: ASSETS ---
 164 | async def seed_assets(db: AsyncSession):
 165 |     pass 
 166 | 
 167 | # --- WAVE 3: HISTORY ---
 168 | async def seed_history(db: AsyncSession):
 169 |     pass
 170 | 

================================================================================

# Source code from: backend\trigger_meta.py
---------------------------------------------
   1 | # FILEPATH: backend/trigger_meta.py
   2 | # @file: Meta-Kernel CDC Trigger
   3 | # @author: The Engineer
   4 | # @description: Creates a PolicyDefinition to verify CDC on 'CORE' domains.
   5 | # Tests the "Meta-Kernel" Coverage.
   6 | 
   7 | import asyncio
   8 | import logging
   9 | import sys
  10 | import os
  11 | 
  12 | # ‚ö° BOOTSTRAP PATH
  13 | sys.path.append(os.path.dirname(os.path.abspath(__file__)))
  14 | 
  15 | from sqlalchemy.orm import Session
  16 | from app.core.database.session import AsyncSessionLocal
  17 | from app.core.meta.models import PolicyDefinition
  18 | from app.core.meta.constants import PolicyResolutionStrategy, RuleActionType
  19 | from app.core.kernel.interceptor import LogicInterceptor
  20 | from app.core.kernel.registry import domain_registry
  21 | import app.core.meta.registry # Ensure registration
  22 | 
  23 | # Setup Logging
  24 | logging.basicConfig(level=logging.INFO, format="%(asctime)s [%(levelname)s] [META-TEST] %(message)s")
  25 | logger = logging.getLogger("trigger.meta")
  26 | 
  27 | async def fire_meta_event():
  28 |     logger.info("üß™ [Meta] Initiating Policy CDC Test...")
  29 |     
  30 |     # Register Interceptor
  31 |     LogicInterceptor.register(Session)
  32 |     
  33 |     # Verify Registration
  34 |     meta_ctx = domain_registry.get_domain("META")
  35 |     if not meta_ctx:
  36 |         logger.error("‚ùå META Domain NOT registered in Kernel!")
  37 |         return
  38 |     logger.info(f"‚úÖ META Domain Registered (Type: {meta_ctx.domain_type})")
  39 | 
  40 |     async with AsyncSessionLocal() as db:
  41 |         try:
  42 |             # 1. Create Policy
  43 |             policy_key = "sys_test_cdc_v1"
  44 |             
  45 |             logger.info(f"   Creating Policy: {policy_key}")
  46 |             policy = PolicyDefinition(
  47 |                 key=policy_key,
  48 |                 name="CDC Verification Policy",
  49 |                 description="Temporary policy to test Outbox.",
  50 |                 resolution=PolicyResolutionStrategy.ALL_MUST_PASS,
  51 |                 rules=[{
  52 |                     "logic": "true == true",
  53 |                     "action": RuleActionType.WARN,
  54 |                     "message": "CDC Test"
  55 |                 }],
  56 |                 is_active=True
  57 |             )
  58 |             
  59 |             db.add(policy)
  60 |             
  61 |             # 2. Commit (Triggers Interceptor)
  62 |             logger.info("üíæ [Commit] Saving to DB...")
  63 |             await db.commit()
  64 |             
  65 |             logger.info("‚úÖ [Success] Policy Saved.")
  66 |             logger.info("   üëâ Run 'probe_diagnostics.py'. Look for 'META:CREATED'.")
  67 | 
  68 |         except Exception as e:
  69 |             logger.error(f"üî• [Failure] {e}", exc_info=True)
  70 |             await db.rollback()
  71 | 
  72 | if __name__ == "__main__":
  73 |     if sys.platform == 'win32':
  74 |         asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
  75 |     asyncio.run(fire_meta_event())
  76 | 

================================================================================

# Source code from: backend\SYSTEM_ATLAS.md
---------------------------------------------
   1 | # üó∫Ô∏è SYSTEM ATLAS: `backend/`
   2 | **Generated:** 2026-02-20 15:02
   3 | 
   4 | ---
   5 | ### üìÑ `backend/alembic/env.py`
   6 | **Components & Logic:**
   7 | 
   8 | - ∆í **`load_all_domain_models`**
   9 |     > *Scans the 'app/domains' directory.*
  10 |     * pkgutil.iter_modules returns (module_loader, name, ispkg)
  11 |     * Construct the potential module path (e.g., app.domains.shipping.models)
  12 |     * Check if models.py physically exists (Prevent Import Errors)
  13 |     * This is fine. Not every domain needs a database table.
  14 |     * Import the module. This executes the Class definitions,
  15 |     * registering them with the global Base.metadata.
  16 |     * **CRITICAL:** If a model file exists but crashes, we must stop migrations.
  17 | 
  18 | - ∆í **`run_migrations_offline`**
  19 |     > *Run migrations in 'offline' mode.*
  20 | - ∆í **`do_run_migrations`**
  21 | - ∆í **`run_migrations_online`**
  22 |     > *Run migrations in 'online' mode.*
  23 | 
  24 | ---
  25 | ### üìÑ `backend/app/api/v1/auth.py`
  26 | **Components & Logic:**
  27 | 
  28 | - ∆í **`login`**
  29 |     > *OAuth2 compatible token login.*
  30 |     * **1.** Find User by Email
  31 |     * **2.** Validate Existence
  32 |     * **3.** GUARDRAIL: System User Check (Hard Logic)
  33 |     * **4.** Verify Password
  34 |     * **5.** Check Active Status
  35 |     * --- üõ°Ô∏è KERNEL GOVERNANCE (The "Brain") ---
  36 |     * We ask the Logic Engine if this specific user is allowed to LOGIN right now.
  37 |     * --- üìù STATE UPDATE & AUDIT (The "Memory") ---
  38 |     * Update Last Login (Triggers a DB Write)
  39 |     * Publish Audit Event to SystemOutbox
  40 |     * **‚ö° FIX:** Added partition_key for Kafka Ordering
  41 |     * Commit Transaction (Saves User Update + Outbox Event atomically)
  42 |     * **6.** Mint Token
  43 | 
  44 | 
  45 | ### üìÑ `backend/app/api/v1/meta.py`
  46 | **Components & Logic:**
  47 | 
  48 | - ∆í **`list_policies`**
  49 | - ∆í **`create_policy`**
  50 | - ∆í **`update_policy`**
  51 | - ∆í **`dry_run_policy`**
  52 | - ∆í **`get_policy_history`**
  53 | - ∆í **`restore_policy_version`**
  54 | - ∆í **`list_bindings`**
  55 | - ∆í **`create_binding`**
  56 | - ∆í **`update_binding`**
  57 | - ∆í **`delete_binding`**
  58 | - ∆í **`create_attribute`**
  59 | - ∆í **`update_attribute`**
  60 | - ∆í **`delete_attribute`**
  61 | - ∆í **`list_rules`**
  62 | - ∆í **`create_rule`**
  63 | - ∆í **`get_domain_schema`**
  64 |     > *SCHEMA FUSION ENDPOINT.*
  65 | - ∆í **`list_domains`**
  66 |     * **1.** Dynamic Domains from DB (The "Wild" Ones)
  67 |     * Allows discovery of domains that exist only via custom attributes
  68 |     * **2.** System Domains from Registry (The "Official" Ones)
  69 |     * **‚ö° FIX:** Passing 'db' session as required by the new Manager to fetch Type Defs
  70 |     * **3.** Merge Strategy
  71 |     * A. Add Registered Domains (Source of Truth)
  72 |     * Pydantic model dump to dictionary for mutability
  73 |     * B. Add Dynamic Domains (if any found that aren't registered)
  74 | 
  75 | 
  76 | ### üìÑ `backend/app/api/v1/resource.py`
  77 | **Components & Logic:**
  78 | 
  79 | - ∆í **`deep_merge`**
  80 |     > *Recursively merges dictionaries to preserve nested data.*
  81 | - ∆í **`get_domain_context`**
  82 |     > *Retrieves the full Registry Contract for a domain.*
  83 | - ∆í **`validate_and_cast`**
  84 |     > *Enforces Strict Typing for Dynamic Fields based on AttributeDefinition.*
  85 | - ∆í **`sanitize_payload`**
  86 |     > *1. Splits payload into Columns vs Extras.*
  87 |     * Check if the model actually has the configured container
  88 |     * **1.** Fetch Dynamic Definitions (The Law)
  89 |     * **‚ö° SECURITY:** Transformation Pipeline
  90 |     * --- A. STATIC COLUMNS ---
  91 |     * ‚ö° METADATA DRIVEN PROTECTION
  92 |     * If the Model says "is_system", we skip it. No magic strings.
  93 |     * Fallback: If DB controls the default (e.g. auto-increment, triggers), skip unless explicit.
  94 |     * --- B. DYNAMIC ATTRIBUTES ---
  95 |     * Dynamic Attributes marked as system are also protected
  96 |     * Allow bulk update of the container itself if passed directly
  97 |     * If strict mode is off, we might allow ad-hoc extras, but for now we only allow defined attributes
  98 |     * or explicit updates to the container.
  99 |     * Store unknown fields in extras?
 100 |     * Policy: If it's not a column and not in dictionary, we treat it as ad-hoc extra.
 101 | 
 102 | - ∆í **`serialize_model`**
 103 |     * **1.** Flatten Columns
 104 |     * **2.** Flatten Dynamic Container (e.g. preferences)
 105 |     * Columns take precedence, so only add if not already present
 106 | 
 107 | - ∆í **`check_availability`**
 108 |     > *Checks if a value exists in the database.*
 109 |     * ‚ö° META-TYPE CHECK: Availability not supported for CONFIG
 110 |     * Config keys are unique, so we check SystemConfig
 111 |     * **1.** Column Existence Check
 112 |     * **2.** PERFORMANCE GUARDRAIL
 113 |     * **3.** Execution
 114 |     * Case-insensitive check for emails/strings
 115 | 
 116 | - ∆í **`list_resources`**
 117 |     > *UNIVERSAL SEARCH ENGINE.*
 118 |     * ‚ö° BRANCH 1: CONFIG DOMAIN (Global)
 119 |     * Return list of SystemConfig items, potentially filtered by category
 120 |     * Simple filter support for Config
 121 |     * Serializer for Config
 122 |     * ‚ö° BRANCH 2: STANDARD DOMAIN (Entity)
 123 |     * **1.** Start with Base Query
 124 |     * **2.** Extract Filters (Exclude Control Params)
 125 |     * **3.** Apply Tri-Layer Filtering logic
 126 |     * LAYER 1: Physical Column
 127 |     * LAYER 2: Dynamic Attribute (JSONB)
 128 |     * ‚ö° Checks the configured container (custom_attributes OR preferences)
 129 |     * Safe JSONB lookup using SQLAlchemy text
 130 |     * LAYER 3: Ignore unknown params (Safety)
 131 |     * **4.** Calculate Total (Filtered)
 132 |     * **5.** Apply Pagination
 133 | 
 134 | - ∆í **`get_resource`**
 135 |     * ‚ö° META-TYPE CHECK
 136 |     * Config items usually accessed by Key, but if ID provided:
 137 | 
 138 | - ∆í **`create_resource`**
 139 |     * ‚ö° BRANCH 1: CONFIG DOMAIN
 140 |     * Create a new SystemConfig Entry
 141 |     * Payload expected: { key, value, label, category, type }
 142 |     * Check existence
 143 |     * ‚ö° HOT SWAP TRIGGER
 144 |     * ‚ö° BRANCH 2: STANDARD DOMAIN
 145 | 
 146 | - ∆í **`update_resource`**
 147 |     * ‚ö° BRANCH 1: CONFIG DOMAIN
 148 |     * ‚ö° HOT SWAP TRIGGER
 149 |     * ‚ö° BRANCH 2: STANDARD DOMAIN
 150 |     * ‚ö° DYNAMIC CONTAINER MERGE LOGIC
 151 | 
 152 | - ∆í **`delete_resource`**
 153 |     * ‚ö° META-TYPE CHECK: Config Deletion
 154 |     * ‚ö° HOT SWAP TRIGGER
 155 | 
 156 | 
 157 | ### üìÑ `backend/app/api/v1/system.py`
 158 | **Components & Logic:**
 159 | 
 160 | - ∆í **`get_system_manifest`**
 161 |     > *BOOTSTRAP ENDPOINT.*
 162 |     * ‚ö° ACQUIRE ACTOR CONTEXT (For RBAC)
 163 |     * The ContextMiddleware has already hydrated this from the JWT.
 164 |     * Pass actor to kernel to filter navigation nodes
 165 | 
 166 | - ∆í **`get_system_capabilities`**
 167 |     > *THE AI MANIFEST.*
 168 |     * **1.** Fetch Base Capabilities (Static Enums)
 169 |     * **2.** Augment with Context Schema
 170 |     * **3.** ‚ö° HYDRATE DYNAMIC WIDGETS (The Upgrade)
 171 |     * We replace the static enum list with the rich DB definitions if available.
 172 |     * Transform to strict schema for AI consumption
 173 |     * Fallback (or empty if none registered)
 174 |     * We keep the static enum as a fallback if the DB is empty
 175 |     * Fail open: Return static caps, don't crash the endpoint
 176 | 
 177 | - ∆í **`get_system_pulse`**
 178 | - ∆í **`list_domains`**
 179 | - ∆í **`patch_domain`**
 180 | - ∆í **`list_circuits`**
 181 |     > *Fetches raw Circuit Breakers.*
 182 |     * Simple serialization
 183 | 
 184 | - ∆í **`set_circuit_state`**
 185 |     > *Directly toggles a switch in the Hypervisor.*
 186 | - ∆í **`list_config`**
 187 | - ∆í **`update_config`**
 188 | 
 189 | ### üìÑ `backend/app/api/v1/workflow.py`
 190 | **Components & Logic:**
 191 | 
 192 | - üì¶ **`UIConfig`**
 193 | - üì¶ **`TransitionOption`**
 194 | - üì¶ **`TransitionRequest`**
 195 | - üì¶ **`TransitionResponse`**
 196 | - ∆í **`_load_machine_and_entity`**
 197 |     > *Shared logic to hydrate context with Scope support.*
 198 |     * **1.** Resolve Model
 199 |     * **2.** Fetch Entity
 200 |     * **3.** Fetch Definition
 201 | 
 202 | - ∆í **`get_transition_options`**
 203 |     > *Menu Builder. Evaluates Governance Rules and returns the strictly formatted Dumb UI manifest.*
 204 |     * Prepare Context Envelope for Governance Check
 205 |     * **1.** üõ°Ô∏è GOVERNANCE CHECK (The Handshake)
 206 |     * **2.** üé® VISUAL HEURISTICS (Backend drives the UI)
 207 |     * Override with explicit XState metadata if available
 208 |     * **3.** BUILD OPTION
 209 | 
 210 | - ∆í **`execute_transition`**
 211 |     > *Executes a State Transition with Context.*
 212 |     * **1.** üõ°Ô∏è PRELIMINARY DRY RUN (Governance Validation before DB touch)
 213 |     * Simulate the payload being applied to the context envelope for evaluation
 214 |     * We return a List of errors so the frontend Array.isArray(detail) parsing works
 215 |     * **2.** üíæ DYNAMIC DATA PERSISTENCE LAYER
 216 |     * A. Dynamically fetch Primary Keys
 217 |     * B. Combine PKs with standard system fields
 218 |     * **3.** üõ°Ô∏è ATTACH SIDECAR (For Interceptor & CDC Events)
 219 |     * Trigger the status change (marks object as dirty for SQLAlchemy)
 220 |     * ‚ö° COMMITTING THE DB TRIGGERS THE INTERCEPTOR (Final Logic Pass & Outbox)
 221 | 
 222 | 
 223 | ---
 224 | ### üìÑ `backend/app/core/ai/router.py`
 225 | **Components & Logic:**
 226 | 
 227 | - üì¶ **`AIRequest`**
 228 | - ∆í **`generate_schema`**
 229 |     * We pass context to the service, which extracts the 'mode' from the SYSTEM_INSTRUCTION item
 230 | 
 231 | 
 232 | ### üìÑ `backend/app/core/ai/service.py`
 233 | **Components & Logic:**
 234 | 
 235 | - üì¶ **`AIService`**
 236 |     > *The Intelligence Layer.*
 237 |   * üîπ **`__init__`**
 238 |       * Initialize the new GenAI Client
 239 | 
 240 |   * üîπ **`generate_schema`**
 241 |       > *Generates content based on User Intent + System Context + Operation Mode.*
 242 |       * **1.** ANALYZE CONTEXT & MODE
 243 |       * Default to WIZARD if no instruction found
 244 |       * ‚ö° DETECT MODE FROM FRONTEND
 245 |       * **2.** CONSTRUCT SYSTEM PROMPT BASED ON MODE
 246 |       * --- CHAT MODE ---
 247 |       * --- WIZARD / JOB / GOVERNANCE MODES ---
 248 |       * **3.** EXECUTE GENERATION
 249 |       * **4.** PARSE OUTPUT
 250 |       * For chat, we return a structured wrapper so the frontend still receives a List[Dict]
 251 |       * For Wizard/Job, we enforce JSON
 252 |       * Heuristic fallback if wrapped in markdown
 253 |       * Attempt to fix single object return
 254 |       * Fallback logic for partial JSON
 255 | 
 256 | 
 257 | ---
 258 | ### üìÑ `backend/app/core/config.py`
 259 | **Components & Logic:**
 260 | 
 261 | - üì¶ **`Settings`**
 262 | 
 263 | ### üìÑ `backend/app/core/context.py`
 264 | **Components & Logic:**
 265 | 
 266 | - üì¶ **`GlobalContext`**
 267 |     > *Static Accessor for the Runtime Context.*
 268 |   * üîπ **`get_request_id`**
 269 |       > *Returns the unique trace ID for the current operation.*
 270 |   * üîπ **`set_request_id`**
 271 |       > *Sets the trace ID. usually called by Middleware.*
 272 |   * üîπ **`get_current_user`**
 273 |       > *Returns the currently authenticated user as a dictionary.*
 274 |   * üîπ **`set_current_user`**
 275 |       > *Hydrates the user context.*
 276 |   * üîπ **`get_actor_id`**
 277 |       > *Helper to safely get the User ID (0 for System).*
 278 |   * üîπ **`is_system_user`**
 279 |       > *True if running as background worker or system process.*
 280 |   * üîπ **`set_admin_mode`**
 281 |       > *Allows bypassing certain policies (Emergency Override).*
 282 |   * üîπ **`is_admin_mode`**
 283 | 
 284 | ---
 285 | ### üìÑ `backend/app/core/database/base.py`
 286 | **Components & Logic:**
 287 | 
 288 | - üì¶ **`Base`**
 289 |     > *The shared registry for all database models.*
 290 | 
 291 | ### üìÑ `backend/app/core/database/session.py`
 292 | **Components & Logic:**
 293 | 
 294 | - ∆í **`get_db`**
 295 | 
 296 | ---
 297 | ### üìÑ `backend/app/core/kernel/actions.py`
 298 | **Components & Logic:**
 299 | 
 300 | - üì¶ **`ActionType`**
 301 |     > *The available effects a Rule can trigger.*
 302 | - üì¶ **`LogicResult`**
 303 |     > *The 'Report Card' returned by the Logic Engine after checking all rules.*
 304 |   * üîπ **`merge`**
 305 |       > *Helper to combine results from multiple rule checks.*
 306 | 
 307 | ---
 308 | ### üìÑ `backend/app/core/kernel/context/base.py`
 309 | **Components & Logic:**
 310 | 
 311 | - üì¶ **`ContextField`**
 312 | - üì¶ **`ContextProvider`**
 313 |     > *The Plugin Interface for Environmental Context.*
 314 |   * üîπ **`namespace`**
 315 |       > *The root key for this context (e.g. 'system', 'actor').*
 316 |   * üîπ **`provide_schema`**
 317 |       > *INTROSPECTION: Returns the list of available variables.*
 318 |   * üîπ **`provide_runtime`**
 319 |       > *EXECUTION: Returns the actual values at runtime.*
 320 | 
 321 | ### üìÑ `backend/app/core/kernel/context/config.py`
 322 | **Components & Logic:**
 323 | 
 324 | - üì¶ **`ConfigProvider`**
 325 |     > *The Bridge between the System Config Database and the Policy Engine.*
 326 |   * üîπ **`namespace`**
 327 |   * üîπ **`provide_schema`**
 328 |       > *INTROSPECTION: Allows the Frontend Rule Builder to see available Config Keys.*
 329 |   * üîπ **`provide_runtime`**
 330 |       > *EXECUTION: Returns the actual Key-Value pairs for the Logic Engine.*
 331 |       * **1.** Check Cache
 332 |       * **2.** Cache Miss -> Fetch from DB
 333 | 
 334 |   * üîπ **`_is_cache_valid`**
 335 |       > *Checks if the RAM cache is fresh.*
 336 |   * üîπ **`_refresh_cache`**
 337 |       > *Reloads the configuration from the database.*
 338 |       * ‚ö° FETCH ALL ACTIVE CONFIGS
 339 |       * key is UPPERCASE by convention in SystemConfig
 340 |       * Update State
 341 | 
 342 |   * üîπ **`invalidate`**
 343 |       > *EXTERNAL SIGNAL: Called by SystemOutbox Consumer or API to force a refresh.*
 344 | 
 345 | ### üìÑ `backend/app/core/kernel/context/defaults.py`
 346 | **Components & Logic:**
 347 | 
 348 | - üì¶ **`SystemProvider`**
 349 |     > *Provides the Space-Time Continuum (Time, Env, Version).*
 350 |   * üîπ **`namespace`**
 351 |   * üîπ **`provide_schema`**
 352 |   * üîπ **`provide_runtime`**
 353 | - üì¶ **`ActorProvider`**
 354 |     > *Provides the Agent of Change (User, Role).*
 355 |   * üîπ **`namespace`**
 356 |   * üîπ **`provide_schema`**
 357 |   * üîπ **`provide_runtime`**
 358 |       * Fallback for Background Workers / Seeds
 359 | 
 360 | 
 361 | ### üìÑ `backend/app/core/kernel/context/manager.py`
 362 | **Components & Logic:**
 363 | 
 364 | - üì¶ **`ContextManager`**
 365 |     > *Singleton Orchestrator.*
 366 |   * üîπ **`__init__`**
 367 |   * üîπ **`register`**
 368 |       > *Plugins call this to hook into the Kernel.*
 369 |   * üîπ **`get_schema`**
 370 |       > *Used by API to serve capabilities to Frontend.*
 371 |   * üîπ **`resolve`**
 372 |       > *Used by LogicInterceptor to build the Envelope.*
 373 |       * In strict fractal design, failures in context should not crash the transaction.
 374 |       * We log and return empty for that namespace.
 375 | 
 376 | 
 377 | ---
 378 | ### üìÑ `backend/app/core/kernel/decorators.py`
 379 | **Components & Logic:**
 380 | 
 381 | - ∆í **`kernel_register`**
 382 |     > *Decorator to register a SQLAlchemy Model as a Kernel Business Domain.*
 383 |     * **1.** Prepare Scopes (Level 6 Compliance Patch)
 384 |     * ‚ö° SMART DEFAULTING
 385 |     * We interpret the legacy string list into typed configurations
 386 |     * Master Lifecycle Scope
 387 |     * Default to Generic Action
 388 |     * **2.** Define Auto-Reflection Schema Provider
 389 |     * A. Scan Columns (Primitives)
 390 |     * Map SQL Types to Meta-Kernel Types
 391 |     * Defaults
 392 |     * Special Case: 'email'
 393 |     * ‚ö° INTELLIGENT SYSTEM DETECTION
 394 |     * A field is 'system' (read-only) if it's managed by the kernel
 395 |     * ‚ö° CORRECTED FLAGS
 396 |     * B. ‚ö° NEW: Scan Relationships (Associations)
 397 |     * Determine type: List (One-to-Many) or Single (Many-to-One)
 398 |     * Target table name
 399 |     * We map these as special types
 400 |     * Usually we don't edit relationships directly here
 401 |     * **3.** Define Default Context Loader
 402 |     * **4.** Construct the Contract
 403 |     * ‚ö° META-TYPE INJECTION (The Fix)
 404 |     * This passes the user's intent (e.g. DomainType.CONFIG) to the Registry.
 405 |     * **5.** Execute Registration
 406 | 
 407 | 
 408 | ### üìÑ `backend/app/core/kernel/enforcer.py`
 409 | **Components & Logic:**
 410 | 
 411 | - üì¶ **`DomainEnforcer`**
 412 |     > *The Enforcer Layer.*
 413 |   * üîπ **`_extract_targets`**
 414 |       > *Parses the URL to find the target Domain AND Scope.*
 415 |       * Expected formats:
 416 |       * **1.** /api/v1/resource/DOMAIN/... (Domain only)
 417 |       * **2.** /api/v1/meta/states/DOMAIN/SCOPE (Domain + Scope)
 418 |       * **3.** /api/v1/workflow/DOMAIN/SCOPE/... (Domain + Scope)
 419 |       * Handle Meta States: /api/v1/meta/states/{DOMAIN}/{SCOPE}
 420 |       * Handle Workflows: /api/v1/workflow/{DOMAIN}/{SCOPE}/...
 421 |       * Handle Resource: /api/v1/resource/{DOMAIN}/... (Domain only usually)
 422 |       * Resource IDs are not scopes, so scope_key remains None
 423 | 
 424 |   * üîπ **`is_api_allowed`**
 425 |       > *Validates if the target domain AND scope are open via the Circuit Breaker.*
 426 |       * **1.** System bypass (Always allow SYS/AUTH to prevent lockouts)
 427 |       * **2.** Level 1 Check: Domain Circuit
 428 |       * **3.** Level 2 Check: Scope Circuit (if a scope was identified)
 429 |       * Check specific scope switch
 430 |       * Special Case: UI requests to API might fail here if we don't distinguish planes.
 431 |       * But Enforcer is an API Guard, so we check API plane.
 432 |       * Note: Ideally, the Frontend UI plane should have hidden the link,
 433 |       * but this acts as the hard gate.
 434 | 
 435 | 
 436 | ### üìÑ `backend/app/core/kernel/events.py`
 437 | **Components & Logic:**
 438 | 
 439 | - üì¶ **`EventError`**
 440 |     > *Base exception for Event definition errors.*
 441 | - üì¶ **`SystemEvent`**
 442 |     > *The Source of Truth for a System Event.*
 443 |   * üîπ **`__post_init__`**
 444 |       > *Validates the Contract immediately upon instantiation.*
 445 |   * üîπ **`_validate_naming_convention`**
 446 |       > *Enforces Strict Naming: DOMAIN:VERB (UPPERCASE)*
 447 |   * üîπ **`_validate_version_format`**
 448 |       > *‚ö° Enforces SemVer Format (X.Y.Z)*
 449 |       * Supports 1.0.0, 1.0.0-alpha, etc.
 450 |       * Legacy support: If passed as int, convert (but warn) - No, strict fail is better for Level 9.
 451 |       * Auto-convert int to SemVer (1 -> 1.0.0) if legacy code exists?
 452 |       * No, Architect demands strictness.
 453 |       * But for transition, we might allow it momentarily if needed.
 454 |       * Let's enforce string.
 455 | 
 456 |   * üîπ **`_validate_schema_structure`**
 457 |       > *Ensures payload_schema is a dictionary (JSON compatible).*
 458 | - üì¶ **`Schemas`**
 459 | 
 460 | ### üìÑ `backend/app/core/kernel/interceptor.py`
 461 | **Components & Logic:**
 462 | 
 463 | - üì¶ **`LogicInterceptor`**
 464 |     > *The Universal Gateway.*
 465 |   * üîπ **`register`**
 466 |   * üîπ **`before_flush`**
 467 |       * ‚ö° NOISE FILTER: Skip Outbox to prevent infinite loops
 468 | 
 469 |   * üîπ **`_process_object`**
 470 |       * **1.** ‚ö° DYNAMIC DOMAIN RESOLUTION (No more hardcoded dicts)
 471 |       * We assume the domain matches the class name, unless overridden by the model itself.
 472 |       * Fallback for internal Kernel structures (Optional but safe)
 473 |       * **2.** ‚ö° PRE-FLIGHT: Freeze & Calculate Changes
 474 |       * Construct default envelope
 475 |       * **3.** üß† THE BRAIN: GOVERNANCE ENGINE (Decoupled Sidecar)
 476 |       * Apply mutations if permitted
 477 |       * ‚ö° FAIL-OPEN RESILIENCE: If Brain crashes, allow the body to survive.
 478 |       * **4.** üèÉ THE BODY: WORKFLOW ENGINE (Decoupled)
 479 |       * Need an ephemeral async session just to fetch state defs for the workflow engine
 480 |       * **5.** ü§ù THE HANDSHAKE: Governance checks Workflow's Transition Request
 481 |       * Schedule side-effects (Actions)
 482 |       * **6.** ‚ö° CHANGE DATA CAPTURE (CDC)
 483 | 
 484 |   * üîπ **`_schedule_workflow_effect`**
 485 |   * üîπ **`_json_friendly`**
 486 |   * üîπ **`_freeze_entity`**
 487 |   * üîπ **`_serialize_entity`**
 488 |   * üîπ **`_apply_mutations`**
 489 |   * üîπ **`_buffer_side_effects`**
 490 |   * üîπ **`_calculate_changeset`**
 491 | 
 492 | ### üìÑ `backend/app/core/kernel/kernel.py`
 493 | **Components & Logic:**
 494 | 
 495 | - üì¶ **`Kernel`**
 496 |     > *The Event Publisher.*
 497 |   * üîπ **`__init__`**
 498 |       * Stateless singleton pattern
 499 | 
 500 |   * üîπ **`publish`**
 501 |       > *Ingests an event into the System Outbox.*
 502 |       * **1.** RESOLVE METADATA
 503 |       * **2.** RESOLVE CONTEXT
 504 |       * We grab the Trace ID from the request context to link API logs with Kafka logs
 505 |       * **3.** RESOLVE PARTITION KEY (Critical for Kafka)
 506 |       * If not provided, we try to use entity_id. If that's missing, we fallback to "global".
 507 |       * **WARNING:** "global" puts everything on one partition (ordering guaranteed but low throughput).
 508 |       * **4.** ENVELOPE CONSTRUCTION
 509 |       * **5.** WRITE TO OUTBOX
 510 |       * In Level 100, we DO raise. If the event cannot be logged, the transaction is unsafe.
 511 | 
 512 |   * üîπ **`commit`**
 513 |       > *Finalizes the transaction.*
 514 | 
 515 | ### üìÑ `backend/app/core/kernel/logic_engine.py`
 516 | **Components & Logic:**
 517 | 
 518 | - üì¶ **`LogicEngine`**
 519 |     > *[DEPRECATED] v1 Logic Engine.*
 520 |   * üîπ **`__init__`**
 521 |   * üîπ **`evaluate`**
 522 |       * Simple passthrough logic for legacy RuleDefinitions
 523 |       * (Preserved from original implementation to prevent crashing legacy tests)
 524 |       * **1.** Build Context
 525 | 
 526 | 
 527 | ### üìÑ `backend/app/core/kernel/models.py`
 528 | **Components & Logic:**
 529 | 
 530 | - üì¶ **`SystemOutbox`**
 531 |     > *TRANSACTIONAL OUTBOX (The Kafka Waiting Room).*
 532 |   * üîπ **`to_dict`**
 533 |       > *Serialization helper for the Relay.*
 534 | 
 535 | ---
 536 | ### üìÑ `backend/app/core/kernel/payload/factory.py`
 537 | **Components & Logic:**
 538 | 
 539 | - üì¶ **`ChangeContext`**
 540 |     > *A Context Manager that watches an Entity and the Database Session*
 541 |   * üîπ **`__init__`**
 542 |       * State Storage
 543 |       * Capture trace if available from request
 544 | 
 545 |   * üîπ **`set_entity`**
 546 |       > *Allows setting the entity late (e.g., if it was just created inside the block).*
 547 |   * üîπ **`add_extended_data`**
 548 |       > *Injects ad-hoc data into the 'extended_data' block of the payload.*
 549 |   * üîπ **`_serialize_value`**
 550 |       > *Helper to safely serialize DB values.*
 551 |   * üîπ **`_snapshot`**
 552 |       > *Serializes a SQLAlchemy model into a clean dictionary using Inspection.*
 553 |       * Map columns
 554 | 
 555 |   * üîπ **`_enrich`**
 556 |       > *Delegates to the PayloadManager to find domain-specific enrichment logic.*
 557 |   * üîπ **`_calculate_changes`**
 558 |       > *Generates the Delta (Old vs New).*
 559 |       * Simple equality check
 560 | 
 561 |   * üîπ **`_detect_impact`**
 562 |       > *Scans the generic DB session to find ALL tables touched in this transaction.*
 563 |       * Check New, Dirty, and Deleted objects in the session
 564 | 
 565 |   * üîπ **`__enter__`**
 566 |       * Capture "Before" State
 567 | 
 568 |   * üîπ **`__exit__`**
 569 |       * If code crashed (Exception raised), don't build payload.
 570 |       * Let the exception propagate.
 571 |       * Capture "After" State
 572 |       * If entity was set late (creation), snapshot it now
 573 |       * **1.** Logic Calculation
 574 |       * **2.** Federated Enrichment
 575 |       * Merge manual extended data with domain strategy data
 576 |       * **3.** Build Context (Actor)
 577 |       * **4.** CONSTRUCT THE ENTERPRISE PAYLOAD
 578 | 
 579 | 
 580 | ### üìÑ `backend/app/core/kernel/payload/manager.py`
 581 | **Components & Logic:**
 582 | 
 583 | - üì¶ **`PayloadManager`**
 584 |     > *Central Registry for Event Payload Strategies.*
 585 |   * üîπ **`__init__`**
 586 |       * Maps Model Class -> Strategy Function
 587 | 
 588 |   * üîπ **`register`**
 589 |       > *Registers a strategy function for a specific SQLAlchemy model.*
 590 |   * üîπ **`get_strategy`**
 591 |       > *Retrieves the strategy function for a given model instance.*
 592 | 
 593 | ---
 594 | ### üìÑ `backend/app/core/kernel/registry/base.py`
 595 | **Components & Logic:**
 596 | 
 597 | - üì¶ **`DomainType`**
 598 |     > *Defines the visibility and lifecycle of a Domain.*
 599 | - üì¶ **`DomainContext`**
 600 |     > *The Dynamic Contract.*
 601 |   * üîπ **`__init__`**
 602 |       * **‚ö° RESTORED:** Meta-Type Classification
 603 |       * ‚ö° v3 UPGRADE: Multi-Entity Support
 604 |       * New: {"PREFS": PrefModel, "LOG": LogModel}
 605 |       * Metadata
 606 |       * **‚ö° OPTIONAL:** Schema Discriminator for Polymorphic Domains
 607 |       * ‚ö° ENTITY REGISTRY LOGIC (The Shim)
 608 |       * Auto-register root if not in entities (Backward Compatibility)
 609 | 
 610 |   * üîπ **`validate`**
 611 |       > *Strict Validation of the Contract.*
 612 |       * Check Entities if present
 613 | 
 614 | - üì¶ **`ScopeConfig`**
 615 |     > *Helper for defining Scopes (Workflows).*
 616 | 
 617 | ### üìÑ `backend/app/core/kernel/registry/event_registry.py`
 618 | **Components & Logic:**
 619 | 
 620 | - üì¶ **`Signals`**
 621 |     > *Static container for all System Events.*
 622 | 
 623 | ### üìÑ `backend/app/core/kernel/registry/manager.py`
 624 | **Components & Logic:**
 625 | 
 626 | - üì¶ **`RegistryManager`**
 627 |   * üîπ **`__new__`**
 628 |   * üîπ **`register`**
 629 |       > *Code-First Registration (during boot).*
 630 |       * Validate v3 Contract
 631 | 
 632 |   * üîπ **`get_domain`**
 633 |       > *Direct access to the Domain Context by key (UPPERCASE).*
 634 |   * üîπ **`get_schema`**
 635 |       > *Retrieves the Static Schema for a Domain.*
 636 |       * ‚ö° EXECUTE CONTRACT
 637 |       * We pass the discriminator (default "DEFAULT") to allow polymorphic schemas
 638 | 
 639 |   * üîπ **`refresh_from_db`**
 640 |       > *Syncs the In-Memory Registry with the Database State.*
 641 |       * Fetch only active keys from the DB to determine current state
 642 |       * If key is in active_keys, it's active. Otherwise, it's disabled.
 643 |       * Fail Open: Don't disable everything if DB fails
 644 | 
 645 |   * üîπ **`get_all_summaries`**
 646 |       > *Returns full domain state including Dynamic Type Metadata.*
 647 |       * ‚ö° Eager load the 'type_def' and 'scopes' relationships
 648 |       * Pydantic 'from_attributes=True' handles the mapping automatically
 649 |       * (e.g. type_key -> type)
 650 | 
 651 |   * üîπ **`sync_to_db`**
 652 |       > *Ensures the Database matches the Code.*
 653 |       * --- 1. SYNC DOMAIN ---
 654 |       * **‚ö° FIX:** Handle Enum or String for domain_type
 655 |       * --- 2. SYNC ENTITIES (v3) ---
 656 |       * Construct full python path if possible
 657 |       * --- 3. SYNC SCOPES ---
 658 |       * Handle Tuple Routing (Legacy/v2 shim) or Dict (v3)
 659 |       * ("DOMAIN", {config})
 660 |       * If routing matches current domain, use it.
 661 |       * v3 Validation: Check Target Entity
 662 | 
 663 | 
 664 | ### üìÑ `backend/app/core/kernel/registry/schemas.py`
 665 | **Components & Logic:**
 666 | 
 667 | - üì¶ **`DomainTypeRead`**
 668 |     > *Metadata about the Domain Classification.*
 669 | - üì¶ **`ScopeSummary`**
 670 | - üì¶ **`DomainSummary`**
 671 |     > *The High-Level Manifest of a System Module.*
 672 | 
 673 | ---
 674 | ### üìÑ `backend/app/core/kernel/relay.py`
 675 | **Components & Logic:**
 676 | 
 677 | - üì¶ **`KafkaRelay`**
 678 |   * üîπ **`__init__`**
 679 |   * üîπ **`connect_kafka`**
 680 |   * üîπ **`start`**
 681 |   * üîπ **`process_batch`**
 682 |       * Poll Pending
 683 | 
 684 | 
 685 | ### üìÑ `backend/app/core/kernel/system.py`
 686 | **Components & Logic:**
 687 | 
 688 | - üì¶ **`SystemManifest`**
 689 |     > *The Single Source of Truth for the System's capabilities.*
 690 |   * üîπ **`generate`**
 691 |       > *Generates the full system manifest including modules, routes, circuit states, AND navigation.*
 692 |       * Ensure RAM cache is up to date with DB
 693 |       * **1.** Fetch Domains
 694 |       * **2.** Apply Circuit Breaker Logic (Hypervisor)
 695 |       * **1.** Determine Kernel State (Physical)
 696 |       * **2.** Determine UI Plane State (Hypervisor)
 697 |       * **3.** Merge Logic
 698 |       * **4.** Inject State into Config for Frontend Awareness
 699 |       * ‚ö° HIERARCHY INJECTION
 700 |       * **5.** ‚ö° GENERATE SECURED NAVIGATION
 701 |       * We pass the actor context (e.g. {"role": "admin"}) to the NavigationService.
 702 |       * It will evaluate any 'required_policy' hooks on the menu nodes.
 703 |       * If no actor is provided, we pass an empty context (Guest Mode).
 704 | 
 705 |   * üîπ **`get_capabilities`**
 706 |       > *Returns the Meta-Kernel capabilities (Widgets, Actions, Context).*
 707 |       * ‚ö° LAZY ACTIVATION: Context Defaults
 708 |       * **‚ö° OPTIMIZATION:** We do NOT load dynamic widgets here anymore.
 709 |       * ‚ö° DYNAMIC CONTEXT SCHEMA
 710 | 
 711 |   * üîπ **`_scan_enum`**
 712 |   * üîπ **`_build_action_capabilities`**
 713 |       > *‚ö° NEW: Constructs a Frontend-Ready grouped list of Action Capabilities.*
 714 | 
 715 | ### üìÑ `backend/app/core/kernel/worker.py`
 716 | **Components & Logic:**
 717 | 
 718 | - üì¶ **`BackgroundWorker`**
 719 |   * üîπ **`__init__`**
 720 |   * üîπ **`start`**
 721 |       * Don't crash the loop, just pause
 722 | 
 723 |   * üîπ **`process_batch`**
 724 |       * **1.** FETCH PENDING (Limit 10 to prevent clogging)
 725 | 
 726 |   * üîπ **`handle_event`**
 727 |       > *The Switchboard. Routes events to their specific handlers.*
 728 |       * ‚ö° ROUTING LOGIC
 729 |       * --- HANDLER: WORKFLOW TRANSITIONS ---
 730 |       * --- HANDLER: AUDIT ---
 731 |       * --- MARK SUCCESS ---
 732 |       * --- MARK FAILURE ---
 733 | 
 734 |   * üîπ **`_handle_workflow_action`**
 735 |       > *Executes business logic triggered by State Changes.*
 736 |       * In a real app, this calls SendGrid/SES
 737 | 
 738 | 
 739 | ---
 740 | ### üìÑ `backend/app/core/loader.py`
 741 | **Components & Logic:**
 742 | 
 743 | - ∆í **`load_domains`**
 744 |     > *1. Scans 'app/domains/' for sub-packages.*
 745 |     * Path to the domains directory
 746 |     * Iterate over all folders in app/domains
 747 |     * pkgutil.iter_modules returns (module_loader, name, ispkg)
 748 |     * Dynamically import the module (e.g., app.domains.auth)
 749 |     * Check for the 'router' attribute (The Plug)
 750 |     * ‚ö° CRITICAL FIX: Auto-Namespace the Route
 751 |     * **OLD:** prefix="/api/v1"
 752 |     * **NEW:** prefix="/api/v1/auth"
 753 |     * Register the Router
 754 | 
 755 | 
 756 | ---
 757 | ### üìÑ `backend/app/core/meta/api.py`
 758 | 
 759 | ### üìÑ `backend/app/core/meta/constants.py`
 760 | **Components & Logic:**
 761 | 
 762 | - üì¶ **`BindingType`**
 763 |     > *The Jurisdiction Class. Defines WHAT we are binding to.*
 764 | - üì¶ **`AttributeType`**
 765 |     > *The Data Type. Defines how the value is stored and validated.*
 766 | - üì¶ **`WidgetType`**
 767 |     > *The Interface Hint. Defines how the field is rendered.*
 768 | - üì¶ **`RuleEventType`**
 769 |     > *The Trigger.*
 770 | - üì¶ **`RuleActionType`**
 771 |     > *The Consequence.*
 772 | - üì¶ **`PolicyResolutionStrategy`**
 773 |     > *The Governance Logic.*
 774 | - üì¶ **`ViewEngineType`**
 775 |     > *The Renderer.*
 776 | - üì¶ **`ScopeType`**
 777 |     > *The Context Hierarchy. Defines the 'Type' of a KernelScope.*
 778 | 
 779 | ### üìÑ `backend/app/core/meta/engine.py`
 780 | **Components & Logic:**
 781 | 
 782 | - üì¶ **`PolicyEngine`**
 783 |     > *The Universal Logic Executor.*
 784 |   * üîπ **`evaluate`**
 785 |       > *The Main Entry Point.*
 786 |       * **1.** Prepare Data Context (Sandbox Envelope)
 787 |       * We wrap the data to allow 'context.meta' or 'context.actor' access if needed later.
 788 |       * Strategy: Pass object directly. Rules should be written as `host.weight > 10`.
 789 |       * **2.** Iterate Policies
 790 |       * **3.** Merge Results based on Governance Strategy
 791 |       * **4.** Apply Resolution Strategy ( The Judge )
 792 | 
 793 |   * üîπ **`_evaluate_single_policy`**
 794 |       > *Executes one Policy Bundle (which may contain multiple Rules).*
 795 |       * Policies store rules as a JSONB list: [{ "logic": "...", "action": "BLOCK", ... }]
 796 |       * A. Execute JMESPath
 797 |       * Boolean expressions: `host.age > 18` returns True/False.
 798 |       * B. Handle Match (Triggered)
 799 |       * ‚ö° RESOLVE DYNAMIC VALUES
 800 |       * If action involves data, we must check if the value is a reference (e.g. actor.id)
 801 |       * **SAFEGUARD:** Bad rule syntax should not crash the system.
 802 |       * ‚ö° FAIL OPEN: Treat crash as WARNING, not BLOCK.
 803 | 
 804 |   * üîπ **`_resolve_value`**
 805 |       > *Detects if a value is a reference (e.g. 'actor.id') and resolves it against the context.*
 806 |       * Heuristic: If it looks like a known context path, try to resolve it.
 807 |       * This matches the 'Value Source' logic in the Frontend Policy Editor.
 808 |       * If resolution works, return it. If it returns None, it might mean the field is missing,
 809 |       * but we return None rather than the string literal "actor.id".
 810 |       * If JMESPath crashes, fallback to the string literal
 811 | 
 812 |   * üîπ **`_apply_strategy`**
 813 |       > *Decides the final outcome based on the strategy.*
 814 |       * Default: Any violation kills the transaction
 815 |       * If (Total - Violations) > 0, then Pass.
 816 | 
 817 |   * üîπ **`_serialize`**
 818 |       > *Helper to convert SQLAlchemy objects to Dict for JMESPath.*
 819 |   * üîπ **`_log_summary`**
 820 | 
 821 | ---
 822 | ### üìÑ `backend/app/core/meta/features/groups/router.py`
 823 | **Components & Logic:**
 824 | 
 825 | - ∆í **`create_group`**
 826 | - ∆í **`list_groups`**
 827 | - ∆í **`get_group`**
 828 | - ∆í **`update_group`**
 829 | - ∆í **`delete_group`**
 830 | 
 831 | ### üìÑ `backend/app/core/meta/features/groups/service.py`
 832 | **Components & Logic:**
 833 | 
 834 | - üì¶ **`GroupService`**
 835 |     > *The Librarian. Manages collections of Policies.*
 836 |   * üîπ **`_generate_key`**
 837 |       > *Auto-generates a system key from a human name if not provided.*
 838 |   * üîπ **`create_group`**
 839 |       > *Creates a new Policy Group.*
 840 |       * **1.** Validate Key Uniqueness
 841 |       * **2.** Validate Policy Keys (Optional but recommended)
 842 |       * We trust the user provided valid keys, or we could verify them here.
 843 |       * **3.** Create Entity
 844 | 
 845 |   * üîπ **`get_groups`**
 846 |       > *Lists all Policy Groups.*
 847 |   * üîπ **`get_group_by_id`**
 848 |       > *Fetches a single group.*
 849 |   * üîπ **`update_group`**
 850 |       > *Updates metadata or membership order.*
 851 |       * Apply Updates
 852 | 
 853 |   * üîπ **`delete_group`**
 854 |       > *Soft Delete (Deactivate) or Hard Delete if no dependencies.*
 855 |       * **TODO:** Check if bound to any active PolicyBinding before deleting?
 856 |       * For Level 5 safety, we just Deactivate.
 857 | 
 858 | 
 859 | ---
 860 | ### üìÑ `backend/app/core/meta/features/simulator/logic/interpreter.py`
 861 | **Components & Logic:**
 862 | 
 863 | - üì¶ **`XStateInterpreter`**
 864 |     > *A lightweight, fault-tolerant interpreter for XState v5 definitions.*
 865 |   * üîπ **`__init__`**
 866 |   * üîπ **`get_initial_state`**
 867 |       > *Returns the starting state of the machine.*
 868 |   * üîπ **`transition`**
 869 |       > *Determines the next state based on the current state and the incoming event.*
 870 |       * **1.** Validate Current State
 871 |       * **2.** Look for Transitions ('on' block)
 872 |       * **3.** Match Event
 873 |       * XState allows 'on': { "EVENT": "TARGET" } OR 'on': { "EVENT": { "target": "TARGET" } }
 874 |       * **4.** Resolve Target
 875 |       * Short syntax: "EVENT": "TARGET"
 876 |       * Object syntax: "EVENT": { "target": "TARGET", "actions": [...] }
 877 |       * Array syntax (Guards): "EVENT": [{ "target": "T1", "guard": "cond" }]
 878 |       * For Phase 1, we just take the first unconditional match or the first one.
 879 |       * **TODO:** Implement Guard Logic evaluation here.
 880 |       * **5.** Final Validation
 881 | 
 882 | 
 883 | ---
 884 | ### üìÑ `backend/app/core/meta/features/simulator/router.py`
 885 | **Components & Logic:**
 886 | 
 887 | - ∆í **`inspect_entity`**
 888 | - ∆í **`run_simulation`**
 889 |     * Client Error (Invalid ID, Domain, etc.)
 890 |     * Server Error
 891 | 
 892 | 
 893 | ### üìÑ `backend/app/core/meta/features/simulator/schemas.py`
 894 | **Components & Logic:**
 895 | 
 896 | - üì¶ **`SimulationRequest`**
 897 |     > *The Input Vector.*
 898 | - üì¶ **`SimulationResult`**
 899 |     > *The Output Report.*
 900 | 
 901 | ### üìÑ `backend/app/core/meta/features/simulator/service.py`
 902 | **Components & Logic:**
 903 | 
 904 | - üì¶ **`RuntimeService`**
 905 |   * üîπ **`inspect_entity`**
 906 |       > *FORENSIC PROBE: Fetches the exact database state of an entity.*
 907 |       * **1.** Resolve Domain Model
 908 |       * **2.** Fetch Row
 909 |       * **3.** Serialize & Flatten (The Fix)
 910 |       * A. Static Columns
 911 |       * Handle Datetime serialization
 912 |       * B. Dynamic Attributes (Flattening)
 913 |       * This pulls 'test' out of 'custom_attributes' and puts it at the root.
 914 | 
 915 |   * üîπ **`simulate_transaction`**
 916 |       > *Executes a business event in a safe Sandbox Transaction.*
 917 |       * **1.** Resolve Domain Model
 918 |       * **2.** Load Entity
 919 |       * Capture Pre-State
 920 |       * **3.** Load State Machine
 921 |       * **4.** Calculate Transition
 922 |       * **5.** Apply Changes
 923 |       * A. Apply Payload updates
 924 |       * B. Apply State Transition
 925 |       * **6.** Trigger Interceptor
 926 |       * **7.** Inspect Side Effects
 927 |       * **8.** THE ROLLBACK
 928 | 
 929 | 
 930 | ---
 931 | ### üìÑ `backend/app/core/meta/features/states/logic/enforcer.py`
 932 | **Components & Logic:**
 933 | 
 934 | - üì¶ **`StateEnforcer`**
 935 |   * üîπ **`fetch_definitions`**
 936 |       > *‚ö° SIDECAR IO: Fetches active state machines for a domain.*
 937 |   * üîπ **`enforce_logic`**
 938 |       > *CPU LOGIC: Evaluates transitions.*
 939 |       * ‚ö° DECOUPLING POINT:
 940 |       * We no longer evaluate the guard here.
 941 |       * We attach the 'guard' and 'actions' to the object sidecar.
 942 |       * The Interceptor will see this and trigger the Governance Signal.
 943 | 
 944 | 
 945 | ### üìÑ `backend/app/core/meta/features/states/logic/machine.py`
 946 | **Components & Logic:**
 947 | 
 948 | - üì¶ **`StateMachine`**
 949 |     > *A Read-Only engine that validates transitions against an XState definition.*
 950 |   * üîπ **`__init__`**
 951 |       > *Args:*
 952 |       * Cache strict transitions for O(1) lookup
 953 | 
 954 |   * üîπ **`_normalize_transition`**
 955 |       > *SAFEGUARD: Converts legacy string targets into object definitions.*
 956 |   * üîπ **`_build_lookup_table`**
 957 |       > *Parses the nested XState structure into a flat lookup map.*
 958 |   * üîπ **`get_transition_config`**
 959 |       > *Finds the configuration (Rules/Actions) for moving A -> B.*
 960 |   * üîπ **`validate_transition_structure`**
 961 |   * üîπ **`get_side_effects`**
 962 |       > *Retrieves 'actions' defined in the transition (Edge).*
 963 |   * üîπ **`get_state_node`**
 964 |       > *Returns the full definition of a specific state node.*
 965 | 
 966 | ### üìÑ `backend/app/core/meta/features/states/logic/validator.py`
 967 | **Components & Logic:**
 968 | 
 969 | - üì¶ **`ScopeValidator`**
 970 |     > *Enforces Level 7 Constraints dynamically.*
 971 |   * üîπ **`validate`**
 972 |       > *Main Entry Point.*
 973 |       * **1.** Fetch Rule Definition from DB (The Source of Truth)
 974 |       * **2.** Extract JSON Schema
 975 |       * **3.** Execute Validation
 976 |       * We validate the ENTIRE definition against the schema stored in DB
 977 |       * Format the error nicely for the API response
 978 | 
 979 | 
 980 | ---
 981 | ### üìÑ `backend/app/core/meta/features/states/models.py`
 982 | **Components & Logic:**
 983 | 
 984 | - üì¶ **`WorkflowType`**
 985 |     > *Defines a Category of State Machine.*
 986 |   * üîπ **`__repr__`**
 987 | 
 988 | ### üìÑ `backend/app/core/meta/features/states/router.py`
 989 | **Components & Logic:**
 990 | 
 991 | - ∆í **`list_workflow_types`**
 992 |     > *Fetches the Dynamic Workflow Registry (V3).*
 993 | - ∆í **`create_state_machine`**
 994 | - ∆í **`list_state_machines`**
 995 | - ∆í **`get_flow_definition`**
 996 | - ∆í **`get_flow_history`**
 997 | - ∆í **`get_flow_version`**
 998 | - ∆í **`delete_workflow`**
 999 | 
1000 | ### üìÑ `backend/app/core/meta/features/states/schemas.py`
1001 | **Components & Logic:**
1002 | 
1003 | - ∆í **`validate_xstate_structure`**
1004 |     > *Forensic audit of the State Machine JSON.*
1005 | - üì¶ **`WorkflowTypeRead`**
1006 |     > *Exposes the 'Class' definition of a workflow (e.g. WIZARD).*
1007 | - üì¶ **`StateMachineCreate`**
1008 |   * üîπ **`check_structure`**
1009 | - üì¶ **`StateMachineUpdate`**
1010 |   * üîπ **`check_structure`**
1011 | - üì¶ **`StateMachineRead`**
1012 |   * üîπ **`version`**
1013 | 
1014 | ### üìÑ `backend/app/core/meta/features/states/seeds.py`
1015 | **Components & Logic:**
1016 | 
1017 | - ∆í **`seed_workflow_types`**
1018 |     > *Idempotent seeder for Workflow Types.*
1019 | 
1020 | ### üìÑ `backend/app/core/meta/features/states/service.py`
1021 | **Components & Logic:**
1022 | 
1023 | - üì¶ **`StateService`**
1024 |   * üîπ **`get_workflow_types`**
1025 |       > *Retrieves the catalogue of available Workflow "Animals" (e.g. WIZARD, JOB).*
1026 |       * Order by key for consistent UI rendering
1027 | 
1028 |   * üîπ **`create_machine`**
1029 |       > *Registers a State Machine (Ledger Strategy).*
1030 |       * --- 0. LEVEL 7 INTEGRITY CHECK ---
1031 |       * **‚ö° UPDATE:** Pass 'db' to allow dynamic rule lookup
1032 |       * --- 1. Determine Next Version (SemVer + Legacy) ---
1033 |       * We fetch the absolute latest version to calculate the increment
1034 |       * Patch Increment Strategy (1.0.0 -> 1.0.1)
1035 |       * Initialize at 1.0.0
1036 |       * --- 2. Archive Old Versions ---
1037 |       * --- 3. Create New Version ---
1038 |       * SemVer
1039 |       * Legacy
1040 | 
1041 |   * üîπ **`get_machines`**
1042 |   * üîπ **`get_machine_by_scope`**
1043 |   * üîπ **`get_machine_history`**
1044 |   * üîπ **`delete_machine`**
1045 |       > *Safe Deletion Protocol.*
1046 | 
1047 | ---
1048 | ### üìÑ `backend/app/core/meta/features/topology/router.py`
1049 | **Components & Logic:**
1050 | 
1051 | - ∆í **`get_domain_topology`**
1052 |     > *‚ö° TOPOLOGY GRAPH ENDPOINT*
1053 |     * The Service handles the DB stitching (Entities + Policies + Scopes)
1054 |     * ‚ö° TELEMETRY PROBE: Print full stack trace to console for debugging 500s
1055 | 
1056 | 
1057 | ### üìÑ `backend/app/core/meta/features/topology/schemas.py`
1058 | **Components & Logic:**
1059 | 
1060 | - üì¶ **`TopologyNodeType`**
1061 |     > *Defines the biological classification of a System Node.*
1062 | - üì¶ **`TopologyNode`**
1063 |     > *A single node in the System Hierarchy.*
1064 | 
1065 | ### üìÑ `backend/app/core/meta/features/topology/service.py`
1066 | **Components & Logic:**
1067 | 
1068 | - üì¶ **`TopologyService`**
1069 |     > *The Cartographer of the Database.*
1070 |   * üîπ **`get_domain_topology`**
1071 |       > *Generates the Concrete Children for a specific Domain.*
1072 |       * ‚ö° 0A. FETCH DYNAMIC WORKFLOW TYPES (Async)
1073 |       * ‚ö° 0B. FETCH DOMAIN METADATA (Async)
1074 |       * **‚ö° SAFETY:** Resolve attributes defensively
1075 |       * ---------------------------------------------------------
1076 |       * **1.** ‚ö° ENTITY NODE (Data Dictionary)
1077 |       * ---------------------------------------------------------
1078 |       * ---------------------------------------------------------
1079 |       * **2.** ‚ö° GOVERNANCE NODE (Policies)
1080 |       * ---------------------------------------------------------
1081 |       * ---------------------------------------------------------
1082 |       * **3.** ‚ö° WORKFLOW NODES (Scopes)
1083 |       * ---------------------------------------------------------
1084 |       * ‚ö° FETCH TYPE DEFINITION
1085 |       * ‚ö° DEFAULT ICONS
1086 |       * ---------------------------------------------------------
1087 |       * ‚ö° GROUPING LOGIC (The "Hierarchy Builder")
1088 |       * ---------------------------------------------------------
1089 |       * Initialize vars
1090 |       * CASE A: WORKFLOWS (Wizards, Jobs, Views, Governance Flows)
1091 |       * We group these under "WORKFLOWS" -> "TYPE"
1092 |       * Parent Folder
1093 |       * Child Folder (The Sub-Tree)
1094 |       * Use the Label from the Workflow Type Definition (e.g. "Interactive Wizard")
1095 |       * Fallback if type def missing
1096 |       * CASE B: FALLBACK
1097 |       * ---------------------------------------------------------
1098 |       * ‚ö° HIERARCHY METADATA
1099 |       * ---------------------------------------------------------
1100 |       * **4.** ‚ö° CHILD DOMAINS (Sub-Modules)
1101 |       * ---------------------------------------------------------
1102 | 
1103 | 
1104 | ---
1105 | ### üìÑ `backend/app/core/meta/features/views/router.py`
1106 | **Components & Logic:**
1107 | 
1108 | - ∆í **`create_view`**
1109 | - ∆í **`list_views`**
1110 | - ∆í **`update_view`**
1111 | - ∆í **`bind_view`**
1112 | - ∆í **`list_bindings`**
1113 |     > *Returns the routing table for UI views.*
1114 | - ∆í **`delete_binding`**
1115 | - ∆í **`resolve_view`**
1116 |     * In a real app, role comes from the JWT Token.
1117 |     * We allow explicit override here for testing/simulation.
1118 | 
1119 | 
1120 | ### üìÑ `backend/app/core/meta/features/views/schemas.py`
1121 | **Components & Logic:**
1122 | 
1123 | - üì¶ **`ViewBase`**
1124 |   * üîπ **`validate_key`**
1125 |   * üîπ **`validate_schema_structure`**
1126 |       > *POLYMORPHIC VALIDATION:*
1127 |       * Logic for Form.io components
1128 | 
1129 | - üì¶ **`ViewCreate`**
1130 | - üì¶ **`ViewUpdate`**
1131 | - üì¶ **`ViewRead`**
1132 | - üì¶ **`ViewBindingBase`**
1133 | - üì¶ **`ViewBindingCreate`**
1134 | - üì¶ **`ViewBindingUpdate`**
1135 | - üì¶ **`ViewBindingRead`**
1136 | 
1137 | ### üìÑ `backend/app/core/meta/features/views/service.py`
1138 | **Components & Logic:**
1139 | 
1140 | - üì¶ **`ViewService`**
1141 |     > *The Orchestrator for the UI Backbone.*
1142 |   * üîπ **`create_view_async`**
1143 |       * Check Uniqueness (Only check against LATEST)
1144 |       * Serialize - by_alias=True ensures 'schema' key is used for DB
1145 |       * Initial Version: 1.00
1146 | 
1147 |   * üîπ **`update_view_async`**
1148 |       > *AUTO-LIVE STRATEGY:*
1149 |       * **1.** Fetch Parent
1150 |       * **2.** Calculate Next Version
1151 |       * **3.** Prepare New Data
1152 |       * **4.** Create New Head
1153 |       * **5.** Deprecate Parent (Mark as not latest)
1154 |       * **6.** AUTO-LIVE: Promote Bindings
1155 |       * Find all bindings pointing to the OLD view and move them to the NEW view
1156 | 
1157 |   * üîπ **`get_views`**
1158 |       * Only return LATEST versions for the list
1159 | 
1160 |   * üîπ **`create_binding`**
1161 |       * **‚ö° FIX:** Eager load the relationship
1162 | 
1163 |   * üîπ **`get_bindings`**
1164 |       > *Retrieves all View Bindings for a given Domain.*
1165 |   * üîπ **`delete_binding`**
1166 |       > *SMART UNBIND:*
1167 |       * PHASE 1: DEACTIVATE
1168 |       * PHASE 2: HARD DELETE
1169 | 
1170 |   * üîπ **`resolve_view`**
1171 |       > *Determines the BEST view for a given context using 'Weighted Specificity'.*
1172 |       * **1.** Fetch Candidates (All active bindings for this domain)
1173 |       * **2.** Score Candidates
1174 |       * Only consider bindings where the View itself is active
1175 |       * A. Role Check
1176 |       * B. State Check
1177 |       * C. Priority
1178 | 
1179 | 
1180 | ---
1181 | ### üìÑ `backend/app/core/meta/features/widgets/models.py`
1182 | **Components & Logic:**
1183 | 
1184 | - üì¶ **`WidgetDefinition`**
1185 |     > *The 'App Store' entry for a UI Component.*
1186 |   * üîπ **`version`**
1187 |   * üîπ **`__repr__`**
1188 | 
1189 | ### üìÑ `backend/app/core/meta/features/widgets/schemas.py`
1190 | **Components & Logic:**
1191 | 
1192 | - üì¶ **`WidgetCreate`**
1193 | - üì¶ **`WidgetUpdate`**
1194 | - üì¶ **`WidgetRead`**
1195 |   * üîπ **`version`**
1196 | 
1197 | ---
1198 | ### üìÑ `backend/app/core/meta/features/widgets/seeds/atoms.py`
1199 | 
1200 | ### üìÑ `backend/app/core/meta/features/widgets/seeds/molecules.py`
1201 | 
1202 | ### üìÑ `backend/app/core/meta/features/widgets/seeds/structures.py`
1203 | 
1204 | ---
1205 | ### üìÑ `backend/app/core/meta/features/widgets/service.py`
1206 | **Components & Logic:**
1207 | 
1208 | - üì¶ **`WidgetService`**
1209 |   * üîπ **`register_widget`**
1210 |       > *Creates a new Widget Definition (v1.0.0).*
1211 |       * Uniqueness Check (Key only)
1212 | 
1213 |   * üîπ **`get_widgets`**
1214 |       > *Lists all LATEST widgets.*
1215 |   * üîπ **`get_widget_by_key`**
1216 | 
1217 | ---
1218 | ### üìÑ `backend/app/core/meta/models.py`
1219 | **Components & Logic:**
1220 | 
1221 | - üì¶ **`AttributeDefinition`**
1222 |   * üîπ **`__repr__`**
1223 | - üì¶ **`PolicyDefinition`**
1224 |   * üîπ **`version_display`**
1225 | - üì¶ **`PolicyGroup`**
1226 |     > *‚ö° ENTERPRISE FEATURE: Explicit Policy Grouping.*
1227 | - üì¶ **`PolicyBinding`**
1228 |     > *The Switchboard. Connects a Policy OR a Group to a Context.*
1229 | - üì¶ **`StateDefinition`**
1230 |   * üîπ **`version_display`**
1231 | - üì¶ **`ViewDefinition`**
1232 | - üì¶ **`ViewBinding`**
1233 | - üì¶ **`RuleDefinition`**
1234 | 
1235 | ### üìÑ `backend/app/core/meta/registry.py`
1236 | 
1237 | ### üìÑ `backend/app/core/meta/schemas.py`
1238 | **Components & Logic:**
1239 | 
1240 | - üì¶ **`SelectOption`**
1241 | - üì¶ **`AttributeConfig`**
1242 | - üì¶ **`AttributeBase`**
1243 | - üì¶ **`AttributeCreate`**
1244 | - üì¶ **`AttributeUpdate`**
1245 | - üì¶ **`AttributeRead`**
1246 | - üì¶ **`PolicyRule`**
1247 | - üì¶ **`PolicyBase`**
1248 | - üì¶ **`PolicyCreate`**
1249 | - üì¶ **`PolicyUpdate`**
1250 | - üì¶ **`PolicyRead`**
1251 |   * üîπ **`version_display`**
1252 | - üì¶ **`PolicyGroupBase`**
1253 |   * üîπ **`validate_key`**
1254 | - üì¶ **`PolicyGroupCreate`**
1255 | - üì¶ **`PolicyGroupUpdate`**
1256 | - üì¶ **`PolicyGroupRead`**
1257 | - üì¶ **`PolicyBindingBase`**
1258 |   * üîπ **`check_source`**
1259 | - üì¶ **`PolicyBindingCreate`**
1260 | - üì¶ **`PolicyBindingUpdate`**
1261 | - üì¶ **`PolicyBindingRead`**
1262 | - üì¶ **`RuleEffect`**
1263 | - üì¶ **`RuleCreate`**
1264 | - üì¶ **`RuleRead`**
1265 | - üì¶ **`DryRunRequest`**
1266 | - üì¶ **`DryRunResult`**
1267 | 
1268 | ### üìÑ `backend/app/core/meta/service.py`
1269 | **Components & Logic:**
1270 | 
1271 | - üì¶ **`MetaService`**
1272 |   * üîπ **`validate_rule_syntax`**
1273 |   * üîπ **`create_policy`**
1274 |   * üîπ **`update_policy`**
1275 |   * üîπ **`dry_run_policy`**
1276 |   * üîπ **`get_policy_history`**
1277 |   * üîπ **`restore_policy`**
1278 |   * üîπ **`get_policies`**
1279 |       > *‚ö° TAG-DRIVEN ARCHITECTURE: Filters policies by their domain tag.*
1280 |       * JSONB contains check: tags @> '["domain:XYZ"]'
1281 | 
1282 |   * üîπ **`create_binding`**
1283 |   * üîπ **`update_binding`**
1284 |   * üîπ **`delete_binding`**
1285 |   * üîπ **`get_bindings`**
1286 |   * üîπ **`create_attribute`**
1287 |   * üîπ **`get_attributes`**
1288 |   * üîπ **`update_attribute`**
1289 |   * üîπ **`delete_attribute`**
1290 |   * üîπ **`create_rule`**
1291 |   * üîπ **`get_rules`**
1292 |   * üîπ **`get_fused_schema`**
1293 |       > *The Brain: Combines Immutable Code (Registry) with Flexible Data (DB).*
1294 |       * **‚ö° LOGGING:** Trace the Fusion Step
1295 |       * **1.** FETCH STATIC SCHEMA (The Bedrock)
1296 |       * **2.** FETCH DYNAMIC SCHEMA (The Overlay)
1297 |       * Use local method to avoid circular dependency issues
1298 |       * Dynamic overrides Static if key matches
1299 |       * Return empty schema instead of crashing, allowing UI to recover
1300 | 
1301 |   * üîπ **`invalidate_cache`**
1302 | 
1303 | ---
1304 | ### üìÑ `backend/app/core/schema_generator.py`
1305 | **Components & Logic:**
1306 | 
1307 | - ∆í **`generate_schema`**
1308 |     > *Introspects SQLAlchemy models and returns a dictionary representation.*
1309 |     * We use the Class Name as the key (e.g., "User") for the Frontend to map easily.
1310 |     * Inspect the class members to find SQLAlchemy columns
1311 |     * Extract Column Metadata
1312 |     * Note: We access .property.columns[0] to get the actual Column object
1313 |     * ‚ö° ARCHITECTURAL INVARIANT: Skip Dynamic Containers
1314 |     * Clean up type name (e.g., "VARCHAR(255)" -> "VARCHAR")
1315 |     * Skip relationships or non-column attributes for now
1316 | 
1317 | 
1318 | ### üìÑ `backend/app/core/security.py`
1319 | **Components & Logic:**
1320 | 
1321 | - ∆í **`verify_password`**
1322 |     > *Verifies a plain-text password against the stored hash.*
1323 | - ∆í **`get_password_hash`**
1324 |     > *Generates a secure hash for a new password.*
1325 | - ∆í **`create_access_token`**
1326 |     > *Mints a new JWT Access Token.*
1327 |     * Expiration
1328 |     * Token Type
1329 | 
1330 | 
1331 | ---
1332 | ### üìÑ `backend/app/core/utilities/async_bridge.py`
1333 | **Components & Logic:**
1334 | 
1335 | - üì¶ **`AsyncBridge`**
1336 |     > *The Connector between the Blocking DB Layer and the Non-Blocking Logic Layer.*
1337 |   * üîπ **`run_sync`**
1338 |       > *Executes a coroutine synchronously by spawning a fresh Event Loop in a separate thread.*
1339 |       * ‚ö° 1. CAPTURE CONTEXT
1340 |       * Snapshot the current state (User, Request ID, etc.)
1341 |       * This allows the background thread to "know" who initiated the save.
1342 |       * ‚ö° 2. SETUP SIDECAR LOOP
1343 |       * ‚ö° 3. EXECUTE WITHIN CONTEXT
1344 |       * We wrap the execution in ctx.run() so the coroutine sees the vars.
1345 |       * Note: We must wrap the loop.run_until_complete call itself,
1346 |       * or create a wrapper task that runs in context.
1347 |       * Best practice: ctx.run(task)
1348 |       * The loop itself doesn't need the context, the coroutine does.
1349 |       * However, ctx.run() takes a callable.
1350 |       * We simply run the loop logic.
1351 |       * This ensures the async task inherits the context
1352 |       * But simpler: we just run the whole block in context if possible.
1353 |       * Actually, contextvars context applies to the *thread* execution stack.
1354 |       * So executing ctx.run(func) sets the context for 'func'.
1355 |       * ‚ö° 4. SPAWN THREAD WITH CONTEXT
1356 |       * We pass 'target' to ctx.run, so 'target' runs with the variables set.
1357 |       * But we are starting a NEW thread. ctx.run() only works in the CURRENT thread.
1358 |       * To pass context to a NEW thread, we must run ctx.run INSIDE the new thread.
1359 |       * "Re-hydrate" the context inside the new thread
1360 |       * Block until the Sidecar finishes (Gatekeeper behavior)
1361 | 
1362 | 
1363 | ---
1364 | ### üìÑ `backend/app/core/utils/reflection.py`
1365 | **Components & Logic:**
1366 | 
1367 | - ∆í **`reflect_model_schema`**
1368 |     > *Introspects a SQLAlchemy Model and returns a structured Context Graph.*
1369 |     * Indentation for logging readability
1370 |     * **1.** SCALAR FIELDS
1371 |     * ‚ö° ARCHITECTURAL INVARIANT: Skip Dynamic Containers
1372 |     * The bucket itself is not a field, it holds the fields.
1373 |     * --- A. Type Mapping ---
1374 |     * Map SQLAlchemy Types to UI Types
1375 |     * --- B. Metadata Extraction (The Explicit Strategy) ---
1376 |     * We look for the 'info' dict on the column definition first.
1377 |     * Fallback to Heuristics if missing.
1378 |     * Label: Override or Auto-Generate
1379 |     * System/Read-Only Status
1380 |     * **1.** Explicit Override
1381 |     * **2.** Heuristic Fallback (Safety Net)
1382 |     * Final Decision Logic
1383 |     * Special Case: 'hashed_password'
1384 |     * Should be "password" widget, but never readable.
1385 |     * --- C. Construct Field Definition ---
1386 |     * Alias for logic engine
1387 |     * Placeholder for extended config
1388 |     * Inject options if found via Enum or Info
1389 |     * **2.** RELATIONSHIPS (The Graph)
1390 |     * Only recurse if we haven't hit the limit
1391 |     * Determine Cardinality
1392 |     * Recursive Call
1393 |     * **3.** CONSTRUCT OUTPUT
1394 | 
1395 | 
1396 | ---
1397 | ### üìÑ `backend/app/domains/auth/features/preferences/models.py`
1398 | **Components & Logic:**
1399 | 
1400 | - üì¶ **`UserPreferences`**
1401 |     > *The UI/UX State Sidecar.*
1402 |   * üîπ **`__repr__`**
1403 |       > *String representation for logging.*
1404 | 
1405 | ### üìÑ `backend/app/domains/auth/features/preferences/seeds.py`
1406 | **Components & Logic:**
1407 | 
1408 | - ∆í **`seed_preferences_schema`**
1409 |     > *Idempotent seeder for User Preference Attributes.*
1410 |     * Check existence
1411 |     * üîí LOCK IT
1412 | 
1413 | 
1414 | ### üìÑ `backend/app/domains/auth/features/preferences/service.py`
1415 | **Components & Logic:**
1416 | 
1417 | - üì¶ **`PreferenceService`**
1418 |     > *The Librarian for User State.*
1419 |   * üîπ **`get_preferences`**
1420 |       > *Fetches preferences. Auto-creates the row if missing (Lazy Init).*
1421 |       * Merge with defaults to ensure new keys appear for old users
1422 |       * Note: In a real implementation, we might want a deep merge utility here.
1423 |       * For now, we trust the stored JSON but could overlay it on DEFAULT_PREFERENCES.
1424 | 
1425 |   * üîπ **`initialize_defaults`**
1426 |       > *Creates the Sidecar row with Factory Settings.*
1427 |       * If race condition (already created), just return existing
1428 | 
1429 |   * üîπ **`get_default_schema`**
1430 |       > *Returns the structure of the preferences for UI generation.*
1431 | 
1432 | ### üìÑ `backend/app/domains/auth/features/preferences/workflows.py`
1433 | 
1434 | ---
1435 | ### üìÑ `backend/app/domains/auth/models.py`
1436 | **Components & Logic:**
1437 | 
1438 | - üì¶ **`User`**
1439 |     > *The Central Identity Entity.*
1440 |   * üîπ **`to_dict`**
1441 | - ∆í **`provide_schema`**
1442 | - ∆í **`user_context_loader`**
1443 | 
1444 | ### üìÑ `backend/app/domains/auth/registry.py`
1445 | 
1446 | ### üìÑ `backend/app/domains/auth/schemas.py`
1447 | **Components & Logic:**
1448 | 
1449 | - üì¶ **`UserBase`**
1450 | - üì¶ **`UserCreate`**
1451 | - üì¶ **`UserLogin`**
1452 | - üì¶ **`UserRead`**
1453 | - üì¶ **`Token`**
1454 | - üì¶ **`TokenPayload`**
1455 | 
1456 | ### üìÑ `backend/app/domains/auth/seeds.py`
1457 | **Components & Logic:**
1458 | 
1459 | - ∆í **`seed_assets`**
1460 |     > *Wave 2: Core Assets*
1461 |     * --- 1. ADMIN USER ---
1462 |     * --- 2. WORKFLOW REGISTRATION (Refactored) ---
1463 |     * ‚ö° CORE IDENTITY FLOWS (USER)
1464 |     * ‚ö° SIDECAR FLOWS (USER_PREFS)
1465 |     * This fixes the missing "User Settings" workflow
1466 |     * --- 3. PREFERENCE SCHEMA ---
1467 |     * --- 4. ‚ö° GOVERNANCE BINDING (Compliance) ---
1468 |     * The User Domain voluntarily accepts the System's Laws
1469 | 
1470 | - ∆í **`_register_domain_workflows`**
1471 |     > *Helper to register workflows for a specific Domain Context.*
1472 |     * Handle Tuple vs Dict scopes (Legacy shim)
1473 |     * ‚ö° CRITICAL FILTER: Only register State Machines (WIZARD, GOVERNANCE).
1474 |     * We EXCLUDE 'JOB' and 'VIEW' because they don't have XState definitions.
1475 | 
1476 | - ∆í **`seed_governance`**
1477 |     > *Binds the USER domain to Global System Policies.*
1478 |     * ‚ö° THE COMPLIANCE LIST
1479 |     * "We agree to follow these System Policies"
1480 |     * **1.** Find the Law
1481 |     * **2.** Check for existing Binding
1482 |     * **3.** Sign the Contract
1483 | 
1484 | 
1485 | ---
1486 | ### üìÑ `backend/app/domains/auth/workflows/lifecycle.py`
1487 | 
1488 | ### üìÑ `backend/app/domains/auth/workflows/signup.py`
1489 | 
1490 | ### üìÑ `backend/app/domains/auth/workflows/user_admin.py`
1491 | 
1492 | ### üìÑ `backend/app/domains/auth/workflows/user_create.py`
1493 | 
1494 | ### üìÑ `backend/app/domains/auth/workflows/user_edit.py`
1495 | 
1496 | ---
1497 | ### üìÑ `backend/app/domains/meta_v2/features/governance/enforcer.py`
1498 | **Components & Logic:**
1499 | 
1500 | - üì¶ **`GovernanceEnforcer`**
1501 |   * üîπ **`fetch_and_evaluate`**
1502 |       > *‚ö° SIDECAR IO: Spawns an independent DB session to fetch Policies,*
1503 |       * **1.** Resolve Environment Context
1504 |       * **2.** Fetch Active Bindings
1505 |       * **3.** Evaluate (Or Pass gracefully if no rules)
1506 | 
1507 |   * üîπ **`evaluate_guard_sync`**
1508 |       > *Evaluates a single transition guard expression synchronously.*
1509 | 
1510 | ---
1511 | ### üìÑ `backend/app/domains/system/features/domain_types/models.py`
1512 | **Components & Logic:**
1513 | 
1514 | - üì¶ **`KernelDomainType`**
1515 |     > *The Meta-Definition for a Domain Category.*
1516 |   * üîπ **`__repr__`**
1517 |       > *String representation for logging.*
1518 | 
1519 | ### üìÑ `backend/app/domains/system/features/domain_types/seeds.py`
1520 | **Components & Logic:**
1521 | 
1522 | - ∆í **`seed_domain_types`**
1523 |     > *Idempotent seeder for Kernel Domain Types.*
1524 |     * Upsert Logic: Insert or Update if exists
1525 | 
1526 | 
1527 | ---
1528 | ### üìÑ `backend/app/domains/system/features/navigation/models.py`
1529 | **Components & Logic:**
1530 | 
1531 | - üì¶ **`SystemMenuNode`**
1532 |     > *The Global UI Shell Navigation Registry.*
1533 |   * üîπ **`__repr__`**
1534 | 
1535 | ### üìÑ `backend/app/domains/system/features/navigation/schemas.py`
1536 | **Components & Logic:**
1537 | 
1538 | - üì¶ **`NavigationNode`**
1539 |     > *A single item in the navigation tree.*
1540 | - üì¶ **`NavigationResponse`**
1541 |     > *The full payload injected into the System Manifest.*
1542 | 
1543 | ### üìÑ `backend/app/domains/system/features/navigation/seeds.py`
1544 | **Components & Logic:**
1545 | 
1546 | - ∆í **`seed_navigation`**
1547 |     > *Idempotent seeder for the OS Navigation Menu.*
1548 | 
1549 | ### üìÑ `backend/app/domains/system/features/navigation/service.py`
1550 | **Components & Logic:**
1551 | 
1552 | - üì¶ **`NavigationService`**
1553 |     > *The Architect of the UI Shell.*
1554 |   * üîπ **`get_secured_navigation`**
1555 |       > *Fetches all active nodes and filters them via the Policy Engine.*
1556 |       * **1.** Fetch all active nodes
1557 |       * **2.** Extract unique policy requirements to minimize DB hits
1558 |       * **3.** Assemble filtered structure
1559 |       * üõ°Ô∏è SECURITY GATE
1560 |       * üì¶ SERIALIZE
1561 | 
1562 | 
1563 | ---
1564 | ### üìÑ `backend/app/domains/system/logic/governance.py`
1565 | **Components & Logic:**
1566 | 
1567 | - üì¶ **`GovernanceService`**
1568 |   * üîπ **`_serialize`**
1569 |       > *Converts SQLAlchemy models to Dictionary.*
1570 |       * Handle 'scopes' relationship manually
1571 |       * **‚ö° FIX:** Handle 'type_def' relationship manually so UI receives api_strategy
1572 | 
1573 |   * üîπ **`list_domains`**
1574 |       > *Fetches Domains + Scopes + Circuit States.*
1575 |       * **1.** Fetch Hierarchy (Now including type_def)
1576 |       * **2.** Fetch All Circuits (Optimization: Single Query instead of N+1)
1577 |       * **3.** Create Lookup Map
1578 |       * Key: "scope:USER:SIGNUP_FLOW::UI" -> "HALTED"
1579 |       * **4.** Inject State into Scopes
1580 |       * Reconstruct Target URI
1581 |       * Lookup UI State
1582 |       * Lookup API State
1583 |       * Attach to Scope Object
1584 | 
1585 |   * üîπ **`patch_domain`**
1586 |   * üîπ **`list_config`**
1587 |   * üîπ **`update_config`**
1588 | 
1589 | ### üìÑ `backend/app/domains/system/logic/hypervisor.py`
1590 | **Components & Logic:**
1591 | 
1592 | - üì¶ **`SystemHypervisor`**
1593 |     > *The Central Logic for Operational State.*
1594 |   * üîπ **`check_state`**
1595 |       > *Checks if a specific Target is allowed to operate on a specific Plane.*
1596 |       * **1.** READ CACHE (Fast Path)
1597 |       * **2.** CACHE MISS -> FETCH DB (Slow Path)
1598 |       * **3.** POPULATE CACHE
1599 |       * Default: Implicitly Nominal
1600 |       * **4.** Return Result
1601 | 
1602 |   * üîπ **`_interpret_status`**
1603 |       > *Converts raw status string to Boolean Permission.*
1604 |   * üîπ **`_update_local_cache`**
1605 |       > *Internal helper to set cache with timestamp.*
1606 |   * üîπ **`set_state`**
1607 |       > *Upserts a Circuit Breaker state.*
1608 |       * **1.** ORM Lookup
1609 |       * **2.** Update or Create
1610 |       * SQLAlchemy tracks this as 'dirty'
1611 |       * **3.** Flush to trigger Interceptor
1612 |       * **4.** Cache Update
1613 | 
1614 |   * üîπ **`ensure_circuit`**
1615 |       > *Idempotent Registration. Ensures a switch exists.*
1616 | 
1617 | ### üìÑ `backend/app/domains/system/logic/seeder.py`
1618 | **Components & Logic:**
1619 | 
1620 | - üì¶ **`SystemSeeder`**
1621 |     > *Bootstrapper for the System Domain.*
1622 |   * üîπ **`seed`**
1623 |       > *Idempotent Seeder.*
1624 |       * --- PHASE 1: System Config ---
1625 |       * --- PHASE 1.5: Meta-Kernel Assets (The Library) ---
1626 |       * ‚ö° This ensures the Widget Registry is populated before any UI renders
1627 |       * --- PHASE 2: Code Registry (Domains & Scopes) ---
1628 |       * We use the RegistryManager directly to get the latest Code Definitions
1629 |       * **‚ö° FIX:** Passing 'db' to fetch Dynamic Types and awaiting the result
1630 |       * DomainSummary is a Pydantic model now
1631 |       * 2.1 Seed DOMAIN Circuits (API, UI, WORKER)
1632 |       * ‚ö° CACHE UPDATE: ensure_circuit now updates the Hypervisor memory map too
1633 |       * 2.2 Seed SCOPE Circuits (Recursive)
1634 |       * All scopes get API and UI controls
1635 |       * Only JOB scopes get a Worker control
1636 |       * --- PHASE 3: Data Registry (Screens) ---
1637 |       * We fetch screens dynamically from the DB
1638 |       * Screens are UI Containers, they only have a UI Plane
1639 |       * Commit all new circuits
1640 | 
1641 | 
1642 | ### üìÑ `backend/app/domains/system/logic/state.py`
1643 | **Components & Logic:**
1644 | 
1645 | - üì¶ **`SystemState`**
1646 |     > *The Central Nervous System Observer.*
1647 |   * üîπ **`get_pulse`**
1648 |       > *Returns the unified System State.*
1649 |       * **1.** Gather Intelligence
1650 |       * **2.** Construct Identity
1651 |       * Immutable Code (v2.5.0)
1652 |       * Database Structure (Hash)
1653 |       * User Logic (SemVer)
1654 | 
1655 |   * üîπ **`_get_schema_version`**
1656 |       > *Queries the Alembic Version Table directly.*
1657 |   * üîπ **`_get_content_version`**
1658 |       > *Calculates the 'System Content Version'.*
1659 |       * Find the highest semantic version label in the Release Table
1660 |       * Note: String comparison is used here as a heuristic.
1661 |       * In a strict environment, we would use SemVer sorting logic.
1662 | 
1663 | 
1664 | ---
1665 | ### üìÑ `backend/app/domains/system/models.py`
1666 | **Components & Logic:**
1667 | 
1668 | - üì¶ **`KernelDomain`**
1669 |     > *The Master Registry of all installed Modules.*
1670 |   * üîπ **`__repr__`**
1671 | - üì¶ **`KernelEntity`**
1672 |     > *‚ö° NEW v3: The Physical Table Registry (Aggregate Components).*
1673 |   * üîπ **`__repr__`**
1674 | - üì¶ **`KernelScope`**
1675 |     > *The Workflow Topology Definition.*
1676 |   * üîπ **`__repr__`**
1677 | - üì¶ **`KernelScopeImpact`**
1678 |     > *‚ö° NEW v3: The Impact Graph (Dependency Map).*
1679 | - üì¶ **`SystemConfig`**
1680 |     > *THE CONTROL KNOBS.*
1681 |   * üîπ **`__repr__`**
1682 |   * üîπ **`typed_value`**
1683 |       > *Auto-converts value_raw based on value_type.*
1684 | - üì¶ **`CircuitBreaker`**
1685 |     > *The System Hypervisor's Memory.*
1686 |   * üîπ **`__repr__`**
1687 | 
1688 | ### üìÑ `backend/app/domains/system/registry.py`
1689 | 
1690 | ### üìÑ `backend/app/domains/system/seeds.py`
1691 | **Components & Logic:**
1692 | 
1693 | - ∆í **`seed_static`**
1694 |     > *Writes the Constitution, Core Bricks, and UI Shell to the Meta-Kernel.*
1695 |     * **1.** Seed Policies
1696 |     * **2.** Seed System Domain & Bricks
1697 |     * Ensure SYS Domain
1698 |     * Ensure SYS Scopes
1699 |     * **3.** ‚ö° HYDRATE WORKFLOW TYPES (State Engine V3)
1700 |     * **4.** ‚ö° HYDRATE NAVIGATION (Fractal UI Shell)
1701 |     * This ensures the Sidebar and Avatar Menu are populated on boot.
1702 | 
1703 | - ∆í **`seed_assets`**
1704 | - ∆í **`seed_history`**
1705 | 
1706 | ---
1707 | ### üìÑ `backend/app/domains/workspace/models.py`
1708 | **Components & Logic:**
1709 | 
1710 | - üì¶ **`Screen`**
1711 |     > *THE CANVAS.*
1712 |   * üîπ **`__repr__`**
1713 | - üì¶ **`ActiveApp`**
1714 |     > *THE DRAFT INSTANCE.*
1715 |   * üîπ **`__repr__`**
1716 | - üì¶ **`Release`**
1717 |     > *THE COMMIT (Snapshot).*
1718 |   * üîπ **`__repr__`**
1719 | - üì¶ **`ReleaseItem`**
1720 |     > *THE FROZEN ARTIFACT.*
1721 |   * üîπ **`__repr__`**
1722 | 
1723 | ### üìÑ `backend/app/domains/workspace/router.py`
1724 | **Components & Logic:**
1725 | 
1726 | - ∆í **`create_screen`**
1727 | - ∆í **`list_screens`**
1728 | - ∆í **`list_bricks`**
1729 | - ∆í **`install_app`**
1730 | - ∆í **`configure_app`**
1731 | - ∆í **`uninstall_app`**
1732 | - ∆í **`publish_release`**
1733 |     > *Triggers a Snapshot of the current Draft.*
1734 | - ∆í **`list_releases`**
1735 | - ∆í **`resolve_layout`**
1736 |     > *Returns the layout tree.*
1737 | 
1738 | ### üìÑ `backend/app/domains/workspace/schemas.py`
1739 | **Components & Logic:**
1740 | 
1741 | - üì¶ **`ScreenBase`**
1742 | - üì¶ **`ScreenCreate`**
1743 | - üì¶ **`ScreenUpdate`**
1744 | - üì¶ **`ScreenRead`**
1745 | - üì¶ **`ScreenList`**
1746 | - üì¶ **`ActiveAppBase`**
1747 | - üì¶ **`ActiveAppCreate`**
1748 | - üì¶ **`ActiveAppUpdate`**
1749 | - üì¶ **`ActiveAppRead`**
1750 | - üì¶ **`BrickList`**
1751 | - üì¶ **`ReleaseCreate`**
1752 | - üì¶ **`ReleaseRead`**
1753 | 
1754 | ### üìÑ `backend/app/domains/workspace/seeds.py`
1755 | **Components & Logic:**
1756 | 
1757 | - ∆í **`seed_assets`**
1758 |     > *Wave 2: Create Default Screens.*
1759 |     * **1.** The Admin Console (Meta Studio)
1760 |     * This matches the Frontend Route '/meta'
1761 |     * **2.** Example Business App (Logistics)
1762 | 
1763 | 
1764 | ### üìÑ `backend/app/domains/workspace/service.py`
1765 | **Components & Logic:**
1766 | 
1767 | - üì¶ **`WorkspaceService`**
1768 |   * üîπ **`create_screen`**
1769 |   * üîπ **`list_screens`**
1770 |       * **‚ö° ENRICHMENT:** Eager load live_release to show version info in Lobby
1771 |       * **‚ö° SORTING:** Show most recently updated screens first
1772 | 
1773 |   * üîπ **`list_available_bricks`**
1774 |       * **‚ö° FILTER:** Only UI-compatible bricks (Use Enum SSOT)
1775 |       * We explicitly exclude ScopeType.JOB as it's a backend-only construct
1776 | 
1777 |   * üîπ **`install_app`**
1778 |       * ‚ö° TOUCH PARENT: Update screen.updated_at so it moves to top of list
1779 | 
1780 |   * üîπ **`update_app`**
1781 |       * ‚ö° TOUCH PARENT
1782 | 
1783 |   * üîπ **`uninstall_app`**
1784 |       * ‚ö° TOUCH PARENT
1785 | 
1786 |   * üîπ **`publish_release`**
1787 |       * Auto-increment internal counter
1788 |       * Snapshot Logic
1789 | 
1790 |   * üîπ **`list_releases`**
1791 |   * üîπ **`resolve_layout`**
1792 |       * ‚ö° HISTORY LOOKUP: Fetch the absolute latest release to inform the UI
1793 |       * **MODE:** LIVE (Render from Snapshot)
1794 |       * **MODE:** DRAFT (Render from ActiveApps)
1795 | 
1796 | 
1797 | ---
1798 | ### üìÑ `backend/app/main.py`
1799 | **Components & Logic:**
1800 | 
1801 | - ∆í **`lifespan`**
1802 |     * ‚ö° PHASE 1: KERNEL BOOT (Read-Only Cache Hydration)
1803 |     * ‚ö° ARCHITECTURAL INVARIANT: The API Server only READS during boot.
1804 |     * Seeding is strictly delegated to the standalone `seed.py` Orchestrator.
1805 |     * We don't raise here to allow the API to start in "Safe Mode" if DB fails,
1806 |     * but in Level 100 we might want to crash. For now, we log loud.
1807 | 
1808 | - ∆í **`create_application`**
1809 |     * ‚ö° GLOBAL INTERCEPTOR (Business Logic Gates)
1810 |     * **1.** MAINTENANCE CHECK (Global)
1811 |     * **2.** ‚ö° DOMAIN ENFORCEMENT (Kill Switch)
1812 |     * ‚ö° INFRASTRUCTURE MIDDLEWARE (Execution Order: Bottom-Up)
1813 |     * **3.** CORS (Outermost)
1814 |     * **2.** CONTEXT HYDRATION (Injects User/TraceID)
1815 |     * **1.** ROUTER MOUNTING
1816 | 
1817 | 
1818 | ---
1819 | ### üìÑ `backend/app/middleware/context.py`
1820 | **Components & Logic:**
1821 | 
1822 | - üì¶ **`ContextMiddleware`**
1823 |     > *Ensures every request has a Trace ID and populates the GlobalContext*
1824 |   * üîπ **`dispatch`**
1825 |       * **1.** ‚ö° TRACE ID (Generate or Propagate)
1826 |       * **2.** ‚ö° AUTHENTICATION INSPECTION
1827 |       * We manually decode the JWT here to ensure the Context is available
1828 |       * even if the endpoint doesn't strictly require auth (e.g. for logging).
1829 |       * Decode JWT
1830 |       * Hydrate Context from Token Claims
1831 |       * Note: Ideally the token contains role/email.
1832 |       * If not, we set safe defaults that the ActorProvider can return.
1833 |       * ‚ö° FAIL OPEN (For Middleware):
1834 |       * We don't block the request here. We just don't set the context.
1835 |       * The Domain Enforcer or Endpoint Dependency will handle 401s.
1836 |       * **3.** ‚ö° SET GLOBAL CONTEXT
1837 |       * **4.** ‚ö° EXECUTE REQUEST
1838 |       * **5.** ‚ö° INJECT TRACE ID INTO RESPONSE HEADER
1839 | 
1840 | 
1841 | ---
1842 | ### üìÑ `backend/audit_hardcoding.py`
1843 | **Components & Logic:**
1844 | 
1845 | - üì¶ **`HardCodingVisitor`**
1846 |   * üîπ **`__init__`**
1847 |   * üîπ **`visit_Assign`**
1848 |       > *Checks variable assignments (e.g., x = '12345').*
1849 |       * If assigning to UPPER_CASE, it's a Constant (Acceptable).
1850 | 
1851 |   * üîπ **`visit_Call`**
1852 |       > *Checks function arguments (e.g., connect('192.168.1.1')).*
1853 |       * Skip logging calls (usually safe text)
1854 | 
1855 |   * üîπ **`_check_value`**
1856 |       * **1.** Check for specific dangerous patterns
1857 |       * Filter out simple path routes like "/api/v1" or relative paths
1858 |       * **2.** Check for "Magic Strings" in logic (longer than 10 chars, no spaces)
1859 |       * if len(value) > 15 and " " not in value and not value.startswith("antd:"):
1860 |       * self.issues.append({
1861 |       * "file": self.filename,
1862 |       * "line": lineno,
1863 |       * "type": "‚ÑπÔ∏è Magic String",
1864 |       * "value": value,
1865 |       * "context": context
1866 |       * })
1867 |       * **3.** Check for "Magic Numbers"
1868 | 
1869 | - ∆í **`scan_file`**
1870 | - ∆í **`main`**
1871 |     * Filter Ignored Directories
1872 | 
1873 | 
1874 | ### üìÑ `backend/cartographer.py`
1875 | **Components & Logic:**
1876 | 
1877 | - üì¶ **`SemanticNode`**
1878 |     > *Represents a code unit (Class, Function) and its metadata.*
1879 |   * üîπ **`__init__`**
1880 | - üì¶ **`FileAnalysis`**
1881 |     > *Holds the scan results for a single file.*
1882 |   * üîπ **`__init__`**
1883 | - üì¶ **`SemanticVisitor`**
1884 |   * üîπ **`__init__`**
1885 |   * üîπ **`_parse_tags`**
1886 |       > *Extracts @tag: value from docstrings.*
1887 |   * üîπ **`_extract_narrative`**
1888 |       > *Scans function body for comments and cleans them.*
1889 |       * ' in line:
1890 |       * ', 1)[1].strip()
1891 | 
1892 |   * üîπ **`visit_Module`**
1893 |   * üîπ **`visit_ClassDef`**
1894 |   * üîπ **`visit_FunctionDef`**
1895 |   * üîπ **`visit_AsyncFunctionDef`**
1896 |   * üîπ **`_visit_function`**
1897 | - üì¶ **`Cartographer`**
1898 |     > *The Main Orchestrator.*
1899 |   * üîπ **`__init__`**
1900 |   * üîπ **`run`**
1901 |   * üîπ **`_scan_codebase`**
1902 |   * üîπ **`_prettify_comment`**
1903 |       > *Transforms raw comments into rich Markdown.*
1904 |   * üîπ **`_render_atlas`**
1905 |       * **1.** Folder Header (Optional, good for grouping)
1906 |       * **‚ö° FIX:** Construct the FULL DISPLAY PATH
1907 |       * "backend" + "app/core/system.py" = "backend/app/core/system.py"
1908 |       * Logic for Role Icons
1909 |       * **2.** File Header with FULL PATH
1910 |       * Description
1911 |       * Nodes
1912 | 
1913 |   * üîπ **`_render_node`**
1914 | 
1915 | ### üìÑ `backend/check_ai.py`
1916 | **Components & Logic:**
1917 | 
1918 | - ∆í **`main`**
1919 |     * Mask key for security
1920 |     * **2.** Initialize Client (New SDK)
1921 |     * **3.** List Models
1922 |     * The new SDK list method returns an iterable of models
1923 |     * **4.** Thinking Model Check
1924 |     * We have to re-iterate or store the list, but list() returns a generator usually.
1925 |     * Let's just do a specific check if we didn't see it above (visual check is good enough for diag).
1926 |     * Actually, let's verify connectivity with a quick test.
1927 |     * Use a generic flash model for safety test
1928 | 
1929 | 
1930 | ### üìÑ `backend/consumer.py`
1931 | **Components & Logic:**
1932 | 
1933 | - ∆í **`consume`**
1934 | 
1935 | ### üìÑ `backend/nuke.py`
1936 | **Components & Logic:**
1937 | 
1938 | - ∆í **`smart_nuke`**
1939 |     > *Connects to the Maintenance DB (postgres) to drop/create the Target DB (flodock).*
1940 |     * **1.** Parse Config to get target DB name
1941 |     * **2.** Construct Maintenance Connection (Connect to 'postgres' instead of target)
1942 |     * We replace the path (database name) with 'postgres'
1943 |     * Isolation level AUTOCOMMIT is required to run DROP DATABASE
1944 |     * **3.** Kill Active Connections (The "Force" move)
1945 |     * **4.** Drop Database
1946 |     * **5.** Create Database
1947 |     * **6.** Grant Permissions (Optional but good practice)
1948 |     * await conn.execute(text(f"GRANT ALL PRIVILEGES ON DATABASE {target_db} TO {parsed.username};"))
1949 |     * If we failed to connect to 'postgres', maybe the credentials only allow connecting to specific DBs?
1950 | 
1951 | 
1952 | ### üìÑ `backend/probe_diagnostics.py`
1953 | **Components & Logic:**
1954 | 
1955 | - ∆í **`run_diagnostics`**
1956 |     * **1.** INSPECT COLUMNS (The Truth)
1957 |     * We use `run_sync` to use the standard SQLAlchemy inspector
1958 |     * **2.** CHECK DATA
1959 |     * Show the latest event
1960 | 
1961 | 
1962 | ---
1963 | ### üìÑ `backend/scripts/kafka/consume.py`
1964 | **Components & Logic:**
1965 | 
1966 | - ∆í **`consume`**
1967 | 
1968 | ### üìÑ `backend/scripts/kafka/install.py`
1969 | **Components & Logic:**
1970 | 
1971 | - ∆í **`get_paths`**
1972 |     * resolve relative to this script: backend/scripts/kafka/
1973 | 
1974 | - ∆í **`download_progress`**
1975 | - ∆í **`force_remove`**
1976 |     > *Retries deletion to handle Windows file locks.*
1977 | - ∆í **`install`**
1978 |     * **1.** PREPARE DIR
1979 |     * **2.** CHECK EXISTING
1980 |     * **3.** DOWNLOAD
1981 |     * **4.** EXTRACT
1982 |     * Python 3.12+ filter fix
1983 |     * **5.** RENAME & MOVE
1984 |     * Cleanup Zip
1985 |     * **6.** CONFIGURE
1986 |     * Paths must use forward slashes for Java on Windows
1987 |     * Patch Server
1988 |     * Patch Zookeeper
1989 | 
1990 | 
1991 | ### üìÑ `backend/scripts/kafka/patch_config.py`
1992 | **Components & Logic:**
1993 | 
1994 | - ∆í **`get_paths`**
1995 |     * resolve relative to this script: ../../../infrastructure/kafka
1996 | 
1997 | - ∆í **`patch_file`**
1998 |     * Add missing keys
1999 | 
2000 | - ∆í **`main`**
2001 |     * Define Paths
2002 |     * Define Data Directories (Force Forward Slashes for Java)
2003 |     * **1.** Patch Server Properties
2004 |     * **2.** Patch Zookeeper Properties
2005 | 
2006 | 
2007 | ### üìÑ `backend/scripts/kafka/run_cluster.py`
2008 | **Components & Logic:**
2009 | 
2010 | - ∆í **`get_paths`**
2011 | - ∆í **`find_java_home`**
2012 | - ∆í **`run_service_blocking`**
2013 |     > *Runs the service in the CURRENT process.*
2014 |     * Minimal Path + Wbem
2015 |     * Construct Command
2016 |     * **FIX:** Use raw string for Windows wildcard path
2017 | 
2018 | - ∆í **`main`**
2019 | 
2020 | ---
2021 | ### üìÑ `backend/seed.py`
2022 | **Components & Logic:**
2023 | 
2024 | - ∆í **`get_domain_modules`**
2025 |     > *Scans 'app/domains' and returns a list of active modules.*
2026 | - ∆í **`run_wave`**
2027 |     > *Executes a specific wave across ALL domains simultaneously.*
2028 | - ∆í **`run_seeding_process`**
2029 |     > *The Main Execution Flow.*
2030 |     * ‚ö° PHASE 0: ZERO-TOUCH BOOTSTRAP (The "Smart Start")
2031 |     * Dynamically load all Domain Models into memory so SQLAlchemy knows they exist
2032 |     * Force SQLAlchemy to construct the physical tables if they are missing
2033 |     * --- RESET MODE (Reverse Waves) ---
2034 |     * ‚ö° PHASE 0.5: KERNEL HYDRATION
2035 |     * --- SEED MODE (Forward Waves) ---
2036 |     * Guard: Don't run History in Prod unless explicit
2037 | 
2038 | - ∆í **`main`**
2039 | 
2040 | ### üìÑ `backend/trigger_circuit.py`
2041 | **Components & Logic:**
2042 | 
2043 | - ∆í **`fire_circuit_event`**
2044 |     * ‚ö° MANUALLY REGISTER INTERCEPTOR (Required for standalone scripts)
2045 |     * **1.** Ensure it exists (Prime the cache/db)
2046 |     * **2.** Toggle State (The Mutation)
2047 |     * This calls the refactored ORM method
2048 |     * **3.** Commit (Triggers Interceptor)
2049 | 
2050 | 
2051 | ### üìÑ `backend/trigger_event.py`
2052 | **Components & Logic:**
2053 | 
2054 | - ∆í **`fire_test_event`**
2055 |     * **‚ö° CRITICAL:** We must register the interceptor manually for this script context
2056 |     * In the real app, main.py does this.
2057 |     * **1.** Fetch User
2058 |     * **2.** Modify State (Trigger Dirty Check)
2059 |     * We update a field to force SQLAlchemy to mark it 'dirty'
2060 |     * **3.** Commit (Triggers Interceptor -> Outbox)
2061 | 
2062 | 
2063 | ### üìÑ `backend/trigger_meta.py`
2064 | **Components & Logic:**
2065 | 
2066 | - ∆í **`fire_meta_event`**
2067 |     * Register Interceptor
2068 |     * Verify Registration
2069 |     * **1.** Create Policy
2070 |     * **2.** Commit (Triggers Interceptor)
2071 | 
2072 | 

================================================================================

# Source code from: frontend\src\api\services\MetaKernelService.ts
--------------------------------------------------------------------
   1 | // FILEPATH: frontend/src/api/services/MetaKernelService.ts
   2 | // generated using openapi-typescript-codegen -- do not edit */
   3 | // istanbul ignore file */
   4 | // tslint:disable */
   5 | // eslint-disable */
   6 | import type { AttributeCreate } from '../models/AttributeCreate';
   7 | import type { AttributeRead } from '../models/AttributeRead';
   8 | import type { AttributeUpdate } from '../models/AttributeUpdate';
   9 | import type { DryRunRequest } from '../models/DryRunRequest';
  10 | import type { DryRunResult } from '../models/DryRunResult';
  11 | import type { PolicyBindingCreate } from '../models/PolicyBindingCreate';
  12 | import type { PolicyBindingRead } from '../models/PolicyBindingRead';
  13 | import type { PolicyBindingUpdate } from '../models/PolicyBindingUpdate';
  14 | import type { PolicyCreate } from '../models/PolicyCreate';
  15 | import type { PolicyGroupCreate } from '../models/PolicyGroupCreate';
  16 | import type { PolicyGroupRead } from '../models/PolicyGroupRead';
  17 | import type { PolicyGroupUpdate } from '../models/PolicyGroupUpdate';
  18 | import type { PolicyRead } from '../models/PolicyRead';
  19 | import type { PolicyUpdate } from '../models/PolicyUpdate';
  20 | import type { RuleCreate } from '../models/RuleCreate';
  21 | import type { RuleRead } from '../models/RuleRead';
  22 | import type { StateMachineCreate } from '../models/StateMachineCreate';
  23 | import type { StateMachineRead } from '../models/StateMachineRead';
  24 | import type { CancelablePromise } from '../core/CancelablePromise';
  25 | import { OpenAPI } from '../core/OpenAPI';
  26 | import { request as __request } from '../core/request';
  27 | 
  28 | export class MetaKernelService {
  29 | 
  30 |     /**
  31 |      * ‚ö° GET TOPOLOGY (Manual Patch)
  32 |      * Fetch the Concrete Topology for a Domain.
  33 |      * @param domain
  34 |      * @returns any[] Successful Response
  35 |      */
  36 |     public static getTopology(
  37 |         domain: string,
  38 |     ): CancelablePromise<Array<any>> {
  39 |         return __request(OpenAPI, {
  40 |             method: 'GET',
  41 |             url: '/api/v1/meta/topology/{domain}',
  42 |             path: {
  43 |                 'domain': domain,
  44 |             },
  45 |         });
  46 |     }
  47 | 
  48 |     /**
  49 |      * Create Policy Group
  50 |      * @param requestBody
  51 |      * @returns PolicyGroupRead Successful Response
  52 |      * @throws ApiError
  53 |      */
  54 |     public static createGroupApiV1MetaGroupsPost(
  55 |         requestBody: PolicyGroupCreate,
  56 |     ): CancelablePromise<PolicyGroupRead> {
  57 |         return __request(OpenAPI, {
  58 |             method: 'POST',
  59 |             url: '/api/v1/meta/groups/',
  60 |             body: requestBody,
  61 |             mediaType: 'application/json',
  62 |             errors: {
  63 |                 422: `Validation Error`,
  64 |             },
  65 |         });
  66 |     }
  67 |     /**
  68 |      * List Groups
  69 |      * @param active Filter active groups
  70 |      * @returns PolicyGroupRead Successful Response
  71 |      * @throws ApiError
  72 |      */
  73 |     public static listGroupsApiV1MetaGroupsGet(
  74 |         active: boolean = true,
  75 |     ): CancelablePromise<Array<PolicyGroupRead>> {
  76 |         return __request(OpenAPI, {
  77 |             method: 'GET',
  78 |             url: '/api/v1/meta/groups/',
  79 |             query: {
  80 |                 'active': active,
  81 |             },
  82 |             errors: {
  83 |                 422: `Validation Error`,
  84 |             },
  85 |         });
  86 |     }
  87 |     /**
  88 |      * Get Group Details
  89 |      * @param id Group ID
  90 |      * @returns PolicyGroupRead Successful Response
  91 |      * @throws ApiError
  92 |      */
  93 |     public static getGroupApiV1MetaGroupsIdGet(
  94 |         id: number,
  95 |     ): CancelablePromise<PolicyGroupRead> {
  96 |         return __request(OpenAPI, {
  97 |             method: 'GET',
  98 |             url: '/api/v1/meta/groups/{id}',
  99 |             path: {
 100 |                 'id': id,
 101 |             },
 102 |             errors: {
 103 |                 422: `Validation Error`,
 104 |             },
 105 |         });
 106 |     }
 107 |     /**
 108 |      * Update Group
 109 |      * @param id
 110 |      * @param requestBody
 111 |      * @returns PolicyGroupRead Successful Response
 112 |      * @throws ApiError
 113 |      */
 114 |     public static updateGroupApiV1MetaGroupsIdPatch(
 115 |         id: number,
 116 |         requestBody: PolicyGroupUpdate,
 117 |     ): CancelablePromise<PolicyGroupRead> {
 118 |         return __request(OpenAPI, {
 119 |             method: 'PATCH',
 120 |             url: '/api/v1/meta/groups/{id}',
 121 |             path: {
 122 |                 'id': id,
 123 |             },
 124 |             body: requestBody,
 125 |             mediaType: 'application/json',
 126 |             errors: {
 127 |                 422: `Validation Error`,
 128 |             },
 129 |         });
 130 |     }
 131 |     /**
 132 |      * Deactivate Group
 133 |      * @param id
 134 |      * @returns void
 135 |      * @throws ApiError
 136 |      */
 137 |     public static deleteGroupApiV1MetaGroupsIdDelete(
 138 |         id: number,
 139 |     ): CancelablePromise<void> {
 140 |         return __request(OpenAPI, {
 141 |             method: 'DELETE',
 142 |             url: '/api/v1/meta/groups/{id}',
 143 |             path: {
 144 |                 'id': id,
 145 |             },
 146 |             errors: {
 147 |                 422: `Validation Error`,
 148 |             },
 149 |         });
 150 |     }
 151 |     /**
 152 |      * Create State Machine
 153 |      * @param requestBody
 154 |      * @returns StateMachineRead Successful Response
 155 |      * @throws ApiError
 156 |      */
 157 |     public static createStateMachineApiV1MetaStatesPost(
 158 |         requestBody: StateMachineCreate,
 159 |     ): CancelablePromise<StateMachineRead> {
 160 |         return __request(OpenAPI, {
 161 |             method: 'POST',
 162 |             url: '/api/v1/meta/states',
 163 |             body: requestBody,
 164 |             mediaType: 'application/json',
 165 |             errors: {
 166 |                 422: `Validation Error`,
 167 |             },
 168 |         });
 169 |     }
 170 |     /**
 171 |      * List State Machines
 172 |      * @param domain
 173 |      * @returns StateMachineRead Successful Response
 174 |      * @throws ApiError
 175 |      */
 176 |     public static listStateMachinesApiV1MetaStatesGet(
 177 |         domain?: (string | null),
 178 |     ): CancelablePromise<Array<StateMachineRead>> {
 179 |         return __request(OpenAPI, {
 180 |             method: 'GET',
 181 |             url: '/api/v1/meta/states',
 182 |             query: {
 183 |                 'domain': domain,
 184 |             },
 185 |             errors: {
 186 |                 422: `Validation Error`,
 187 |             },
 188 |         });
 189 |     }
 190 |     /**
 191 |      * Get Flow Definition
 192 |      * @param domain
 193 |      * @param scope
 194 |      * @returns StateMachineRead Successful Response
 195 |      * @throws ApiError
 196 |      */
 197 |     public static getFlowDefinitionApiV1MetaStatesDomainScopeGet(
 198 |         domain: string,
 199 |         scope: string,
 200 |     ): CancelablePromise<StateMachineRead> {
 201 |         return __request(OpenAPI, {
 202 |             method: 'GET',
 203 |             url: '/api/v1/meta/states/{domain}/{scope}',
 204 |             path: {
 205 |                 'domain': domain,
 206 |                 'scope': scope,
 207 |             },
 208 |             errors: {
 209 |                 422: `Validation Error`,
 210 |             },
 211 |         });
 212 |     }
 213 |     /**
 214 |      * Get Flow History
 215 |      * @param domain
 216 |      * @param scope
 217 |      * @returns StateMachineRead Successful Response
 218 |      * @throws ApiError
 219 |      */
 220 |     public static getFlowHistoryApiV1MetaStatesDomainScopeHistoryGet(
 221 |         domain: string,
 222 |         scope: string,
 223 |     ): CancelablePromise<Array<StateMachineRead>> {
 224 |         return __request(OpenAPI, {
 225 |             method: 'GET',
 226 |             url: '/api/v1/meta/states/{domain}/{scope}/history',
 227 |             path: {
 228 |                 'domain': domain,
 229 |                 'scope': scope,
 230 |             },
 231 |             errors: {
 232 |                 422: `Validation Error`,
 233 |             },
 234 |         });
 235 |     }
 236 |     /**
 237 |      * Get Flow Version
 238 |      * @param domain
 239 |      * @param scope
 240 |      * @param version
 241 |      * @returns StateMachineRead Successful Response
 242 |      * @throws ApiError
 243 |      */
 244 |     public static getFlowVersionApiV1MetaStatesDomainScopeVersionGet(
 245 |         domain: string,
 246 |         scope: string,
 247 |         version: number,
 248 |     ): CancelablePromise<StateMachineRead> {
 249 |         return __request(OpenAPI, {
 250 |             method: 'GET',
 251 |             url: '/api/v1/meta/states/{domain}/{scope}/{version}',
 252 |             path: {
 253 |                 'domain': domain,
 254 |                 'scope': scope,
 255 |                 'version': version,
 256 |             },
 257 |             errors: {
 258 |                 422: `Validation Error`,
 259 |             },
 260 |         });
 261 |     }
 262 |     /**
 263 |      * Delete Workflow
 264 |      * @param id
 265 |      * @returns any Successful Response
 266 |      * @throws ApiError
 267 |      */
 268 |     public static deleteWorkflowApiV1MetaStatesIdDelete(
 269 |         id: number,
 270 |     ): CancelablePromise<any> {
 271 |         return __request(OpenAPI, {
 272 |             method: 'DELETE',
 273 |             url: '/api/v1/meta/states/{id}',
 274 |             path: {
 275 |                 'id': id,
 276 |             },
 277 |             errors: {
 278 |                 422: `Validation Error`,
 279 |             },
 280 |         });
 281 |     }
 282 |     /**
 283 |      * List Policies
 284 |      * @returns PolicyRead Successful Response
 285 |      * @throws ApiError
 286 |      */
 287 |     public static listPoliciesApiV1MetaPoliciesGet(): CancelablePromise<Array<PolicyRead>> {
 288 |         return __request(OpenAPI, {
 289 |             method: 'GET',
 290 |             url: '/api/v1/meta/policies',
 291 |         });
 292 |     }
 293 |     /**
 294 |      * Create Policy
 295 |      * @param requestBody
 296 |      * @returns PolicyRead Successful Response
 297 |      * @throws ApiError
 298 |      */
 299 |     public static createPolicyApiV1MetaPoliciesPost(
 300 |         requestBody: PolicyCreate,
 301 |     ): CancelablePromise<PolicyRead> {
 302 |         return __request(OpenAPI, {
 303 |             method: 'POST',
 304 |             url: '/api/v1/meta/policies',
 305 |             body: requestBody,
 306 |             mediaType: 'application/json',
 307 |             errors: {
 308 |                 422: `Validation Error`,
 309 |             },
 310 |         });
 311 |     }
 312 |     /**
 313 |      * Update Policy
 314 |      * @param id
 315 |      * @param requestBody
 316 |      * @returns PolicyRead Successful Response
 317 |      * @throws ApiError
 318 |      */
 319 |     public static updatePolicyApiV1MetaPoliciesIdPatch(
 320 |         id: number,
 321 |         requestBody: PolicyUpdate,
 322 |     ): CancelablePromise<PolicyRead> {
 323 |         return __request(OpenAPI, {
 324 |             method: 'PATCH',
 325 |             url: '/api/v1/meta/policies/{id}',
 326 |             path: {
 327 |                 'id': id,
 328 |             },
 329 |             body: requestBody,
 330 |             mediaType: 'application/json',
 331 |             errors: {
 332 |                 422: `Validation Error`,
 333 |             },
 334 |         });
 335 |     }
 336 |     /**
 337 |      * Dry Run Policy
 338 |      * @param requestBody
 339 |      * @returns DryRunResult Successful Response
 340 |      * @throws ApiError
 341 |      */
 342 |     public static dryRunPolicyApiV1MetaPoliciesDryRunPost(
 343 |         requestBody: DryRunRequest,
 344 |     ): CancelablePromise<DryRunResult> {
 345 |         return __request(OpenAPI, {
 346 |             method: 'POST',
 347 |             url: '/api/v1/meta/policies/dry-run',
 348 |             body: requestBody,
 349 |             mediaType: 'application/json',
 350 |             errors: {
 351 |                 422: `Validation Error`,
 352 |             },
 353 |         });
 354 |     }
 355 |     /**
 356 |      * Get Policy History
 357 |      * @param key
 358 |      * @returns PolicyRead Successful Response
 359 |      * @throws ApiError
 360 |      */
 361 |     public static getPolicyHistoryApiV1MetaPoliciesKeyHistoryGet(
 362 |         key: string,
 363 |     ): CancelablePromise<Array<PolicyRead>> {
 364 |         return __request(OpenAPI, {
 365 |             method: 'GET',
 366 |             url: '/api/v1/meta/policies/{key}/history',
 367 |             path: {
 368 |                 'key': key,
 369 |             },
 370 |             errors: {
 371 |                 422: `Validation Error`,
 372 |             },
 373 |         });
 374 |     }
 375 |     /**
 376 |      * Restore Policy Version
 377 |      * @param versionId
 378 |      * @returns PolicyRead Successful Response
 379 |      * @throws ApiError
 380 |      */
 381 |     public static restorePolicyVersionApiV1MetaPoliciesVersionIdRestorePost(
 382 |         versionId: number,
 383 |     ): CancelablePromise<PolicyRead> {
 384 |         return __request(OpenAPI, {
 385 |             method: 'POST',
 386 |             url: '/api/v1/meta/policies/{version_id}/restore',
 387 |             path: {
 388 |                 'version_id': versionId,
 389 |             },
 390 |             errors: {
 391 |                 422: `Validation Error`,
 392 |             },
 393 |         });
 394 |     }
 395 |     /**
 396 |      * List Bindings
 397 |      * @param domain Filter by Domain Key
 398 |      * @param scope Filter by Scope
 399 |      * @param search Search by Name or Tag
 400 |      * @returns PolicyBindingRead Successful Response
 401 |      * @throws ApiError
 402 |      */
 403 |     public static listBindingsApiV1MetaBindingsGet(
 404 |         domain?: (string | null),
 405 |         scope?: (string | null),
 406 |         search?: (string | null),
 407 |     ): CancelablePromise<Array<PolicyBindingRead>> {
 408 |         return __request(OpenAPI, {
 409 |             method: 'GET',
 410 |             url: '/api/v1/meta/bindings',
 411 |             query: {
 412 |                 'domain': domain,
 413 |                 'scope': scope,
 414 |                 'search': search,
 415 |             },
 416 |             errors: {
 417 |                 422: `Validation Error`,
 418 |             },
 419 |         });
 420 |     }
 421 |     /**
 422 |      * Create Binding
 423 |      * @param requestBody
 424 |      * @returns PolicyBindingRead Successful Response
 425 |      * @throws ApiError
 426 |      */
 427 |     public static createBindingApiV1MetaBindingsPost(
 428 |         requestBody: PolicyBindingCreate,
 429 |     ): CancelablePromise<PolicyBindingRead> {
 430 |         return __request(OpenAPI, {
 431 |             method: 'POST',
 432 |             url: '/api/v1/meta/bindings',
 433 |             body: requestBody,
 434 |             mediaType: 'application/json',
 435 |             errors: {
 436 |                 422: `Validation Error`,
 437 |             },
 438 |         });
 439 |     }
 440 |     /**
 441 |      * Update Binding
 442 |      * @param id
 443 |      * @param requestBody
 444 |      * @returns PolicyBindingRead Successful Response
 445 |      * @throws ApiError
 446 |      */
 447 |     public static updateBindingApiV1MetaBindingsIdPatch(
 448 |         id: number,
 449 |         requestBody: PolicyBindingUpdate,
 450 |     ): CancelablePromise<PolicyBindingRead> {
 451 |         return __request(OpenAPI, {
 452 |             method: 'PATCH',
 453 |             url: '/api/v1/meta/bindings/{id}',
 454 |             path: {
 455 |                 'id': id,
 456 |             },
 457 |             body: requestBody,
 458 |             mediaType: 'application/json',
 459 |             errors: {
 460 |                 422: `Validation Error`,
 461 |             },
 462 |         });
 463 |     }
 464 |     /**
 465 |      * Delete Binding
 466 |      * @param id
 467 |      * @returns any Successful Response
 468 |      * @throws ApiError
 469 |      */
 470 |     public static deleteBindingApiV1MetaBindingsIdDelete(
 471 |         id: number,
 472 |     ): CancelablePromise<any> {
 473 |         return __request(OpenAPI, {
 474 |             method: 'DELETE',
 475 |             url: '/api/v1/meta/bindings/{id}',
 476 |             path: {
 477 |                 'id': id,
 478 |             },
 479 |             errors: {
 480 |                 422: `Validation Error`,
 481 |             },
 482 |         });
 483 |     }
 484 |     /**
 485 |      * Create Attribute
 486 |      * @param requestBody
 487 |      * @returns AttributeRead Successful Response
 488 |      * @throws ApiError
 489 |      */
 490 |     public static createAttributeApiV1MetaAttributesPost(
 491 |         requestBody: AttributeCreate,
 492 |     ): CancelablePromise<AttributeRead> {
 493 |         return __request(OpenAPI, {
 494 |             method: 'POST',
 495 |             url: '/api/v1/meta/attributes',
 496 |             body: requestBody,
 497 |             mediaType: 'application/json',
 498 |             errors: {
 499 |                 422: `Validation Error`,
 500 |             },
 501 |         });
 502 |     }
 503 |     /**
 504 |      * Update Attribute
 505 |      * @param id
 506 |      * @param requestBody
 507 |      * @returns AttributeRead Successful Response
 508 |      * @throws ApiError
 509 |      */
 510 |     public static updateAttributeApiV1MetaAttributesIdPatch(
 511 |         id: number,
 512 |         requestBody: AttributeUpdate,
 513 |     ): CancelablePromise<AttributeRead> {
 514 |         return __request(OpenAPI, {
 515 |             method: 'PATCH',
 516 |             url: '/api/v1/meta/attributes/{id}',
 517 |             path: {
 518 |                 'id': id,
 519 |             },
 520 |             body: requestBody,
 521 |             mediaType: 'application/json',
 522 |             errors: {
 523 |                 422: `Validation Error`,
 524 |             },
 525 |         });
 526 |     }
 527 |     /**
 528 |      * Delete Attribute
 529 |      * @param id
 530 |      * @returns any Successful Response
 531 |      * @throws ApiError
 532 |      */
 533 |     public static deleteAttributeApiV1MetaAttributesIdDelete(
 534 |         id: number,
 535 |     ): CancelablePromise<any> {
 536 |         return __request(OpenAPI, {
 537 |             method: 'DELETE',
 538 |             url: '/api/v1/meta/attributes/{id}',
 539 |             path: {
 540 |                 'id': id,
 541 |             },
 542 |             errors: {
 543 |                 422: `Validation Error`,
 544 |             },
 545 |         });
 546 |     }
 547 |     /**
 548 |      * List Rules
 549 |      * @param domain
 550 |      * @param eventType
 551 |      * @param scope
 552 |      * @returns RuleRead Successful Response
 553 |      * @throws ApiError
 554 |      */
 555 |     public static listRulesApiV1MetaRulesGet(
 556 |         domain: string,
 557 |         eventType?: (string | null),
 558 |         scope?: (string | null),
 559 |     ): CancelablePromise<Array<RuleRead>> {
 560 |         return __request(OpenAPI, {
 561 |             method: 'GET',
 562 |             url: '/api/v1/meta/rules',
 563 |             query: {
 564 |                 'domain': domain,
 565 |                 'event_type': eventType,
 566 |                 'scope': scope,
 567 |             },
 568 |             errors: {
 569 |                 422: `Validation Error`,
 570 |             },
 571 |         });
 572 |     }
 573 |     /**
 574 |      * Create Rule
 575 |      * @param requestBody
 576 |      * @returns RuleRead Successful Response
 577 |      * @throws ApiError
 578 |      */
 579 |     public static createRuleApiV1MetaRulesPost(
 580 |         requestBody: RuleCreate,
 581 |     ): CancelablePromise<RuleRead> {
 582 |         return __request(OpenAPI, {
 583 |             method: 'POST',
 584 |             url: '/api/v1/meta/rules',
 585 |             body: requestBody,
 586 |             mediaType: 'application/json',
 587 |             errors: {
 588 |                 422: `Validation Error`,
 589 |             },
 590 |         });
 591 |     }
 592 |     /**
 593 |      * Get Domain Schema
 594 |      * SCHEMA FUSION ENDPOINT.
 595 |      * Delegates all logic to MetaService.get_fused_schema.
 596 |      * @param domain
 597 |      * @param activeOnly
 598 |      * @returns any Successful Response
 599 |      * @throws ApiError
 600 |      */
 601 |     public static getDomainSchemaApiV1MetaSchemaDomainGet(
 602 |         domain: string,
 603 |         activeOnly: boolean = true,
 604 |     ): CancelablePromise<any> {
 605 |         return __request(OpenAPI, {
 606 |             method: 'GET',
 607 |             url: '/api/v1/meta/schema/{domain}',
 608 |             path: {
 609 |                 'domain': domain,
 610 |             },
 611 |             query: {
 612 |                 'active_only': activeOnly,
 613 |             },
 614 |             errors: {
 615 |                 422: `Validation Error`,
 616 |             },
 617 |         });
 618 |     }
 619 |     /**
 620 |      * List Domains
 621 |      * @returns any Successful Response
 622 |      * @throws ApiError
 623 |      */
 624 |     public static listDomainsApiV1MetaDomainsGet(): CancelablePromise<any> {
 625 |         return __request(OpenAPI, {
 626 |             method: 'GET',
 627 |             url: '/api/v1/meta/domains',
 628 |         });
 629 |     }
 630 | }
 631 | 

================================================================================

# Source code from: frontend\src\domains\meta\_kernel\MetaContext.tsx
-----------------------------------------------------------------------
   1 | // FILEPATH: frontend/src/domains/meta/_kernel/MetaContext.tsx
   2 | // @file: Meta Context (The Brain)
   3 | // @role: üß† State Manager */
   4 | // @author: The Engineer
   5 | // @description: Manages Domain Selection, Scope, and Deep Linking. Bridges the URL to the Application State.
   6 | // @security-level: LEVEL 0 (Kernel) */
   7 | 
   8 | import React, { createContext, useContext, useEffect, useMemo } from 'react';
   9 | import { useUrlState } from '../../../platform/hooks/useUrlState';
  10 | import { logger } from '../../../platform/logging/Narrator';
  11 | import { MetaKernelService } from '../../../api/services/MetaKernelService';
  12 | import { useQuery } from '@tanstack/react-query';
  13 | 
  14 | // ‚ö° CRITICAL FIX: IMPORT SHARED CONTRACTS AS TYPES ONLY
  15 | import type { 
  16 |     MetaContextState, 
  17 |     DomainSummary, 
  18 |     ScopeSummary 
  19 | } from '../types';
  20 | 
  21 | // Default State (Safe Fallback)
  22 | const DEFAULT_STATE: MetaContextState = {
  23 |     selectedDomain: null,
  24 |     selectedScope: null,
  25 |     selectedItem: null,
  26 |     domains: [],
  27 |     isLoading: true,
  28 |     error: null,
  29 |     selectDomain: () => logger.scream("META", "selectDomain called before Context Init"),
  30 |     selectScope: () => {},
  31 |     selectItem: () => {},
  32 |     refresh: () => {}
  33 | };
  34 | 
  35 | const MetaContext = createContext<MetaContextState>(DEFAULT_STATE);
  36 | 
  37 | export const MetaProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  38 |     
  39 |     // 1. DATA: Fetch Topology (Domains -> Scopes)
  40 |     const { 
  41 |         data: rawDomains = [], 
  42 |         isLoading, 
  43 |         error, 
  44 |         refetch 
  45 |     } = useQuery({
  46 |         queryKey: ['meta', 'domains'],
  47 |         queryFn: async () => {
  48 |             logger.tell("META", "üì° Fetching System Topology...");
  49 |             // ‚ö° API FIX: Match the exact generated OpenAPI SDK method name
  50 |             const response = await MetaKernelService.listDomainsApiV1MetaDomainsGet();
  51 |             
  52 |             // @ts-ignore - Handle Manifest Wrapper if present
  53 |             const domains = (response.modules || response) as DomainSummary[]; 
  54 |             logger.trace("META", "Topology Fetched", { count: domains?.length });
  55 |             return domains;
  56 |         },
  57 |         staleTime: 1000 * 60 * 5, 
  58 |     });
  59 | 
  60 |     // 2. STATE: Universal URL Persistence
  61 |     const [domainKey, setDomainKey] = useUrlState('domain', '');
  62 |     const [scopeKey, setScopeKey] = useUrlState('scope', '');
  63 |     const [itemId, setItemId] = useUrlState('select', ''); 
  64 | 
  65 |     // 3. DERIVED STATE: Resolve Objects from Keys
  66 |     const selectedDomain = useMemo(() => {
  67 |         if (!domainKey) return null;
  68 |         return rawDomains.find(d => d.key === domainKey) || null;
  69 |     }, [domainKey, rawDomains]);
  70 | 
  71 |     const selectedScope = useMemo(() => {
  72 |         if (!selectedDomain || !scopeKey) return null;
  73 |         return selectedDomain.scopes?.find(s => s.key === scopeKey) || null;
  74 |     }, [selectedDomain, scopeKey]);
  75 | 
  76 |     // 4. ACTIONS (The Interface Implementation)
  77 |     const selectDomain = (key: string) => {
  78 |         if (key === domainKey) return; 
  79 |         logger.tell("META", `üëâ Select Domain: ${key || 'None'}`);
  80 |         setDomainKey(key || null);
  81 |         // Clear children when parent changes
  82 |         setScopeKey(null);
  83 |         setItemId(null); 
  84 |     };
  85 | 
  86 |     const selectScope = (key: string) => {
  87 |         if (key === scopeKey) return;
  88 |         logger.tell("META", `üëâ Select Scope: ${key || 'None'}`);
  89 |         setScopeKey(key || null);
  90 |         setItemId(null);
  91 |     };
  92 | 
  93 |     const selectItem = (id: string | null) => {
  94 |         if (id === itemId) return;
  95 |         if (id) logger.tell("META", `üëâ Select Item: ${id}`);
  96 |         setItemId(id || null);
  97 |     };
  98 | 
  99 |     // 5. SIDE EFFECTS
 100 |     useEffect(() => {
 101 |         if (rawDomains.length > 0) {
 102 |             logger.whisper("META", `üì• Loaded ${rawDomains.length} Domains into Context`);
 103 |         }
 104 |     }, [rawDomains.length]);
 105 | 
 106 |     useEffect(() => {
 107 |         if (error) {
 108 |             logger.scream("META", "üî• Failed to fetch topology", error);
 109 |         }
 110 |     }, [error]);
 111 | 
 112 |     // 6. CONSTRUCT CONTEXT
 113 |     const value: MetaContextState = {
 114 |         domains: rawDomains,
 115 |         isLoading,
 116 |         error: error ? String(error) : null,
 117 |         selectedDomain,
 118 |         selectedScope,
 119 |         selectedItem: itemId,
 120 |         selectDomain,
 121 |         selectScope,
 122 |         selectItem,
 123 |         refresh: refetch
 124 |     };
 125 | 
 126 |     return (
 127 |         <MetaContext.Provider value={value}>
 128 |             {children}
 129 |         </MetaContext.Provider>
 130 |     );
 131 | };
 132 | 
 133 | export const useMetaContext = () => {
 134 |     const context = useContext(MetaContext);
 135 |     if (!context) {
 136 |         throw new Error("useMetaContext must be used within a MetaProvider");
 137 |     }
 138 |     return context;
 139 | };

================================================================================

# Source code from: frontend\src\domains\meta\features\governance\hooks\usePolicyBindings.ts
----------------------------------------------------------------------------------------------
   1 | /* FILEPATH: frontend/src/domains/meta/features/governance/hooks/usePolicyBindings.ts */
   2 | /* @file Policy Binding Hook */
   3 | /* @author The Engineer */
   4 | /* @description Manages the "Jurisdiction" of policies (Binding Policies to Domains/Events). 
   5 |  * UPDATED: Uses Centralized Kernel Configuration.
   6 |  */
   7 | 
   8 | import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
   9 | import axios from 'axios';
  10 | import { App } from 'antd';
  11 | // ‚ö° FRACTAL IMPORT
  12 | import { API_BASE_URL } from '@kernel/config';
  13 | 
  14 | export interface PolicyBinding {
  15 |   id: number;
  16 |   policy_id: number;
  17 |   target_domain: string;
  18 |   target_scope: string; // 'DOMAIN' | 'PROCESS' | 'FIELD'
  19 |   target_context?: string; // e.g. 'GATE_IN' or 'email'
  20 |   priority: number;
  21 |   is_active: boolean;
  22 | }
  23 | 
  24 | export interface PolicyBindingDraft {
  25 |   policy_id: number;
  26 |   target_domain: string;
  27 |   target_scope: string;
  28 |   target_context?: string;
  29 |   priority: number;
  30 |   is_active: boolean;
  31 | }
  32 | 
  33 | export const usePolicyBindings = (domainKey: string) => {
  34 |   const queryClient = useQueryClient();
  35 |   const { message } = App.useApp();
  36 | 
  37 |   // 1. FETCH BINDINGS
  38 |   const { data: bindings = [], isLoading } = useQuery({
  39 |     queryKey: ['meta', 'bindings', domainKey],
  40 |     queryFn: async () => {
  41 |         const res = await axios.get<PolicyBinding[]>(`${API_BASE_URL}/api/v1/meta/bindings`, {
  42 |             params: { domain: domainKey }
  43 |         });
  44 |         return res.data;
  45 |     },
  46 |     enabled: !!domainKey
  47 |   });
  48 | 
  49 |   // 2. CREATE BINDING
  50 |   const createMutation = useMutation({
  51 |     mutationFn: async (draft: PolicyBindingDraft) => {
  52 |         return axios.post(`${API_BASE_URL}/api/v1/meta/bindings`, draft);
  53 |     },
  54 |     onSuccess: () => {
  55 |         queryClient.invalidateQueries({ queryKey: ['meta', 'bindings'] });
  56 |         message.success('Policy Enforced');
  57 |     },
  58 |     onError: (err: any) => {
  59 |         message.error(err.response?.data?.detail || 'Binding Failed');
  60 |     }
  61 |   });
  62 | 
  63 |   // 3. TOGGLE/UPDATE BINDING
  64 |   const updateMutation = useMutation({
  65 |       mutationFn: async ({ id, data }: { id: number, data: Partial<PolicyBinding> }) => {
  66 |           return axios.patch(`${API_BASE_URL}/api/v1/meta/bindings/${id}`, data);
  67 |       },
  68 |       onSuccess: () => {
  69 |           queryClient.invalidateQueries({ queryKey: ['meta', 'bindings'] });
  70 |       }
  71 |   });
  72 | 
  73 |   // 4. DELETE BINDING
  74 |   const deleteMutation = useMutation({
  75 |       mutationFn: async (id: number) => {
  76 |           return axios.delete(`${API_BASE_URL}/api/v1/meta/bindings/${id}`);
  77 |       },
  78 |       onSuccess: () => {
  79 |           queryClient.invalidateQueries({ queryKey: ['meta', 'bindings'] });
  80 |           message.success('Enforcement Removed');
  81 |       }
  82 |   });
  83 | 
  84 |   return {
  85 |     bindings,
  86 |     isLoading,
  87 |     createBinding: createMutation.mutateAsync,
  88 |     updateBinding: updateMutation.mutate,
  89 |     deleteBinding: deleteMutation.mutateAsync,
  90 |     isCreating: createMutation.isPending
  91 |   };
  92 | };
  93 | 

================================================================================

# Source code from: frontend\src\domains\meta\features\policy_groups\PolicyGroupsView.tsx
-------------------------------------------------------------------------------------------
   1 | // FILEPATH: frontend/src/domains/meta/features/policy_groups/PolicyGroupsView.tsx
   2 | // @file: Policy Groups Dashboard (Deep Linked + Smooth)
   3 | // @author: The Engineer
   4 | // @description: Main view for managing Policy Bundles (Groups).
   5 | // REFACTOR: Implemented 'useUrlState' for View Mode and Search Persistence.
   6 | // VISUAL: Added <FadeIn> wrapper for standard transitions.
   7 | 
   8 | 
   9 | import React, { useMemo } from 'react';
  10 | import { 
  11 |     Layout, Card, Button, Typography, Row, Col, Tag, 
  12 |     Empty, Space, Popconfirm, theme, Tooltip, Segmented, Input, Table 
  13 | } from 'antd';
  14 | import { 
  15 |     PlusOutlined, EditOutlined, DeleteOutlined, 
  16 |     SolutionOutlined, CheckCircleOutlined, StopOutlined,
  17 |     AppstoreOutlined, BarsOutlined, SearchOutlined
  18 | } from '@ant-design/icons';
  19 | 
  20 | import { useMetaContext } from '../../_kernel/MetaContext'; // ‚ö° GLOBAL STATE (Editor)
  21 | import { useUrlState } from '../../../../platform/hooks/useUrlState'; // ‚ö° UNIVERSAL STATE (View/Search)
  22 | import { FadeIn } from '../../../../platform/ui/animation/FadeIn'; // ‚ö° ANIMATION
  23 | import { usePolicyGroups } from './hooks/usePolicyGroups';
  24 | import { GroupEditor } from './components/GroupEditor';
  25 | import { useSwitchboard } from '../switchboard/hooks/useSwitchboard';
  26 | import type { PolicyGroup } from './types';
  27 | 
  28 | const { Title, Text, Paragraph } = Typography;
  29 | const { Content } = Layout;
  30 | 
  31 | export const PolicyGroupsView: React.FC = () => {
  32 |     const { token } = theme.useToken();
  33 | 
  34 |     // 1. GLOBAL CONTEXT (Editor State via ?select=...)
  35 |     const { selectedItem, setSelectedItem } = useMetaContext();
  36 | 
  37 |     // 2. UNIVERSAL URL STATE (View State)
  38 |     const [viewMode, setViewMode] = useUrlState<'Grid' | 'List'>('view', 'List');
  39 |     const [searchText, setSearchText] = useUrlState('q', '');
  40 | 
  41 |     // 3. Data
  42 |     const { 
  43 |         groups, 
  44 |         isLoading, 
  45 |         createGroup, 
  46 |         updateGroup, 
  47 |         deleteGroup, 
  48 |         isMutating 
  49 |     } = usePolicyGroups();
  50 | 
  51 |     const { availablePolicies } = useSwitchboard();
  52 | 
  53 |     // 4. Computed (Filter)
  54 |     const filteredGroups = useMemo(() => {
  55 |         if (!searchText) return groups;
  56 |         const lower = searchText.toLowerCase();
  57 |         return groups.filter(g => 
  58 |             g.name.toLowerCase().includes(lower) || 
  59 |             g.key.toLowerCase().includes(lower)
  60 |         );
  61 |     }, [groups, searchText]);
  62 | 
  63 |     // --- COMPUTED EDITOR STATE ---
  64 |     const isEditorOpen = !!selectedItem;
  65 |     const editingGroup = useMemo(() => {
  66 |         if (selectedItem === 'NEW') return null;
  67 |         return groups.find(g => String(g.id) === selectedItem) || null;
  68 |     }, [groups, selectedItem]);
  69 | 
  70 |     // --- ACTIONS ---
  71 |     const handleCreate = () => setSelectedItem('NEW');
  72 |     const handleEdit = (group: PolicyGroup) => setSelectedItem(String(group.id));
  73 |     
  74 |     const handleCloseEditor = () => setSelectedItem(null);
  75 | 
  76 |     const handleSave = async (payload: any) => {
  77 |         if (editingGroup) {
  78 |             await updateGroup({ id: editingGroup.id, data: payload });
  79 |         } else {
  80 |             await createGroup(payload);
  81 |         }
  82 |         handleCloseEditor();
  83 |     };
  84 | 
  85 |     // --- TABLE COLUMNS ---
  86 |     const columns = [
  87 |         {
  88 |             title: 'Bundle Name',
  89 |             key: 'name',
  90 |             render: (_: any, r: PolicyGroup) => (
  91 |                 <Space direction="vertical" size={0}>
  92 |                     <Text strong>{r.name}</Text>
  93 |                     <Text type="secondary" style={{ fontSize: 11, fontFamily: 'monospace' }}>{r.key}</Text>
  94 |                 </Space>
  95 |             )
  96 |         },
  97 |         {
  98 |             title: 'Execution Sequence',
  99 |             key: 'policies',
 100 |             render: (_: any, r: PolicyGroup) => (
 101 |                 <div style={{ display: 'flex', gap: 4, flexWrap: 'wrap' }}>
 102 |                     {r.policy_keys.map((key, idx) => (
 103 |                         <Tag key={`${r.id}-${key}`} color="blue">
 104 |                              <span style={{ marginRight: 4, opacity: 0.6 }}>#{idx + 1}</span>
 105 |                             {key}
 106 |                         </Tag>
 107 |                     ))}
 108 |                 </div>
 109 |             )
 110 |         },
 111 |         {
 112 |             title: 'Status',
 113 |             key: 'status',
 114 |             width: 100,
 115 |             render: (_: any, r: PolicyGroup) => (
 116 |                 r.is_active 
 117 |                     ? <Tag color="success" icon={<CheckCircleOutlined />}>Active</Tag> 
 118 |                     : <Tag color="error" icon={<StopOutlined />}>Inactive</Tag>
 119 |             )
 120 |         },
 121 |         {
 122 |             title: 'Action',
 123 |             key: 'action',
 124 |             align: 'right' as const,
 125 |             render: (_: any, r: PolicyGroup) => (
 126 |                 <Space>
 127 |                     <Button size="small" icon={<EditOutlined />} onClick={() => handleEdit(r)} />
 128 |                     <Popconfirm 
 129 |                         title="Delete Group?" 
 130 |                         onConfirm={() => deleteGroup(r.id)}
 131 |                         okButtonProps={{ loading: isMutating }}
 132 |                     >
 133 |                         <Button size="small" danger icon={<DeleteOutlined />} />
 134 |                     </Popconfirm>
 135 |                 </Space>
 136 |             )
 137 |         }
 138 |     ];
 139 | 
 140 |     return (
 141 |         <FadeIn>
 142 |             <Layout style={{ background: 'transparent', height: '100%', display: 'flex', flexDirection: 'column' }}>
 143 |                 {/* HEADER */}
 144 |                 <div style={{ marginBottom: 24, padding: '0 24px', paddingTop: 24 }}>
 145 |                     <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
 146 |                         <div>
 147 |                             <Title level={2} style={{ margin: 0 }}>
 148 |                                 <Space>
 149 |                                     <SolutionOutlined style={{ color: token.colorPrimary }} />
 150 |                                     Policy Groups
 151 |                                 </Space>
 152 |                             </Title>
 153 |                             <Text type="secondary">Bundle logic rules into ordered execution kits.</Text>
 154 |                         </div>
 155 |                         <Button type="primary" icon={<PlusOutlined />} size="large" onClick={handleCreate}>
 156 |                             Create Group
 157 |                         </Button>
 158 |                     </div>
 159 |                     
 160 |                     {/* TOOLBAR */}
 161 |                     <div style={{ display: 'flex', gap: 16, background: token.colorBgContainer, padding: 12, borderRadius: 8 }}>
 162 |                         <Input 
 163 |                             prefix={<SearchOutlined style={{ color: token.colorTextDisabled }} />} 
 164 |                             placeholder="Search groups..." 
 165 |                             style={{ flex: 1 }}
 166 |                             value={searchText}
 167 |                             onChange={e => setSearchText(e.target.value)}
 168 |                             allowClear
 169 |                         />
 170 |                         <Segmented
 171 |                             options={[
 172 |                                 { value: 'Grid', icon: <AppstoreOutlined /> },
 173 |                                 { value: 'List', icon: <BarsOutlined /> },
 174 |                             ]}
 175 |                             value={viewMode}
 176 |                             onChange={val => setViewMode(val as 'Grid' | 'List')}
 177 |                         />
 178 |                     </div>
 179 |                 </div>
 180 | 
 181 |                 {/* CONTENT */}
 182 |                 <Content style={{ flex: 1, overflowY: 'auto', padding: '0 24px 24px' }}>
 183 |                     {isLoading ? (
 184 |                         <Card loading />
 185 |                     ) : filteredGroups.length === 0 ? (
 186 |                         <Empty 
 187 |                             image={Empty.PRESENTED_IMAGE_SIMPLE} 
 188 |                             description={searchText ? "No matches found." : "No Policy Groups defined."} 
 189 |                         />
 190 |                     ) : viewMode === 'List' ? (
 191 |                         <Card styles={{ body: { padding: 0 } }}>
 192 |                             <Table 
 193 |                                 dataSource={filteredGroups} 
 194 |                                 columns={columns} 
 195 |                                 rowKey="id" 
 196 |                                 pagination={false} 
 197 |                                 size="small"
 198 |                             />
 199 |                         </Card>
 200 |                     ) : (
 201 |                         <Row gutter={[16, 16]}>
 202 |                             {filteredGroups.map(group => (
 203 |                                 <Col xs={24} sm={12} lg={8} xl={6} key={group.id}>
 204 |                                     <Card
 205 |                                         hoverable
 206 |                                         style={{ 
 207 |                                             height: '100%', 
 208 |                                             display: 'flex', 
 209 |                                             flexDirection: 'column',
 210 |                                             borderColor: group.is_active ? token.colorBorderSecondary : token.colorErrorBorder,
 211 |                                             opacity: group.is_active ? 1 : 0.6
 212 |                                         }}
 213 |                                         styles={{ body: { flex: 1, display: 'flex', flexDirection: 'column' } }}
 214 |                                         actions={[
 215 |                                             <Tooltip title="Edit Bundle">
 216 |                                                 <EditOutlined key="edit" onClick={() => handleEdit(group)} />
 217 |                                             </Tooltip>,
 218 |                                             <Popconfirm
 219 |                                                 title="Deactivate Group?"
 220 |                                                 onConfirm={() => deleteGroup(group.id)}
 221 |                                                 okButtonProps={{ loading: isMutating }}
 222 |                                             >
 223 |                                                 <DeleteOutlined key="delete" style={{ color: token.colorError }} />
 224 |                                             </Popconfirm>
 225 |                                         ]}
 226 |                                     >
 227 |                                         <div style={{ marginBottom: 12, display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
 228 |                                             <Space direction="vertical" size={0}>
 229 |                                                 <Text strong style={{ fontSize: 16 }}>{group.name}</Text>
 230 |                                                 <Text type="secondary" style={{ fontSize: 11, fontFamily: 'monospace' }}>{group.key}</Text>
 231 |                                             </Space>
 232 |                                             {group.is_active ? (
 233 |                                                 <Tag color="success" icon={<CheckCircleOutlined />} />
 234 |                                             ) : (
 235 |                                                 <Tag color="error" icon={<StopOutlined />} />
 236 |                                             )}
 237 |                                         </div>
 238 | 
 239 |                                         <Paragraph type="secondary" ellipsis={{ rows: 2 }} style={{ fontSize: 13, marginBottom: 16 }}>
 240 |                                             {group.description || "No description provided."}
 241 |                                         </Paragraph>
 242 | 
 243 |                                         <div style={{ marginTop: 'auto', background: token.colorFillAlter, padding: 8, borderRadius: 6 }}>
 244 |                                             <Text type="secondary" style={{ fontSize: 10, display: 'block', marginBottom: 4, textTransform: 'uppercase' }}>
 245 |                                                 Execution Sequence ({group.policy_keys.length})
 246 |                                             </Text>
 247 |                                             {/* SEQUENTIAL LIST */}
 248 |                                             <div style={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
 249 |                                                 {group.policy_keys.slice(0, 4).map((key, idx) => (
 250 |                                                     <div key={key} style={{ display: 'flex', alignItems: 'center', fontSize: 11 }}>
 251 |                                                         <div style={{ 
 252 |                                                             width: 16, height: 16, borderRadius: '50%', 
 253 |                                                             background: token.colorFillContent, color: token.colorTextSecondary,
 254 |                                                             display: 'flex', alignItems: 'center', justifyContent: 'center',
 255 |                                                             marginRight: 6, fontSize: 9, fontWeight: 'bold'
 256 |                                                         }}>
 257 |                                                             {idx + 1}
 258 |                                                         </div>
 259 |                                                         <Text ellipsis style={{ flex: 1 }}>{key}</Text>
 260 |                                                     </div>
 261 |                                                 ))}
 262 |                                                 {group.policy_keys.length > 4 && (
 263 |                                                     <Text type="secondary" style={{ fontSize: 10, paddingLeft: 22 }}>
 264 |                                                         +{group.policy_keys.length - 4} more...
 265 |                                                     </Text>
 266 |                                                 )}
 267 |                                             </div>
 268 |                                         </div>
 269 |                                     </Card>
 270 |                                 </Col>
 271 |                             ))}
 272 |                         </Row>
 273 |                     )}
 274 |                 </Content>
 275 | 
 276 |                 <GroupEditor
 277 |                     open={isEditorOpen}
 278 |                     onClose={handleCloseEditor}
 279 |                     availablePolicies={availablePolicies}
 280 |                     initialValues={editingGroup || undefined}
 281 |                     onSave={handleSave}
 282 |                     isSaving={isMutating}
 283 |                 />
 284 |             </Layout>
 285 |         </FadeIn>
 286 |     );
 287 | };
 288 | 

================================================================================

# Source code from: frontend\src\domains\meta\features\policy_groups\types.ts
-------------------------------------------------------------------------------
   1 | /* FILEPATH: frontend/src/domains/meta/features/policy_groups/types.ts */
   2 | /* @file Policy Group Types */
   3 | /* @author The Engineer */
   4 | /* @description TypeScript interfaces for Policy Bundles.
   5 |  * MATCHES: backend/app/core/meta/schemas.py (PolicyGroupRead, PolicyGroupCreate)
   6 |  */
   7 | 
   8 | export interface PolicyGroup {
   9 |     id: number;
  10 |     key: string;
  11 |     name: string;
  12 |     description?: string;
  13 |     
  14 |     // The ordered list of policy keys to execute
  15 |     policy_keys: string[];
  16 |     
  17 |     is_active: boolean;
  18 |     created_at: string;
  19 |     updated_at?: string;
  20 | }
  21 | 
  22 | export interface GroupDraft {
  23 |     key: string;
  24 |     name: string;
  25 |     description?: string;
  26 |     policy_keys: string[];
  27 |     is_active: boolean;
  28 | }
  29 | 
  30 | export const DEFAULT_GROUP_DRAFT: GroupDraft = {
  31 |     key: '',
  32 |     name: '',
  33 |     description: '',
  34 |     policy_keys: [],
  35 |     is_active: true
  36 | };
  37 | 

================================================================================

# Source code from: frontend\src\domains\meta\features\switchboard\SwitchboardView.tsx
----------------------------------------------------------------------------------------
   1 | // FILEPATH: frontend/src/domains/meta/features/switchboard/SwitchboardView.tsx
   2 | // @file: Switchboard Console (Deep Linked + Smooth)
   3 | // @author: The Engineer
   4 | // @description: The Main Control Panel for Governance.
   5 | // REFACTOR: Implemented 'useUrlState' for Search Persistence.
   6 | // REFACTOR: Uses Global MetaContext for Modal State (?select=NEW).
   7 | // VISUAL: Added <FadeIn> wrapper for standard transitions.
   8 | 
   9 | 
  10 | import React, { useState, useMemo } from 'react';
  11 | import { 
  12 |     Layout, Card, Button, Typography, Space, Popconfirm, theme, 
  13 |     Input, Table, Badge, Empty, Tag, Tooltip
  14 | } from 'antd';
  15 | import { 
  16 |     PlusOutlined, StopOutlined, DeleteOutlined,
  17 |     GlobalOutlined, AppstoreOutlined, ThunderboltOutlined, 
  18 |     SearchOutlined, RobotOutlined, FieldTimeOutlined,
  19 |     DatabaseOutlined, FileProtectOutlined, ReloadOutlined,
  20 |     CheckCircleOutlined, PauseCircleOutlined
  21 | } from '@ant-design/icons';
  22 | 
  23 | import { useMetaContext } from '../../_kernel/MetaContext'; // ‚ö° GLOBAL STATE
  24 | import { useUrlState } from '../../../../platform/hooks/useUrlState'; // ‚ö° UNIVERSAL STATE
  25 | import { FadeIn } from '../../../../platform/ui/animation/FadeIn'; // ‚ö° ANIMATION
  26 | import { useSwitchboard } from './hooks/useSwitchboard';
  27 | import { AssignmentModal } from './components/AssignmentModal';
  28 | import type { PolicyBinding } from './types';
  29 | 
  30 | const { Title, Text } = Typography;
  31 | const { Content } = Layout;
  32 | 
  33 | export const SwitchboardView: React.FC = () => {
  34 |     const { token } = theme.useToken();
  35 | 
  36 |     // 1. GLOBAL CONTEXT (Deep Link for Modal)
  37 |     const { selectedItem, setSelectedItem } = useMetaContext();
  38 | 
  39 |     // 2. UNIVERSAL URL STATE (Search Persistence)
  40 |     const [searchText, setSearchTerm] = useUrlState('q', '');
  41 | 
  42 |     // 3. Data Hooks
  43 |     const { 
  44 |         activeBindings, 
  45 |         availablePolicies,
  46 |         availableGroups,
  47 |         isLoading, 
  48 |         assignPolicy, 
  49 |         removeAssignment, 
  50 |         isAssigning 
  51 |     } = useSwitchboard();
  52 | 
  53 |     // Local loading state for individual row actions
  54 |     const [loadingIds, setLoadingIds] = useState<Set<number>>(new Set());
  55 | 
  56 |     const handleUnbind = async (id: number) => {
  57 |         setLoadingIds(prev => new Set(prev).add(id));
  58 |         try {
  59 |             await removeAssignment(id);
  60 |         } finally {
  61 |             setLoadingIds(prev => {
  62 |                 const next = new Set(prev);
  63 |                 next.delete(id);
  64 |                 return next;
  65 |             });
  66 |         }
  67 |     };
  68 | 
  69 |     // --- MODAL STATE (Derived from Global) ---
  70 |     const isAssignmentModalOpen = selectedItem === 'NEW';
  71 |     const setAssignmentModalOpen = (open: boolean) => setSelectedItem(open ? 'NEW' : null);
  72 | 
  73 |     // --- GROUPING LOGIC ---
  74 |     const jurisdictions = useMemo(() => {
  75 |         const groups: Record<string, PolicyBinding[]> = {};
  76 |         
  77 |         const filtered = activeBindings.filter(b => 
  78 |             !searchText || 
  79 |             b.target_domain.toLowerCase().includes(searchText.toLowerCase()) ||
  80 |             b.policy?.name.toLowerCase().includes(searchText.toLowerCase()) ||
  81 |             b.group?.name.toLowerCase().includes(searchText.toLowerCase())
  82 |         );
  83 | 
  84 |         filtered.forEach(b => {
  85 |             if (!groups[b.target_domain]) groups[b.target_domain] = [];
  86 |             groups[b.target_domain].push(b);
  87 |         });
  88 | 
  89 |         // Sort: Active first, then by Priority
  90 |         Object.keys(groups).forEach(key => {
  91 |             groups[key].sort((a, b) => {
  92 |                 if (a.is_active !== b.is_active) return a.is_active ? -1 : 1;
  93 |                 return (b.priority - a.priority) || (b.id - a.id);
  94 |             });
  95 |         });
  96 | 
  97 |         return Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]));
  98 |     }, [activeBindings, searchText]);
  99 | 
 100 |     // --- RENDER HELPERS ---
 101 |     const getScopeIcon = (scope: string) => {
 102 |         if (scope === 'GLOBAL') return <GlobalOutlined />;
 103 |         if (scope === 'JOB') return <RobotOutlined />;
 104 |         if (scope === 'TRANSITION') return <FieldTimeOutlined />;
 105 |         if (scope === 'PROCESS') return <ThunderboltOutlined />;
 106 |         return <AppstoreOutlined />;
 107 |     };
 108 | 
 109 |     const getColumns = (domain: string) => [
 110 |         {
 111 |             title: '#',
 112 |             key: 'sequence',
 113 |             width: 50,
 114 |             render: (_: any, record: PolicyBinding, index: number) => (
 115 |                 <Text type="secondary" style={{ fontSize: 11, opacity: record.is_active ? 1 : 0.5 }}>{index + 1}</Text>
 116 |             )
 117 |         },
 118 |         {
 119 |             title: 'Policy Source',
 120 |             key: 'policy',
 121 |             render: (_: any, record: PolicyBinding) => {
 122 |                 const opacity = record.is_active ? 1 : 0.5;
 123 |                 if (record.policy) {
 124 |                     return (
 125 |                         <Space style={{ opacity }}>
 126 |                             <FileProtectOutlined style={{ color: token.colorPrimary }} />
 127 |                             <Text strong>{record.policy.name}</Text>
 128 |                             <Tag bordered={false} style={{ fontSize: 10 }}>v{record.policy.version_major}.{record.policy.version_minor}</Tag>
 129 |                         </Space>
 130 |                     );
 131 |                 } else if (record.group) {
 132 |                     return (
 133 |                         <Space style={{ opacity }}>
 134 |                             <AppstoreOutlined style={{ color: token.colorSuccess }} />
 135 |                             <Text strong>{record.group.name}</Text>
 136 |                             <Tag color="cyan" style={{ fontSize: 10 }}>BUNDLE</Tag>
 137 |                         </Space>
 138 |                     );
 139 |                 }
 140 |                 return <Text type="secondary">Unknown Source</Text>;
 141 |             }
 142 |         },
 143 |         {
 144 |             title: 'Scope',
 145 |             key: 'scope',
 146 |             render: (_: any, record: PolicyBinding) => (
 147 |                 <Space style={{ opacity: record.is_active ? 1 : 0.5 }}>
 148 |                     {getScopeIcon(record.target_scope)}
 149 |                     <span>{record.target_scope}</span>
 150 |                     {record.target_context && (
 151 |                         <Tag style={{ margin: 0 }}>{record.target_context}</Tag>
 152 |                     )}
 153 |                 </Space>
 154 |             )
 155 |         },
 156 |         {
 157 |             title: 'Status',
 158 |             key: 'status',
 159 |             width: 100,
 160 |             render: (_: any, record: PolicyBinding) => (
 161 |                 record.is_active ? (
 162 |                     <Tag icon={<CheckCircleOutlined />} color="success">Active</Tag>
 163 |                 ) : (
 164 |                     <Tag icon={<PauseCircleOutlined />} color="warning">Inactive</Tag>
 165 |                 )
 166 |             )
 167 |         },
 168 |         {
 169 |             title: 'Priority',
 170 |             dataIndex: 'priority',
 171 |             key: 'priority',
 172 |             width: 80,
 173 |             render: (p: number, record: PolicyBinding) => (
 174 |                 <div style={{ opacity: record.is_active ? 1 : 0.5 }}>
 175 |                     <Tag color={p >= 100 ? 'gold' : p >= 50 ? 'orange' : 'blue'}>{p}</Tag>
 176 |                 </div>
 177 |             )
 178 |         },
 179 |         {
 180 |             title: 'Action',
 181 |             key: 'action',
 182 |             align: 'right' as const,
 183 |             width: 120,
 184 |             render: (_: any, record: PolicyBinding) => {
 185 |                 if (record.is_active) {
 186 |                     // STEP 1: DEACTIVATE
 187 |                     return (
 188 |                         <Popconfirm
 189 |                             title="Deactivate Enforcement?"
 190 |                             description="This policy will stop applying, but the binding remains."
 191 |                             onConfirm={() => handleUnbind(record.id)}
 192 |                             okButtonProps={{ loading: loadingIds.has(record.id) }}
 193 |                             okText="Deactivate"
 194 |                         >
 195 |                             <Button 
 196 |                                 type="text" 
 197 |                                 size="small" 
 198 |                                 style={{ color: token.colorWarning }}
 199 |                                 icon={<StopOutlined />}
 200 |                                 loading={loadingIds.has(record.id)}
 201 |                             >
 202 |                                 Deactivate
 203 |                             </Button>
 204 |                         </Popconfirm>
 205 |                     );
 206 |                 } else {
 207 |                     // STEP 2: REMOVE
 208 |                     return (
 209 |                         <Popconfirm
 210 |                             title="Remove Permanently?"
 211 |                             description="This binding configuration will be deleted."
 212 |                             onConfirm={() => handleUnbind(record.id)}
 213 |                             okButtonProps={{ loading: loadingIds.has(record.id), danger: true }}
 214 |                             okText="Remove"
 215 |                         >
 216 |                             <Button 
 217 |                                 type="text" 
 218 |                                 danger 
 219 |                                 size="small" 
 220 |                                 icon={<DeleteOutlined />}
 221 |                                 loading={loadingIds.has(record.id)}
 222 |                             >
 223 |                                 Remove
 224 |                             </Button>
 225 |                         </Popconfirm>
 226 |                     );
 227 |                 }
 228 |             }
 229 |         }
 230 |     ];
 231 | 
 232 |     return (
 233 |         <FadeIn>
 234 |             <Layout style={{ background: 'transparent', height: '100%', display: 'flex', flexDirection: 'column' }}>
 235 |                 {/* HEADER */}
 236 |                 <div style={{ marginBottom: 24, padding: '0 24px', paddingTop: 24 }}>
 237 |                     <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
 238 |                         <div>
 239 |                             <Title level={2} style={{ margin: 0 }}>
 240 |                                 <Space>
 241 |                                     <AppstoreOutlined style={{ color: token.colorPrimary }} />
 242 |                                     Switchboard
 243 |                                 </Space>
 244 |                             </Title>
 245 |                             <Text type="secondary">Manage Active Jurisdictions.</Text>
 246 |                         </div>
 247 |                         <Space>
 248 |                             <Button icon={<ReloadOutlined />} onClick={() => window.location.reload()} />
 249 |                             <Button type="primary" icon={<PlusOutlined />} size="large" onClick={() => setAssignmentModalOpen(true)}>
 250 |                                 Enforce Policy
 251 |                             </Button>
 252 |                         </Space>
 253 |                     </div>
 254 |                     
 255 |                     <div style={{ background: token.colorBgContainer, padding: 12, borderRadius: 8 }}>
 256 |                         <Input 
 257 |                             prefix={<SearchOutlined style={{ color: '#ccc' }} />} 
 258 |                             placeholder="Search jurisdictions..." 
 259 |                             style={{ width: '100%' }}
 260 |                             value={searchText}
 261 |                             onChange={e => setSearchTerm(e.target.value)}
 262 |                             allowClear
 263 |                         />
 264 |                     </div>
 265 |                 </div>
 266 | 
 267 |                 {/* CONTENT AREA */}
 268 |                 <Content style={{ flex: 1, overflowY: 'auto', padding: '0 24px 24px' }}>
 269 |                     {isLoading ? (
 270 |                         <Card loading />
 271 |                     ) : jurisdictions.length === 0 ? (
 272 |                         <Empty image={Empty.PRESENTED_IMAGE_SIMPLE} description="No active policies enforced." />
 273 |                     ) : (
 274 |                         <Space direction="vertical" style={{ width: '100%' }} size="large">
 275 |                             {jurisdictions.map(([domain, bindings]) => (
 276 |                                 <Card 
 277 |                                     key={domain}
 278 |                                     size="small"
 279 |                                     title={
 280 |                                         <Space>
 281 |                                             <DatabaseOutlined style={{ color: token.colorTextSecondary }} />
 282 |                                             <Text strong style={{ fontSize: 16 }}>{domain}</Text>
 283 |                                             <Badge count={bindings.filter(b => b.is_active).length} style={{ backgroundColor: token.colorFillContent, color: token.colorText }} />
 284 |                                         </Space>
 285 |                                     }
 286 |                                     style={{ borderColor: token.colorBorderSecondary }}
 287 |                                     styles={{ body: { padding: 0 } }}
 288 |                                 >
 289 |                                     <Table 
 290 |                                         dataSource={bindings}
 291 |                                         columns={getColumns(domain)}
 292 |                                         rowKey="id"
 293 |                                         pagination={false} 
 294 |                                         size="small"
 295 |                                     />
 296 |                                 </Card>
 297 |                             ))}
 298 |                         </Space>
 299 |                     )}
 300 |                 </Content>
 301 | 
 302 |                 <AssignmentModal 
 303 |                     open={isAssignmentModalOpen} 
 304 |                     onClose={() => setAssignmentModalOpen(false)}
 305 |                     onAssign={assignPolicy}
 306 |                     policies={availablePolicies}
 307 |                     groups={availableGroups}
 308 |                     loading={isAssigning}
 309 |                 />
 310 |             </Layout>
 311 |         </FadeIn>
 312 |     );
 313 | };
 314 | 

================================================================================

# Source code from: frontend\src\domains\meta\features\switchboard\components\AssignmentModal.tsx
---------------------------------------------------------------------------------------------------
   1 | /* FILEPATH: frontend/src/domains/meta/features/switchboard/components/AssignmentModal.tsx */
   2 | /* @file Assignment Modal (Groups Enabled) */
   3 | /* @author The Engineer */
   4 | /* @description Modal to bind a Policy OR a Group to a Domain Context.
   5 |  * UPDATED: Replaced 'Tag' source with 'Group' source.
   6 |  */
   7 | 
   8 | import React, { useState, useEffect, useMemo } from 'react';
   9 | import { 
  10 |     Modal, Form, Select, Input, Divider, Typography, Space, 
  11 |     Segmented, InputNumber, theme 
  12 | } from 'antd';
  13 | import { 
  14 |     PartitionOutlined, GlobalOutlined, ThunderboltOutlined, 
  15 |     FieldTimeOutlined, DatabaseOutlined, 
  16 |     AppstoreOutlined, FileProtectOutlined
  17 | } from '@ant-design/icons';
  18 | import type { PolicyDefinition, BindingDraft, BindingScope } from '../types';
  19 | import type { PolicyGroup } from '../../policy_groups/types';
  20 | 
  21 | import { useMetaContext } from '../../../_kernel/MetaContext';
  22 | 
  23 | const { Text } = Typography;
  24 | const { Option } = Select;
  25 | 
  26 | interface AssignmentModalProps {
  27 |     open: boolean;
  28 |     onClose: () => void;
  29 |     onAssign: (draft: BindingDraft) => Promise<void>;
  30 |     policies: PolicyDefinition[];
  31 |     groups: PolicyGroup[]; // ‚ö° NEW: Groups Data
  32 |     loading: boolean;
  33 | }
  34 | 
  35 | type SourceType = 'POLICY' | 'GROUP';
  36 | 
  37 | export const AssignmentModal: React.FC<AssignmentModalProps> = ({ 
  38 |     open, onClose, onAssign, policies, groups, loading 
  39 | }) => {
  40 |     const [form] = Form.useForm();
  41 |     const { domainList } = useMetaContext(); 
  42 |     const { token } = theme.useToken();
  43 |     
  44 |     // UI State
  45 |     const [sourceType, setSourceType] = useState<SourceType>('POLICY');
  46 |     const [selectedDomain, setSelectedDomain] = useState<string | null>(null);
  47 |     const [scope, setScope] = useState<string>('DOMAIN');
  48 | 
  49 |     const activePolicies = useMemo(() => policies.filter(p => p.is_active), [policies]);
  50 |     const activeGroups = useMemo(() => groups.filter(g => g.is_active), [groups]);
  51 | 
  52 |     const contextOptions = useMemo(() => {
  53 |         if (!selectedDomain) return [];
  54 |         const domainDef = domainList.find(d => d.key === selectedDomain);
  55 |         if (!domainDef) return [];
  56 |         return domainDef.scopes.map(s => ({ label: s.label, value: s.key }));
  57 |     }, [selectedDomain, domainList]);
  58 | 
  59 |     useEffect(() => {
  60 |         if (open) {
  61 |             form.resetFields();
  62 |             setScope('DOMAIN');
  63 |             setSelectedDomain(null);
  64 |             setSourceType('POLICY');
  65 |         }
  66 |     }, [open]);
  67 | 
  68 |     const handleOk = async () => {
  69 |         try {
  70 |             const values = await form.validateFields();
  71 |             
  72 |             const payload: BindingDraft = {
  73 |                 binding_type: 'ENTITY', // Enforced
  74 |                 target_domain: values.target_domain,
  75 |                 target_scope: values.target_scope as BindingScope,
  76 |                 target_context: values.target_context || undefined,
  77 |                 priority: values.priority || 10,
  78 |                 is_active: true,
  79 |                 // ‚ö° LOGIC: Send either ID or GroupID
  80 |                 policy_id: sourceType === 'POLICY' ? values.policy_id : undefined,
  81 |                 policy_group_id: sourceType === 'GROUP' ? values.policy_group_id : undefined
  82 |             };
  83 | 
  84 |             await onAssign(payload);
  85 |             onClose();
  86 |         } catch (info) { }
  87 |     };
  88 | 
  89 |     const segmentedStyle = {
  90 |         background: token.colorBgLayout,
  91 |         border: `1px solid ${token.colorBorderSecondary}`,
  92 |         padding: 4
  93 |     };
  94 | 
  95 |     return (
  96 |         <Modal
  97 |             title={<Space><PartitionOutlined style={{ color: token.colorPrimary }} /><span>Enforce Policy</span></Space>}
  98 |             open={open}
  99 |             onOk={handleOk}
 100 |             onCancel={onClose}
 101 |             confirmLoading={loading}
 102 |             okText="Bind"
 103 |             width={700}
 104 |             styles={{ body: { padding: '24px 0 0 0' } }}
 105 |         >
 106 |             <Form form={form} layout="vertical" initialValues={{ target_scope: 'DOMAIN', priority: 10 }}>
 107 |                 
 108 |                 {/* === SECTION 1: THE SOURCE (What) === */}
 109 |                 <div style={{ padding: '0 24px' }}>
 110 |                     <Divider orientation="left" style={{ marginTop: 0, fontSize: 12, color: token.colorTextSecondary }}>SOURCE (What)</Divider>
 111 |                     <div style={{ marginBottom: 16 }}>
 112 |                         <Segmented 
 113 |                             value={sourceType} 
 114 |                             onChange={val => setSourceType(val as SourceType)}
 115 |                             block
 116 |                             style={segmentedStyle}
 117 |                             options={[
 118 |                                 { label: 'Single Policy', value: 'POLICY', icon: <FileProtectOutlined /> },
 119 |                                 { label: 'Policy Bundle', value: 'GROUP', icon: <AppstoreOutlined /> }
 120 |                             ]}
 121 |                         />
 122 |                     </div>
 123 | 
 124 |                     {sourceType === 'POLICY' ? (
 125 |                         <Form.Item name="policy_id" rules={[{ required: true, message: 'Select a policy' }]}>
 126 |                             <Select showSearch placeholder="Select a specific policy..." optionLabelProp="label">
 127 |                                 {activePolicies.map(p => (
 128 |                                     <Option key={p.id} value={p.id} label={p.name}>
 129 |                                         <Space direction="vertical" size={0}>
 130 |                                             <div style={{ display: 'flex', justifyContent: 'space-between' }}>
 131 |                                                 <Text strong>{p.name}</Text>
 132 |                                             </div>
 133 |                                             <Text type="secondary" style={{ fontSize: 11 }}>{p.description}</Text>
 134 |                                         </Space>
 135 |                                     </Option>
 136 |                                 ))}
 137 |                             </Select>
 138 |                         </Form.Item>
 139 |                     ) : (
 140 |                         <Form.Item name="policy_group_id" rules={[{ required: true, message: 'Select a bundle' }]}>
 141 |                             <Select showSearch placeholder="Select a policy bundle..." optionLabelProp="label">
 142 |                                 {activeGroups.map(g => (
 143 |                                     <Option key={g.id} value={g.id} label={g.name}>
 144 |                                         <Space direction="vertical" size={0}>
 145 |                                             <Text strong>{g.name}</Text>
 146 |                                             <Text type="secondary" style={{ fontSize: 11 }}>
 147 |                                                 Contains {g.policy_keys.length} policies
 148 |                                             </Text>
 149 |                                         </Space>
 150 |                                     </Option>
 151 |                                 ))}
 152 |                             </Select>
 153 |                         </Form.Item>
 154 |                     )}
 155 |                 </div>
 156 | 
 157 |                 {/* === SECTION 2: THE TARGET (Where) === */}
 158 |                 <div style={{ padding: '0 24px' }}>
 159 |                     <Divider orientation="left" style={{ fontSize: 12, color: token.colorTextSecondary }}>TARGET (Where)</Divider>
 160 |                     
 161 |                     <div style={{ display: 'flex', gap: 16 }}>
 162 |                         <Form.Item name="target_domain" label="Domain" style={{ flex: 1 }} rules={[{ required: true }]}>
 163 |                             <Select placeholder="Select Domain..." showSearch onChange={setSelectedDomain}>
 164 |                                 {domainList.map(d => (
 165 |                                     <Option key={d.key} value={d.key}><DatabaseOutlined /> {d.label}</Option>
 166 |                                 ))}
 167 |                             </Select>
 168 |                         </Form.Item>
 169 |                         <Form.Item name="target_scope" label="Scope" style={{ flex: 1 }}>
 170 |                             <Select onChange={setScope}>
 171 |                                 <Option value="DOMAIN">Domain Wide</Option>
 172 |                                 <Option value="PROCESS">Process</Option>
 173 |                                 <Option value="TRANSITION">Transition</Option>
 174 |                             </Select>
 175 |                         </Form.Item>
 176 |                     </div>
 177 | 
 178 |                     {(scope === 'PROCESS' || scope === 'TRANSITION') && (
 179 |                         <Form.Item name="target_context" label="Context" rules={[{ required: true }]}>
 180 |                             {scope === 'PROCESS' && contextOptions.length > 0 ? (
 181 |                                 <Select options={contextOptions} placeholder="Select Process..." />
 182 |                             ) : (
 183 |                                 <Input placeholder={scope === 'TRANSITION' ? "e.g. APPROVED" : "Context Key"} />
 184 |                             )}
 185 |                         </Form.Item>
 186 |                     )}
 187 | 
 188 |                     <Form.Item name="priority" label="Priority (Higher wins)">
 189 |                         <InputNumber style={{ width: '100%' }} />
 190 |                     </Form.Item>
 191 |                 </div>
 192 |             </Form>
 193 |         </Modal>
 194 |     );
 195 | };
 196 | 

================================================================================

# Source code from: frontend\src\domains\meta\features\switchboard\hooks\useSwitchboard.ts
--------------------------------------------------------------------------------------------
   1 | /* FILEPATH: frontend/src/domains/meta/features/switchboard/hooks/useSwitchboard.ts */
   2 | /* @file Switchboard Logic Hook */
   3 | /* @author The Engineer */
   4 | /* @description Manages fetching and binding of Policies AND Policy Groups.
   5 |  * UPDATED: Uses Centralized Kernel Configuration via Alias.
   6 |  */
   7 | 
   8 | import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
   9 | import axios from 'axios';
  10 | import { App } from 'antd';
  11 | import type { PolicyDefinition, PolicyBinding, BindingDraft } from '../types';
  12 | import type { PolicyGroup } from '../../policy_groups/types'; // Import from sibling feature
  13 | // ‚ö° FRACTAL IMPORT
  14 | import { API_BASE_URL } from '@kernel/config';
  15 | 
  16 | export const useSwitchboard = (domainKey?: string) => {
  17 |     const queryClient = useQueryClient();
  18 |     const { message } = App.useApp();
  19 | 
  20 |     // 1. FETCH AVAILABLE POLICIES (The Atoms)
  21 |     const { data: policies = [], isLoading: isLoadingPolicies } = useQuery({
  22 |         queryKey: ['meta', 'policies', 'list'],
  23 |         queryFn: async () => {
  24 |             const res = await axios.get<PolicyDefinition[]>(`${API_BASE_URL}/api/v1/meta/policies`);
  25 |             return res.data;
  26 |         }
  27 |     });
  28 | 
  29 |     // 2. FETCH AVAILABLE GROUPS (The Bundles) - ‚ö° NEW
  30 |     const { data: groups = [], isLoading: isLoadingGroups } = useQuery({
  31 |         queryKey: ['meta', 'groups', 'list'],
  32 |         queryFn: async () => {
  33 |             const res = await axios.get<PolicyGroup[]>(`${API_BASE_URL}/api/v1/meta/groups`);
  34 |             return res.data;
  35 |         }
  36 |     });
  37 | 
  38 |     // 3. FETCH ACTIVE BINDINGS (The Assignments)
  39 |     const { data: bindings = [], isLoading: isLoadingBindings } = useQuery({
  40 |         queryKey: ['meta', 'bindings', domainKey || 'ALL'],
  41 |         queryFn: async () => {
  42 |             const params: any = {};
  43 |             if (domainKey) params.domain = domainKey;
  44 |             
  45 |             const res = await axios.get<PolicyBinding[]>(`${API_BASE_URL}/api/v1/meta/bindings`, { params });
  46 |             return res.data;
  47 |         },
  48 |         enabled: true 
  49 |     });
  50 | 
  51 |     // 4. CREATE ASSIGNMENT
  52 |     const bindMutation = useMutation({
  53 |         mutationFn: async (draft: BindingDraft) => {
  54 |             return axios.post(`${API_BASE_URL}/api/v1/meta/bindings`, draft);
  55 |         },
  56 |         onSuccess: () => {
  57 |             queryClient.invalidateQueries({ queryKey: ['meta', 'bindings'] });
  58 |             message.success('Policy Enforced');
  59 |         },
  60 |         onError: (err: any) => {
  61 |             message.error(err.response?.data?.detail || 'Assignment Failed');
  62 |         }
  63 |     });
  64 | 
  65 |     // 5. UPDATE ASSIGNMENT
  66 |     const updateMutation = useMutation({
  67 |         mutationFn: async ({ id, data }: { id: number, data: Partial<PolicyBinding> }) => {
  68 |             return axios.patch(`${API_BASE_URL}/api/v1/meta/bindings/${id}`, data);
  69 |         },
  70 |         onSuccess: () => {
  71 |             queryClient.invalidateQueries({ queryKey: ['meta', 'bindings'] });
  72 |         },
  73 |         onError: (err: any) => {
  74 |             message.error(err.response?.data?.detail || 'Update Failed');
  75 |         }
  76 |     });
  77 | 
  78 |     // 6. REMOVE ASSIGNMENT
  79 |     const unbindMutation = useMutation({
  80 |         mutationFn: async (bindingId: number) => {
  81 |             return axios.delete(`${API_BASE_URL}/api/v1/meta/bindings/${bindingId}`);
  82 |         },
  83 |         onSuccess: (data: any) => {
  84 |             queryClient.invalidateQueries({ queryKey: ['meta', 'bindings'] });
  85 |             message.success(data?.data?.message || 'Assignment Removed');
  86 |         }
  87 |     });
  88 | 
  89 |     return {
  90 |         // Data
  91 |         availablePolicies: policies,
  92 |         availableGroups: groups, // ‚ö° EXPOSED
  93 |         activeBindings: bindings,
  94 |         isLoading: isLoadingPolicies || isLoadingBindings || isLoadingGroups,
  95 | 
  96 |         // Actions
  97 |         assignPolicy: bindMutation.mutateAsync,
  98 |         updateAssignment: updateMutation.mutateAsync,
  99 |         removeAssignment: unbindMutation.mutateAsync,
 100 |         
 101 |         isAssigning: bindMutation.isPending
 102 |     };
 103 | };
 104 | 

================================================================================

# Source code from: frontend\src\domains\meta\features\switchboard\types.ts
-----------------------------------------------------------------------------
   1 | /* FILEPATH: frontend/src/domains/meta/features/switchboard/types.ts */
   2 | /* @file Switchboard Types */
   3 | /* @author The Engineer */
   4 | /* @description Defines the shapes for Policies and Bindings.
   5 |  * MATCHES: backend/app/core/meta/schemas.py (PolicyBindingRead, BindingDraft)
   6 |  * REFACTOR: Replaced 'policy_tag' with 'policy_group_id'.
   7 |  */
   8 | 
   9 | import type { PolicyGroup } from '../policy_groups/types';
  10 | 
  11 | // --- 1. THE ATOM (Policy) ---
  12 | export interface PolicyDefinition {
  13 |     id: number;
  14 |     key: string;
  15 |     name: string;
  16 |     description?: string;
  17 |     rules: any[];
  18 |     tags: string[];
  19 |     is_active: boolean;
  20 |     version_major: number;
  21 |     version_minor: number;
  22 |     is_latest: boolean;
  23 | }
  24 | 
  25 | // --- 2. THE ASSIGNMENT (Binding) ---
  26 | export interface PolicyBinding {
  27 |     id: number;
  28 |     
  29 |     // Source Polymorphism (One is always set)
  30 |     policy_id?: number;
  31 |     policy_group_id?: number; // ‚ö° NEW: Strict Link to Group Entity
  32 |     
  33 |     // Expanded Relations (For UI display)
  34 |     policy?: PolicyDefinition;
  35 |     group?: PolicyGroup;      // ‚ö° NEW: Expanded Group Data
  36 | 
  37 |     // Target Polymorphism
  38 |     binding_type: 'ENTITY'; 
  39 |     target_domain: string;
  40 |     target_scope: BindingScope;
  41 |     target_context?: string;
  42 |     
  43 |     priority: number;
  44 |     is_active: boolean;
  45 | }
  46 | 
  47 | // --- 3. OPTIONS ---
  48 | export type BindingScope = 'GLOBAL' | 'DOMAIN' | 'PROCESS' | 'TRANSITION' | 'FIELD' | 'JOB';
  49 | 
  50 | export interface BindingDraft {
  51 |     // ‚ö° Logic: Must provide either policy_id OR policy_group_id
  52 |     policy_id?: number;
  53 |     policy_group_id?: number;
  54 |     
  55 |     binding_type: 'ENTITY';
  56 |     target_domain: string;
  57 |     target_scope: BindingScope;
  58 |     target_context?: string;
  59 |     priority: number;
  60 |     is_active: boolean;
  61 | }
  62 | 

================================================================================

# Source code from: frontend\src\domains\meta\types\index.ts
--------------------------------------------------------------
   1 | // FILEPATH: frontend/src/domains/meta/types/index.ts
   2 | // @file: Meta Domain Type Definitions
   3 | // @role: üì¶ Data Structure */
   4 | // @author: The Engineer
   5 | // @description: Centralizes type definitions for the Meta Domain. Acts as the SSOT for Domain/Scope shapes.
   6 | // @security-level: LEVEL 0 (Core Types) */
   7 | 
   8 | // 1. Re-export Constants (Preserves existing imports)
   9 | export * from './constants';
  10 | 
  11 | import { type ScopeType } from './constants';
  12 | 
  13 | // --- KERNEL PROPERTIES ---
  14 | 
  15 | export interface DomainTypeProperties {
  16 |     storage_strategy: "TABLE" | "KV_STORE" | "NONE";
  17 |     api_strategy: "CRUD" | "REFLECT" | "READ_ONLY";
  18 |     supports_meta: boolean;
  19 |     supports_activity: boolean;
  20 | }
  21 | 
  22 | export interface DomainTypeDefinition {
  23 |     key: string;
  24 |     label: string;
  25 |     icon?: string;
  26 |     color?: string;
  27 |     description?: string;
  28 |     properties: DomainTypeProperties;
  29 | }
  30 | 
  31 | // --- SUMMARIES (Lists) ---
  32 | 
  33 | export interface ScopeSummary {
  34 |     key: string;
  35 |     label: string;
  36 |     type: ScopeType | string;
  37 |     target_field?: string;
  38 |     mode?: string;
  39 |     config?: Record<string, any>;
  40 |     
  41 |     // ‚ö° RUNTIME STATE (Injected by Hypervisor)
  42 |     circuit_state?: {
  43 |         ui?: "NOMINAL" | "HALTED" | "MAINTENANCE";
  44 |         api?: "NOMINAL" | "HALTED" | "MAINTENANCE";
  45 |     };
  46 | }
  47 | 
  48 | export interface DomainSummary {
  49 |     key: string;
  50 |     label: string;
  51 |     
  52 |     // Dynamic Type
  53 |     type: string; 
  54 |     type_def?: DomainTypeDefinition;
  55 | 
  56 |     // Topology
  57 |     system_module: string;
  58 |     module_label: string;
  59 |     module_icon: string;
  60 |     
  61 |     // ‚ö° HIERARCHY (The Tree Link)
  62 |     parent_domain?: string | null;
  63 | 
  64 |     // Visuals
  65 |     icon?: string;
  66 |     description?: string;
  67 |     
  68 |     // Capabilities
  69 |     scopes: ScopeSummary[];
  70 |     
  71 |     // Runtime Config
  72 |     is_active: boolean;
  73 |     config?: Record<string, any>;
  74 | }
  75 | 
  76 | // --- CONTEXT STATE ---
  77 | 
  78 | export interface MetaContextState {
  79 |     // Selection
  80 |     selectedDomain: DomainSummary | null;
  81 |     selectedScope: ScopeSummary | null;
  82 |     selectedItem: string | null;
  83 | 
  84 |     // Data
  85 |     domains: DomainSummary[];
  86 |     isLoading: boolean;
  87 |     error: string | null;
  88 |     
  89 |     // Actions
  90 |     selectDomain: (key: string) => void;
  91 |     selectScope: (key: string) => void;
  92 |     selectItem: (id: string | null) => void;
  93 |     refresh: () => void;
  94 | }
  95 | 

================================================================================

# Source code from: frontend\src\platform\hooks\useUrlState.ts
----------------------------------------------------------------
   1 | // FILEPATH: frontend/src/platform/hooks/useUrlState.ts
   2 | // @file: Universal URL State Hook
   3 | // @role üîå Platform Utility */
   4 | // @author: The Engineer
   5 | // @description: Provides a useState-like interface that persists to the URL Query String.
   6 | // @security-level LEVEL 0 (Kernel Utility) */
   7 | // @invariant Must handle browser history without causing page reloads. */
   8 | 
   9 | import { useState, useEffect, useCallback } from 'react';
  10 | 
  11 | /**
  12 |  * @description Creates a state variable that syncs with a URL query parameter.
  13 |  * @example const [tab, setTab] = useUrlState('tab', 'overview');
  14 |  */
  15 | export function useUrlState<T extends string>(key: string, defaultValue: T): [T, (newValue: T | null) => void] {
  16 |     // 1. READ: Lazy initializer to read from URL only once on boot
  17 |     const [state, setState] = useState<T>(() => {
  18 |         if (typeof window === 'undefined') return defaultValue;
  19 |         const params = new URLSearchParams(window.location.search);
  20 |         const value = params.get(key);
  21 |         return (value as T) || defaultValue;
  22 |     });
  23 | 
  24 |     // 2. WRITE: Updates both Local State and URL
  25 |     const setUrlState = useCallback((newValue: T | null) => {
  26 |         setState(newValue || defaultValue);
  27 | 
  28 |         // Access the current URL state directly from the browser to avoid race conditions
  29 |         const currentUrl = new URL(window.location.href);
  30 |         
  31 |         if (newValue && newValue !== defaultValue) {
  32 |             currentUrl.searchParams.set(key, newValue);
  33 |         } else {
  34 |             currentUrl.searchParams.delete(key);
  35 |         }
  36 | 
  37 |         // ‚ö° HISTORY: Use replaceState to avoid cluttering the "Back" button history with every click
  38 |         // If you want "Back" to undo the selection, change this to pushState.
  39 |         // For simple UI tabs/filters, replaceState is usually better UX.
  40 |         window.history.replaceState(null, '', currentUrl.toString());
  41 |     }, [key, defaultValue]);
  42 | 
  43 |     // 3. LISTEN: (Optional) If the user clicks "Back", sync the internal state
  44 |     useEffect(() => {
  45 |         const handlePopState = () => {
  46 |             const params = new URLSearchParams(window.location.search);
  47 |             const value = params.get(key);
  48 |             setState((value as T) || defaultValue);
  49 |         };
  50 | 
  51 |         window.addEventListener('popstate', handlePopState);
  52 |         return () => window.removeEventListener('popstate', handlePopState);
  53 |     }, [key, defaultValue]);
  54 | 
  55 |     return [state, setUrlState];
  56 | }
  57 | 

================================================================================

# Source code from: frontend\src\platform\logging\Narrator.ts
---------------------------------------------------------------
   1 | // FILEPATH: frontend/src/platform/logging/Narrator.ts
   2 | // @file: Universal Narrative Engine 3.5 (Diagnostic Edition)
   3 | // @author: The Engineer
   4 | // @description: The "Storyteller" Observability System.
   5 | // FEATURES:
   6 | // ‚ö° REAL-TIME TYPING: Captures 'input' events globally.
   7 | // ‚ö° FOCUS TRACKING: Captures 'focusout' (Blur) events globally.
   8 | // ‚ö° X-RAY VISION: Auto-resolves File Path and Line Number for every log.
   9 | // ‚ö° WARN CHANNEL: Added missing public API for warnings.
  10 | // ‚ö° GROUPING: Added support for console groups.
  11 | // üîä OMNISCIENT SENTINEL: Logs ALL clicks for debugging.
  12 | 
  13 | 
  14 | import { IS_DEV } from '../../config';
  15 | 
  16 | type LogLevel = 'INFO' | 'WARN' | 'ERROR' | 'DEBUG' | 'TRACE';
  17 | type LogChannel = 'USER' | 'NETWORK' | 'UI' | 'STORE' | 'LOGIC' | 'SYSTEM' | 'STORY' | 'INPUT' | 'VALIDATOR' | 'WIZARD' | 'API' | 'MOCK' | 'CACHE' | 'RENDERER' | 'SENTINEL' | 'KERNEL' | 'BOOT' | 'ROUTER' | 'SHELL' | 'REGISTRY';
  18 | 
  19 | export class UniversalNarrator {
  20 |   private version = '3.5.0-DIAGNOSTIC';
  21 |   private isEnabled: boolean;
  22 |   private lastLogTime: number = Date.now();
  23 |   
  24 |   // ‚ö° CONFIGURATION: Maximum Verbosity
  25 |   private MAX_LOG_LENGTH = 1000000; // 1 Million Characters (Effectively Unlimited)
  26 | 
  27 |   private styles: Record<LogChannel, string> = {
  28 |     USER:      'color: #e91e63; font-weight: bold; background: #ffe0eb; padding: 2px 4px; border-radius: 3px;',
  29 |     NETWORK:   'color: #2196f3; font-weight: bold;',
  30 |     UI:        'color: #9c27b0; font-weight: bold;',
  31 |     STORE:     'color: #4caf50; font-weight: bold;',
  32 |     LOGIC:     'color: #ff9800; font-weight: bold;',
  33 |     SYSTEM:    'color: #607d8b; font-style: italic;',
  34 |     STORY:     'color: #000; background: #00e676; padding: 2px 6px; border-radius: 4px; font-weight: bold;',
  35 |     INPUT:     'color: #00bcd4; font-family: monospace;',
  36 |     VALIDATOR: 'color: #ff5722; font-weight: bold;',
  37 |     WIZARD:    'color: #795548; font-weight: bold;',
  38 |     API:       'color: #3f51b5; font-weight: bold;',
  39 |     MOCK:      'color: #9e9e9e; font-style: italic;',
  40 |     CACHE:     'color: #009688; font-weight: bold;',
  41 |     RENDERER:  'color: #673ab7; font-weight: bold;',
  42 |     SENTINEL:  'color: #e91e63; font-weight: bold;',
  43 |     KERNEL:    'color: #ff5722; font-weight: bold; background: #fff0f6; padding: 2px 4px;',
  44 |     BOOT:      'color: #fff; background: #000; padding: 2px 4px; font-weight: bold;',
  45 |     ROUTER:    'color: #722ed1; font-weight: bold;',
  46 |     SHELL:     'color: #13c2c2; font-weight: bold;',
  47 |     REGISTRY:  'color: #eb2f96; font-weight: bold;'
  48 |   };
  49 | 
  50 |   constructor() {
  51 |     // We try to detect environment, but default to true if we can't tell, to ensure logging works.
  52 |     let isDev = true; 
  53 |     let isDebug = false;
  54 | 
  55 |     try {
  56 |         // @ts-ignore
  57 |         isDev = import.meta.env.DEV;
  58 |         // @ts-ignore
  59 |         isDebug = import.meta.env.VITE_DEBUG_MODE === 'true';
  60 |     } catch { isDev = true; }
  61 |     
  62 |     this.isEnabled = isDev || isDebug;
  63 | 
  64 |     if (this.isEnabled) {
  65 |       console.log(`%c üëÅÔ∏è NARRATOR v${this.version} %c [DIAGNOSTIC MODE] `, 'color: #00e676; background: #000; padding: 4px;', 'color: white; background: red; padding: 4px;');
  66 |       this._initNetworkInterceptor();
  67 |       this._initDOMSentinel();
  68 |       this._initDragSentinel();
  69 |       this._initKeyboardSentinel();
  70 |       this._initPresenceSentinel();
  71 |       this._initInputSentinel();
  72 |     }
  73 |   }
  74 | 
  75 |   // --- PUBLIC API ---
  76 | 
  77 |   public tell(channel: LogChannel, message: string, data: any = null): void {
  78 |     this._broadcast('INFO', channel, message, data);
  79 |   }
  80 | 
  81 |   public whisper(channel: LogChannel, message: string, data: any = null): void {
  82 |     this._broadcast('DEBUG', channel, message, data);
  83 |   }
  84 | 
  85 |   public warn(channel: LogChannel, message: string, data: any = null): void {
  86 |     this._broadcast('WARN', channel, message, data);
  87 |   }
  88 | 
  89 |   public scream(channel: LogChannel, message: string, error: any = null): void {
  90 |     this._broadcast('ERROR', channel, message, error);
  91 |   }
  92 | 
  93 |   public trace(component: string, action: string, state: any): void {
  94 |     this._broadcast('TRACE', 'UI', `üé• <${component}> ${action}`, state);
  95 |   }
  96 | 
  97 |   public story(headline: string, detail?: string): void {
  98 |     this._broadcast('INFO', 'STORY', headline, detail);
  99 |   }
 100 | 
 101 |   // ‚ö° NEW: Grouping Support
 102 |   public group(label: string): void {
 103 |     if (this.isEnabled) console.groupCollapsed(`%c üìÇ ${label}`, 'font-weight: bold; color: #666;');
 104 |   }
 105 | 
 106 |   public groupEnd(): void {
 107 |     if (this.isEnabled) console.groupEnd();
 108 |   }
 109 | 
 110 |   // --- INTERNAL ---
 111 | 
 112 |   private _resolveCaller(): string {
 113 |     try {
 114 |         const err = new Error();
 115 |         const stack = err.stack;
 116 |         if (!stack) return '';
 117 | 
 118 |         const lines = stack.split('\n');
 119 |         // Line 0: Error
 120 |         // Line 1: _resolveCaller
 121 |         // Line 2: _broadcast
 122 |         // Line 3: tell/scream/whisper
 123 |         // Line 4: The actual caller <--- Target
 124 |         
 125 |         // Find the first line that is NOT inside Narrator.ts
 126 |         // This regex looks for file paths that include /src/
 127 |         for (let i = 3; i < lines.length; i++) {
 128 |             const line = lines[i];
 129 |             if (!line.includes('Narrator.ts')) {
 130 |                 // Extract file path: "    at Context (http://localhost:3000/src/file.ts:10:20)"
 131 |                 const match = line.match(/\((.*src\/.*)\)/) || line.match(/at\s+(.*src\/.*)/);
 132 |                 if (match && match[1]) {
 133 |                     const fullUrl = match[1];
 134 |                     // Clean up: Remove http://localhost:port/
 135 |                     const parts = fullUrl.split('/src/');
 136 |                     if (parts.length > 1) {
 137 |                         return `src/${parts[1]}`; 
 138 |                     }
 139 |                     return fullUrl;
 140 |                 }
 141 |             }
 142 |         }
 143 |         return '';
 144 |     } catch {
 145 |         return '';
 146 |     }
 147 |   }
 148 | 
 149 |   private _broadcast(level: LogLevel, channel: LogChannel, message: string, payload: any): void {
 150 |     if (!this.isEnabled) return;
 151 | 
 152 |     // Time Delta Calculation
 153 |     const now = Date.now();
 154 |     const delta = now - this.lastLogTime;
 155 |     this.lastLogTime = now;
 156 |     
 157 |     // Format Delta: [+450ms] or [+1.2s] or [-----] if idle > 5s
 158 |     let deltaStr = '';
 159 |     if (delta > 5000) deltaStr = `[-----]`;
 160 |     else if (delta > 1000) deltaStr = `[+${(delta/1000).toFixed(1)}s]`;
 161 |     else deltaStr = `[+${delta}ms]`;
 162 | 
 163 |     const style = this.styles[channel] || 'color: #ccc';
 164 |     
 165 |     // ‚ö° X-RAY: Inject Caller Context
 166 |     const caller = this._resolveCaller();
 167 |     const callerTag = caller ? ` %c[${caller}]` : '';
 168 |     const callerStyle = 'color: #888; font-weight: normal; font-size: 0.8em;';
 169 | 
 170 |     const prefix = `%c${deltaStr} [${channel}]`;
 171 | 
 172 |     // ‚ö° IMPROVED OUTPUT
 173 |     if (payload !== null && payload !== undefined) {
 174 |       if (level === 'ERROR') {
 175 |           console.group(prefix + callerTag, style, callerStyle, message); 
 176 |       } else {
 177 |           console.groupCollapsed(prefix + callerTag, style, callerStyle, message);
 178 |       }
 179 |       
 180 |       // 1. Live Object (Chrome DevTools lets you expand this)
 181 |       console.log(payload);
 182 |       
 183 |       // 2. Serialized Backup (For Copy/Paste) - ‚ö° LOUD MODE: Limit increased significantly
 184 |       try {
 185 |            if (payload instanceof Error) {
 186 |                console.log(`%c[STACK]`, 'color:red', payload.stack);
 187 |            } else {
 188 |                const str = JSON.stringify(payload, null, 2);
 189 |                if (str.length < this.MAX_LOG_LENGTH) console.log(`[JSON]`, str);
 190 |                else console.log(`[JSON] (Truncated ${str.length} chars)`, str.substring(0, this.MAX_LOG_LENGTH) + '... [TRUNCATED]');
 191 |            }
 192 |       } catch (e) {
 193 |           console.warn(`[JSON] Circular Structure`);
 194 |       }
 195 |       
 196 |       console.groupEnd();
 197 |     } else {
 198 |       console.log(prefix + callerTag, style, callerStyle, message);
 199 |     }
 200 |   }
 201 | 
 202 |   // --- SENTINELS ---
 203 | 
 204 |   private _initPresenceSentinel(): void {
 205 |       if (typeof window === 'undefined') return;
 206 | 
 207 |       document.addEventListener('visibilitychange', () => {
 208 |           if (document.hidden) {
 209 |               this.tell('USER', '‚è∏Ô∏è User switched tab (Background)');
 210 |           } else {
 211 |               this.tell('USER', '‚ñ∂Ô∏è User returned to tab (Foreground)');
 212 |           }
 213 |   
 214 |     });
 215 | 
 216 |       window.addEventListener('blur', () => this.tell('USER', 'üò∂ Window lost focus (Alt-Tab)'));
 217 |       window.addEventListener('focus', () => this.tell('USER', 'üëÄ Window active'));
 218 |   }
 219 | 
 220 |   private _initDOMSentinel(): void {
 221 |     if (typeof window === 'undefined') return;
 222 |     
 223 |     // ‚ö° DIAGNOSTIC: Confirm Sentinel Attachment
 224 |     this.tell('SENTINEL', 'üëÅÔ∏è DOM Watcher Active (Logging ALL interactions)');
 225 | 
 226 |     // 1. OMNISCIENT CLICK LISTENER (UNFILTERED)
 227 |     document.addEventListener('click', (e: MouseEvent) => {
 228 |       const target = e.target as HTMLElement;
 229 |       
 230 |       // Gather Identity
 231 |       const tag = target.tagName;
 232 |       const id = target.id ? `#${target.id}` : '';
 233 |       const classes = target.className && typeof target.className === 'string' ? `.${target.className.split(' ').join('.')}` : '';
 234 |       const text = target.innerText?.slice(0, 20).replace(/\n/g, ' ') || '';
 235 |       
 236 |       this.tell('USER', `üëÜ Clicked <${tag}${id}${classes}> "${text}"`, {
 237 |           x: e.clientX,
 238 |           y: e.clientY,
 239 |           path: e.composedPath().map((el: any) => el.tagName || 'WINDOW').join(' > ')
 240 |       });
 241 | 
 242 |     }, true); // Capture phase to see it before React stops it
 243 | 
 244 |     // 2. GLOBAL BLUR LISTENER
 245 |     document.addEventListener('focusout', (e: FocusEvent) => {
 246 |         const target = e.target as HTMLElement;
 247 |         if (['INPUT', 'TEXTAREA'].includes(target.tagName)) {
 248 |             const label = target.getAttribute('name') || target.id || 'Unknown Input';
 249 |             // @ts-ignore
 250 |             const val = target.value; 
 251 |      
 252 |        this.tell('USER', `üí® Blured [${label}] Value: "${val}"`);
 253 |         }
 254 |     }, true);
 255 |   }
 256 | 
 257 |   private _initDragSentinel(): void {
 258 |     if (typeof window === 'undefined') return;
 259 | 
 260 |     document.addEventListener('dragstart', (e: DragEvent) => {
 261 |        const target = e.target as HTMLElement;
 262 |        const label = target.innerText || target.getAttribute('title') || 'Object';
 263 |        this.tell('USER', `‚úã Started Dragging "${label}"`);
 264 |     });
 265 | 
 266 |     document.addEventListener('drop', (e: DragEvent) => {
 267 |         const target = e.target as HTMLElement;
 268 |         if (target.classList.contains('react-flow__pane')) {
 269 |             this.tell('USER', `üìç Dropped Item onto Workflow Canvas`);
 270 |         }
 271 |     });
 272 |   }
 273 | 
 274 |   private _initKeyboardSentinel(): void {
 275 |       if (typeof window === 'undefined') return;
 276 | 
 277 |       document.addEventListener('keydown', (e: KeyboardEvent) => {
 278 |           const target = e.target as HTMLElement;
 279 |           const isInput = ['INPUT', 'TEXTAREA'].includes(target.tagName);
 280 |           
 281 |           if (!isInput || e.key === 'Enter' || e.key === 'Escape' || e.key === 'Tab') {
 282 |              this.tell('USER', `‚å®Ô∏è  Key: [${e.key}]`);
 283 |           }
 284 |       });
 285 |   }
 286 | 
 287 |   private _initInputSentinel(): void {
 288 |       if (typeof window === 'undefined') return;
 289 | 
 290 |       document.addEventListener('input', (e: Event) => {
 291 |           const target = e.target as HTMLInputElement;
 292 |           this.whisper('INPUT', `Typing in [${target.name || target.id}]: "${target.value}"`);
 293 |       }, true);
 294 |   }
 295 | 
 296 |   private _initNetworkInterceptor(): void {
 297 |     const originalFetch = window.fetch;
 298 |     const self = this;
 299 | 
 300 |     window.fetch = async function (...args: [RequestInfo | URL, RequestInit?]) {
 301 |       const [resource, config] = args;
 302 |       const url = typeof resource === 'string' ? resource : (resource as Request).url;
 303 |       const method = config?.method || 'GET';
 304 | 
 305 |       if (url.includes('node_modules') || url.includes('@vite')) return originalFetch.apply(window, args);
 306 | 
 307 |       const start = performance.now();
 308 |       try {
 309 |         const response = await originalFetch.apply(window, args);
 310 |         const duration = (performance.now() - start).toFixed(0);
 311 |         const status = response.status;
 312 |         
 313 |         if (status >= 400) {
 314 |             self.scream('NETWORK', `üî• ${method} ${url} (${status}) - ${duration}ms`);
 315 |         } else {
 316 |             self.whisper('NETWORK', `‚úÖ ${method} ${url} (${status}) - ${duration}ms`);
 317 |         }
 318 |         return response;
 319 |       } catch (err) {
 320 |         self.scream('NETWORK', `‚ùå ${method} ${url} FAILED`, err);
 321 |         throw err;
 322 |       }
 323 |     };
 324 |   }
 325 | }
 326 | 
 327 | export const logger = new UniversalNarrator();
 328 | 

================================================================================

# Source code from: frontend\src\platform\logging\index.ts
------------------------------------------------------------
   1 | // FILEPATH: frontend/src/platform/logging/index.ts
   2 | // @file: Logging Barrel
   3 | // @role: ‚öôÔ∏è Utility Export */
   4 | // @author: The Engineer
   5 | // @description: Exports the Singleton Logger for application-wide use.
   6 | // @security-level: LEVEL 0 (Kernel) */
   7 | // @invariant: Must always export a valid 'logger' instance. */
   8 | 
   9 | import { UniversalNarrator } from './Narrator';
  10 | 
  11 | /**
  12 |  * @description The Global Logger Instance.
  13 |  * Uses UniversalNarrator to support both console and remote telemetry (future).
  14 |  */
  15 | export const logger = new UniversalNarrator();
  16 | 
  17 | // Export Types if needed
  18 | export type { UniversalNarrator } from './Narrator';
  19 | 

================================================================================

# Source code from: frontend\src\platform\routing\RouterFactory.tsx
---------------------------------------------------------------------
   1 | // FILEPATH: frontend/src/platform/routing/RouterFactory.tsx
   2 | // @file: Router Factory (The Cartographer - v2.3)
   3 | // @role: üîå Wiring */
   4 | // @author: The Engineer
   5 | // @description: Converts System Manifest into React Router Object.
   6 | // DIAGNOSTIC MODE: Telemetry added to verify V2 route registration.
   7 | 
   8 | 
   9 | // @security-level: LEVEL 0 (Kernel) */
  10 | 
  11 | import React, { Suspense } from 'react';
  12 | import { createBrowserRouter, Navigate } from 'react-router-dom';
  13 | import { Result, Button, Spin } from 'antd';
  14 | 
  15 | // üîå TELEMETRY
  16 | import { useTrace } from '../logging/useTrace';
  17 | import { logger } from '../logging'; // ‚ö° NEW: Import Logger
  18 | 
  19 | // üîå CORE SHELLS
  20 | import { MetaRoot } from '../../domains/meta/_shell/MetaRoot';
  21 | 
  22 | // üîå META FEATURES (Static)
  23 | import MetaDashboard from '../../domains/meta/views/MetaDashboard';
  24 | import { StatesView } from '../../domains/meta/features/states/StatesView';
  25 | import { DictionaryView } from '../../domains/meta/features/dictionary/DictionaryView';
  26 | import { GovernanceView } from '../../domains/meta/features/governance/GovernanceView';
  27 | import { PolicyGroupsView } from '../../domains/meta/features/policy_groups/PolicyGroupsView';
  28 | import { SwitchboardView } from '../../domains/meta/features/switchboard/SwitchboardView';
  29 | import { RunnerView } from '../../domains/meta/features/runner/RunnerView';
  30 | import { AppStudioView } from '../../domains/meta/features/app_studio';
  31 | 
  32 | // üîå WORKSPACE RUNTIME
  33 | import { WorkspaceRuntime } from '../../domains/workspace/views/WorkspaceRuntime';
  34 | 
  35 | // üß™ LAB BENCH
  36 | import { TestWorkflow } from '../../pages/TestWorkflow';
  37 | 
  38 | // ‚ö° SYSTEM CONSOLE (Lazy Loaded)
  39 | const SystemDashboard = React.lazy(() => import('../../domains/system/features/admin_console/SystemDashboard'));
  40 | 
  41 | // ‚ö° CORTEX STUDIO (Lazy Loaded)
  42 | const CortexView = React.lazy(() => import('../../domains/meta/features/cortex/CortexView').then(m => ({ default: m.CortexView })));
  43 | 
  44 | // ‚ö° META V2 (The Kernel Lab) - ISOLATED IMPORT
  45 | const MetaV2Root = React.lazy(() => import('../../domains/meta_v2/MetaV2Root').then(m => ({ default: m.MetaV2Root })));
  46 | 
  47 | // --- ERROR BOUNDARY ---
  48 | const ErrorPage = () => {
  49 |   useTrace('ErrorPage', { 
  50 |     status: 404, 
  51 |     path: window.location.pathname, 
  52 |     referrer: document.referrer || 'Direct'
  53 |   });
  54 | 
  55 |   return (
  56 |     <div style={{ height: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
  57 |       <Result
  58 |         status="404"
  59 |         title="404"
  60 |         subTitle="The page you visited does not exist."
  61 |         extra={<Button type="primary" href="/">Back Home</Button>}
  62 |       />
  63 |     </div>
  64 |   );
  65 | };
  66 | 
  67 | // --- FACTORY ---
  68 | export const createDynamicRouter = (manifest: any) => {
  69 |   logger.whisper('ROUTER', 'üè≠ Factory: Constructing Router Tree...');
  70 |   
  71 |   try {
  72 |       // 1. Define Static Routes (System & Dev Tools)
  73 |       const staticRoutes = [
  74 |         {
  75 |           path: '/login',
  76 |           element: <div>Login Placeholder</div> // Should be handled by AuthContext but keeping route structure
  77 |         },
  78 |         {
  79 |           path: '/',
  80 |           element: <ShellLayout />, // ‚ö° MASTER SHELL (Top Bar + Theme)
  81 |           errorElement: <ErrorPage />,
  82 |           children: [
  83 |             {
  84 |               index: true,
  85 |               element: <Navigate to="/meta" replace />
  86 |             },
  87 |             {
  88 |               path: '/test-workflow', // ‚ö° THE LAB BENCH
  89 |               element: <TestWorkflow />,
  90 |             },
  91 |             // ‚ö° SYSTEM ADMIN CONSOLE
  92 |             {
  93 |               path: '/system',
  94 |               element: (
  95 |                 <Suspense fallback={
  96 |                   <div style={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
  97 |                     <Spin size="large" tip="Loading System Core..." />
  98 |                   </div>
  99 |                 }>
 100 |                   <SystemDashboard />
 101 |                 </Suspense>
 102 |               )
 103 |             },
 104 |             // Meta Kernel Routes
 105 |             {
 106 |               path: '/meta',
 107 |               element: <MetaRoot />,
 108 |               children: [
 109 |                 {
 110 |                   index: true,
 111 |                   element: <MetaDashboard />
 112 |                 },
 113 |                 {
 114 |                   path: 'dictionary',
 115 |                   element: <DictionaryView />
 116 |                 },
 117 |                 {
 118 |                   path: 'governance',
 119 |                   element: <GovernanceView />
 120 |                 },
 121 |                 {
 122 |                   path: 'groups',
 123 |                   element: <PolicyGroupsView />
 124 |                 },
 125 |                 {
 126 |                   path: 'states',
 127 |                   element: <StatesView />,
 128 |                 },
 129 |                 {
 130 |                   path: 'switchboard',
 131 |                   element: <SwitchboardView />
 132 |                 },
 133 |                 {
 134 |                   path: 'studio',
 135 |                   element: <AppStudioView />
 136 |                 },
 137 |                 {
 138 |                   path: 'cortex', // ‚ö° NEW: Cortex Studio
 139 |                   element: (
 140 |                     <Suspense fallback={<Spin size="large" />}>
 141 |                          <CortexView />
 142 |                      </Suspense>
 143 |                   )
 144 |                 },
 145 |                 {
 146 |                   path: 'runner', // Sandbox
 147 |                   element: <RunnerView />
 148 |                 },
 149 |                 {
 150 |                   path: 'production', // Live
 151 |                   element: <RunnerView />
 152 |                 }
 153 |               ]
 154 |             },
 155 |             
 156 |             // ‚ö° META V2 (The Kernel Lab)
 157 |             // ‚úÖ NESTED INSIDE SHELL to inherit Top Bar & Theme
 158 |             {
 159 |               path: '/meta-v2/*',
 160 |               element: (
 161 |                 <Suspense fallback={<div style={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Spin size="large" tip="Booting Kernel V2..." /></div>}>
 162 |                   <MetaV2Root />
 163 |                 </Suspense>
 164 |               )
 165 |             },
 166 | 
 167 |             // ‚ö° DYNAMIC WORKSPACE ROUTES (The "Player")
 168 |             {
 169 |                 path: '/app/:slug/*',
 170 |                 element: <WorkspaceRuntime />
 171 |             }
 172 |           ]
 173 |         }
 174 |       ];
 175 |       
 176 |       logger.tell('ROUTER', '‚úÖ Router Tree Constructed Successfully.');
 177 |       
 178 |       // 2. Construct Router
 179 |       const router = createBrowserRouter(staticRoutes);
 180 |       return router;
 181 | 
 182 |   } catch (error) {
 183 |       logger.scream('ROUTER', 'üî• CRITICAL: Router Construction Failed', error);
 184 |       throw error;
 185 |   }
 186 | };
 187 | 
 188 | // ‚ö° SHELL IMPORT FIX (Lazy load avoided for Core Shell to prevent flicker)
 189 | import { ShellLayout } from '../shell/ShellLayout';
 190 | import { LoginScreen } from '../auth/LoginScreen';
 191 | 

================================================================================

# Source code from: frontend\src\platform\ui\animation\FadeIn.tsx
-------------------------------------------------------------------
   1 | // FILEPATH: frontend/src/platform/ui/animation/FadeIn.tsx
   2 | // @file: Fade In Animation (The "Breathing" Fix)
   3 | // @role: üé® UI Utility */
   4 | // @author: The Engineer
   5 | // @description: Standardized entry animation wrapper.
   6 | // FIX: Replaced 'translateY' (which caused scrollbars) with 'scale' (which contains them).
   7 | // TELEMETRY: Now communicates view transitions to the Narrator.
   8 | 
   9 | 
  10 | import React, { useEffect } from 'react';
  11 | import { theme } from 'antd';
  12 | import { logger } from '../../logging';
  13 | 
  14 | interface FadeInProps {
  15 |     children: React.ReactNode;
  16 |     /** Optional key to trigger re-animation when data changes */
  17 |     triggerKey?: string | number | null;
  18 | }
  19 | 
  20 | export const FadeIn: React.FC<FadeInProps> = ({ children, triggerKey }) => {
  21 |     const { token } = theme.useToken();
  22 | 
  23 |     // ‚ö° TELEMETRY: Communicate the transition
  24 |     useEffect(() => {
  25 |         logger.trace("UI", "‚ú® View Transition Complete", { key: triggerKey || 'root' });
  26 |     }, [triggerKey]);
  27 | 
  28 |     return (
  29 |         <>
  30 |             <style>{`
  31 |                 @keyframes systemFadeIn {
  32 |                     from { 
  33 |                         opacity: 0; 
  34 |                         transform: scale(0.99); /* ‚ö° FIX: Scale keeps it INSIDE the viewport */
  35 |                     }
  36 |                     to { 
  37 |                         opacity: 1; 
  38 |                         transform: scale(1); 
  39 |                     }
  40 |                 }
  41 |                 .system-fade-enter {
  42 |                     animation: systemFadeIn ${token.motionDurationMid} ${token.motionEaseOut};
  43 |                     height: 100%;
  44 |                     width: 100%;
  45 |                     overflow: hidden; 
  46 |                     display: flex;
  47 |                     flex-direction: column;
  48 |                     will-change: transform, opacity; /* ‚ö° PERF: GPU Acceleration */
  49 |                 }
  50 |             `}</style>
  51 |             
  52 |             <div 
  53 |                 key={triggerKey ?? 'static'} 
  54 |                 className="system-fade-enter"
  55 |             >
  56 |                 {children}
  57 |             </div>
  58 |         </>
  59 |     );
  60 | };

================================================================================

# Source code from: frontend\FRONTEND_ATLAS.md
------------------------------------------------
   1 | # üó∫Ô∏è FLODOCK SYSTEM ATLAS (Prism V10)
   2 | **Generated:** 2026-02-20 15:02
   3 | **Mode:** Total Recall (Full Comment Extraction).
   4 | 
   5 | ---
   6 | ## üìÇ `frontend/src/`
   7 | 
   8 | ### üìÑ `App.tsx`
   9 | > Root Provider Stack with fixed locale and fluid height.
  10 | 
  11 | ---
  12 | ## üìÇ `frontend/src/_kernel/`
  13 | 
  14 | ### üìÑ `CapabilitiesContext.tsx`
  15 | > FILEPATH: frontend/src/_kernel/CapabilitiesContext.tsx */
  16 | 
  17 | **Components & Logic:**
  18 | 
  19 | * **`CapabilitiesProvider`**
  20 |   * **Logic Flow:**
  21 |     * `Execute the Handshake`
  22 |     * `Hook for consuming the capabilities`
  23 | * **`useCapabilities`**
  24 |   * üìù *Hook for consuming the capabilities*
  25 | 
  26 | ---
  27 | ### üìÑ `SystemRegistry.ts`
  28 | > Keeps the app alive by catching legacy calls from 'CapabilitiesContext' or 'SystemContext'.
  29 | 
  30 | | Attribute | Value |
  31 | | :--- | :--- |
  32 | | **status** | `ZOMBIE (Logic Removed, Interfaces Preserved)` |
  33 | 
  34 | **Components & Logic:**
  35 | 
  36 | * **`CapabilityItem`**
  37 |   * üìù *--- TYPES (Kept for compatibility to prevent TS errors) ---*
  38 | * **`ContextField`**
  39 | * **`SystemCapabilities`**
  40 |   * **Logic Flow:**
  41 |     * `--- SAFE MODE DEFAULTS ---`
  42 | * **`SystemRegistry`**
  43 | 
  44 | ---
  45 | ### üìÑ `config.ts`
  46 | > FILEPATH: frontend/src/_kernel/config.ts */
  47 | 
  48 | **Components & Logic:**
  49 | 
  50 | * **`API_BASE_URL`**
  51 |   * üìù *localhost:8000';*
  52 |   * **Logic Flow:**
  53 |     * `3. Application Metadata`
  54 | * **`APP_VERSION`**
  55 |   * üìù *3. Application Metadata*
  56 | * **`IS_DEV`**
  57 | * **`IS_DEBUG`**
  58 | 
  59 | ---
  60 | ## üìÇ `frontend/src/api/core/`
  61 | 
  62 | ### üìÑ `ApiError.ts`
  63 | > generated using openapi-typescript-codegen -- do not edit */
  64 | 
  65 | **Components & Logic:**
  66 | 
  67 | * **`ApiError`**
  68 | 
  69 | ---
  70 | ### üìÑ `ApiRequestOptions.ts`
  71 | > generated using openapi-typescript-codegen -- do not edit */
  72 | 
  73 | **Components & Logic:**
  74 | 
  75 | * **`ApiRequestOptions`**
  76 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
  77 | 
  78 | ---
  79 | ### üìÑ `ApiResult.ts`
  80 | > generated using openapi-typescript-codegen -- do not edit */
  81 | 
  82 | **Components & Logic:**
  83 | 
  84 | * **`ApiResult`**
  85 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
  86 | 
  87 | ---
  88 | ### üìÑ `CancelablePromise.ts`
  89 | > generated using openapi-typescript-codegen -- do not edit */
  90 | 
  91 | **Components & Logic:**
  92 | 
  93 | * **`CancelError`**
  94 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
  95 | * **`OnCancel`**
  96 | * **`CancelablePromise`**
  97 | 
  98 | ---
  99 | ### üìÑ `OpenAPI.ts`
 100 | > generated using openapi-typescript-codegen -- do not edit */
 101 | 
 102 | **Components & Logic:**
 103 | 
 104 | * **`OpenAPIConfig`**
 105 | * **`OpenAPI`**
 106 | 
 107 | ---
 108 | ### üìÑ `request.ts`
 109 | > generated using openapi-typescript-codegen -- do not edit */
 110 | 
 111 | **Components & Logic:**
 112 | 
 113 | * **`request`**
 114 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 115 | 
 116 | ---
 117 | ## üìÇ `frontend/src/api/`
 118 | 
 119 | ### üìÑ `index.ts`
 120 | > generated using openapi-typescript-codegen -- do not edit */
 121 | 
 122 | ---
 123 | ## üìÇ `frontend/src/api/models/`
 124 | 
 125 | ### üìÑ `AIRequest.ts`
 126 | > generated using openapi-typescript-codegen -- do not edit */
 127 | 
 128 | **Components & Logic:**
 129 | 
 130 | * **`AIRequest`**
 131 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 132 | 
 133 | ---
 134 | ### üìÑ `ActiveAppCreate.ts`
 135 | > generated using openapi-typescript-codegen -- do not edit */
 136 | 
 137 | **Components & Logic:**
 138 | 
 139 | * **`ActiveAppCreate`**
 140 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 141 | 
 142 | ---
 143 | ### üìÑ `ActiveAppRead.ts`
 144 | > generated using openapi-typescript-codegen -- do not edit */
 145 | 
 146 | **Components & Logic:**
 147 | 
 148 | * **`ActiveAppRead`**
 149 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 150 | 
 151 | ---
 152 | ### üìÑ `ActiveAppUpdate.ts`
 153 | > generated using openapi-typescript-codegen -- do not edit */
 154 | 
 155 | **Components & Logic:**
 156 | 
 157 | * **`ActiveAppUpdate`**
 158 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 159 | 
 160 | ---
 161 | ### üìÑ `AttributeConfig.ts`
 162 | > generated using openapi-typescript-codegen -- do not edit */
 163 | 
 164 | **Components & Logic:**
 165 | 
 166 | * **`AttributeConfig`**
 167 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 168 | 
 169 | ---
 170 | ### üìÑ `AttributeCreate.ts`
 171 | > generated using openapi-typescript-codegen -- do not edit */
 172 | 
 173 | **Components & Logic:**
 174 | 
 175 | * **`AttributeCreate`**
 176 | 
 177 | ---
 178 | ### üìÑ `AttributeRead.ts`
 179 | > generated using openapi-typescript-codegen -- do not edit */
 180 | 
 181 | **Components & Logic:**
 182 | 
 183 | * **`AttributeRead`**
 184 | 
 185 | ---
 186 | ### üìÑ `AttributeType.ts`
 187 | > generated using openapi-typescript-codegen -- do not edit */
 188 | 
 189 | **Components & Logic:**
 190 | 
 191 | * **`AttributeType`**
 192 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 193 | 
 194 | ---
 195 | ### üìÑ `AttributeUpdate.ts`
 196 | > generated using openapi-typescript-codegen -- do not edit */
 197 | 
 198 | **Components & Logic:**
 199 | 
 200 | * **`AttributeUpdate`**
 201 | 
 202 | ---
 203 | ### üìÑ `BindingType.ts`
 204 | > generated using openapi-typescript-codegen -- do not edit */
 205 | 
 206 | **Components & Logic:**
 207 | 
 208 | * **`BindingType`**
 209 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 210 | 
 211 | ---
 212 | ### üìÑ `BrickList.ts`
 213 | > generated using openapi-typescript-codegen -- do not edit */
 214 | 
 215 | **Components & Logic:**
 216 | 
 217 | * **`BrickList`**
 218 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 219 | 
 220 | ---
 221 | ### üìÑ `DataCircuitCreate.ts`
 222 | > generated using openapi-typescript-codegen -- do not edit */
 223 | 
 224 | **Components & Logic:**
 225 | 
 226 | * **`DataCircuitCreate`**
 227 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 228 | 
 229 | ---
 230 | ### üìÑ `DataCircuitRead.ts`
 231 | > generated using openapi-typescript-codegen -- do not edit */
 232 | 
 233 | **Components & Logic:**
 234 | 
 235 | * **`DataCircuitRead`**
 236 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 237 | 
 238 | ---
 239 | ### üìÑ `DataCircuitUpdate.ts`
 240 | > generated using openapi-typescript-codegen -- do not edit */
 241 | 
 242 | **Components & Logic:**
 243 | 
 244 | * **`DataCircuitUpdate`**
 245 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 246 | 
 247 | ---
 248 | ### üìÑ `DryRunRequest.ts`
 249 | > generated using openapi-typescript-codegen -- do not edit */
 250 | 
 251 | **Components & Logic:**
 252 | 
 253 | * **`DryRunRequest`**
 254 | 
 255 | ---
 256 | ### üìÑ `DryRunResult.ts`
 257 | > generated using openapi-typescript-codegen -- do not edit */
 258 | 
 259 | **Components & Logic:**
 260 | 
 261 | * **`DryRunResult`**
 262 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 263 | 
 264 | ---
 265 | ### üìÑ `HTTPValidationError.ts`
 266 | > generated using openapi-typescript-codegen -- do not edit */
 267 | 
 268 | **Components & Logic:**
 269 | 
 270 | * **`HTTPValidationError`**
 271 | 
 272 | ---
 273 | ### üìÑ `NexusTraceRead.ts`
 274 | > generated using openapi-typescript-codegen -- do not edit */
 275 | 
 276 | **Components & Logic:**
 277 | 
 278 | * **`NexusTraceRead`**
 279 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 280 | 
 281 | ---
 282 | ### üìÑ `PolicyBase.ts`
 283 | > generated using openapi-typescript-codegen -- do not edit */
 284 | 
 285 | **Components & Logic:**
 286 | 
 287 | * **`PolicyBase`**
 288 | 
 289 | ---
 290 | ### üìÑ `PolicyBindingCreate.ts`
 291 | > generated using openapi-typescript-codegen -- do not edit */
 292 | 
 293 | **Components & Logic:**
 294 | 
 295 | * **`PolicyBindingCreate`**
 296 | 
 297 | ---
 298 | ### üìÑ `PolicyBindingRead.ts`
 299 | > generated using openapi-typescript-codegen -- do not edit */
 300 | 
 301 | **Components & Logic:**
 302 | 
 303 | * **`PolicyBindingRead`**
 304 | 
 305 | ---
 306 | ### üìÑ `PolicyBindingUpdate.ts`
 307 | > generated using openapi-typescript-codegen -- do not edit */
 308 | 
 309 | **Components & Logic:**
 310 | 
 311 | * **`PolicyBindingUpdate`**
 312 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 313 | 
 314 | ---
 315 | ### üìÑ `PolicyCreate.ts`
 316 | > generated using openapi-typescript-codegen -- do not edit */
 317 | 
 318 | **Components & Logic:**
 319 | 
 320 | * **`PolicyCreate`**
 321 | 
 322 | ---
 323 | ### üìÑ `PolicyGroupCreate.ts`
 324 | > generated using openapi-typescript-codegen -- do not edit */
 325 | 
 326 | **Components & Logic:**
 327 | 
 328 | * **`PolicyGroupCreate`**
 329 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 330 | 
 331 | ---
 332 | ### üìÑ `PolicyGroupRead.ts`
 333 | > generated using openapi-typescript-codegen -- do not edit */
 334 | 
 335 | **Components & Logic:**
 336 | 
 337 | * **`PolicyGroupRead`**
 338 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 339 | 
 340 | ---
 341 | ### üìÑ `PolicyGroupUpdate.ts`
 342 | > generated using openapi-typescript-codegen -- do not edit */
 343 | 
 344 | **Components & Logic:**
 345 | 
 346 | * **`PolicyGroupUpdate`**
 347 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 348 | 
 349 | ---
 350 | ### üìÑ `PolicyRead.ts`
 351 | > generated using openapi-typescript-codegen -- do not edit */
 352 | 
 353 | **Components & Logic:**
 354 | 
 355 | * **`PolicyRead`**
 356 | 
 357 | ---
 358 | ### üìÑ `PolicyResolutionStrategy.ts`
 359 | > generated using openapi-typescript-codegen -- do not edit */
 360 | 
 361 | **Components & Logic:**
 362 | 
 363 | * **`PolicyResolutionStrategy`**
 364 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 365 | 
 366 | ---
 367 | ### üìÑ `PolicyRule.ts`
 368 | > generated using openapi-typescript-codegen -- do not edit */
 369 | 
 370 | **Components & Logic:**
 371 | 
 372 | * **`PolicyRule`**
 373 | 
 374 | ---
 375 | ### üìÑ `PolicyUpdate.ts`
 376 | > generated using openapi-typescript-codegen -- do not edit */
 377 | 
 378 | **Components & Logic:**
 379 | 
 380 | * **`PolicyUpdate`**
 381 | 
 382 | ---
 383 | ### üìÑ `ReleaseCreate.ts`
 384 | > generated using openapi-typescript-codegen -- do not edit */
 385 | 
 386 | **Components & Logic:**
 387 | 
 388 | * **`ReleaseCreate`**
 389 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 390 | 
 391 | ---
 392 | ### üìÑ `ReleaseRead.ts`
 393 | > generated using openapi-typescript-codegen -- do not edit */
 394 | 
 395 | **Components & Logic:**
 396 | 
 397 | * **`ReleaseRead`**
 398 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 399 | 
 400 | ---
 401 | ### üìÑ `RuleActionType.ts`
 402 | > generated using openapi-typescript-codegen -- do not edit */
 403 | 
 404 | **Components & Logic:**
 405 | 
 406 | * **`RuleActionType`**
 407 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 408 | 
 409 | ---
 410 | ### üìÑ `RuleCreate.ts`
 411 | > generated using openapi-typescript-codegen -- do not edit */
 412 | 
 413 | **Components & Logic:**
 414 | 
 415 | * **`RuleCreate`**
 416 | 
 417 | ---
 418 | ### üìÑ `RuleEffect.ts`
 419 | > generated using openapi-typescript-codegen -- do not edit */
 420 | 
 421 | **Components & Logic:**
 422 | 
 423 | * **`RuleEffect`**
 424 | 
 425 | ---
 426 | ### üìÑ `RuleEventType.ts`
 427 | > generated using openapi-typescript-codegen -- do not edit */
 428 | 
 429 | **Components & Logic:**
 430 | 
 431 | * **`RuleEventType`**
 432 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 433 | 
 434 | ---
 435 | ### üìÑ `RuleRead.ts`
 436 | > generated using openapi-typescript-codegen -- do not edit */
 437 | 
 438 | **Components & Logic:**
 439 | 
 440 | * **`RuleRead`**
 441 | 
 442 | ---
 443 | ### üìÑ `ScopeType.ts`
 444 | > generated using openapi-typescript-codegen -- do not edit */
 445 | 
 446 | **Components & Logic:**
 447 | 
 448 | * **`ScopeType`**
 449 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 450 | 
 451 | ---
 452 | ### üìÑ `ScreenCreate.ts`
 453 | > generated using openapi-typescript-codegen -- do not edit */
 454 | 
 455 | **Components & Logic:**
 456 | 
 457 | * **`ScreenCreate`**
 458 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 459 | 
 460 | ---
 461 | ### üìÑ `ScreenList.ts`
 462 | > generated using openapi-typescript-codegen -- do not edit */
 463 | 
 464 | **Components & Logic:**
 465 | 
 466 | * **`ScreenList`**
 467 | 
 468 | ---
 469 | ### üìÑ `ScreenRead.ts`
 470 | > generated using openapi-typescript-codegen -- do not edit */
 471 | 
 472 | **Components & Logic:**
 473 | 
 474 | * **`ScreenRead`**
 475 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 476 | 
 477 | ---
 478 | ### üìÑ `SelectOption.ts`
 479 | > generated using openapi-typescript-codegen -- do not edit */
 480 | 
 481 | **Components & Logic:**
 482 | 
 483 | * **`SelectOption`**
 484 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 485 | 
 486 | ---
 487 | ### üìÑ `StateMachineCreate.ts`
 488 | > generated using openapi-typescript-codegen -- do not edit */
 489 | 
 490 | **Components & Logic:**
 491 | 
 492 | * **`StateMachineCreate`**
 493 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 494 | 
 495 | ---
 496 | ### üìÑ `StateMachineRead.ts`
 497 | > generated using openapi-typescript-codegen -- do not edit */
 498 | 
 499 | **Components & Logic:**
 500 | 
 501 | * **`StateMachineRead`**
 502 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 503 | 
 504 | ---
 505 | ### üìÑ `Token.ts`
 506 | > generated using openapi-typescript-codegen -- do not edit */
 507 | 
 508 | **Components & Logic:**
 509 | 
 510 | * **`Token`**
 511 | 
 512 | ---
 513 | ### üìÑ `TransitionOption.ts`
 514 | > generated using openapi-typescript-codegen -- do not edit */
 515 | 
 516 | **Components & Logic:**
 517 | 
 518 | * **`TransitionOption`**
 519 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 520 | 
 521 | ---
 522 | ### üìÑ `TransitionRequest.ts`
 523 | > generated using openapi-typescript-codegen -- do not edit */
 524 | 
 525 | **Components & Logic:**
 526 | 
 527 | * **`TransitionRequest`**
 528 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 529 | 
 530 | ---
 531 | ### üìÑ `TransitionResponse.ts`
 532 | > generated using openapi-typescript-codegen -- do not edit */
 533 | 
 534 | **Components & Logic:**
 535 | 
 536 | * **`TransitionResponse`**
 537 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 538 | 
 539 | ---
 540 | ### üìÑ `UserLogin.ts`
 541 | > generated using openapi-typescript-codegen -- do not edit */
 542 | 
 543 | **Components & Logic:**
 544 | 
 545 | * **`UserLogin`**
 546 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 547 | 
 548 | ---
 549 | ### üìÑ `UserRead.ts`
 550 | > generated using openapi-typescript-codegen -- do not edit */
 551 | 
 552 | **Components & Logic:**
 553 | 
 554 | * **`UserRead`**
 555 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 556 | 
 557 | ---
 558 | ### üìÑ `ValidationError.ts`
 559 | > generated using openapi-typescript-codegen -- do not edit */
 560 | 
 561 | **Components & Logic:**
 562 | 
 563 | * **`ValidationError`**
 564 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 565 | 
 566 | ---
 567 | ### üìÑ `WidgetType.ts`
 568 | > generated using openapi-typescript-codegen -- do not edit */
 569 | 
 570 | **Components & Logic:**
 571 | 
 572 | * **`WidgetType`**
 573 |   * üìù *generated using openapi-typescript-codegen -- do not edit */*
 574 | 
 575 | ---
 576 | ## üìÇ `frontend/src/api/services/`
 577 | 
 578 | ### üìÑ `AiCortexService.ts`
 579 | > generated using openapi-typescript-codegen -- do not edit */
 580 | 
 581 | **Components & Logic:**
 582 | 
 583 | * **`AiCortexService`**
 584 | 
 585 | ---
 586 | ### üìÑ `AuthService.ts`
 587 | > generated using openapi-typescript-codegen -- do not edit */
 588 | 
 589 | **Components & Logic:**
 590 | 
 591 | * **`AuthService`**
 592 | 
 593 | ---
 594 | ### üìÑ `MetaKernelService.ts`
 595 | > FILEPATH: frontend/src/api/services/MetaKernelService.ts
 596 | 
 597 | **Components & Logic:**
 598 | 
 599 | * **`MetaKernelService`**
 600 | 
 601 | ---
 602 | ### üìÑ `NexusBrokerService.ts`
 603 | > generated using openapi-typescript-codegen -- do not edit */
 604 | 
 605 | **Components & Logic:**
 606 | 
 607 | * **`NexusBrokerService`**
 608 | 
 609 | ---
 610 | ### üìÑ `PolicyGroupsService.ts`
 611 | > generated using openapi-typescript-codegen -- do not edit */
 612 | 
 613 | **Components & Logic:**
 614 | 
 615 | * **`PolicyGroupsService`**
 616 | 
 617 | ---
 618 | ### üìÑ `SystemCoreService.ts`
 619 | > generated using openapi-typescript-codegen -- do not edit */
 620 | 
 621 | **Components & Logic:**
 622 | 
 623 | * **`SystemCoreService`**
 624 | 
 625 | ---
 626 | ### üìÑ `UniversalResourceService.ts`
 627 | > generated using openapi-typescript-codegen -- do not edit */
 628 | 
 629 | **Components & Logic:**
 630 | 
 631 | * **`UniversalResourceService`**
 632 | 
 633 | ---
 634 | ### üìÑ `WorkflowEngineService.ts`
 635 | > generated using openapi-typescript-codegen -- do not edit */
 636 | 
 637 | **Components & Logic:**
 638 | 
 639 | * **`WorkflowEngineService`**
 640 | 
 641 | ---
 642 | ### üìÑ `WorkflowsService.ts`
 643 | > generated using openapi-typescript-codegen -- do not edit */
 644 | 
 645 | **Components & Logic:**
 646 | 
 647 | * **`WorkflowsService`**
 648 | 
 649 | ---
 650 | ### üìÑ `WorkspaceService.ts`
 651 | > generated using openapi-typescript-codegen -- do not edit */
 652 | 
 653 | **Components & Logic:**
 654 | 
 655 | * **`WorkspaceService`**
 656 | 
 657 | ---
 658 | ## üìÇ `frontend/src/`
 659 | 
 660 | ### üìÑ `config.ts`
 661 | > FILEPATH: frontend/src/config.ts */
 662 | 
 663 | **Components & Logic:**
 664 | 
 665 | * **`API_BASE_URL`**
 666 |   * üìù *localhost:8000';*
 667 |   * **Logic Flow:**
 668 |     * `3. Application Metadata`
 669 | * **`APP_VERSION`**
 670 |   * üìù *Remove any remaining trailing slashes*
 671 | * **`IS_DEV`**
 672 | * **`IS_DEBUG`**
 673 | 
 674 | ---
 675 | ## üìÇ `frontend/src/domains/meta/_kernel/`
 676 | 
 677 | ### üìÑ `CapabilitiesContext.tsx`
 678 | > Fetches and provides System Introspection Data.
 679 | 
 680 | | Attribute | Value |
 681 | | :--- | :--- |
 682 | | **security-level** | `LEVEL 0 (Kernel)` |
 683 | | **invariant** | `Must be the ONLY instance in the app.` |
 684 | | **updated** | `Added Strict Array Sanitization to prevent 'NEURAL LINK SEVERED' crash.` |
 685 | 
 686 | **Components & Logic:**
 687 | 
 688 | * **`CapabilityItem`**
 689 | * **`ContextField`**
 690 | * **`SystemCapabilities`**
 691 | * **`CapabilitiesProvider`**
 692 |   * **Logic Flow:**
 693 |     * `‚ö° SANITIZATION LAYER: Ensure no null arrays to prevent crashes`
 694 | * **`useCapabilities`**
 695 | 
 696 | ---
 697 | ### üìÑ `MetaContext.tsx`
 698 | > Manages Domain Selection, Scope, and Deep Linking. Bridges the URL to the Application State.
 699 | 
 700 | | Attribute | Value |
 701 | | :--- | :--- |
 702 | | **security-level** | `LEVEL 0 (Kernel) */` |
 703 | 
 704 | **Components & Logic:**
 705 | 
 706 | * **`MetaProvider`**
 707 |   * **Logic Flow:**
 708 |     * `1. DATA: Fetch Topology (Domains -> Scopes)`
 709 |     * `‚ö° API FIX: Match the exact generated OpenAPI SDK method name`
 710 |     * `2. STATE: Universal URL Persistence`
 711 |     * `3. DERIVED STATE: Resolve Objects from Keys`
 712 |     * `4. ACTIONS (The Interface Implementation)`
 713 |     * `Clear children when parent changes`
 714 |     * `5. SIDE EFFECTS`
 715 |     * `6. CONSTRUCT CONTEXT`
 716 | * **`useMetaContext`**
 717 | 
 718 | ---
 719 | ### üìÑ `types.ts`
 720 | > Shared type definitions for the Meta Module state.
 721 | 
 722 | | Attribute | Value |
 723 | | :--- | :--- |
 724 | | **security-level** | `LEVEL 0 (Kernel Definition) */` |
 725 | | **invariant** | `Must match Backend Pydantic Models in 'app.core.kernel.registry.schemas'. */` |
 726 | | **updated** | `Added 'selectedItem' for Global Deep Linking. */` |
 727 | 
 728 | **Components & Logic:**
 729 | 
 730 | * **`ScopeConfig`**
 731 |   * üìù *Shared type definitions for the Meta Module state.*
 732 |   * **Logic Flow:**
 733 |     * `For Governance/Sub-Flow: Which DB column does this control?`
 734 |     * `For Wizards: "CREATE" or "EDIT"`
 735 |     * `For Jobs: "high_priority" etc.`
 736 |     * `Generic Configuration`
 737 |     * `‚ö° LEVEL 7: DYNAMIC TYPE DEFINITION (From DB: kernel_domain_types)`
 738 | * **`DomainTypeProperties`**
 739 |   * üìù *‚ö° LEVEL 7: DYNAMIC TYPE DEFINITION (From DB: kernel_domain_types)*
 740 | * **`DomainTypeDefinition`**
 741 |   * **Logic Flow:**
 742 |     * `‚ö° FIX: Added strictly typed properties bag to receive Backend Contract`
 743 | * **`DomainSummary`**
 744 |   * **Logic Flow:**
 745 |     * `‚ö° DYNAMIC TYPE (Data-Driven)`
 746 |     * `Matches 'backend/app/domains/system/features/domain_types/models.py'`
 747 |     * `‚ö° TOPOLOGY METADATA (Level 100)`
 748 |     * `Visuals`
 749 |     * `Capabilities`
 750 | * **`MetaContextState`**
 751 |   * **Logic Flow:**
 752 |     * `Selection State (Deep Linking)`
 753 |     * `‚ö° GLOBAL ITEM STATE (Fixes Refresh Amnesia)`
 754 |     * `Data Access`
 755 | 
 756 | ---
 757 | ## üìÇ `frontend/src/domains/meta/_shell/`
 758 | 
 759 | ### üìÑ `MetaLayout.tsx`
 760 | > The structural frame for the System Configuration module.
 761 | 
 762 | **Components & Logic:**
 763 | 
 764 | * **`MetaLayout`**
 765 | 
 766 | ---
 767 | ### üìÑ `MetaRoot.tsx`
 768 | > Provides the MetaContext and persistent Layout Shell for the Meta Kernel.
 769 | 
 770 | **Components & Logic:**
 771 | 
 772 | * **`MetaRoot`**
 773 | 
 774 | ---
 775 | ### üñ•Ô∏è `MetaSidebar.tsx`
 776 | > High-density navigation for the System Configuration module.
 777 | 
 778 | | Attribute | Value |
 779 | | :--- | :--- |
 780 | | **security-level** | `LEVEL 5 (Presentation) */` |
 781 | 
 782 | **Components & Logic:**
 783 | 
 784 | * **`MetaSidebar`**
 785 |   * **Logic Flow:**
 786 |     * `‚ö° PERSISTENCE`
 787 |     * `‚ö° SYSTEM LINK`
 788 |     * `‚ö° THE APP STORE`
 789 | 
 790 | ---
 791 | ## üìÇ `frontend/src/domains/meta/components/`
 792 | 
 793 | ### üìÑ `DomainTree.tsx`
 794 | > A hierarchical visual grid to select Domains. Supports nesting (Parent -> Child).
 795 | 
 796 | | Attribute | Value |
 797 | | :--- | :--- |
 798 | | **security-level** | `LEVEL 9 (Read-Only) */` |
 799 | 
 800 | **Components & Logic:**
 801 | 
 802 | * **`DomainTree`**
 803 |   * **Logic Flow:**
 804 |     * `‚ö° TOPOLOGY ENGINE: Build the Tree`
 805 |     * `1. Initialize Nodes`
 806 |     * `2. Link Parents & Children`
 807 |     * `If parent exists in the map, link it. Otherwise, treat as root.`
 808 |     * `3. Sort by Module then Label`
 809 |     * `‚ö° RENDERER: Recursive Node`
 810 |     * `Card Style`
 811 | 
 812 | ---
 813 | ### üìÑ `RuleBuilder.tsx`
 814 | > FILEPATH: frontend/src/domains/meta/components/RuleBuilder.tsx */
 815 | 
 816 | **Components & Logic:**
 817 | 
 818 | * **`RuleBuilder`**
 819 |   * üìù *--- COMPONENT ---*
 820 |   * **Logic Flow:**
 821 |     * `1. Context Intelligence`
 822 |     * `2. Kernel Capabilities (Dynamic Introspection)`
 823 |     * `3. Form State`
 824 |     * `4. Logic State (Simplified Builder)`
 825 |     * `5. Effect State`
 826 |     * `--- HELPERS ---`
 827 |     * `Compile Visual Conditions to JMESPath String`
 828 | 
 829 | ---
 830 | ## üìÇ `frontend/src/domains/meta/features/app_studio/`
 831 | 
 832 | ### üìÑ `AppStudioView.tsx`
 833 | > Orchestrates Lobby, Canvas, and Brick Library. Passes Meta History to Editor.
 834 | 
 835 | | Attribute | Value |
 836 | | :--- | :--- |
 837 | | **security-level** | `LEVEL 9 (Deep Linking) */` |
 838 | 
 839 | **Components & Logic:**
 840 | 
 841 | * **`AppStudioView`**
 842 |   * **Logic Flow:**
 843 |     * `1. GLOBAL STATE (URL)`
 844 |     * `2. LOGIC HOOK (Actions & Screens List)`
 845 |     * `3. DERIVED STATE`
 846 |     * `4. DATA HOOK (Layout & Content)`
 847 |     * `We only fetch layout if we have an active screen`
 848 |     * `‚ö° NORMALIZE APPS FOR EDITOR`
 849 |     * `--- HANDLERS ---`
 850 |     * `‚ö° DND HANDLER (Delegated from Editor)`
 851 |     * `CASE A: Dropped on a ZONE`
 852 |     * `CASE B: Dropped on a FOLDER (Container)`
 853 |     * `‚ö° CONTEXT MENU HANDLER (The "Easy Way")`
 854 |     * `--- RENDER: LOBBY MODE ---`
 855 |     * `--- RENDER: EDITOR MODE ---`
 856 |     * `‚ö° INJECT HISTORY: Pass the meta from the layout response`
 857 | 
 858 | ---
 859 | ## üìÇ `frontend/src/domains/meta/features/app_studio/components/`
 860 | 
 861 | ### üìÑ `AppConfigurator.tsx`
 862 | > The Inspector. Now supports Parent/Child relationships with strict Container filtering.
 863 | 
 864 | | Attribute | Value |
 865 | | :--- | :--- |
 866 | | **security-level** | `LEVEL 9 (UI Safe) */` |
 867 | | **invariant** | `Must handle missing 'config' objects gracefully. Only nesting under CONTAINERS is allowed. */` |
 868 | 
 869 | **Components & Logic:**
 870 | 
 871 | * **`AppConfigurator`**
 872 |   * **Logic Flow:**
 873 |     * `‚ö° HIERARCHY LOGIC: Build Tree Options for Parent Selection`
 874 |     * `‚ö° STRICT FILTER: Only allow nesting under CONTAINERS in the SIDEBAR`
 875 |     * `FIX: Check both 'type' (Runtime) and 'scope_type' (Static) to ensure compatibility`
 876 |     * `‚ö° FIX: Safe access to config.label with fallbacks`
 877 |     * `üõ°Ô∏è SAFE ACCESS`
 878 |     * `Identity`
 879 |     * `Placement & Hierarchy`
 880 |     * `Behavior (Polymorphic)`
 881 |     * `Security`
 882 |     * `‚ö° DYNAMIC FIELDS based on Brick Type`
 883 | 
 884 | ---
 885 | ### üìÑ `AppStudioLobby.tsx`
 886 | > The "Welcome Screen" for the App Studio. Lists existing apps and allows creation.
 887 | 
 888 | | Attribute | Value |
 889 | | :--- | :--- |
 890 | | **security-level** | `LEVEL 9 (Read-Only List) */` |
 891 | | **invariant** | `Must display all available screens from the registry. */` |
 892 | 
 893 | **Components & Logic:**
 894 | 
 895 | * **`AppStudioLobby`**
 896 |   * **Logic Flow:**
 897 |     * `‚ö° GOVERNANCE FILTER: Hide screens locked by backend policy (mode='strict')`
 898 |     * `We strictly filter out any screen that claims to be "strict" in its security policy.`
 899 | 
 900 | ---
 901 | ### üìÑ `BrickLibrary.tsx`
 902 | > The "Smart" Palette with Context Menu for instant placement.
 903 | 
 904 | | Attribute | Value |
 905 | | :--- | :--- |
 906 | | **security-level** | `LEVEL 9 (Safe Return) */` |
 907 | | **invariant** | `Must filter by text and type. Must handle empty data gracefully. */` |
 908 | | **updated** | `Fixed missing 'Space' import to prevent ReferenceError. */` |
 909 | 
 910 | **Components & Logic:**
 911 | 
 912 | * **`BrickLibrary`**
 913 |   * **Logic Flow:**
 914 |     * `‚ö° FILTER LOGIC`
 915 |     * `‚ö° GROUPING LOGIC`
 916 |     * `‚ö° CONTEXT MENU FACTORY`
 917 | 
 918 | ---
 919 | ### üìÑ `CreateAppModal.tsx`
 920 | > A form to define the Identity (Name, Route, Purpose) of a new Application before it exists.
 921 | 
 922 | | Attribute | Value |
 923 | | :--- | :--- |
 924 | | **security-level** | `LEVEL 9 (Input Validation) */` |
 925 | | **invariant** | `Route Slug must be URL-safe (lowercase, hyphens). */` |
 926 | 
 927 | **Components & Logic:**
 928 | 
 929 | * **`CreateAppModal`**
 930 |   * **Logic Flow:**
 931 |     * `‚ö° AUTO-SLUG LOGIC`
 932 |     * `When title changes, auto-generate a slug if the user hasn't manually edited it.`
 933 |     * `Only auto-set if the slug field is pristine or matches the previous auto-gen`
 934 | 
 935 | ---
 936 | ### üìÑ `DraggableBrick.tsx`
 937 | > A palette item that uses @dnd-kit to be compatible with the Screen Canvas.
 938 | 
 939 | | Attribute | Value |
 940 | | :--- | :--- |
 941 | | **security-level** | `LEVEL 9 (DND-Kit Integrated) */` |
 942 | | **invariant** | `Must pass 'brick' data to the drag context. */` |
 943 | 
 944 | **Components & Logic:**
 945 | 
 946 | * **`DraggableBrick`**
 947 |   * **Logic Flow:**
 948 |     * `‚ö° DND-KIT HOOK`
 949 | 
 950 | ---
 951 | ### üìÑ `IconFactory.tsx`
 952 | > Renders icons from Token Strings. Supports 'antd:' prefix.
 953 | 
 954 | **Components & Logic:**
 955 | 
 956 | * **`IconFactory`**
 957 |   * **Logic Flow:**
 958 |     * `1. Handle Empty`
 959 |     * `2. Parse Token`
 960 |     * `3. Render Strategy: Ant Design`
 961 |     * `Fallback`
 962 | 
 963 | ---
 964 | ### üìÑ `IconPicker.tsx`
 965 | > Visual grid for selecting icons. Dynamically loads entire Ant Design library.
 966 | 
 967 | **Components & Logic:**
 968 | 
 969 | * **`IconPicker`**
 970 |   * **Logic Flow:**
 971 |     * `‚ö° SEARCH ENGINE: Filters 800+ icons instantly`
 972 | 
 973 | ---
 974 | ### üìÑ `ScreenCanvas.tsx`
 975 | > Renders the Application Wireframe with nested Container support.
 976 | 
 977 | | Attribute | Value |
 978 | | :--- | :--- |
 979 | | **security-level** | `LEVEL 9 (UI Safe) */` |
 980 | | **invariant** | `Must visually represent the layout structure accurately, including hierarchy. */` |
 981 | 
 982 | **Components & Logic:**
 983 | 
 984 | * **`ScreenCanvas`**
 985 | 
 986 | ---
 987 | ### üìÑ `StudioEditor.tsx`
 988 | > The full-screen IDE interface. Displays Version History in Header.
 989 | 
 990 | | Attribute | Value |
 991 | | :--- | :--- |
 992 | | **security-level** | `LEVEL 9 (UI Partition) */` |
 993 | | **narrator** | `üïµÔ∏è TELEMETRY + VERSIONING ENABLED */` |
 994 | 
 995 | **Components & Logic:**
 996 | 
 997 | * **`StudioEditor`**
 998 |   * **Logic Flow:**
 999 |     * `üïµÔ∏è TELEMETRY`
1000 |     * `‚ö° PUBLISH STATE`
1001 |     * `‚ö° SEMVER CALCULATOR`
1002 |     * `‚ö° FIX: Pass the user-edited version string`
1003 | 
1004 | ---
1005 | ## üìÇ `frontend/src/domains/meta/features/app_studio/hooks/`
1006 | 
1007 | ### üìÑ `useAppStudio.ts`
1008 | > Manages IDE Actions. Updates 'publishApp' to support explicit version labels.
1009 | 
1010 | | Attribute | Value |
1011 | | :--- | :--- |
1012 | | **security-level** | `LEVEL 9 (Direct Fetch Implementation) */` |
1013 | 
1014 | **Components & Logic:**
1015 | 
1016 | * **`useAppStudio`**
1017 |   * **Logic Flow:**
1018 |     * `1. DATA (Bricks Only - Workspace is managed by View)`
1019 |     * `Normalize Library Data`
1020 |     * `2. STATE`
1021 |     * `‚ö° HELPER: Direct Fetcher`
1022 |     * `‚ö° ACTION: Fetch Screens List (With Race Condition Fix)`
1023 |     * `3. ACTIONS`
1024 |     * `‚ö° FIX: Accept versionLabel explicitly`
1025 | 
1026 | ---
1027 | ## üìÇ `frontend/src/domains/meta/features/app_studio/`
1028 | 
1029 | ### üìÑ `index.ts`
1030 | > Exports the main view. Used by the Router.
1031 | 
1032 | ---
1033 | ### üìÑ `types.ts`
1034 | > Added 'Release' interface for version history.
1035 | 
1036 | **Components & Logic:**
1037 | 
1038 | * **`BrickType`**
1039 |   * üìù *Added 'Release' interface for version history.*
1040 | * **`SystemBrick`**
1041 |   * **Logic Flow:**
1042 |     * `2. THE SCREEN`
1043 | * **`Screen`**
1044 |   * üìù *2. THE SCREEN*
1045 |   * **Logic Flow:**
1046 |     * `3. THE APP`
1047 | * **`ActiveApp`**
1048 |   * üìù *3. THE APP*
1049 |   * **Logic Flow:**
1050 |     * `‚ö° NEW: RELEASE HISTORY`
1051 | * **`Release`**
1052 |   * üìù *‚ö° NEW: RELEASE HISTORY*
1053 | * **`ZoneType`**
1054 | * **`DragItem`**
1055 | 
1056 | ---
1057 | ## üìÇ `frontend/src/domains/meta/features/cortex/`
1058 | 
1059 | ### üìÑ `CortexView.tsx`
1060 | > Standalone view for the AI Architect.
1061 | 
1062 | | Attribute | Value |
1063 | | :--- | :--- |
1064 | | **updated** | `Added Domain Picker and Back Navigation to the Active Toolbar. */` |
1065 | 
1066 | **Components & Logic:**
1067 | 
1068 | * **`CortexView`**
1069 | 
1070 | ---
1071 | ## üìÇ `frontend/src/domains/meta/features/dictionary/`
1072 | 
1073 | ### üìÑ `DictionaryView.tsx`
1074 | > Master Controller. Fixes 'config' vs 'configuration' crash and Layout Regressions.
1075 | 
1076 | | Attribute | Value |
1077 | | :--- | :--- |
1078 | | **security-level** | `LEVEL 9 (UI Safe) */` |
1079 | 
1080 | **Components & Logic:**
1081 | 
1082 | * **`DictionaryView`**
1083 |   * **Logic Flow:**
1084 |     * `1. GLOBAL CONTEXT`
1085 |     * `Sync URL -> Context`
1086 |     * `2. FEATURE LOGIC`
1087 |     * `Local UI State`
1088 |     * `3. HANDLERS`
1089 |     * `4. COMPUTED: Safe Data Resolution`
1090 |     * `‚ö° CONTRACT FIX: Ensure we map DB config to 'configuration'`
1091 |     * `Return Fresh Draft for "New" mode`
1092 |     * `‚ö° SECURITY CHECK: Is this a System Field?`
1093 |     * `‚ö° STATE: Are we in "New Mode"?`
1094 |     * `--- RENDER: STATE A (LOBBY) ---`
1095 |     * `--- RENDER: STATE B (MASTER-DETAIL EDITOR) ---`
1096 | 
1097 | ---
1098 | ## üìÇ `frontend/src/domains/meta/features/dictionary/components/`
1099 | 
1100 | ### üìÑ `AttributeEditor.tsx`
1101 | > The Master Controller for editing Attributes. Uses 'configuration' correctly.
1102 | 
1103 | | Attribute | Value |
1104 | | :--- | :--- |
1105 | | **security-level** | `LEVEL 9 (UI Safe) */` |
1106 | 
1107 | **Components & Logic:**
1108 | 
1109 | * **`AttributeEditor`**
1110 |   * **Logic Flow:**
1111 |     * `‚ö° SYNC: Update local state if parent selection changes`
1112 |     * `‚ö° LOGIC: Auto-switch widget if data type changes`
1113 |     * `‚ö° CONTRACT FIX: Updates 'configuration', NOT 'config'`
1114 |     * `We allow config updates even if locked, generally (e.g. placeholder)`
1115 |     * `but maybe not logic. For now, allow it.`
1116 |     * `‚ö° LOGIC: Auto-Slugify`
1117 |     * `Label is editable even if locked (usually)`
1118 |     * `Widget CAN change usually, unless strict`
1119 |     * `‚ö° CRITICAL FIX: Pass 'configuration', not 'config'`
1120 | 
1121 | ---
1122 | ### üìÑ `AttributeExplorer.tsx`
1123 | > Navigable list of Domain Attributes.
1124 | 
1125 | **Components & Logic:**
1126 | 
1127 | * **`AttributeExplorer`**
1128 |   * **Logic Flow:**
1129 |     * `üß† SMART SORTING`
1130 |     * `‚ö° FIX: Use 'key' (string) instead of 'id' (number) for uniqueness`
1131 |     * `System fields all have ID 0, which caused Duplicate Key errors.`
1132 | 
1133 | ---
1134 | ### üìÑ `DomainPicker.tsx`
1135 | > A visual grid to select which Domain Schema to edit.
1136 | 
1137 | | Attribute | Value |
1138 | | :--- | :--- |
1139 | | **updated** | `Fixed visual overlap by switching to Vertical Layout. Increased Card Size. */` |
1140 | 
1141 | **Components & Logic:**
1142 | 
1143 | * **`DomainPicker`**
1144 |   * **Logic Flow:**
1145 |     * `‚ö° RENDERER: Capability Popover Content`
1146 |     * `Governance Check`
1147 |     * `Visual States`
1148 | 
1149 | ---
1150 | ## üìÇ `frontend/src/domains/meta/features/dictionary/components/editor/`
1151 | 
1152 | ### üìÑ `ConfigPanels.tsx`
1153 | > Fractal sub-component for handling Type-Specific settings. CRASH PROOFED.
1154 | 
1155 | **Components & Logic:**
1156 | 
1157 | * **`ConfigPanels`**
1158 |   * **Logic Flow:**
1159 |     * `‚ö° CRASH GUARD: Ensure we have an object to read from [cite: 1090]`
1160 |     * `--- 1. NUMBER CONFIGURATION ---`
1161 |     * `--- 2. TEXT CONFIGURATION ---`
1162 |     * `--- 3. SELECTION CONFIGURATION ---`
1163 |     * `--- 4. DATE / DATETIME ---`
1164 |     * `--- 5. REFERENCE (COMPLEX) ---`
1165 |     * `--- 6. FILE ---`
1166 | 
1167 | ---
1168 | ### üìÑ `PreviewPanel.tsx`
1169 | > FILEPATH: frontend/src/domains/meta/features/dictionary/components/editor/PreviewPanel.tsx */
1170 | 
1171 | **Components & Logic:**
1172 | 
1173 | * **`PreviewPanel`**
1174 |   * **Logic Flow:**
1175 |     * `--- TEXT WIDGETS ---`
1176 |     * `--- NUMBER WIDGETS ---`
1177 |     * `--- SELECTION WIDGETS ---`
1178 |     * `--- DATE WIDGETS ---`
1179 |     * `--- BOOLEAN WIDGETS ---`
1180 |     * `--- FILE WIDGETS ---`
1181 |     * `--- COMPLEX WIDGETS ---`
1182 |     * `Fallback`
1183 | 
1184 | ---
1185 | ## üìÇ `frontend/src/domains/meta/features/dictionary/hooks/`
1186 | 
1187 | ### üìÑ `useDictionary.ts`
1188 | > FILEPATH: frontend/src/domains/meta/features/dictionary/hooks/useDictionary.ts */
1189 | 
1190 | **Components & Logic:**
1191 | 
1192 | * **`useDictionary`**
1193 |   * **Logic Flow:**
1194 |     * `1. FETCH ATTRIBUTES`
1195 |     * `‚ö° GATEWAY: Use standardized base`
1196 |     * `2. SAVE (CREATE / UPDATE)`
1197 |     * `Update Existing`
1198 |     * `Create New`
1199 |     * `3. DELETE`
1200 |     * `Data`
1201 |     * `Actions`
1202 |     * `State`
1203 | 
1204 | ---
1205 | ## üìÇ `frontend/src/domains/meta/features/dictionary/logic/`
1206 | 
1207 | ### üìÑ `schemaNormalizer.ts`
1208 | > FILEPATH: frontend/src/domains/meta/features/dictionary/logic/schemaNormalizer.ts */
1209 | 
1210 | **Components & Logic:**
1211 | 
1212 | * **`normalizeSchema`**
1213 |   * **Logic Flow:**
1214 |     * `Scenario A: It's already an Array`
1215 |     * `Scenario B: It's a Hybrid Schema Object`
1216 |     * `Check possible containers`
1217 | 
1218 | ---
1219 | ## üìÇ `frontend/src/domains/meta/features/dictionary/types/`
1220 | 
1221 | ### üìÑ `constants.ts`
1222 | > FILEPATH: frontend/src/domains/meta/features/dictionary/types/constants.ts */
1223 | 
1224 | **Components & Logic:**
1225 | 
1226 | * **`AttributeType`**
1227 |   * üìù *Values that EXIST at runtime (Enums, Objects).*
1228 | * **`WidgetType`**
1229 |   * **Logic Flow:**
1230 |     * `Text`
1231 |     * `Numeric`
1232 |     * `Choice`
1233 |     * `Boolean`
1234 |     * `Date`
1235 |     * `Advanced`
1236 |     * `üõ°Ô∏è THE MATRIX: Defines valid Widgets for each Data Type`
1237 | * **`WIDGET_COMPATIBILITY`**
1238 |   * üìù *üõ°Ô∏è THE MATRIX: Defines valid Widgets for each Data Type*
1239 |   * **Logic Flow:**
1240 |     * `üìò THE KNOWLEDGE BASE: User-friendly descriptions`
1241 | * **`HELP_TEXT`**
1242 |   * üìù *üìò THE KNOWLEDGE BASE: User-friendly descriptions*
1243 | * **`DEFAULT_DRAFT_CONFIG`**
1244 | 
1245 | ---
1246 | ### üìÑ `index.ts`
1247 | > FILEPATH: frontend/src/domains/meta/features/dictionary/types/index.ts */
1248 | 
1249 | **Components & Logic:**
1250 | 
1251 | * **`DEFAULT_DRAFT`**
1252 |   * üìù *3. Default Constant*
1253 | 
1254 | ---
1255 | ### üìÑ `types.ts`
1256 | > FILEPATH: frontend/src/domains/meta/features/dictionary/types/types.ts */
1257 | 
1258 | **Components & Logic:**
1259 | 
1260 | * **`SelectOption`**
1261 | * **`AttributeConfig`**
1262 |   * **Logic Flow:**
1263 |     * `Text`
1264 |     * `Number`
1265 |     * `Date`
1266 |     * `Options`
1267 |     * `Reference`
1268 |     * `File`
1269 |     * `JSON`
1270 |     * `General`
1271 | * **`AttributeDefinition`**
1272 | * **`AttributeDraft`**
1273 | 
1274 | ---
1275 | ## üìÇ `frontend/src/domains/meta/features/governance/`
1276 | 
1277 | ### üìÑ `GovernanceView.tsx`
1278 | > The Master Controller for the Rule Engine.
1279 | 
1280 | **Components & Logic:**
1281 | 
1282 | * **`GovernanceView`**
1283 |   * **Logic Flow:**
1284 |     * `1. GLOBAL CONTEXT (The Session)`
1285 |     * `‚ö° GLOBAL STATE: Deep Linking`
1286 |     * `Local UI State (Transient)`
1287 |     * `2. LOGIC (Only runs if domain is selected)`
1288 |     * `3. HANDLERS`
1289 |     * `4. COMPUTED`
1290 |     * `--- RENDER: STATE A (LOBBY) ---`
1291 |     * `--- RENDER: STATE B (EDITOR) ---`
1292 | 
1293 | ---
1294 | ## üìÇ `frontend/src/domains/meta/features/governance/components/`
1295 | 
1296 | ### üìÑ `JmesPathHelp.tsx`
1297 | > FILEPATH: frontend/src/domains/meta/features/governance/components/JmesPathHelp.tsx */
1298 | 
1299 | **Components & Logic:**
1300 | 
1301 | * **`JmesPathHelp`**
1302 |   * **Logic Flow:**
1303 |     * `--- CONTENT DATA ---`
1304 |     * `--- RENDERERS ---`
1305 | 
1306 | ---
1307 | ### üìÑ `PolicyEditor.tsx`
1308 | > Advanced Policy Editor with Multi-Vector Consequence Stacks.
1309 | 
1310 | | Attribute | Value |
1311 | | :--- | :--- |
1312 | | **security-level** | `LEVEL 9 (UI Validation) */` |
1313 | 
1314 | **Components & Logic:**
1315 | 
1316 | * **`PolicyEditor`**
1317 |   * **Logic Flow:**
1318 |     * `‚ö° HYDRATED DATA SOURCE`
1319 |     * `--- HANDLERS ---`
1320 |     * `‚ö° AUTO-KEY GENERATION`
1321 |     * `Only auto-generate key if it's a NEW policy (no ID) to avoid breaking existing bindings`
1322 |     * `‚ö° MULTI-CONSEQUENCE MANAGEMENT`
1323 |     * `--- RENDER HELPERS ---`
1324 | 
1325 | ---
1326 | ### üìÑ `PolicyExplorer.tsx`
1327 | > FILEPATH: frontend/src/domains/meta/features/governance/components/PolicyExplorer.tsx */
1328 | 
1329 | **Components & Logic:**
1330 | 
1331 | * **`PolicyExplorer`**
1332 |   * **Logic Flow:**
1333 |     * `Helper to format v1.05`
1334 |     * `Default to v1.00 if missing (legacy data)`
1335 |     * `‚ö° SHOW VERSION`
1336 | 
1337 | ---
1338 | ## üìÇ `frontend/src/domains/meta/features/governance/components/editor/`
1339 | 
1340 | ### üìÑ `EnforcementPanel.tsx`
1341 | > FILEPATH: frontend/src/domains/meta/features/governance/components/editor/EnforcementPanel.tsx */
1342 | 
1343 | **Components & Logic:**
1344 | 
1345 | * **`EnforcementPanel`**
1346 |   * **Logic Flow:**
1347 |     * `Filter bindings for *this* policy`
1348 |     * `State for New Binding`
1349 | 
1350 | ---
1351 | ### üìÑ `HistoryDrawer.tsx`
1352 | > FILEPATH: frontend/src/domains/meta/features/governance/components/editor/HistoryDrawer.tsx */
1353 | 
1354 | **Components & Logic:**
1355 | 
1356 | * **`HistoryDrawer`**
1357 |   * **Logic Flow:**
1358 |     * `‚ö° GATEWAY: Use standardized base`
1359 |     * `‚ö° FIX: Use the Hook-based Modal, not the Static one`
1360 | 
1361 | ---
1362 | ### üìÑ `LogicBuilder.tsx`
1363 | > Recursive Subject-Verb-Object Composer for Governance Rules.
1364 | 
1365 | **Components & Logic:**
1366 | 
1367 | * **`LogicBuilder`**
1368 |   * **Logic Flow:**
1369 |     * `1. STATE`
1370 |     * `2. PARSER (Simulated for this iteration - usually requires AST)`
1371 |     * `We default to Code Mode if we detect complex logic we can't parse yet.`
1372 |     * `Simple heuristic: If it looks like a flat tree, try to load it.`
1373 |     * `For Level 100 SVO, we assume new rules start empty or simple.`
1374 |     * `If complex, we stay in code mode.`
1375 |     * `3. COMPILER (Tree -> JMESPath)`
1376 |     * `RULE`
1377 |     * `4. HANDLERS`
1378 |     * `Find parent and push child`
1379 |     * `--- RENDERERS ---`
1380 |     * `RULE (Leaf)`
1381 | 
1382 | ---
1383 | ### üìÑ `TestPanel.tsx`
1384 | > FILEPATH: frontend/src/domains/meta/features/governance/components/editor/TestPanel.tsx */
1385 | 
1386 | **Components & Logic:**
1387 | 
1388 | * **`TestPanel`**
1389 |   * **Logic Flow:**
1390 |     * `Default mock data based on standard "host" envelope`
1391 | 
1392 | ---
1393 | ## üìÇ `frontend/src/domains/meta/features/governance/components/editor/logic/`
1394 | 
1395 | ### üìÑ `SubjectPicker.tsx`
1396 | > Smart Context Selector with Lazy Loading, Module Grouping, and State Hydration.
1397 | 
1398 | | Attribute | Value |
1399 | | :--- | :--- |
1400 | | **security-level** | `LEVEL 9 (Data Access) */` |
1401 | 
1402 | **Components & Logic:**
1403 | 
1404 | * **`SubjectPicker`**
1405 |   * **Logic Flow:**
1406 |     * `‚ö° STATE HYDRATION: Restore tab and domain from existing value`
1407 |     * `Check known roots`
1408 |     * `Assume Global Domain (e.g., "user.email" -> Domain "USER")`
1409 |     * `Ensure it's not one of our reserved keywords`
1410 |     * `‚ö° LAZY LOAD: Global Domain List`
1411 |     * `‚ö° DATA TRANSFORM: Group Domains by Module`
1412 |     * `‚ö° LAZY LOAD: Specific Domain Schema`
1413 |     * `--- RENDERERS ---`
1414 | 
1415 | ---
1416 | ## üìÇ `frontend/src/domains/meta/features/governance/hooks/`
1417 | 
1418 | ### üìÑ `useGovernance.ts`
1419 | > Manages Policy State and Fuses Domain Schema with System Context.
1420 | 
1421 | | Attribute | Value |
1422 | | :--- | :--- |
1423 | | **security-level** | `LEVEL 9 (Schema Fusion) */` |
1424 | | **updated** | `Aligned API calls with generated OpenAPI SDK. Preserved Delete logic. */` |
1425 | 
1426 | **Components & Logic:**
1427 | 
1428 | * **`useGovernance`**
1429 |   * **Logic Flow:**
1430 |     * `1. FETCH POLICIES (The Law)`
1431 |     * `‚ö° FIX: Use generated SDK name`
1432 |     * `2. FETCH FUSED SCHEMA (The Vocabulary)`
1433 |     * `‚ö° LEVEL 100: Context Fusion`
1434 |     * `The API returns the "Fused" schema (Static + Dynamic + Context)`
1435 |     * `‚ö° FIX: Use generated SDK name`
1436 |     * `3. CREATE POLICY`
1437 |     * `‚ö° FIX: Use generated SDK name`
1438 |     * `4. UPDATE POLICY`
1439 |     * `‚ö° FIX: Use generated SDK name`
1440 |     * `5. DELETE POLICY (Restored)`
1441 |     * `‚ö° FIX: Use 'any' cast if SDK signature varies, but call correct delete endpoint`
1442 |     * `Assuming standard naming pattern from codegen`
1443 |     * `6. DRY RUN`
1444 |     * `‚ö° FIX: Use generated SDK name`
1445 |     * `Data`
1446 |     * `Actions`
1447 |     * `State`
1448 | 
1449 | ---
1450 | ### üìÑ `usePolicyBindings.ts`
1451 | > FILEPATH: frontend/src/domains/meta/features/governance/hooks/usePolicyBindings.ts */
1452 | 
1453 | **Components & Logic:**
1454 | 
1455 | * **`PolicyBinding`**
1456 | * **`PolicyBindingDraft`**
1457 | * **`usePolicyBindings`**
1458 |   * **Logic Flow:**
1459 |     * `1. FETCH BINDINGS`
1460 |     * `2. CREATE BINDING`
1461 |     * `3. TOGGLE/UPDATE BINDING`
1462 |     * `4. DELETE BINDING`
1463 | 
1464 | ---
1465 | ## üìÇ `frontend/src/domains/meta/features/governance/types/`
1466 | 
1467 | ### üìÑ `index.ts`
1468 | > Contracts for Policy Management and Logic Building.
1469 | 
1470 | | Attribute | Value |
1471 | | :--- | :--- |
1472 | | **security-level** | `LEVEL 9 (Type Safety) */` |
1473 | 
1474 | **Components & Logic:**
1475 | 
1476 | * **`Consequence`**
1477 |   * üìù *--- CONSEQUENCES (The Verdicts) ---*
1478 |   * **Logic Flow:**
1479 |     * `--- RULES ---`
1480 | * **`Rule`**
1481 |   * üìù *--- RULES ---*
1482 |   * **Logic Flow:**
1483 |     * `‚ö° ENTERPRISE UPGRADE: Multi-Vector Consequences`
1484 |     * `Metadata`
1485 |     * `--- POLICIES ---`
1486 | * **`Policy`**
1487 |   * üìù *--- POLICIES ---*
1488 |   * **Logic Flow:**
1489 |     * `Ledger Metadata`
1490 | * **`PolicyDraft`**
1491 | * **`DEFAULT_POLICY_DRAFT`**
1492 |   * **Logic Flow:**
1493 |     * `--- SCHEMA REFLECTION (For Dropdowns) ---`
1494 | * **`SelectOption`**
1495 |   * üìù *--- SCHEMA REFLECTION (For Dropdowns) ---*
1496 | * **`SchemaField`**
1497 |   * **Logic Flow:**
1498 |     * `‚ö° GROUPING: For the Omni-Picker`
1499 |     * `--- SIMULATION ---`
1500 | * **`DryRunRequest`**
1501 |   * üìù *--- SIMULATION ---*
1502 | * **`DryRunResult`**
1503 | 
1504 | ---
1505 | ## üìÇ `frontend/src/domains/meta/features/policy_groups/`
1506 | 
1507 | ### üìÑ `PolicyGroupsView.tsx`
1508 | > Main view for managing Policy Bundles (Groups).
1509 | 
1510 | **Components & Logic:**
1511 | 
1512 | * **`PolicyGroupsView`**
1513 |   * **Logic Flow:**
1514 |     * `1. GLOBAL CONTEXT (Editor State via ?select=...)`
1515 |     * `2. UNIVERSAL URL STATE (View State)`
1516 |     * `3. Data`
1517 |     * `4. Computed (Filter)`
1518 |     * `--- COMPUTED EDITOR STATE ---`
1519 |     * `--- ACTIONS ---`
1520 |     * `--- TABLE COLUMNS ---`
1521 | 
1522 | ---
1523 | ## üìÇ `frontend/src/domains/meta/features/policy_groups/components/`
1524 | 
1525 | ### üìÑ `GroupEditor.tsx`
1526 | > FILEPATH: frontend/src/domains/meta/features/policy_groups/components/GroupEditor.tsx */
1527 | 
1528 | **Components & Logic:**
1529 | 
1530 | * **`GroupEditor`**
1531 |   * **Logic Flow:**
1532 |     * `‚ö° AUTO-CAPS HANDLER`
1533 |     * `Validation failed`
1534 | 
1535 | ---
1536 | ## üìÇ `frontend/src/domains/meta/features/policy_groups/hooks/`
1537 | 
1538 | ### üìÑ `usePolicyGroups.ts`
1539 | > FILEPATH: frontend/src/domains/meta/features/policy_groups/hooks/usePolicyGroups.ts */
1540 | 
1541 | **Components & Logic:**
1542 | 
1543 | * **`usePolicyGroups`**
1544 |   * **Logic Flow:**
1545 |     * `1. FETCH GROUPS`
1546 |     * `2. CREATE GROUP`
1547 |     * `3. UPDATE GROUP`
1548 |     * `4. DELETE GROUP`
1549 | 
1550 | ---
1551 | ## üìÇ `frontend/src/domains/meta/features/policy_groups/`
1552 | 
1553 | ### üìÑ `types.ts`
1554 | > FILEPATH: frontend/src/domains/meta/features/policy_groups/types.ts */
1555 | 
1556 | **Components & Logic:**
1557 | 
1558 | * **`PolicyGroup`**
1559 |   * üìù *TypeScript interfaces for Policy Bundles.*
1560 |   * **Logic Flow:**
1561 |     * `The ordered list of policy keys to execute`
1562 | * **`GroupDraft`**
1563 | * **`DEFAULT_GROUP_DRAFT`**
1564 | 
1565 | ---
1566 | ## üìÇ `frontend/src/domains/meta/features/runner/`
1567 | 
1568 | ### üìÑ `RunnerView.tsx`
1569 | > The "Launchpad" for Business Processes.
1570 | 
1571 | **Components & Logic:**
1572 | 
1573 | * **`RunnerView`**
1574 |   * **Logic Flow:**
1575 |     * `1. UNIVERSAL URL STATE (Search Persistence)`
1576 |     * `2. DISCOVERY ENGINE`
1577 |     * `Flatten the Domain->Scope hierarchy into a list of "Apps"`
1578 |     * `‚ö° FILTER: Only show Wizards (Interactive Processes)`
1579 |     * `3. ROUTING LOGIC`
1580 |     * `4. RENDER: RUNTIME HOST (The Overlay)`
1581 |     * `5. RENDER: DASHBOARD (The Grid)`
1582 | 
1583 | ---
1584 | ### üìÑ `RuntimeHost.tsx`
1585 | > The "Focus Mode" container for running a Wizard.
1586 | 
1587 | **Components & Logic:**
1588 | 
1589 | * **`RuntimeHost`**
1590 |   * **Logic Flow:**
1591 |     * `1. RESOLVE CONTEXT (Metadata)`
1592 | 
1593 | ---
1594 | ## üìÇ `frontend/src/domains/meta/features/states/`
1595 | 
1596 | ### üìÑ `StatesView.tsx`
1597 | > The Orchestrator for State Machines. Uses Tree Topology for Navigation.
1598 | 
1599 | | Attribute | Value |
1600 | | :--- | :--- |
1601 | | **security-level** | `LEVEL 9 (UI Safe) */` |
1602 | 
1603 | **Components & Logic:**
1604 | 
1605 | * **`StatesView`**
1606 |   * **Logic Flow:**
1607 |     * `1. GLOBAL CONTEXT (Deep Linking for Selection)`
1608 |     * `Resolve active state from context (Handle DEFAULT case)`
1609 |     * `2. UNIVERSAL URL STATE (Persistence)`
1610 |     * `Sync URL -> Context`
1611 |     * `‚ö° NODE SYNC: If URL has node, sync to context. If URL has NO node, clear context.`
1612 |     * `We use '' to represent no selection in the URL, effectively null`
1613 |     * `3. DATA LOADING`
1614 |     * `We only fetch workflows if a domain is selected`
1615 |     * `4. Local UI State (Transient)`
1616 |     * `Auto-open right panel if we have a deep link selection`
1617 |     * `Effect: Keep right panel sync with selection`
1618 |     * `If panel closed but item selected, deselect item (two-way bind)`
1619 |     * `Clean URL`
1620 |     * `5. Data Hooks`
1621 |     * `Find the definition for the selected scope`
1622 |     * `‚ö° HELPER: Resolve Workflow Type Logic`
1623 |     * `We need to know if this is a WIZARD, JOB, or GOVERNANCE flow to render the right tools.`
1624 |     * `A. Check Registry`
1625 |     * `B. Check Metadata`
1626 |     * `C. Fallback`
1627 |     * `‚ö° SMART TYPE RESOLUTION`
1628 |     * `Some keys might be "WIZARD" (Backend enum) vs "WIZARD_FLOW" (UI Constant)`
1629 |     * `We normalize here.`
1630 |     * `‚ö° FILTERED LIST`
1631 |     * `6. Session Manager`
1632 |     * `Manages the "Draft" state vs "Live" state`
1633 |     * `7. Navigation Guard`
1634 |     * `Close panels`
1635 |     * `If we have a domain but no scope selected,`
1636 |     * `AND we have workflows, maybe auto-select the first one?`
1637 |     * `No, better to show a list/gallery view.`
1638 |     * `Optional: Auto-select first?`
1639 |     * `handleSelectWorkflow(workflows[0].scope_key);`
1640 |     * `Sync Reset (If scope invalid for domain)`
1641 |     * `Only reset if we are sure it's loaded and truly missing`
1642 |     * `selectScope(''); // Commented out to prevent flash resets during load`
1643 |     * `Canvas Update`
1644 |     * `Sync URL for F5 safety`
1645 |     * `--- RENDER: STATE A (LOBBY) ---`
1646 |     * `‚ö° REFACTOR: Use DomainTree instead of Flat Picker`
1647 |     * `--- RENDER: STATE B (WORKFLOW GALLERY) ---`
1648 | 
1649 | ---
1650 | ## üìÇ `frontend/src/domains/meta/features/states/components/`
1651 | 
1652 | ### üìÑ `CodeEditorDrawer.tsx`
1653 | > FILEPATH: frontend/src/domains/meta/features/states/components/CodeEditorDrawer.tsx */
1654 | 
1655 | **Components & Logic:**
1656 | 
1657 | * **`CodeEditorDrawer`**
1658 |   * **Logic Flow:**
1659 |     * `Sync when opening or when definition changes externally`
1660 |     * `Basic Schema Check to prevent graph crashes`
1661 | 
1662 | ---
1663 | ### üìÑ `DomainPicker.tsx`
1664 | > FILEPATH: frontend/src/domains/meta/features/states/components/DomainPicker.tsx */
1665 | 
1666 | **Components & Logic:**
1667 | 
1668 | * **`DomainPicker`**
1669 |   * **Logic Flow:**
1670 |     * `‚ö° SAFETY: Ensure we have an array`
1671 |     * `Only block with spinner if we have NO data to show`
1672 |     * `Fix for AntD v5 style warning`
1673 | 
1674 | ---
1675 | ### üìÑ `EditorToolbar.tsx`
1676 | > The Control Deck for the Workflow Editor.
1677 | 
1678 | | Attribute | Value |
1679 | | :--- | :--- |
1680 | | **security-level** | `LEVEL 9 (UI Safe Guards)` |
1681 | | **invariant** | `Delete button only visible in VIEW mode.` |
1682 | | **fix** | `Changed Edit icon to 'EditOutlined'. Added z-index.` |
1683 | 
1684 | **Components & Logic:**
1685 | 
1686 | * **`EditorToolbar`**
1687 | 
1688 | ---
1689 | ### üìÑ `EventRegistryModal.tsx`
1690 | > FILEPATH: frontend/src/domains/meta/features/states/components/EventRegistryModal.tsx */
1691 | 
1692 | **Components & Logic:**
1693 | 
1694 | * **`EventRegistryModal`**
1695 |   * **Logic Flow:**
1696 |     * `‚ö° MOCK DEFAULT EVENTS (In production, fetch from CapabilitiesContext)`
1697 |     * `Merge system defaults with any custom ones passed in`
1698 |     * `Deduplicate by key`
1699 |     * `Simple creation logic for now - just returns the uppercase search text`
1700 |     * `Hover effect handled via CSS or inline mouse events if needed`
1701 | 
1702 | ---
1703 | ### üìÑ `FlowCanvas.tsx`
1704 | > Provides the ReactFlow surface.
1705 | 
1706 | | Attribute | Value |
1707 | | :--- | :--- |
1708 | | **security-level** | `LEVEL 9 (UI Invariant)` |
1709 | | **invariant** | `NodeTypes must be Memoized. Wrapper must be 100% Width/Height.` |
1710 | | **narrator** | `Logs layout recalculations.` |
1711 | 
1712 | **Components & Logic:**
1713 | 
1714 | * **`FlowCanvas`**
1715 |   * **Logic Flow:**
1716 |     * `‚ö° CRITICAL FIX: Provider wraps everything`
1717 | 
1718 | ---
1719 | ### üìÑ `InspectorPanel.tsx`
1720 | > The Right-Hand Panel that decides WHICH tools to show.
1721 | 
1722 | **Components & Logic:**
1723 | 
1724 | * **`InspectorPanel`**
1725 |   * üìù *The Inspector Panel handles the contextual editing of Nodes, Edges, and Workflow Properties.*
1726 |   * **Logic Flow:**
1727 |     * `‚ö° PERSISTENT TAB STATE`
1728 |     * `"config" or "json"`
1729 |     * `‚ö° FETCH REAL DB CONTEXT`
1730 |     * `‚ö° FETCH WIDGET REGISTRY (Safe Access)`
1731 |     * `‚ö° FIX: Use 'allWidgets' directly. The hook returns an array, not a Map 'registry'.`
1732 |     * `Resolve Node Data`
1733 |     * `‚ö° POLYMORPHIC RESOLUTION`
1734 |     * `Deep update the node data`
1735 |     * `Update parent`
1736 |     * `‚ö° APPEND FIELDS (Don't Overwrite)`
1737 |     * `Persist Update`
1738 |     * `Deep update parent structure to ensure React Flow sees the change`
1739 |     * `For Generic/Governance, maybe append to description?`
1740 |     * `Implementation for future expansion`
1741 | 
1742 | ---
1743 | ### üìÑ `NodeCard.tsx`
1744 | > FILEPATH: frontend/src/domains/meta/features/states/components/NodeCard.tsx */
1745 | 
1746 | **Components & Logic:**
1747 | 
1748 | * **`NodeCard`**
1749 |   * **Logic Flow:**
1750 |     * `‚ö° START NODE STYLING`
1751 |     * `üé® Dynamic Styling based on Selection`
1752 | 
1753 | ---
1754 | ### üìÑ `OSExplorerModal.tsx`
1755 | > FILEPATH: frontend/src/domains/meta/features/states/components/OSExplorerModal.tsx */
1756 | 
1757 | **Components & Logic:**
1758 | 
1759 | * **`OSExplorerModal`**
1760 |   * **Logic Flow:**
1761 |     * `Safe access`
1762 |     * `‚ö° DATA TRANSFORMATION: Registry -> AntD Tree Data`
1763 |     * `Mock fields for visual feedback`
1764 |     * `‚ö° FILTER LOGIC`
1765 | 
1766 | ---
1767 | ### üìÑ `WorkflowGenesis.tsx`
1768 | > FILEPATH: frontend/src/domains/meta/features/states/components/WorkflowGenesis.tsx */
1769 | 
1770 | **Components & Logic:**
1771 | 
1772 | * **`WorkflowGenesis`**
1773 |   * **Logic Flow:**
1774 |     * `Default: Governance`
1775 |     * `‚ö° FIX: Removed aggressive maxHeight/overflow on body.`
1776 |     * `AntD handles this natively better.`
1777 |     * `‚ö° CONSTANT DRIVEN OPTIONS`
1778 | 
1779 | ---
1780 | ## üìÇ `frontend/src/domains/meta/features/states/components/canvas/`
1781 | 
1782 | ### üìÑ `CanvasPalette.tsx`
1783 | > FILEPATH: frontend/src/domains/meta/features/states/components/canvas/CanvasPalette.tsx */
1784 | 
1785 | **Components & Logic:**
1786 | 
1787 | * **`CanvasPalette`**
1788 | 
1789 | ---
1790 | ### üìÑ `FloatingToolbar.tsx`
1791 | > FILEPATH: frontend/src/domains/meta/features/states/components/canvas/FloatingToolbar.tsx */
1792 | 
1793 | **Components & Logic:**
1794 | 
1795 | * **`FloatingToolbar`**
1796 | 
1797 | ---
1798 | ## üìÇ `frontend/src/domains/meta/features/states/components/canvas/nodes/`
1799 | 
1800 | ### üìÑ `ScreenNode.tsx`
1801 | > FILEPATH: frontend/src/domains/meta/features/states/components/canvas/nodes/ScreenNode.tsx */
1802 | 
1803 | **Components & Logic:**
1804 | 
1805 | * **`ScreenNode`**
1806 |   * **Logic Flow:**
1807 |     * `Extract Metadata`
1808 | 
1809 | ---
1810 | ### üìÑ `StandardNode.tsx`
1811 | > FILEPATH: frontend/src/domains/meta/features/states/components/canvas/nodes/StandardNode.tsx */
1812 | 
1813 | **Components & Logic:**
1814 | 
1815 | * **`StandardNode`**
1816 | 
1817 | ---
1818 | ### üìÑ `TaskNode.tsx`
1819 | > FILEPATH: frontend/src/domains/meta/features/states/components/canvas/nodes/TaskNode.tsx */
1820 | 
1821 | **Components & Logic:**
1822 | 
1823 | * **`TaskNode`**
1824 |   * **Logic Flow:**
1825 |     * `Extract Metadata`
1826 | 
1827 | ---
1828 | ## üìÇ `frontend/src/domains/meta/features/states/components/inspector/`
1829 | 
1830 | ### üìÑ `InspectorShell.tsx`
1831 | > The outer frame of the Inspector Panel. Provides the Header, Close Action, and AI Trigger.
1832 | 
1833 | | Attribute | Value |
1834 | | :--- | :--- |
1835 | | **security-level** | `LEVEL 9 (UI Safe) */` |
1836 | | **invariant** | `Must always provide a Close button. AI button is optional. */` |
1837 | 
1838 | **Components & Logic:**
1839 | 
1840 | * **`InspectorShell`**
1841 |   * üìù *Standardized container for all Inspector panels.*
1842 |   * **Logic Flow:**
1843 |     * `üîç DEBUG TRACE`
1844 |     * `--- RENDERERS ---`
1845 | 
1846 | ---
1847 | ### üìÑ `JobNode.tsx`
1848 | > FILEPATH: frontend/src/domains/meta/features/states/components/inspector/JobNode.tsx */
1849 | 
1850 | **Components & Logic:**
1851 | 
1852 | * **`JobNode`**
1853 | 
1854 | ---
1855 | ### üìÑ `NodeInspector.tsx`
1856 | > Determines which specific Inspector to render based on the passed Workflow Type.
1857 | 
1858 | | Attribute | Value |
1859 | | :--- | :--- |
1860 | | **security-level** | `LEVEL 9 (Data Integrity) */` |
1861 | | **invariant** | `Must handle null data gracefully. */` |
1862 | 
1863 | **Components & Logic:**
1864 | 
1865 | * **`NodeInspector`**
1866 |   * üìù *The Brain of the Inspector. Routes to the correct editor.*
1867 |   * **Logic Flow:**
1868 |     * `üîä LOUD NARRATOR: Inspect Selection Context`
1869 |     * `‚ö° ROUTER LOGIC: Trust the Panel's decision (workflowType)`
1870 |     * `1. WIZARD SCOPE (Form Builder 2.0)`
1871 |     * `2. JOB SCOPE (DevOps Config)`
1872 |     * `3. DEFAULT / GOVERNANCE (Standard Config)`
1873 | 
1874 | ---
1875 | ### üìÑ `StandardNode.tsx`
1876 | > FILEPATH: frontend/src/domains/meta/features/states/components/inspector/StandardNode.tsx */
1877 | 
1878 | **Components & Logic:**
1879 | 
1880 | * **`StandardNode`**
1881 |   * **Logic Flow:**
1882 |     * `Convert AntD Color object to Hex string`
1883 | 
1884 | ---
1885 | ### üìÑ `TransitionEdge.tsx`
1886 | > FILEPATH: frontend/src/domains/meta/features/states/components/inspector/TransitionEdge.tsx */
1887 | 
1888 | **Components & Logic:**
1889 | 
1890 | * **`TransitionEdge`**
1891 | 
1892 | ---
1893 | ### üìÑ `WizardNode.tsx`
1894 | > Specialized editor for UI Workflows with Space-Optimized Field Cards.
1895 | 
1896 | | Attribute | Value |
1897 | | :--- | :--- |
1898 | | **security-level** | `LEVEL 9 (UI Safe) */` |
1899 | | **invariant** | `Must write to 'meta' key to persist in XState. */` |
1900 | 
1901 | **Components & Logic:**
1902 | 
1903 | * **`WizardNode`**
1904 |   * **Logic Flow:**
1905 |     * `‚ö° DEEP EXTRACTION (Backend XState Structure)`
1906 |     * `‚ö° REACTIVE HYDRATION`
1907 |     * `‚ö° FIELD HANDLERS`
1908 | 
1909 | ---
1910 | ## üìÇ `frontend/src/domains/meta/features/states/components/inspector/governance/`
1911 | 
1912 | ### üìÑ `GovernanceEngine.tsx`
1913 | > FILEPATH: frontend/src/domains/meta/features/states/components/inspector/governance/GovernanceEngine.tsx */
1914 | 
1915 | **Components & Logic:**
1916 | 
1917 | * **`GovernanceEngine`**
1918 | 
1919 | ---
1920 | ## üìÇ `frontend/src/domains/meta/features/states/components/inspector/jobs/`
1921 | 
1922 | ### üìÑ `JobConfigurator.tsx`
1923 | > FILEPATH: frontend/src/domains/meta/features/states/components/inspector/jobs/JobConfigurator.tsx */
1924 | 
1925 | **Components & Logic:**
1926 | 
1927 | * **`JobConfigurator`**
1928 |   * **Logic Flow:**
1929 |     * `Extract config safely`
1930 |     * `‚ö° INPUT MAPPING HANDLERS`
1931 |     * `If renaming key`
1932 |     * `Just updating value`
1933 | 
1934 | ---
1935 | ## üìÇ `frontend/src/domains/meta/features/states/components/inspector/wizard/`
1936 | 
1937 | ### üìÑ `AIComposer.tsx`
1938 | > Orchestrates the Context Browser and Prompt Interface with Isolated Theme Support.
1939 | 
1940 | | Attribute | Value |
1941 | | :--- | :--- |
1942 | | **security-level** | `LEVEL 9 (UI Safe) */` |
1943 | | **invariant** | `State must be lifted here to persist across tabs. */` |
1944 | | **updated** | `Connected 'selectedDomains' to Assembler for Multi-Domain Sync. */` |
1945 | 
1946 | **Components & Logic:**
1947 | 
1948 | * **`AIComposer`**
1949 |   * üìù *The centralized orchestrator for AI-assisted form generation.*
1950 |   * **Logic Flow:**
1951 |     * `Optional Injections`
1952 |     * `--- 1. UI STATE ---`
1953 |     * `--- 2. SELECTION STATE & DYNAMIC DOMAIN ---`
1954 |     * `‚ö° DYNAMIC PIVOT: Active Domain determines what the LEFT PANEL shows`
1955 |     * `--- 3. DATA RESOLUTION (For Left Panel Display Only) ---`
1956 |     * `We still fetch the active schema to detect loading state for the UI`
1957 |     * `--- 4. LOGIC HOOK (The Omniscient Assembler) ---`
1958 |     * `‚ö° INJECTED DATA`
1959 |     * `domainFields & schemaDomain REMOVED -> Assembler fetches on its own`
1960 |     * `‚ö° SELECTION STATE`
1961 |     * `--- 5. HANDLERS ---`
1962 |     * `--- 6. RENDER ---`
1963 | 
1964 | ---
1965 | ### üìÑ `FieldConfigDrawer.tsx`
1966 | > FILEPATH: frontend/src/domains/meta/features/states/components/inspector/wizard/FieldConfigDrawer.tsx */
1967 | 
1968 | **Components & Logic:**
1969 | 
1970 | * **`FieldConfigDrawer`**
1971 |   * **Logic Flow:**
1972 |     * `Reset form when opening`
1973 |     * `Determine initial mode based on key naming convention`
1974 |     * `Clean up internal flags`
1975 |     * `‚ö° LOGIC: Map DB Types to UI Components`
1976 |     * `Disable required if system field implies logic, but let user override`
1977 | 
1978 | ---
1979 | ### üìÑ `WizardInspector.tsx`
1980 | > FILEPATH: frontend/src/domains/meta/features/states/components/inspector/wizard/WizardInspector.tsx */
1981 | 
1982 | **Components & Logic:**
1983 | 
1984 | * **`WizardInspector`**
1985 |   * **Logic Flow:**
1986 |     * `Manage Detail View locally`
1987 |     * `‚ö° AI HANDLER: Appends generated fields`
1988 |     * `Merge strategy: Append to end`
1989 | 
1990 | ---
1991 | ## üìÇ `frontend/src/domains/meta/features/states/components/inspector/wizard/components/ContextBrowser/`
1992 | 
1993 | ### üìÑ `ComponentGallery.tsx`
1994 | > Visual grid for selecting UI Primitives to make available to the AI.
1995 | 
1996 | | Attribute | Value |
1997 | | :--- | :--- |
1998 | | **security-level** | `LEVEL 9 (Read-Only) */` |
1999 | | **invariant** | `Must handle empty widget lists gracefully. */` |
2000 | | **updated** | `Fixed Data Binding (label -> name) and aligned Theme Tokens. */` |
2001 | 
2002 | **Components & Logic:**
2003 | 
2004 | * **`ComponentGallery`**
2005 |   * üìù *Renders a filterable grid of UI components.*
2006 |   * **Logic Flow:**
2007 |     * `‚ö° COMPUTE CATEGORIES`
2008 |     * `‚ö° FILTER LIST`
2009 |     * `‚ö° THEME FIX: Replaced hardcoded HEX with Tokens`
2010 |     * `‚ö° THEME FIX: Background adapts to Dark Mode`
2011 |     * `‚ö° THEME FIX: Color adapts`
2012 | 
2013 | ---
2014 | ### üìÑ `DataPicker.tsx`
2015 | > Allows selection of Data Domains to inject Schema Context.
2016 | 
2017 | | Attribute | Value |
2018 | | :--- | :--- |
2019 | | **security-level** | `LEVEL 9 (Read-Only) */` |
2020 | | **invariant** | `Must clearly indicate the 'Current' domain. */` |
2021 | | **updated** | `Tokenized colors for Dark Mode compatibility. */` |
2022 | 
2023 | **Components & Logic:**
2024 | 
2025 | * **`DataPicker`**
2026 |   * üìù *Renders a list of available Data Domains.*
2027 |   * **Logic Flow:**
2028 |     * `‚ö° THEME FIX: Use Tokens instead of Hardcoded Hex`
2029 | 
2030 | ---
2031 | ### üìÑ `GovernancePicker.tsx`
2032 | > Provides granular selection of Policy Groups and specific Domain Policies.
2033 | 
2034 | | Attribute | Value |
2035 | | :--- | :--- |
2036 | | **security-level** | `LEVEL 9 (Read-Only) */` |
2037 | | **invariant** | `Must distinguishing between 'GROUP:' and 'POLICY:' prefixes for the assembler. */` |
2038 | 
2039 | **Components & Logic:**
2040 | 
2041 | * **`GovernancePicker`**
2042 |   * üìù *Renders a dual-view picker for Governance constraints.*
2043 |   * **Logic Flow:**
2044 |     * `‚ö° FILTER LOGIC`
2045 |     * `‚ö° THEME MAPPING: Use semantic tokens instead of hardcoded hex`
2046 |     * `‚ö° THEME FIX: Dynamic Background`
2047 |     * `‚ö° THEME FIX: Dynamic Border`
2048 |     * `‚ö° THEME FIX: Input Background`
2049 | 
2050 | ---
2051 | ### üìÑ `WorkflowPicker.tsx`
2052 | > Allows the user to select existing Workflows to inject as reference context for the AI.
2053 | 
2054 | | Attribute | Value |
2055 | | :--- | :--- |
2056 | | **security-level** | `LEVEL 9 (Read-Only) */` |
2057 | | **invariant** | `Must filter displayed workflows by the current Domain context. */` |
2058 | | **narrator** | `Logs search interactions. */` |
2059 | | **updated** | `Replaced hardcoded HEX colors with System Theme Tokens. */` |
2060 | 
2061 | **Components & Logic:**
2062 | 
2063 | * **`WorkflowPicker`**
2064 |   * üìù *Renders a searchable list of workflows grouped by intent.*
2065 |   * **Logic Flow:**
2066 |     * `‚ö° FILTER & GROUP LOGIC`
2067 |     * `1. Text Filter`
2068 |     * `‚ö° THEME FIX: Swapped hardcoded background for Token`
2069 |     * `‚ö° THEME FIX: Swapped #f9f0ff for Token`
2070 |     * `‚ö° THEME FIX: Swapped #d3adf7 for Token`
2071 | 
2072 | ---
2073 | ### üìÑ `index.tsx`
2074 | > Tabbed interface for browsing and selecting AI Context sources.
2075 | 
2076 | | Attribute | Value |
2077 | | :--- | :--- |
2078 | | **security-level** | `LEVEL 9 (UI Safe) */` |
2079 | | **invariant** | `Must retain selection state across tab switches. */` |
2080 | 
2081 | **Components & Logic:**
2082 | 
2083 | * **`ContextBrowser`**
2084 |   * üìù *The main container for the Context Selection Interface.*
2085 |   * **Logic Flow:**
2086 |     * `‚ö° DYNAMIC STYLING (Semantic)`
2087 |     * `We rely on the parent ConfigProvider (Dark Algorithm) to set token values correctly.`
2088 | 
2089 | ---
2090 | ## üìÇ `frontend/src/domains/meta/features/states/components/inspector/wizard/components/`
2091 | 
2092 | ### üìÑ `PromptInterface.tsx`
2093 | > The text input and control deck for sending instructions to the Cortex.
2094 | 
2095 | | Attribute | Value |
2096 | | :--- | :--- |
2097 | | **security-level** | `LEVEL 9 (UI Safe) */` |
2098 | | **invariant** | `Handles DATABASE_SCHEMA rendering. */` |
2099 | | **updated** | `Added 'DATABASE_SCHEMA' case to fix 'Unknown' label. */` |
2100 | 
2101 | **Components & Logic:**
2102 | 
2103 | * **`PromptInterface`**
2104 | 
2105 | ---
2106 | ## üìÇ `frontend/src/domains/meta/features/states/components/inspector/wizard/hooks/`
2107 | 
2108 | ### üìÑ `useContextAssembler.ts`
2109 | > Marshals Data, Rules, Flows, and UI Components into a structured AI Payload.
2110 | 
2111 | | Attribute | Value |
2112 | | :--- | :--- |
2113 | | **security-level** | `LEVEL 9 (Sanitized Input) */` |
2114 | | **invariant** | `Sync is Manual & Omniscient. Fetches all selected domains on demand. */` |
2115 | 
2116 | **Components & Logic:**
2117 | 
2118 | * **`CommandMode`**
2119 |   * **Logic Flow:**
2120 |     * `domainFields: SchemaField[]; // ‚ùå REMOVED: Single source`
2121 |     * `schemaDomain?: string;       // ‚ùå REMOVED: Single source`
2122 | * **`useContextAssembler`**
2123 |   * **Logic Flow:**
2124 |     * `‚ö° STATE`
2125 |     * `‚ö° CHANGE DETECTION`
2126 |     * `‚ö° HELPER: Normalize API Response`
2127 |     * `‚ö° SYNC ENGINE (Omniscient)`
2128 |     * `üïê Artificial Delay for UX`
2129 |     * `0. System Instruction`
2130 |     * `A. Database Context (MULTI-DOMAIN FETCH)`
2131 |     * `‚ö° PARALLEL FETCH: Get all schemas at once`
2132 |     * `B. Governance`
2133 |     * `C. Workflows`
2134 |     * `D. UI Toolkit`
2135 |     * `E. Draft`
2136 |     * `‚ö° COMMIT`
2137 |     * `Update Signature`
2138 |     * `‚ö° FEEDBACK`
2139 | 
2140 | ---
2141 | ## üìÇ `frontend/src/domains/meta/features/states/components/inspector/wizards/`
2142 | 
2143 | ### üìÑ `WizardArchitect.tsx`
2144 | > FILEPATH: frontend/src/domains/meta/features/states/components/inspector/wizards/WizardArchitect.tsx */
2145 | 
2146 | **Components & Logic:**
2147 | 
2148 | * **`WizardArchitect`**
2149 |   * **Logic Flow:**
2150 |     * `1. Extract Schema safely`
2151 |     * `2. Actions`
2152 |     * `FieldConfigDrawer doesn't strictly need readOnly because we prevent opening it,`
2153 |     * `but if we wanted "View Details", we'd pass it here too.`
2154 | 
2155 | ---
2156 | ## üìÇ `frontend/src/domains/meta/features/states/`
2157 | 
2158 | ### üìÑ `constants.tsx`
2159 | > FILEPATH: frontend/src/domains/meta/features/states/constants.tsx */
2160 | 
2161 | **Components & Logic:**
2162 | 
2163 | * **`WorkflowTypeDef`**
2164 | * **`WORKFLOW_TYPES`**
2165 | * **`DEFAULT_WORKFLOW_ICON`**
2166 | * **`getWorkflowMeta`**
2167 | 
2168 | ---
2169 | ## üìÇ `frontend/src/domains/meta/features/states/hooks/`
2170 | 
2171 | ### üìÑ `useCanvasHistory.ts`
2172 | > FILEPATH: frontend/src/domains/meta/features/states/hooks/useCanvasHistory.ts */
2173 | 
2174 | **Components & Logic:**
2175 | 
2176 | * **`useCanvasHistory`**
2177 |   * **Logic Flow:**
2178 |     * `We don't store 'present' in state here to avoid duping ReactFlow's internal state.`
2179 |     * `Instead, we capture snapshots.`
2180 |     * `‚ö° SNAPSHOT ENGINE`
2181 |     * `Limit history depth to 50`
2182 |     * `Debounced version for drag events`
2183 |     * `‚ö° UNDO`
2184 |     * `‚ö° REDO`
2185 | 
2186 | ---
2187 | ### üìÑ `useDomainSchema.ts`
2188 | > Fetches and normalizes the Domain Schema from the Kernel.
2189 | 
2190 | | Attribute | Value |
2191 | | :--- | :--- |
2192 | | **security-level** | `LEVEL 9 (Type Safety) */` |
2193 | | **updated** | `Now returns full Context Identity to prevent Assembler Race Conditions. */` |
2194 | 
2195 | **Components & Logic:**
2196 | 
2197 | * **`useDomainSchema`**
2198 |   * **Logic Flow:**
2199 |     * `1. Fetch from Backend`
2200 |     * `Response Format: { domain: "USER", fields: { "email": { ... }, "role": { ... } } }`
2201 |     * `2. ‚ö° NORMALIZATION LOGIC`
2202 |     * `The backend returns { domain: "USER", fields: { key: def } }`
2203 |     * `We need to convert that Dictionary into a List [ def1, def2 ]`
2204 |     * `Scenario A: Standard V2 Dictionary`
2205 |     * `Scenario B: Legacy Array (Rare fallback)`
2206 |     * `Scenario C: Flat Object Fallback`
2207 |     * `‚ö° EXPOSE FULL CONTEXT`
2208 | 
2209 | ---
2210 | ### üìÑ `useDomains.ts`
2211 | > FILEPATH: frontend/src/domains/meta/features/states/hooks/useDomains.ts */
2212 | 
2213 | **Components & Logic:**
2214 | 
2215 | * **`useDomains`**
2216 |   * **Logic Flow:**
2217 |     * `Fetch generic domains via Kernel Service`
2218 |     * `Note: The API returns `any`, we cast to DomainSummary[] based on known shape`
2219 |     * `If response is wrapped in 'modules' (manifest style), extract it`
2220 | 
2221 | ---
2222 | ### üìÑ `useEditorSession.ts`
2223 | > Manages the 'VIEW' vs 'EDIT' state and the Draft copy.
2224 | 
2225 | | Attribute | Value |
2226 | | :--- | :--- |
2227 | | **security-level** | `LEVEL 9 (State Integrity)` |
2228 | | **invariant** | `Mode defaults to VIEW. Draft is cleared on Discard.` |
2229 | 
2230 | **Components & Logic:**
2231 | 
2232 | * **`useEditorSession`**
2233 |   * **Logic Flow:**
2234 |     * `‚ö° AUTO-RESET: When changing workflows, always revert to VIEW and clear draft.`
2235 |     * `Initialize draft with current definition if not exists`
2236 |     * `‚ö° FIX: Removed auto-setMode('EDIT').`
2237 |     * `We now require explicit entry via "Edit Workflow" button.`
2238 |     * `This prevents the Toolbar from flipping if the Canvas auto-layouts on load.`
2239 | 
2240 | ---
2241 | ### üìÑ `useFlowEditor.ts`
2242 | > FILEPATH: frontend/src/domains/meta/features/states/hooks/useFlowEditor.ts */
2243 | 
2244 | **Components & Logic:**
2245 | 
2246 | * **`useFlowEditor`**
2247 |   * **Logic Flow:**
2248 |     * `1. FETCH MACHINES`
2249 |     * `‚ö° GATEWAY: Use standardized base`
2250 |     * `2. SAVE (CREATE / UPDATE)`
2251 |     * `POST creates a new VERSION in the ledger strategy`
2252 | 
2253 | ---
2254 | ### üìÑ `useWorkflows.ts`
2255 | > React Query wrappers for the State Engine API.
2256 | 
2257 | | Attribute | Value |
2258 | | :--- | :--- |
2259 | | **security-level** | `LEVEL 9 (Type Safety)` |
2260 | | **invariant** | `Cache invalidation must occur on mutation success.` |
2261 | | **updated** | `Changed 'version' type from number to string (SemVer).` |
2262 | 
2263 | **Components & Logic:**
2264 | 
2265 | * **`WorkflowDefinition`**
2266 | * **`useWorkflows`**
2267 |   * **Logic Flow:**
2268 |     * `1. Fetch List`
2269 |     * `2. Create / Update`
2270 |     * `3. Delete`
2271 | 
2272 | ---
2273 | ## üìÇ `frontend/src/domains/meta/features/states/logic/`
2274 | 
2275 | ### üìÑ `xstateAdapter.ts`
2276 | > FILEPATH: frontend/src/domains/meta/features/states/logic/xstateAdapter.ts */
2277 | 
2278 | **Components & Logic:**
2279 | 
2280 | * **`toGraph`**
2281 |   * üìù *Converts backend JSON into Graph Nodes/Edges and back.*
2282 |   * **Logic Flow:**
2283 |     * `1. Build Nodes`
2284 |     * `Default layout if no positions saved (Simple grid fallback)`
2285 |     * `2. Build Edges (Transitions)`
2286 | * **`toXState`**
2287 |   * üìù *CONVERTER: Frontend Graph -> Backend JSON*
2288 |   * **Logic Flow:**
2289 |     * `1. Serialize Nodes (State + Metadata)`
2290 |     * `Persist Layout Positions`
2291 |     * `2. Serialize Edges (Transitions)`
2292 |     * `Safety check: ensure source/target nodes actually exist in the definition`
2293 |     * `XState simple syntax: "EVENT": "TARGET"`
2294 |     * `TODO: Expand this to object syntax if we add actions/guards later`
2295 | 
2296 | ---
2297 | ## üìÇ `frontend/src/domains/meta/features/states/types/`
2298 | 
2299 | ### üìÑ `index.ts`
2300 | > FILEPATH: frontend/src/domains/meta/features/states/types/index.ts */
2301 | 
2302 | **Components & Logic:**
2303 | 
2304 | * **`StateDefinition`**
2305 |   * üìù *--- BACKEND CONTRACT (XState JSON) ---*
2306 |   * **Logic Flow:**
2307 |     * `‚ö° NEW: The Composite Column Target`
2308 |     * `Default is 'status'. Can be 'approval_state', 'shipping_stage', etc.`
2309 |     * `Strict XState v5 Schema`
2310 | * **`XStateDefinition`**
2311 |   * üìù *Strict XState v5 Schema*
2312 | * **`XStateNode`**
2313 |   * **Logic Flow:**
2314 |     * `--- FRONTEND MODEL (ProFlow / ReactFlow) ---`
2315 | * **`FlowNodeData`**
2316 |   * üìù *--- FRONTEND MODEL (ProFlow / ReactFlow) ---*
2317 |   * **Logic Flow:**
2318 |     * `Metadata for the Inspector`
2319 | * **`FlowEdgeData`**
2320 | * **`StateMachineDraft`**
2321 |   * **Logic Flow:**
2322 |     * `‚ö° NEW: Must specify which column to control`
2323 | 
2324 | ---
2325 | ## üìÇ `frontend/src/domains/meta/features/switchboard/`
2326 | 
2327 | ### üìÑ `SwitchboardView.tsx`
2328 | > The Main Control Panel for Governance.
2329 | 
2330 | **Components & Logic:**
2331 | 
2332 | * **`SwitchboardView`**
2333 |   * **Logic Flow:**
2334 |     * `1. GLOBAL CONTEXT (Deep Link for Modal)`
2335 |     * `2. UNIVERSAL URL STATE (Search Persistence)`
2336 |     * `3. Data Hooks`
2337 |     * `Local loading state for individual row actions`
2338 |     * `--- MODAL STATE (Derived from Global) ---`
2339 |     * `--- GROUPING LOGIC ---`
2340 |     * `Sort: Active first, then by Priority`
2341 |     * `--- RENDER HELPERS ---`
2342 |     * `STEP 1: DEACTIVATE`
2343 |     * `STEP 2: REMOVE`
2344 | 
2345 | ---
2346 | ## üìÇ `frontend/src/domains/meta/features/switchboard/components/`
2347 | 
2348 | ### üìÑ `AssignmentModal.tsx`
2349 | > FILEPATH: frontend/src/domains/meta/features/switchboard/components/AssignmentModal.tsx */
2350 | 
2351 | **Components & Logic:**
2352 | 
2353 | * **`AssignmentModal`**
2354 |   * **Logic Flow:**
2355 |     * `UI State`
2356 |     * `‚ö° LOGIC: Send either ID or GroupID`
2357 | 
2358 | ---
2359 | ### üìÑ `GroupPolicyModal.tsx`
2360 | > FILEPATH: frontend/src/domains/meta/features/switchboard/components/GroupPolicyModal.tsx */
2361 | 
2362 | **Components & Logic:**
2363 | 
2364 | * **`GroupPolicyModal`**
2365 |   * **Logic Flow:**
2366 |     * `‚ö° MUTATION: Patch Policy`
2367 |     * `‚ö° GATEWAY: Use standardized base`
2368 |     * `‚ö° BULK OPERATION: Update each selected policy`
2369 |     * `We append the new tag to existing tags to avoid overwriting.`
2370 | 
2371 | ---
2372 | ## üìÇ `frontend/src/domains/meta/features/switchboard/hooks/`
2373 | 
2374 | ### üìÑ `useSwitchboard.ts`
2375 | > FILEPATH: frontend/src/domains/meta/features/switchboard/hooks/useSwitchboard.ts */
2376 | 
2377 | **Components & Logic:**
2378 | 
2379 | * **`useSwitchboard`**
2380 |   * **Logic Flow:**
2381 |     * `1. FETCH AVAILABLE POLICIES (The Atoms)`
2382 |     * `2. FETCH AVAILABLE GROUPS (The Bundles) - ‚ö° NEW`
2383 |     * `3. FETCH ACTIVE BINDINGS (The Assignments)`
2384 |     * `4. CREATE ASSIGNMENT`
2385 |     * `5. UPDATE ASSIGNMENT`
2386 |     * `6. REMOVE ASSIGNMENT`
2387 |     * `Data`
2388 |     * `Actions`
2389 | 
2390 | ---
2391 | ## üìÇ `frontend/src/domains/meta/features/switchboard/`
2392 | 
2393 | ### üìÑ `types.ts`
2394 | > FILEPATH: frontend/src/domains/meta/features/switchboard/types.ts */
2395 | 
2396 | **Components & Logic:**
2397 | 
2398 | * **`PolicyDefinition`**
2399 |   * üìù *--- 1. THE ATOM (Policy) ---*
2400 |   * **Logic Flow:**
2401 |     * `--- 2. THE ASSIGNMENT (Binding) ---`
2402 | * **`PolicyBinding`**
2403 |   * üìù *--- 2. THE ASSIGNMENT (Binding) ---*
2404 |   * **Logic Flow:**
2405 |     * `Source Polymorphism (One is always set)`
2406 |     * `Expanded Relations (For UI display)`
2407 |     * `Target Polymorphism`
2408 |     * `--- 3. OPTIONS ---`
2409 | * **`BindingScope`**
2410 |   * üìù *--- 3. OPTIONS ---*
2411 | * **`BindingDraft`**
2412 |   * **Logic Flow:**
2413 |     * `‚ö° Logic: Must provide either policy_id OR policy_group_id`
2414 | 
2415 | ---
2416 | ## üìÇ `frontend/src/domains/meta/`
2417 | 
2418 | ### üìÑ `manifest.tsx`
2419 | > Registers the System Configuration Module.
2420 | 
2421 | | Attribute | Value |
2422 | | :--- | :--- |
2423 | | **fix** | `Lazy Loaded MetaRoot to prevent Circular Dependency with Sidebar.` |
2424 | 
2425 | **Components & Logic:**
2426 | 
2427 | * **`metaManifest`**
2428 | 
2429 | ---
2430 | ## üìÇ `frontend/src/domains/meta/types/`
2431 | 
2432 | ### üìÑ `constants.ts`
2433 | > Shared Enums for the Meta-Kernel (Dictionary, Governance, Workflow).
2434 | 
2435 | | Attribute | Value |
2436 | | :--- | :--- |
2437 | | **invariant** | `Must match 'backend/app/core/meta/constants.py' exactly. */` |
2438 | 
2439 | **Components & Logic:**
2440 | 
2441 | * **`BindingType`**
2442 |   * üìù *Shared Enums for the Meta-Kernel (Dictionary, Governance, Workflow).*
2443 | * **`AttributeType`**
2444 | * **`WidgetType`**
2445 |   * **Logic Flow:**
2446 |     * `Text`
2447 |     * `Numeric`
2448 |     * `Choice`
2449 |     * `Boolean`
2450 |     * `Date`
2451 |     * `Advanced`
2452 | * **`RuleEventType`**
2453 | * **`RuleActionType`**
2454 | * **`PolicyResolutionStrategy`**
2455 | * **`ViewEngineType`**
2456 | * **`ScopeType`**
2457 |   * **Logic Flow:**
2458 |     * `‚ö° SYSTEM BRICKS (The "App" Types)`
2459 | 
2460 | ---
2461 | ### üìÑ `index.ts`
2462 | > Centralizes type definitions for the Meta Domain. Acts as the SSOT for Domain/Scope shapes.
2463 | 
2464 | | Attribute | Value |
2465 | | :--- | :--- |
2466 | | **security-level** | `LEVEL 0 (Core Types) */` |
2467 | 
2468 | **Components & Logic:**
2469 | 
2470 | * **`DomainTypeProperties`**
2471 |   * üìù *--- KERNEL PROPERTIES ---*
2472 | * **`DomainTypeDefinition`**
2473 |   * **Logic Flow:**
2474 |     * `--- SUMMARIES (Lists) ---`
2475 | * **`ScopeSummary`**
2476 |   * üìù *--- SUMMARIES (Lists) ---*
2477 |   * **Logic Flow:**
2478 |     * `‚ö° RUNTIME STATE (Injected by Hypervisor)`
2479 | * **`DomainSummary`**
2480 |   * **Logic Flow:**
2481 |     * `Dynamic Type`
2482 |     * `Topology`
2483 |     * `‚ö° HIERARCHY (The Tree Link)`
2484 |     * `Visuals`
2485 |     * `Capabilities`
2486 |     * `Runtime Config`
2487 |     * `--- CONTEXT STATE ---`
2488 | * **`MetaContextState`**
2489 |   * üìù *--- CONTEXT STATE ---*
2490 |   * **Logic Flow:**
2491 |     * `Selection`
2492 |     * `Data`
2493 |     * `Actions`
2494 | 
2495 | ---
2496 | ## üìÇ `frontend/src/domains/meta/views/`
2497 | 
2498 | ### üìÑ `MetaDashboard.tsx`
2499 | > The clean entry point for the new System Configurator.
2500 | 
2501 | ---
2502 | ## üìÇ `frontend/src/domains/meta_v2/`
2503 | 
2504 | ### üìÑ `MetaV2Root.tsx`
2505 | > Bootstraps the Meta V2 Kernel Context and Routing.
2506 | 
2507 | | Attribute | Value |
2508 | | :--- | :--- |
2509 | | **security-level** | `LEVEL 0 (Kernel Boot) */` |
2510 | | **updated** | `Injected WorkflowsTool routes to prevent Router Unmount crashes. */` |
2511 | 
2512 | **Components & Logic:**
2513 | 
2514 | * **`MetaV2Root`**
2515 |   * **Logic Flow:**
2516 |     * `‚ö° DIAGNOSTIC: Log Entry`
2517 | 
2518 | ---
2519 | ## üìÇ `frontend/src/domains/meta_v2/_kernel/`
2520 | 
2521 | ### üìÑ `KernelContext.tsx`
2522 | > Bootstraps the Meta-Kernel V2. Loads Registry, Types, and Capabilities.
2523 | 
2524 | | Attribute | Value |
2525 | | :--- | :--- |
2526 | | **security-level** | `LEVEL 0 (Kernel Boot) */` |
2527 | 
2528 | **Components & Logic:**
2529 | 
2530 | * **`KernelContext`**
2531 | * **`KernelProvider`**
2532 |   * **Logic Flow:**
2533 |     * `2. STATE: Universal URL Persistence`
2534 |     * `3. ACTIONS`
2535 |     * `‚ö° PARALLEL FETCHING: Use raw requests for both to bypass OpenAPI generated name mismatches`
2536 |     * `Handle potential response wrappers (e.g. { modules: [...] } vs [...])`
2537 |     * `4. EFFECTS: Boot`
2538 |     * `5. DERIVED STATE (Selection Resolution)`
2539 |     * `Resolve Objects from Keys (O(n) but n is small)`
2540 |     * `‚ö° CRITICAL FIX: Add selectContext as an alias to selectDomain so UniversalTree works`
2541 | * **`useKernel`**
2542 | 
2543 | ---
2544 | ### üìÑ `logic.ts`
2545 | > Calculates features based on Backend Domain Properties. Zero UI dependencies.
2546 | 
2547 | | Attribute | Value |
2548 | | :--- | :--- |
2549 | | **security-level** | `LEVEL 9 (Logic Safe) */` |
2550 | | **updated** | `Removed 'SYS' magic string. Now uses strict type checking. */` |
2551 | 
2552 | **Components & Logic:**
2553 | 
2554 | * **`calculateCapabilities`**
2555 |   * üìù *Decodes the Domain Properties into UI Capabilities.*
2556 |   * **Logic Flow:**
2557 |     * `üõ°Ô∏è SAFETY: Handle missing type definitions gracefully (Legacy fallback)`
2558 |     * `1. Dictionary: Only if the domain supports Custom Attributes (Metadata)`
2559 |     * `2. Workflows: Only if the domain logs Activity/State Transitions`
2560 |     * `3. Governance: If it has an API, it needs Rules.`
2561 |     * `We exclude 'NONE' (Virtual domains) but include 'READ_ONLY'.`
2562 |     * `4. Data Browser: Only if we can CRUD the data via standard API.`
2563 | * **`buildActiveContext`**
2564 |   * üìù *Factory that builds the Context Object from a selected Domain.*
2565 |   * **Logic Flow:**
2566 |     * `‚ö° FIX: Use the Domain Type classification, NOT the hardcoded 'SYS' key.`
2567 | 
2568 | ---
2569 | ### üìÑ `types.ts`
2570 | > Strict type definitions for the Context-Driven Architecture.
2571 | 
2572 | | Attribute | Value |
2573 | | :--- | :--- |
2574 | | **security-level** | `LEVEL 0 (Kernel) */` |
2575 | | **invariant** | `Must match Backend Pydantic Models in 'app.core.kernel.registry.schemas'. */` |
2576 | | **updated** | `Added 'WorkflowTypeRead' for V3 Dynamic Workflow Types. */` |
2577 | 
2578 | **Components & Logic:**
2579 | 
2580 | * **`ScopeConfig`**
2581 |   * üìù *Strict type definitions for the Context-Driven Architecture.*
2582 | * **`DomainTypeProperties`**
2583 |   * **Logic Flow:**
2584 |     * `‚ö° LEVEL 7: DYNAMIC TYPE DEFINITION (From DB: kernel_domain_types)`
2585 | * **`DomainTypeDefinition`**
2586 |   * üìù *‚ö° LEVEL 7: DYNAMIC TYPE DEFINITION (From DB: kernel_domain_types)*
2587 |   * **Logic Flow:**
2588 |     * `‚ö° V3: DYNAMIC WORKFLOW TYPE (From DB: meta_workflow_types)`
2589 | * **`WorkflowTypeRead`**
2590 |   * üìù *‚ö° V3: DYNAMIC WORKFLOW TYPE (From DB: meta_workflow_types)*
2591 |   * **Logic Flow:**
2592 |     * `--- SUMMARIES (Lists) ---`
2593 | * **`ScopeSummary`**
2594 |   * üìù *--- SUMMARIES (Lists) ---*
2595 |   * **Logic Flow:**
2596 |     * `‚ö° RUNTIME STATE (Injected by Hypervisor)`
2597 | * **`DomainSummary`**
2598 |   * **Logic Flow:**
2599 |     * `‚ö° DYNAMIC TYPE (Data-Driven)`
2600 |     * `‚ö° TOPOLOGY METADATA (Level 100)`
2601 |     * `‚ö° HIERARCHY (The Tree Link)`
2602 |     * `Visuals`
2603 |     * `Capabilities`
2604 |     * `Runtime Config`
2605 |     * `--- CONTEXT STATE ---`
2606 | * **`MetaContextState`**
2607 |   * üìù *--- CONTEXT STATE ---*
2608 |   * **Logic Flow:**
2609 |     * `1. Registry (The Menu)`
2610 |     * `‚ö° V3 STATE: The Rules of Physics`
2611 |     * `2. Selection (The Focus)`
2612 |     * `‚ö° GLOBAL ITEM STATE (Fixes Refresh Amnesia)`
2613 |     * `Stores the full object so we don't have to re-find it constantly`
2614 |     * `3. Data Access`
2615 |     * `4. Actions`
2616 | 
2617 | ---
2618 | ### üìÑ `useKernel.ts`
2619 | > PREVENTS CRASHES. Re-exports the hook from KernelContext so existing imports work.
2620 | 
2621 | | Attribute | Value |
2622 | | :--- | :--- |
2623 | | **security-level** | `LEVEL 0 (Public) */` |
2624 | 
2625 | ---
2626 | ## üìÇ `frontend/src/domains/meta_v2/_shell/`
2627 | 
2628 | ### üìÑ `MetaUIContext.tsx`
2629 | > Centralizes UI state (Sidebar collapse, Tree expansion) with LocalStorage persistence.
2630 | 
2631 | **Components & Logic:**
2632 | 
2633 | * **`MetaUIProvider`**
2634 |   * **Logic Flow:**
2635 |     * `--- 1. LAYOUT STATE ---`
2636 |     * `--- 2. TREE STATE ---`
2637 |     * `--- ACTIONS ---`
2638 | * **`useMetaUI`**
2639 | 
2640 | ---
2641 | ### üìÑ `StudioLayout.tsx`
2642 | > The Master Layout (3-Pane) powered by MetaUIContext.
2643 | 
2644 | | Attribute | Value |
2645 | | :--- | :--- |
2646 | | **security-level** | `LEVEL 9 (UI Safe) */` |
2647 | | **invariant** | `Must use <Outlet /> for center pane to respect MetaV2Root nested routes. */` |
2648 | 
2649 | **Components & Logic:**
2650 | 
2651 | * **`StudioLayout`**
2652 |   * üìù *‚ö° WRAPPER TO PROVIDE CONTEXT*
2653 | 
2654 | ---
2655 | ## üìÇ `frontend/src/domains/meta_v2/components/`
2656 | 
2657 | ### üõ†Ô∏è `ContextInspector.tsx`
2658 | > Visualizes the Active Kernel Context.
2659 | 
2660 | **Components & Logic:**
2661 | 
2662 | * **`ContextInspector`**
2663 |   * **Logic Flow:**
2664 |     * `‚ö° FIX: Access Global Theme Tokens`
2665 |     * `Helper to render boolean capabilities visually`
2666 |     * `‚ö° FIX: Use Semantic Tokens for Background/Border`
2667 | 
2668 | ---
2669 | ### üìÑ `DomainTopology.tsx`
2670 | > Renders the System Hierarchy using a Recursive Engine for infinite nesting support.
2671 | 
2672 | | Attribute | Value |
2673 | | :--- | :--- |
2674 | | **security-level** | `LEVEL 9 (UI Safe)` |
2675 | | **updated** | `Added support for 'ACTION' node type to render "Create" placeholders distinctively.` |
2676 | 
2677 | **Components & Logic:**
2678 | 
2679 | * **`DomainTopology`**
2680 |   * üìù *Renders the System Hierarchy using a Recursive Engine.*
2681 |   * **Logic Flow:**
2682 |     * `1. DATA`
2683 |     * `2. STATE`
2684 |     * `3. ROUTING LOGIC`
2685 |     * `‚ö° V2 ROUTING HOOK: Workflow Editor Integration`
2686 |     * `‚ö° UX: If it's the Workflows folder, navigate to the Workflow Lobby`
2687 |     * `‚ö° ACTION HANDLER (For Placeholders)`
2688 |     * `Actions like "Create First Workflow" route to the lobby`
2689 |     * `Default: External Route`
2690 |     * `4. NORMALIZATION ENGINE (The Flattening & Recursive Builder)`
2691 |     * `Helper: Recursive Filter & Map`
2692 |     * `Check self match`
2693 |     * `Process children recursively`
2694 |     * `If searched, only return if self matches or has matching children`
2695 |     * `If we have matches in children, expand this node`
2696 |     * `TRANSFORM: Cluster -> Domain -> Section -> Item -> UniversalTreeNode`
2697 |     * `Root Items`
2698 |     * `metadata for display`
2699 |     * `Sections (Folders)`
2700 |     * `Run Filter`
2701 |     * `5. RECURSIVE RENDERER`
2702 |     * `Determine styles based on type`
2703 | 
2704 | ---
2705 | ### üìÑ `UniversalTree.tsx`
2706 | > Renders the System Hierarchy.
2707 | 
2708 | | Attribute | Value |
2709 | | :--- | :--- |
2710 | | **security-level** | `LEVEL 9 (UI Safe) */` |
2711 | | **updated** | `Injected Auto-Collapse UX on selection to maximize focus area. */` |
2712 | 
2713 | **Components & Logic:**
2714 | 
2715 | * **`UniversalTree`**
2716 |   * **Logic Flow:**
2717 |     * `‚ö° CONNECT TO SHELL STATE`
2718 |     * `3. HANDLERS`
2719 |     * `‚ö° UX AUTOFOCUS: Collapse the main sidebar to maximize screen real estate`
2720 |     * `4. RENDERER (Custom Node)`
2721 |     * `‚ö° RESPONSIVE MODE: ICON ONLY`
2722 |     * `‚ö° FULL MODE: TREE`
2723 | 
2724 | ---
2725 | ### üìÑ `useDomainTree.ts`
2726 | > Transforms flat Domain list into a Hierarchy.
2727 | 
2728 | | Attribute | Value |
2729 | | :--- | :--- |
2730 | | **security-level** | `LEVEL 9 (UI Safe) */` |
2731 | | **updated** | `Removed hardcoded 'SYS' check. Uses Backend 'display_weight' for sorting. */` |
2732 | 
2733 | **Components & Logic:**
2734 | 
2735 | * **`KernelTreeNode`**
2736 | * **`useDomainTree`**
2737 |   * **Logic Flow:**
2738 |     * `1. Initialize Nodes`
2739 |     * `‚ö° READ DYNAMIC WEIGHT (Default to 50 if missing)`
2740 |     * `2. Link Hierarchy`
2741 |     * `Normalize parent key (handles v2 vs v3 differences)`
2742 |     * `3. Sort & Polish`
2743 |     * `‚ö° DYNAMIC SORT: Compare weights first (lower number = higher up)`
2744 |     * `Fallback to alphabetical label sorting`
2745 | 
2746 | ---
2747 | ### üìÑ `useTopology.ts`
2748 | > Fetches and groups the System Topology Graph from the API.
2749 | 
2750 | | Attribute | Value |
2751 | | :--- | :--- |
2752 | | **security-level** | `LEVEL 9 (UI Safe) */` |
2753 | | **updated** | `Injected "Zero-Touch" Workflow Placeholder for empty domains. */` |
2754 | 
2755 | **Components & Logic:**
2756 | 
2757 | * **`TopologyItem`**
2758 |   * üìù *‚ö° SHARED TYPES*
2759 | * **`TopologySection`**
2760 | * **`TopologyDomain`**
2761 | * **`DomainCluster`**
2762 | * **`useTopology`**
2763 |   * **Logic Flow:**
2764 |     * `1. ‚ö° FETCH TOPOLOGY GRAPH (Server-Side Source of Truth)`
2765 |     * `2. ‚ö° THE DUMB PIPE (Zero Frontend Opinions)`
2766 |     * `‚ö° DB-DRIVEN MATCHING: Trust the Backend's Section Assignment completely.`
2767 |     * `If the backend commanded a group, build or append to it.`
2768 |     * `‚ö° ROOT ENTITIES: Nodes without a section_key remain at the root`
2769 |     * `‚ö° ZERO-TOUCH WORKFLOWS: If capability exists but no workflows, offer creation.`
2770 |     * `This ensures the "Workflows" folder always appears if the domain supports it.`
2771 |     * `Ensure section exists`
2772 |     * `Inject Placeholder if empty`
2773 |     * `Sort dynamic folders alphabetically by their DB label`
2774 |     * `Construct the "Self" Domain representation`
2775 |     * `Wrap in a Cluster (to maintain compatibility with DomainTopology.tsx renderer)`
2776 | 
2777 | ---
2778 | ## üìÇ `frontend/src/domains/meta_v2/features/dictionary/`
2779 | 
2780 | ### üìÑ `DictionaryTool.tsx`
2781 | > The V2-Native wrapper for the Data Dictionary.
2782 | 
2783 | **Components & Logic:**
2784 | 
2785 | * **`DictionaryTool`**
2786 |   * **Logic Flow:**
2787 |     * `‚ö° ROUTING LOGIC: Capture both Path Param and Query Param`
2788 |     * `1. RESOLVE CONTEXT (V2 Way)`
2789 |     * `Prioritize Prop -> Path Param -> Query Param -> Active Context`
2790 |     * `‚ö° SYNC ENGINE: Ensure Kernel is aware of Router URL changes`
2791 |     * `2. FEATURE LOGIC`
2792 |     * `3. LOCAL UI STATE`
2793 |     * `‚ö° UX STATE: Auto-Collapse the list when editing`
2794 |     * `4. COMPUTED DRAFT`
2795 |     * `5. HANDLERS`
2796 |     * `Go back to Topology (parent route)`
2797 |     * `‚ö° UX: Expand list again after saving so they can pick the next item`
2798 |     * `‚ö° UX: Auto-collapse when user selects a field to edit`
2799 | 
2800 | ---
2801 | ## üìÇ `frontend/src/domains/meta_v2/features/dictionary/components/`
2802 | 
2803 | ### üìÑ `AttributeEditor.tsx`
2804 | > The Master Controller for editing Attributes.
2805 | 
2806 | **Components & Logic:**
2807 | 
2808 | * **`AttributeEditor`**
2809 |   * **Logic Flow:**
2810 |     * `‚ö° SYNC: Update local state if parent selection changes`
2811 |     * `‚ö° LOGIC: Auto-switch widget if data type changes`
2812 |     * `‚ö° CONTRACT FIX: Updates 'configuration', NOT 'config'`
2813 |     * `We allow config updates even if locked, generally (e.g. placeholder)`
2814 |     * `‚ö° LOGIC: Auto-Slugify`
2815 | 
2816 | ---
2817 | ### üìÑ `AttributeExplorer.tsx`
2818 | > Navigable list of Domain Attributes.
2819 | 
2820 | **Components & Logic:**
2821 | 
2822 | * **`AttributeExplorer`**
2823 |   * **Logic Flow:**
2824 |     * `‚ö° DEEP LINKING: Replaced local state with URL state for search persistence`
2825 |     * `üß† SMART SORTING`
2826 |     * `ID sort for stability`
2827 |     * `System fields first`
2828 |     * `Alphabetical`
2829 |     * `‚ö° FIX: Use 'key' (string) instead of 'id' (number) for uniqueness`
2830 | 
2831 | ---
2832 | ## üìÇ `frontend/src/domains/meta_v2/features/dictionary/components/editor/`
2833 | 
2834 | ### üìÑ `ConfigPanels.tsx`
2835 | > Fractal sub-component for handling Type-Specific settings. CRASH PROOFED.
2836 | 
2837 | **Components & Logic:**
2838 | 
2839 | * **`ConfigPanels`**
2840 |   * **Logic Flow:**
2841 |     * `‚ö° CRASH GUARD: Ensure we have an object to read from`
2842 |     * `--- 1. NUMBER CONFIGURATION ---`
2843 |     * `--- 2. TEXT CONFIGURATION ---`
2844 |     * `--- 3. SELECTION CONFIGURATION ---`
2845 |     * `--- 4. DATE / DATETIME ---`
2846 |     * `--- 5. REFERENCE (COMPLEX) ---`
2847 |     * `--- 6. FILE ---`
2848 | 
2849 | ---
2850 | ### üìÑ `PreviewPanel.tsx`
2851 | > Renders the widget in real-time.
2852 | 
2853 | **Components & Logic:**
2854 | 
2855 | * **`PreviewPanel`**
2856 |   * **Logic Flow:**
2857 |     * `--- TEXT WIDGETS ---`
2858 |     * `--- NUMBER WIDGETS ---`
2859 |     * `--- SELECTION WIDGETS ---`
2860 |     * `--- DATE WIDGETS ---`
2861 |     * `--- BOOLEAN WIDGETS ---`
2862 |     * `--- FILE WIDGETS ---`
2863 |     * `--- COMPLEX WIDGETS ---`
2864 |     * `Fallback`
2865 | 
2866 | ---
2867 | ## üìÇ `frontend/src/domains/meta_v2/features/dictionary/hooks/`
2868 | 
2869 | ### üìÑ `useDictionary.ts`
2870 | > Encapsulates all Data Access Logic for Domain Attributes.
2871 | 
2872 | **Components & Logic:**
2873 | 
2874 | * **`useDictionary`**
2875 |   * **Logic Flow:**
2876 |     * `1. FETCH ATTRIBUTES`
2877 |     * `‚ö° GATEWAY: Use standardized base`
2878 |     * `2. SAVE (CREATE / UPDATE)`
2879 |     * `Update Existing`
2880 |     * `Create New`
2881 |     * `3. DELETE`
2882 |     * `Data`
2883 |     * `Actions`
2884 |     * `State`
2885 | 
2886 | ---
2887 | ## üìÇ `frontend/src/domains/meta_v2/features/dictionary/logic/`
2888 | 
2889 | ### üìÑ `schemaNormalizer.ts`
2890 | > Logic Adapter.
2891 | 
2892 | **Components & Logic:**
2893 | 
2894 | * **`normalizeSchema`**
2895 |   * üìù *V2 Types now contain Enums too*
2896 |   * **Logic Flow:**
2897 |     * `Scenario A: It's already an Array`
2898 |     * `Scenario B: It's a Hybrid Schema Object`
2899 |     * `Check possible containers`
2900 | 
2901 | ---
2902 | ## üìÇ `frontend/src/domains/meta_v2/features/dictionary/types/`
2903 | 
2904 | ### üìÑ `constants.ts`
2905 | > Values that EXIST at runtime (Enums, Objects).
2906 | 
2907 | **Components & Logic:**
2908 | 
2909 | * **`AttributeType`**
2910 |   * üìù *Values that EXIST at runtime (Enums, Objects).*
2911 | * **`WidgetType`**
2912 |   * **Logic Flow:**
2913 |     * `Text`
2914 |     * `Numeric`
2915 |     * `Choice`
2916 |     * `Boolean`
2917 |     * `Date`
2918 |     * `Advanced`
2919 |     * `üõ°Ô∏è THE MATRIX: Defines valid Widgets for each Data Type`
2920 | * **`WIDGET_COMPATIBILITY`**
2921 |   * üìù *üõ°Ô∏è THE MATRIX: Defines valid Widgets for each Data Type*
2922 |   * **Logic Flow:**
2923 |     * `üìò THE KNOWLEDGE BASE: User-friendly descriptions`
2924 | * **`HELP_TEXT`**
2925 |   * üìù *üìò THE KNOWLEDGE BASE: User-friendly descriptions*
2926 | * **`DEFAULT_DRAFT_CONFIG`**
2927 | 
2928 | ---
2929 | ### üìÑ `index.ts`
2930 | > Re-exports Types and Constants explicitly to prevent bundler confusion.
2931 | 
2932 | **Components & Logic:**
2933 | 
2934 | * **`DEFAULT_DRAFT`**
2935 |   * üìù *3. Default Constant*
2936 | 
2937 | ---
2938 | ### üìÑ `types.ts`
2939 | > Types that DISAPPEAR at runtime. Pure Interfaces.
2940 | 
2941 | | Attribute | Value |
2942 | | :--- | :--- |
2943 | | **security-level** | `LEVEL 0 (Core Types) */` |
2944 | 
2945 | **Components & Logic:**
2946 | 
2947 | * **`AttributeType`**
2948 |   * üìù *Types that DISAPPEAR at runtime. Pure Interfaces.*
2949 | * **`WidgetType`**
2950 | * **`SelectOption`**
2951 | * **`AttributeConfig`**
2952 |   * **Logic Flow:**
2953 |     * `Text`
2954 |     * `Number`
2955 |     * `Date`
2956 |     * `Options`
2957 |     * `Reference`
2958 |     * `File`
2959 |     * `JSON`
2960 |     * `General`
2961 | * **`AttributeDefinition`**
2962 | * **`AttributeDraft`**
2963 | 
2964 | ---
2965 | ## üìÇ `frontend/src/domains/meta_v2/features/governance/`
2966 | 
2967 | ### üìÑ `GovernanceTool.tsx`
2968 | > Master Controller for the V2 Rule Engine. URL-driven, fully decoupled.
2969 | 
2970 | | Attribute | Value |
2971 | | :--- | :--- |
2972 | | **security-level** | `LEVEL 9 (UI Safe) */` |
2973 | | **updated** | `Added 'Tag' import to fix Runtime Crash. */` |
2974 | 
2975 | **Components & Logic:**
2976 | 
2977 | * **`GovernanceTool`**
2978 |   * **Logic Flow:**
2979 |     * `‚ö° ROUTING STATE`
2980 |     * `‚ö° V2 UI STATE (Centralized Shell)`
2981 |     * `‚ö° GLOBAL URL STATE (Deep Linking)`
2982 |     * `‚ö° LOGIC HOOK`
2983 |     * `‚ö° TELEMETRY`
2984 |     * `--- HANDLERS ---`
2985 |     * `‚ö° TAG-DRIVEN CONTEXT: Automatically associate this policy with the active domain`
2986 |     * `--- COMPUTED ---`
2987 |     * `--- RENDER: EMPTY STATE (No Domain) ---`
2988 |     * `--- RENDER: WORKSPACE ---`
2989 | 
2990 | ---
2991 | ## üìÇ `frontend/src/domains/meta_v2/features/governance/components/editor/`
2992 | 
2993 | ### üìÑ `ConsequenceStack.tsx`
2994 | > Renders the action stack for a rule. Driven by dynamic Backend Capabilities (Dumb UI Pattern).
2995 | 
2996 | | Attribute | Value |
2997 | | :--- | :--- |
2998 | | **security-level** | `LEVEL 9 (UI Safe) */` |
2999 | | **invariant** | `Avoids <Option> elements to prevent AntD click interception bugs. */` |
3000 | 
3001 | **Components & Logic:**
3002 | 
3003 | * **`ConsequenceStack`**
3004 |   * **Logic Flow:**
3005 |     * `‚ö° THE DUMB UI LINK: Read Actions directly from the Kernel's Context Schema`
3006 |     * `Derived options for target fields`
3007 |     * `‚ö° FIX: Use options array to prevent AntD click interception on complex DOM nodes`
3008 | 
3009 | ---
3010 | ### üìÑ `EnforcementPanel.tsx`
3011 | > UI for binding a Policy to a Context.
3012 | 
3013 | **Components & Logic:**
3014 | 
3015 | * **`EnforcementPanel`**
3016 |   * **Logic Flow:**
3017 |     * `Filter bindings for *this* policy`
3018 |     * `State for New Binding (Transient form state, does not need URL sync)`
3019 | 
3020 | ---
3021 | ### üìÑ `HistoryDrawer.tsx`
3022 | > Displays version timeline with Expandable JSON views.
3023 | 
3024 | **Components & Logic:**
3025 | 
3026 | * **`HistoryDrawer`**
3027 |   * **Logic Flow:**
3028 |     * `‚ö° GATEWAY: OpenAPI SDK replaces Axios`
3029 | 
3030 | ---
3031 | ### üìÑ `PolicyEditor.tsx`
3032 | > Advanced Policy Editor utilizing isolated Fractal Components and URL state.
3033 | 
3034 | | Attribute | Value |
3035 | | :--- | :--- |
3036 | | **security-level** | `LEVEL 9 (UI Validation) */` |
3037 | | **narrator** | `Traces all rule and consequence mutations deeply. */` |
3038 | 
3039 | **Components & Logic:**
3040 | 
3041 | * **`PolicyEditor`**
3042 |   * **Logic Flow:**
3043 |     * `‚ö° HYDRATED DATA SOURCE`
3044 |     * `‚ö° DEEP LINKING BY DEFAULT (Cures History Drawer Amnesia)`
3045 |     * `--- HANDLERS ---`
3046 | 
3047 | ---
3048 | ### üìÑ `TestPanel.tsx`
3049 | > A sandbox to test logic before deploying it to production.
3050 | 
3051 | **Components & Logic:**
3052 | 
3053 | * **`TestPanel`**
3054 |   * **Logic Flow:**
3055 |     * `Default mock data based on standard "host" envelope`
3056 | 
3057 | ---
3058 | ## üìÇ `frontend/src/domains/meta_v2/features/governance/components/editor/logic/`
3059 | 
3060 | ### üìÑ `LogicBuilder.tsx`
3061 | > Recursive Subject-Verb-Object Composer for Governance Rules.
3062 | 
3063 | | Attribute | Value |
3064 | | :--- | :--- |
3065 | | **security-level** | `LEVEL 9 (Functional State Safety) */` |
3066 | | **invariant** | `The AST (root) is the absolute source of truth for the Visual Mode. */` |
3067 | | **narrator** | `Traces AST mutations and compilations. */` |
3068 | 
3069 | **Components & Logic:**
3070 | 
3071 | * **`LogicBuilder`**
3072 |   * **Logic Flow:**
3073 |     * `‚ö° SAFEGUARD: Switch to CODE mode if there's an existing complex value we can't visually parse yet`
3074 |     * `COMPILER`
3075 |     * `‚ö° FIX: Gracefully ignore incomplete rules without destroying the string`
3076 |     * `HANDLERS`
3077 |     * `‚ö° FIX: Functional State Update ensures we never drop intermediate keystrokes`
3078 |     * `RENDERERS`
3079 | 
3080 | ---
3081 | ### üìÑ `SubjectPicker.tsx`
3082 | > Smart Context Selector. Strict TS bindings, avoids AntD click-interception, deep telemetry.
3083 | 
3084 | | Attribute | Value |
3085 | | :--- | :--- |
3086 | | **security-level** | `LEVEL 9 (Data Access) */` |
3087 | | **narrator** | `Emits explicit string paths for the Logic Compiler. */` |
3088 | 
3089 | **Components & Logic:**
3090 | 
3091 | * **`SubjectPicker`**
3092 |   * **Logic Flow:**
3093 |     * `‚ö° THE DUMB UI LINK: Read Context safely using the Registry accessor`
3094 |     * `‚ö° STATE HYDRATION: Restore tab and domain from existing value robustly`
3095 |     * `1. Check Context Roots (e.g. actor., system.)`
3096 |     * `2. Check Global Domain (e.g., "USER.email")`
3097 |     * `Ensure it's not a known root or 'HOST'`
3098 |     * `3. Fallback to Host (Any un-prefixed field or explicitly 'host.email')`
3099 |     * `‚ö° LAZY LOAD: Global Domain List`
3100 |     * `‚ö° LAZY LOAD: Specific Domain Schema`
3101 |     * `--- RENDERERS ---`
3102 |     * `‚ö° CRITICAL FIX: Convert from Components to standard Render Functions`
3103 |     * `This stops the "Cannot create components during render" crash.`
3104 | 
3105 | ---
3106 | ## üìÇ `frontend/src/domains/meta_v2/features/governance/components/list/`
3107 | 
3108 | ### üìÑ `PolicyExplorer.tsx`
3109 | > Navigable list of Governance Policies.
3110 | 
3111 | **Components & Logic:**
3112 | 
3113 | * **`PolicyExplorer`**
3114 |   * **Logic Flow:**
3115 |     * `‚ö° DEEP LINKING: Replaced useState with useUrlState`
3116 |     * `‚ö° TELEMETRY: Trace Component Lifecycle`
3117 |     * `Helper to format v1.05`
3118 |     * `Default to v1.00 if missing (legacy data)`
3119 |     * `‚ö° SHOW VERSION`
3120 | 
3121 | ---
3122 | ## üìÇ `frontend/src/domains/meta_v2/features/governance/hooks/`
3123 | 
3124 | ### üìÑ `useGovernance.ts`
3125 | > Manages Policy State and Fuses Domain Schema with System Context. Uses OpenAPI SDK.
3126 | 
3127 | | Attribute | Value |
3128 | | :--- | :--- |
3129 | | **security-level** | `LEVEL 9 (Schema Fusion) */` |
3130 | | **updated** | `Added Data Normalization to convert Schema Dictionary -> Array. Fixes 'filter is not a function' crash. */` |
3131 | 
3132 | **Components & Logic:**
3133 | 
3134 | * **`useGovernance`**
3135 |   * **Logic Flow:**
3136 |     * `1. FETCH POLICIES (The Law)`
3137 |     * `Note: In standard architecture, policies are fetched globally and bound locally.`
3138 |     * `2. FETCH FUSED SCHEMA (The Vocabulary)`
3139 |     * `‚ö° ADAPTER: Normalize Dictionary to Array for UI Consumption`
3140 |     * `If it's already an array, pass it through (Legacy Safe)`
3141 |     * `If it's a Dictionary, convert to Array and inject 'group' for grouping logic`
3142 |     * `3. CREATE POLICY`
3143 |     * `4. UPDATE POLICY`
3144 |     * `5. DELETE POLICY`
3145 |     * `Explicit cast to 'any' to handle OpenAPI Codegen delete signature if it varies`
3146 |     * `6. DRY RUN`
3147 |     * `Data`
3148 |     * `Actions`
3149 |     * `State`
3150 | 
3151 | ---
3152 | ### üìÑ `usePolicyBindings.ts`
3153 | > Manages enforcement jurisdictions. Uses OpenAPI SDK.
3154 | 
3155 | | Attribute | Value |
3156 | | :--- | :--- |
3157 | | **security-level** | `LEVEL 9 (API Integration) */` |
3158 | 
3159 | **Components & Logic:**
3160 | 
3161 | * **`usePolicyBindings`**
3162 |   * **Logic Flow:**
3163 |     * `1. FETCH BINDINGS`
3164 |     * `2. CREATE BINDING`
3165 |     * `3. TOGGLE/UPDATE BINDING`
3166 |     * `4. DELETE BINDING`
3167 | 
3168 | ---
3169 | ## üìÇ `frontend/src/domains/meta_v2/features/workflows/`
3170 | 
3171 | ### üìÑ `WorkflowsTool.tsx`
3172 | > The V2-Native wrapper for the Workflow Engine. Injected with P1-DIAG-02 probes.
3173 | 
3174 | | Attribute | Value |
3175 | | :--- | :--- |
3176 | | **security-level** | `LEVEL 9 (UI Safe) */` |
3177 | 
3178 | **Components & Logic:**
3179 | 
3180 | * **`WorkflowsTool`**
3181 |   * **Logic Flow:**
3182 |     * `üî¨ BLACK BOX PROBE: P1-DIAG-02 (WorkflowsTool)`
3183 |     * `‚ö° SYNC ENGINE: Ensure Kernel is aware of Router URL changes`
3184 | 
3185 | ---
3186 | ## üìÇ `frontend/src/domains/meta_v2/features/workflows/components/`
3187 | 
3188 | ### üõ†Ô∏è `CodeEditorDrawer.tsx`
3189 | > Raw XState JSON Editor with syntax validation and live graph sync.
3190 | 
3191 | | Attribute | Value |
3192 | | :--- | :--- |
3193 | | **security-level** | `LEVEL 9 */` |
3194 | 
3195 | **Components & Logic:**
3196 | 
3197 | * **`CodeEditorDrawer`**
3198 |   * üìù *The low-level interface for direct XState manipulation.*
3199 |   * **Logic Flow:**
3200 |     * `‚ö° SIGNAL TELEMETRY: Source Sync`
3201 |     * `Basic Schema Check`
3202 | 
3203 | ---
3204 | ### üìÑ `EditorToolbar.tsx`
3205 | > The Control Deck for the Workflow Editor. Restored the Back Button for navigation.
3206 | 
3207 | | Attribute | Value |
3208 | | :--- | :--- |
3209 | | **security-level** | `LEVEL 9 (UI Safe Guards) */` |
3210 | 
3211 | **Components & Logic:**
3212 | 
3213 | * **`EditorToolbar`**
3214 |   * üìù *The top navigation bar for the workflow editor.*
3215 | 
3216 | ---
3217 | ### üìÑ `FlowCanvas.tsx`
3218 | > Renders the Interactive Node Graph with Auto-Layout. Rewired to V2 Nodes.
3219 | 
3220 | | Attribute | Value |
3221 | | :--- | :--- |
3222 | | **security-level** | `LEVEL 9 (UI Invariant) */` |
3223 | 
3224 | **Components & Logic:**
3225 | 
3226 | * **`FlowCanvas`**
3227 | 
3228 | ---
3229 | ### üìÑ `WorkflowEditor.tsx`
3230 | > The Canvas and Inspector workspace. Safely synthesizes missing Database definitions using Code Defaults.
3231 | 
3232 | | Attribute | Value |
3233 | | :--- | :--- |
3234 | | **security-level** | `LEVEL 9 (Strict Null Checks & Memory Synthesis) */` |
3235 | | **narrator** | `Deeply traces interactions with nodes and pane background. */` |
3236 | 
3237 | **Components & Logic:**
3238 | 
3239 | * **`WorkflowEditor`**
3240 |   * **Logic Flow:**
3241 |     * `‚ö° DEEP LINKING BY DEFAULT`
3242 |     * `‚ö° THE SYNTHESIS ENGINE (Fixes the "Process Definition Missing" bug for Jobs/Views)`
3243 |     * `1. Try to find it in the Database`
3244 |     * `2. Fallback to Code Registry (Kernel Context) to Synthesize a Draft`
3245 |     * `‚ö° REACTFLOW HANDLERS`
3246 |     * `‚ö° API MUTATION HANDLERS`
3247 |     * `Only attempt to delete if it's a real DB record (not a synthetic one)`
3248 | 
3249 | ---
3250 | ### üìÑ `WorkflowExplorer.tsx`
3251 | > Renders a filterable gallery of workflows. Now correctly includes JOB and VIEW scopes.
3252 | 
3253 | | Attribute | Value |
3254 | | :--- | :--- |
3255 | | **security-level** | `LEVEL 9 (Strict TypeScript) */` |
3256 | | **invariant** | `MUST support code-first scopes that do not yet exist in the DB. */` |
3257 | | **narrator** | `Emits traces for all list calculations and segment filters. */` |
3258 | 
3259 | **Components & Logic:**
3260 | 
3261 | * **`WorkflowExplorer`**
3262 |   * **Logic Flow:**
3263 |     * `‚ö° CONTEXT`
3264 |     * `‚ö° DEEP LINKING BY DEFAULT`
3265 |     * `‚ö° DATA FETCH`
3266 |     * `‚ö° LOGIC: Robust Union & Strict Filter`
3267 |     * `1. Gather ALL code-first scopes from the Registry (No longer hiding JOB/VIEW)`
3268 |     * `2. Add/Merge db-first workflows`
3269 |     * `3. Convert to array and apply user's UI filter`
3270 |     * `‚ö° HANDLERS`
3271 | 
3272 | ---
3273 | ### üìÑ `WorkflowGenesis.tsx`
3274 | > UI for defining the root properties of a new State Machine. Rewired to V2.
3275 | 
3276 | | Attribute | Value |
3277 | | :--- | :--- |
3278 | | **security-level** | `LEVEL 9 (Data Validation) */` |
3279 | 
3280 | **Components & Logic:**
3281 | 
3282 | * **`WorkflowGenesis`**
3283 |   * **Logic Flow:**
3284 |     * `‚ö° ROBUST DOMAIN RESOLUTION`
3285 |     * `‚ö° V2 HOOKS`
3286 |     * `Reset form on open`
3287 |     * `V2 uses 'updateWorkflow' (which runs POST) for creation`
3288 | 
3289 | ---
3290 | ## üìÇ `frontend/src/domains/meta_v2/features/workflows/components/canvas/`
3291 | 
3292 | ### üìÑ `CanvasNodes.tsx`
3293 | > Renders ReactFlow Custom Nodes (Screen, Task, Standard) representing workflow states.
3294 | 
3295 | | Attribute | Value |
3296 | | :--- | :--- |
3297 | | **security-level** | `LEVEL 9 (UI Safe) */` |
3298 | 
3299 | **Components & Logic:**
3300 | 
3301 | * **`CanvasNodeData`**
3302 |   * üìù *--- SHARED DOMAIN TYPES ---*
3303 |   * **Logic Flow:**
3304 |     * `============================================================================`
3305 |     * `1. SCREEN NODE (WIZARD VISUAL)`
3306 |     * `============================================================================`
3307 | * **`ScreenNode`**
3308 |   * **Logic Flow:**
3309 |     * `============================================================================`
3310 |     * `2. STANDARD NODE (GOVERNANCE VISUAL)`
3311 |     * `============================================================================`
3312 | * **`StandardNode`**
3313 |   * üìù *============================================================================*
3314 |   * **Logic Flow:**
3315 |     * `============================================================================`
3316 |     * `3. TASK NODE (JOB VISUAL)`
3317 |     * `============================================================================`
3318 | * **`TaskNode`**
3319 |   * üìù *============================================================================*
3320 | 
3321 | ---
3322 | ## üìÇ `frontend/src/domains/meta_v2/features/workflows/components/inspector/`
3323 | 
3324 | ### üìÑ `InspectorShell.tsx`
3325 | > Standardized outer frame for inspector panels. Preserves pixel-perfect legacy appearance.
3326 | 
3327 | | Attribute | Value |
3328 | | :--- | :--- |
3329 | | **security-level** | `LEVEL 9 */` |
3330 | 
3331 | **Components & Logic:**
3332 | 
3333 | * **`SelectionType`**
3334 | * **`InspectorShell`**
3335 |   * üìù *Renders the high-density container for node editing. [cite: 2855-2884]*
3336 |   * **Logic Flow:**
3337 |     * `‚ö° SIGNAL TELEMETRY: Render tracking`
3338 | 
3339 | ---
3340 | ### üìÑ `JobNode.tsx`
3341 | > Configuration for Async Background Tasks (Queues, Handlers, Retries).
3342 | 
3343 | | Attribute | Value |
3344 | | :--- | :--- |
3345 | | **security-level** | `LEVEL 9 */` |
3346 | 
3347 | **Components & Logic:**
3348 | 
3349 | * **`JobNode`**
3350 |   * üìù *Decoupled V2 editor for background task nodes. [cite: 2885-2923]*
3351 |   * **Logic Flow:**
3352 |     * `‚ö° SIGNAL TELEMETRY: Init`
3353 | 
3354 | ---
3355 | ### üìÑ `StandardNode.tsx`
3356 | > Basic configuration for Lifecycle/Governance States (Color, Documentation).
3357 | 
3358 | | Attribute | Value |
3359 | | :--- | :--- |
3360 | | **security-level** | `LEVEL 9 */` |
3361 | 
3362 | **Components & Logic:**
3363 | 
3364 | * **`StandardNode`**
3365 |   * üìù *Decoupled V2 editor for basic state nodes. [cite: 2954-2981]*
3366 |   * **Logic Flow:**
3367 |     * `‚ö° SIGNAL TELEMETRY: Init`
3368 | 
3369 | ---
3370 | ### üìÑ `TransitionEdge.tsx`
3371 | > Manages the logic connecting two nodes, including events, guards, and side effects.
3372 | 
3373 | | Attribute | Value |
3374 | | :--- | :--- |
3375 | | **security-level** | `LEVEL 9 */` |
3376 | 
3377 | **Components & Logic:**
3378 | 
3379 | * **`TransitionEdge`**
3380 |   * üìù *Decoupled V2 inspector for Workflow Edges. [cite: 2988-3027]*
3381 |   * **Logic Flow:**
3382 |     * `‚ö° SIGNAL TELEMETRY: Component Init`
3383 | 
3384 | ---
3385 | ### üìÑ `WizardNode.tsx`
3386 | > Orchestrates Wizard Step configuration. Manages step metadata and the field collection.
3387 | 
3388 | | Attribute | Value |
3389 | | :--- | :--- |
3390 | | **security-level** | `LEVEL 9 */` |
3391 | 
3392 | **Components & Logic:**
3393 | 
3394 | * **`WIZARD_COMPONENTS`**
3395 |   * üìù *Rich component registry for user-facing selection [cite: 3034-3048] */*
3396 | * **`WizardNode`**
3397 |   * **Logic Flow:**
3398 |     * `‚ö° SIGNAL TELEMETRY: Component Lifecycle`
3399 | 
3400 | ---
3401 | ### üìÑ `WorkflowInspector.tsx`
3402 | > Orchestrates the contextual editing of Nodes. Added Editable Raw JSON tab.
3403 | 
3404 | | Attribute | Value |
3405 | | :--- | :--- |
3406 | | **security-level** | `LEVEL 9 */` |
3407 | 
3408 | **Components & Logic:**
3409 | 
3410 | * **`WorkflowInspector`**
3411 |   * **Logic Flow:**
3412 |     * `‚ö° DEEP LINKING BY DEFAULT`
3413 |     * `‚ö° LOCAL STATE: JSON Editor Buffer`
3414 |     * `‚ö° TELEMETRY PROBE: Selection Change`
3415 |     * `‚ö° SYNC JSON BUFFER: Keep the text area updated when nodeData changes externally`
3416 |     * `‚ö° HANDLER: Apply JSON Mutations`
3417 | 
3418 | ---
3419 | ## üìÇ `frontend/src/domains/meta_v2/features/workflows/components/inspector/_atoms/`
3420 | 
3421 | ### üìÑ `FieldCard.tsx`
3422 | > Renders the draggable, space-optimized cards for individual form fields.
3423 | 
3424 | | Attribute | Value |
3425 | | :--- | :--- |
3426 | | **security-level** | `LEVEL 9 */` |
3427 | 
3428 | **Components & Logic:**
3429 | 
3430 | * **`FieldCard`**
3431 |   * üìù *Atomic component for managing the list of fields within a Wizard step. [cite: 3069-3101]*
3432 | 
3433 | ---
3434 | ## üìÇ `frontend/src/domains/meta_v2/features/workflows/`
3435 | 
3436 | ### üìÑ `constants.tsx`
3437 | > Centralized definitions for Workflow Types, Icons, and Metadata. Localized to V2.
3438 | 
3439 | | Attribute | Value |
3440 | | :--- | :--- |
3441 | | **security-level** | `LEVEL 9 (Read-Only Data) */` |
3442 | 
3443 | **Components & Logic:**
3444 | 
3445 | * **`WorkflowTypeDef`**
3446 |   * **Logic Flow:**
3447 |     * `‚ö° V2 LOCALIZED CONSTANTS`
3448 | * **`WORKFLOW_TYPES`**
3449 |   * üìù *‚ö° V2 LOCALIZED CONSTANTS*
3450 | * **`DEFAULT_WORKFLOW_ICON`**
3451 | * **`getWorkflowMeta`**
3452 | 
3453 | ---
3454 | ## üìÇ `frontend/src/domains/meta_v2/features/workflows/hooks/`
3455 | 
3456 | ### üìÑ `useCanvasHistory.ts`
3457 | > Provides Undo/Redo capability for ReactFlow with debounced snapshots.
3458 | 
3459 | | Attribute | Value |
3460 | | :--- | :--- |
3461 | | **security-level** | `LEVEL 9 */` |
3462 | 
3463 | **Components & Logic:**
3464 | 
3465 | * **`useCanvasHistory`**
3466 |   * üìù *‚ö° CRITICAL FIX: Removed unused 'initialNodes' & 'initialEdges' to clear ESLint warnings*
3467 |   * **Logic Flow:**
3468 |     * `‚ö° SNAPSHOT ENGINE`
3469 |     * `Limit history depth to 50`
3470 |     * `‚ö° CRITICAL FIX: Replaced invalid `useRef().current` access during render with `useMemo``
3471 |     * `Clean up debounce on unmount to prevent memory leaks`
3472 |     * `‚ö° UNDO`
3473 |     * `‚ö° REDO`
3474 | 
3475 | ---
3476 | ### üìÑ `useDomainSchema.ts`
3477 | > Fetches and normalizes the Domain Schema from the Kernel for the V2 Workflow Engine.
3478 | 
3479 | | Attribute | Value |
3480 | | :--- | :--- |
3481 | | **security-level** | `LEVEL 9 (Type Safety) */` |
3482 | 
3483 | **Components & Logic:**
3484 | 
3485 | * **`useDomainSchema`**
3486 |   * **Logic Flow:**
3487 |     * `‚ö° FIX: Namespaced Key 'workflow_schema' to prevent collision with Governance 'schema' key.`
3488 |     * `This ensures this hook always runs its own normalization logic (Array) instead of receiving a raw Object from cache.`
3489 |     * `1. Fetch from Backend`
3490 |     * `2. ‚ö° NORMALIZATION LOGIC`
3491 | 
3492 | ---
3493 | ### üìÑ `useEditorSession.ts`
3494 | > Manages the 'VIEW' vs 'EDIT' state and the Draft copy. Crash-proofed against undefined transitions.
3495 | 
3496 | | Attribute | Value |
3497 | | :--- | :--- |
3498 | | **security-level** | `LEVEL 9 (State Integrity) */` |
3499 | 
3500 | **Components & Logic:**
3501 | 
3502 | * **`useEditorSession`**
3503 |   * **Logic Flow:**
3504 |     * `‚ö° AUTO-RESET: When changing workflows, always revert to VIEW and clear draft.`
3505 |     * `üõ°Ô∏è CRASH FIX: Safe extraction of definition`
3506 |     * `Look for 'transitions' first, fallback to 'definition', fallback to empty XState structure`
3507 |     * `Suppress heavy logging here as this fires rapidly on node drag`
3508 | 
3509 | ---
3510 | ### üìÑ `useWorkflows.ts`
3511 | > React Query wrappers for the State Engine API. Fully instrumented with Narrator.
3512 | 
3513 | | Attribute | Value |
3514 | | :--- | :--- |
3515 | | **security-level** | `LEVEL 9 (Data Access) */` |
3516 | 
3517 | **Components & Logic:**
3518 | 
3519 | * **`WorkflowDefinition`**
3520 | * **`useWorkflows`**
3521 |   * **Logic Flow:**
3522 |     * `1. Fetch List`
3523 |     * `2. Create / Update`
3524 |     * `The API expects the full definition wrapper`
3525 |     * `3. Delete`
3526 | 
3527 | ---
3528 | ## üìÇ `frontend/src/domains/meta_v2/`
3529 | 
3530 | ### üìÑ `manifest.tsx`
3531 | > Registers the V2 System Configurator in the Global Menu.
3532 | 
3533 | | Attribute | Value |
3534 | | :--- | :--- |
3535 | | **security-level** | `LEVEL 0 (Public) */` |
3536 | 
3537 | **Components & Logic:**
3538 | 
3539 | * **`metaV2Manifest`**
3540 | 
3541 | ---
3542 | ## üìÇ `frontend/src/domains/system/api/`
3543 | 
3544 | ### üìÑ `index.ts`
3545 | > Typed fetchers for System Internals.
3546 | 
3547 | **Components & Logic:**
3548 | 
3549 | * **`SystemAPI`**
3550 | 
3551 | ---
3552 | ## üìÇ `frontend/src/domains/system/features/admin_console/`
3553 | 
3554 | ### üìÑ `ConfigDrawer.tsx`
3555 | > A dynamic form for editing SystemConfig values.
3556 | 
3557 | **Components & Logic:**
3558 | 
3559 | * **`ConfigDrawer`**
3560 |   * **Logic Flow:**
3561 |     * `‚ö° TELEMETRY: Log Access`
3562 |     * `Sync form with config prop`
3563 | 
3564 | ---
3565 | ### üìÑ `SystemDashboard.tsx`
3566 | > Master Control Plane for System Administrators to toggle Modules, Circuits, and Global Settings.
3567 | 
3568 | | Attribute | Value |
3569 | | :--- | :--- |
3570 | | **security-level** | `LEVEL 9 (Admin Control) */` |
3571 | | **invariant** | `'safety.isOn' must be strictly enforced before allowing any toggles. */` |
3572 | | **narrator** | `Logs intent and outcome for all system-level mutations. */` |
3573 | | **updated** | `Re-wired IconFactory to read from Database SSOT (module_icon) instead of hardcoded fallbacks. */` |
3574 | 
3575 | ---
3576 | ## üìÇ `frontend/src/domains/system/features/identity/`
3577 | 
3578 | ### üìÑ `SystemIdentityCard.tsx`
3579 | > A dense information display for the User Avatar Menu.
3580 | 
3581 | **Components & Logic:**
3582 | 
3583 | * **`SystemIdentityCard`**
3584 | 
3585 | ---
3586 | ## üìÇ `frontend/src/domains/system/hooks/`
3587 | 
3588 | ### üìÑ `useSystemControl.ts`
3589 | > Smartly routes toggle requests to either Domain Governance or Circuit Hypervisor.
3590 | 
3591 | **Components & Logic:**
3592 | 
3593 | * **`useSystemControl`**
3594 |   * **Logic Flow:**
3595 |     * `1. Fetch Domains (Modules & Scopes)`
3596 |     * `2. Fetch Screens (Raw Circuits)`
3597 |     * `We fetch all circuits of type 'SCREEN'`
3598 |     * `3. Fetch System Config`
3599 |     * `‚ö° POLYMORPHIC TOGGLER`
3600 |     * `BRANCH A: Circuit Target (Scope/Screen) -> Uses ':' as separator`
3601 |     * `BRANCH B: Domain Target (Simple Key) -> Uses legacy patch`
3602 |     * `Map UI/API to config keys`
3603 |     * `Invalidate everything to be safe`
3604 | 
3605 | ---
3606 | ### üìÑ `useSystemPulse.ts`
3607 | > Polls the System API to maintain situational awareness.
3608 | 
3609 | **Components & Logic:**
3610 | 
3611 | * **`useSystemPulse`**
3612 |   * **Logic Flow:**
3613 |     * `‚ö° TELEMETRY: Only whisper if something changed or on first load`
3614 |     * `Boot Sequence`
3615 |     * `‚ö° HEARTBEAT: Poll every 60 seconds to detect version changes`
3616 | 
3617 | ---
3618 | ## üìÇ `frontend/src/domains/system/`
3619 | 
3620 | ### üìÑ `manifest.tsx`
3621 | > Registers the "System Internals" domain.
3622 | 
3623 | **Components & Logic:**
3624 | 
3625 | * **`systemManifest`**
3626 | 
3627 | ---
3628 | ### üìÑ `types.ts`
3629 | > TypeScript definitions for System Domain.
3630 | 
3631 | **Components & Logic:**
3632 | 
3633 | * **`SystemIdentity`**
3634 |   * üìù *TypeScript definitions for System Domain.*
3635 | * **`SystemVersioning`**
3636 | * **`SystemHealth`**
3637 |   * **Logic Flow:**
3638 |     * `The Aggregate Payload`
3639 | * **`SystemPulse`**
3640 |   * üìù *The Aggregate Payload*
3641 |   * **Logic Flow:**
3642 |     * `‚ö° NEW: Governance Types`
3643 | * **`KernelScope`**
3644 |   * üìù *‚ö° NEW: Governance Types*
3645 | * **`KernelDomain`**
3646 |   * **Logic Flow:**
3647 |     * `‚ö° NEW: Hierarchy`
3648 | * **`SystemConfig`**
3649 | 
3650 | ---
3651 | ## üìÇ `frontend/src/domains/workspace/features/widget_runner/`
3652 | 
3653 | ### üìÑ `WidgetHost.tsx`
3654 | > Connects the URL Route to the Active App definition.
3655 | 
3656 | **Components & Logic:**
3657 | 
3658 | * **`WidgetHost`**
3659 |   * **Logic Flow:**
3660 |     * `1. PARSE URL TO FIND APP SCOPE`
3661 |     * `2. FIND APP DEFINITION`
3662 |     * `‚ö° 3. PRE-FLIGHT GOVERNANCE CHECK (Loud)`
3663 |     * `We use 'console.log' directly here for formatting, or extend Narrator`
3664 |     * `4. RENDER`
3665 | 
3666 | ---
3667 | ### üìÑ `WidgetRegistry.tsx`
3668 | > Mounts the widget only after a LIVE, GRANULAR Governance Check.
3669 | 
3670 | **Components & Logic:**
3671 | 
3672 | * **`WidgetRegistry`**
3673 |   * **Logic Flow:**
3674 |     * `Parse Scope (e.g. "USER:USER_ADMIN" -> domain="USER", scope="USER_ADMIN")`
3675 |     * `‚ö° REAL-TIME GOVERNANCE STATE`
3676 |     * `We start in 'CHECKING' to prevent rendering the widget before we know it's safe.`
3677 |     * `‚ö° DIRECT CHECK: Bypass the Manifest Cache`
3678 |     * `We ask the kernel specifically about the system domains right now.`
3679 |     * `1. Evaluate Domain Level Switches`
3680 |     * `2. Evaluate Scope Level Switches (The Deep Check)`
3681 |     * `Check if specific UI circuit is HALTED`
3682 |     * `Scope defined in frontend but missing in backend registry?`
3683 |     * `Fail Open for development, but log warning.`
3684 |     * `Determine specific reason for user feedback`
3685 |     * `Fail Safe: Security best practice is Fail Closed (Deny).`
3686 |     * `‚ö° RENDER LOGIC`
3687 |     * `‚ö° MOUNT WIDGET (Permission Granted)`
3688 | 
3689 | ---
3690 | ## üìÇ `frontend/src/domains/workspace/hooks/`
3691 | 
3692 | ### üìÑ `useBricks.ts`
3693 | > Fetches available System Capabilities (Bricks) for the App Studio.
3694 | 
3695 | | Attribute | Value |
3696 | | :--- | :--- |
3697 | | **security-level** | `LEVEL 9 (Read-Only) */` |
3698 | | **invariant** | `Must return a stable list of SystemBrick objects. */` |
3699 | 
3700 | **Components & Logic:**
3701 | 
3702 | * **`useBricks`**
3703 |   * **Logic Flow:**
3704 |     * `‚ö° FIX: Use the auto-generated verbose method name`
3705 | 
3706 | ---
3707 | ### üìÑ `useWorkspace.tsx`
3708 | > Fetches Layout Data and normalizes it for the UI.
3709 | 
3710 | | Attribute | Value |
3711 | | :--- | :--- |
3712 | | **updated** | `Added robust Label Fallback to prevent "Ghost Apps" in Sidebar. */` |
3713 | 
3714 | **Components & Logic:**
3715 | 
3716 | * **`useWorkspace`**
3717 |   * **Logic Flow:**
3718 |     * `‚ö° SAFE GUARDS`
3719 | 
3720 | ---
3721 | ## üìÇ `frontend/src/domains/workspace/`
3722 | 
3723 | ### üìÑ `types.ts`
3724 | > Defines the shape of the Runtime Application and Release Metadata.
3725 | 
3726 | | Attribute | Value |
3727 | | :--- | :--- |
3728 | | **security-level** | `LEVEL 0 (Core Types) */` |
3729 | | **invariant** | `Must match 'backend/app/domains/workspace/schemas.py' contracts. */` |
3730 | | **updated** | `Added 'meta' field to RuntimeLayout to support Versioning. */` |
3731 | 
3732 | **Components & Logic:**
3733 | 
3734 | * **`BrickType`**
3735 |   * üìù *--- 1. THE BRICK ---*
3736 |   * **Logic Flow:**
3737 |     * `--- 2. THE SCREEN ---`
3738 | * **`Screen`**
3739 |   * üìù *--- 2. THE SCREEN ---*
3740 |   * **Logic Flow:**
3741 |     * `‚ö° EAGER LOADED (Lobby Richness)`
3742 |     * `--- 3. THE APP ---`
3743 | * **`ActiveApp`**
3744 |   * üìù *--- 3. THE APP ---*
3745 |   * **Logic Flow:**
3746 |     * `‚ö° JSON RESPONSE ADAPTATION`
3747 |     * `The Layout API returns a simplified view, IDs might be implicit or missing in read-mode`
3748 |     * `Identity`
3749 |     * `‚ö° FIX: Match Backend JSON exactly ("type", not "scope_type")`
3750 |     * `Configuration (The Paint)`
3751 |     * `Backend sends "intent" in layout, but "config" in DB. We support both.`
3752 |     * `Placement`
3753 |     * `--- 4. RELEASE HISTORY ---`
3754 | * **`Release`**
3755 |   * üìù *--- 4. RELEASE HISTORY ---*
3756 |   * **Logic Flow:**
3757 |     * `--- 5. THE RUNTIME LAYOUT ---`
3758 | * **`RuntimeLayout`**
3759 |   * üìù *--- 5. THE RUNTIME LAYOUT ---*
3760 |   * **Logic Flow:**
3761 |     * `‚ö° VERSION CONTROL INTELLIGENCE`
3762 | 
3763 | ---
3764 | ## üìÇ `frontend/src/domains/workspace/views/`
3765 | 
3766 | ### üìÑ `WorkspaceRuntime.tsx`
3767 | > Bridges Logic to UI with crash protection and Governance Checks.
3768 | 
3769 | **Components & Logic:**
3770 | 
3771 | * **`WorkspaceRuntime`**
3772 |   * üìù *‚ö° NEW*
3773 |   * **Logic Flow:**
3774 |     * `1. DATA LINK`
3775 |     * `2. GOVERNANCE SYNC (Critical Fix)`
3776 |     * `When entering a Workspace, we MUST know the latest System State.`
3777 |     * `If an Admin just disabled a module, we can't rely on a 5-minute cache.`
3778 |     * `3. SECURITY GATE & LOGGING`
3779 |     * `‚ö° GOVERNANCE ROLL CALL`
3780 |     * `3. RENDER THE SHELL`
3781 | 
3782 | ---
3783 | ## üìÇ `frontend/src/lab/workflow/`
3784 | 
3785 | ### üìÑ `TestWorkflow.tsx`
3786 | > FILEPATH: frontend/src/lab/workflow/TestWorkflow.tsx */
3787 | 
3788 | **Components & Logic:**
3789 | 
3790 | * **`TestWorkflow`**
3791 |   * **Logic Flow:**
3792 |     * `‚ö° DYNAMIC STATE: Allow AI to overwrite the definition in memory`
3793 |     * `1. Fetch the Seeded Definition (Baseline)`
3794 |     * `‚ö° GATEWAY: Use standardized base`
3795 |     * `2. Handle AI Generation (Hot-Swap)`
3796 |     * `3. Handle Transitions`
3797 | 
3798 | ---
3799 | ## üìÇ `frontend/src/`
3800 | 
3801 | ### üìÑ `main.tsx`
3802 | > FILEPATH: frontend/src/main.tsx */
3803 | 
3804 | ---
3805 | ## üìÇ `frontend/src/pages/`
3806 | 
3807 | ### üìÑ `TestWorkflow.tsx`
3808 | > FILEPATH: frontend/src/pages/TestWorkflow.tsx */
3809 | 
3810 | **Components & Logic:**
3811 | 
3812 | * **`TestWorkflow`**
3813 |   * **Logic Flow:**
3814 |     * `üé® THEME ENGINE HOOK`
3815 |     * `‚ö° GATEWAY: Use standardized base`
3816 |     * `--- STYLES (Dynamic based on Theme) ---`
3817 | 
3818 | ---
3819 | ## üìÇ `frontend/src/platform/auth/`
3820 | 
3821 | ### üìÑ `AuthContext.tsx`
3822 | > FILEPATH: frontend/src/platform/auth/AuthContext.tsx */
3823 | 
3824 | **Components & Logic:**
3825 | 
3826 | * **`AuthProvider`**
3827 |   * **Logic Flow:**
3828 |     * `Start the Machine`
3829 |     * `Helper Hook for easy access`
3830 | * **`useAuth`**
3831 |   * üìù *Helper Hook for easy access*
3832 | 
3833 | ---
3834 | ### üìÑ `LoginScreen.tsx`
3835 | > FILEPATH: frontend/src/platform/auth/LoginScreen.tsx */
3836 | 
3837 | ---
3838 | ### üìÑ `machine.ts`
3839 | > FILEPATH: frontend/src/platform/auth/machine.ts */
3840 | 
3841 | **Components & Logic:**
3842 | 
3843 | * **`authMachine`**
3844 |   * üìù *4. The Machine Definition*
3845 |   * **Logic Flow:**
3846 |     * `1. Boot Sequence`
3847 |     * `2. Login Flow`
3848 |     * `3. The Async "Thinking" State`
3849 |     * `4. The Platform`
3850 | 
3851 | ---
3852 | ## üìÇ `frontend/src/platform/core/`
3853 | 
3854 | ### üìÑ `ModuleRegistry.ts`
3855 | > Singleton registry for Feature Modules.
3856 | 
3857 | **Components & Logic:**
3858 | 
3859 | * **`ModuleManifest`**
3860 | * **`MenuItem`**
3861 |   * **Logic Flow:**
3862 |     * `Silent discovery to keep console clean, we log the result later`
3863 |     * `üîç DIAGNOSTIC LOG`
3864 |     * `logger.trace('REGISTRY', 'Generated Menu Items', items);`
3865 |     * `STRATEGY A: NESTED LAYOUT (Parent "/key" -> Children "path")`
3866 |     * `STRATEGY B: FLAT ROUTES (Prefix "/key/path")`
3867 |     * `‚ö° ROUTING TELEMETRY (The "Help Me" Feature)`
3868 |     * `Parent`
3869 |     * `Children`
3870 |     * `Flat`
3871 | * **`ModuleRegistry`**
3872 | 
3873 | ---
3874 | ## üìÇ `frontend/src/platform/design/system/`
3875 | 
3876 | ### üìÑ `useNotification.ts`
3877 | > FILEPATH: frontend/src/platform/design/system/useNotification.ts */
3878 | 
3879 | **Components & Logic:**
3880 | 
3881 | * **`useNotification`**
3882 |   * **Logic Flow:**
3883 |     * `‚ö° HOOK INTO ANT DESIGN APP CONTEXT`
3884 |     * `This requires the component to be wrapped in <App> (which is done in App.tsx)`
3885 |     * `DX Wrapper: Provides semantic methods matching the old API`
3886 |     * `Advanced usage with Title + Description`
3887 | 
3888 | ---
3889 | ## üìÇ `frontend/src/platform/hooks/`
3890 | 
3891 | ### üìÑ `useUrlState.ts`
3892 | > Provides a useState-like interface that persists to the URL Query String.
3893 | 
3894 | | Attribute | Value |
3895 | | :--- | :--- |
3896 | | **security-level** | `LEVEL 0 (Kernel Utility) */` |
3897 | | **invariant** | `Must handle browser history without causing page reloads. */` |
3898 | 
3899 | **Components & Logic:**
3900 | 
3901 | * **`useUrlState`**
3902 |   * üìù *Creates a state variable that syncs with a URL query parameter.*
3903 |   * **Logic Flow:**
3904 |     * `1. READ: Lazy initializer to read from URL only once on boot`
3905 |     * `2. WRITE: Updates both Local State and URL`
3906 |     * `Access the current URL state directly from the browser to avoid race conditions`
3907 |     * `‚ö° HISTORY: Use replaceState to avoid cluttering the "Back" button history with every click`
3908 |     * `If you want "Back" to undo the selection, change this to pushState.`
3909 |     * `For simple UI tabs/filters, replaceState is usually better UX.`
3910 |     * `3. LISTEN: (Optional) If the user clicks "Back", sync the internal state`
3911 | 
3912 | ---
3913 | ## üìÇ `frontend/src/platform/kernel/`
3914 | 
3915 | ### üìÑ `BootLoader.tsx`
3916 | > FILEPATH: frontend/src/platform/kernel/BootLoader.tsx */
3917 | 
3918 | **Components & Logic:**
3919 | 
3920 | * **`BootLoader`**
3921 | 
3922 | ---
3923 | ### üìÑ `SystemContext.tsx`
3924 | > Stores the Auto-Discovered System Manifest.
3925 | 
3926 | **Components & Logic:**
3927 | 
3928 | * **`SystemContextType`**
3929 |   * üìù *‚ö° EXPORTED INTERFACE*
3930 |   * **Logic Flow:**
3931 |     * `‚ö° SAFE DEFAULT: Prevents crash if accessed before provider mount (though unlikely)`
3932 | * **`SystemProvider`**
3933 |   * **Logic Flow:**
3934 |     * `‚ö° STABLE HANDLER: Force Refresh`
3935 |     * `Invalidate both manifest and specific queries to be safe`
3936 | * **`useSystem`**
3937 | 
3938 | ---
3939 | ### üìÑ `types.ts`
3940 | > Shared definitions for the Operating System Core.
3941 | 
3942 | **Components & Logic:**
3943 | 
3944 | * **`ProcessStep`**
3945 |   * üìù *Shared definitions for the Operating System Core.*
3946 | * **`ProcessDefinition`**
3947 | * **`ModuleDefinition`**
3948 |   * **Logic Flow:**
3949 |     * `Legacy config support`
3950 |     * `‚ö° NEW: Navigation Node Contract (Matches Backend)`
3951 | * **`NavigationNode`**
3952 |   * üìù *‚ö° NEW: Navigation Node Contract (Matches Backend)*
3953 |   * **Logic Flow:**
3954 |     * `Architecture Metadata`
3955 |     * `Discovery`
3956 |     * `Config`
3957 |     * `Recursion`
3958 | * **`NavigationResponse`**
3959 | * **`SystemManifest`**
3960 |   * **Logic Flow:**
3961 |     * `‚ö° NEW: Secured Navigation Payload`
3962 | 
3963 | ---
3964 | ## üìÇ `frontend/src/platform/logging/`
3965 | 
3966 | ### üìÑ `Narrator.ts`
3967 | > The "Storyteller" Observability System.
3968 | 
3969 | **Components & Logic:**
3970 | 
3971 | * **`UniversalNarrator`**
3972 |   * **Logic Flow:**
3973 |     * `‚ö° CONFIGURATION: Maximum Verbosity`
3974 |     * `We try to detect environment, but default to true if we can't tell, to ensure logging works.`
3975 |     * `--- PUBLIC API ---`
3976 |     * `‚ö° NEW: Grouping Support`
3977 |     * `--- INTERNAL ---`
3978 |     * `Line 0: Error`
3979 |     * `Line 1: _resolveCaller`
3980 |     * `Line 2: _broadcast`
3981 |     * `Line 3: tell/scream/whisper`
3982 |     * `Line 4: The actual caller <--- Target`
3983 |     * `Find the first line that is NOT inside Narrator.ts`
3984 |     * `This regex looks for file paths that include /src/`
3985 |     * `Extract file path: "    at Context (http://localhost:3000/src/file.ts:10:20)"`
3986 |     * `Clean up: Remove http://localhost:port/`
3987 |     * `Time Delta Calculation`
3988 |     * `Format Delta: [+450ms] or [+1.2s] or [-----] if idle > 5s`
3989 |     * `‚ö° X-RAY: Inject Caller Context`
3990 |     * `‚ö° IMPROVED OUTPUT`
3991 |     * `1. Live Object (Chrome DevTools lets you expand this)`
3992 |     * `2. Serialized Backup (For Copy/Paste) - ‚ö° LOUD MODE: Limit increased significantly`
3993 |     * `--- SENTINELS ---`
3994 | * **`logger`**
3995 | 
3996 | ---
3997 | ### üìÑ `index.ts`
3998 | > Exports the Singleton Logger for application-wide use.
3999 | 
4000 | | Attribute | Value |
4001 | | :--- | :--- |
4002 | | **security-level** | `LEVEL 0 (Kernel) */` |
4003 | | **invariant** | `Must always export a valid 'logger' instance. */` |
4004 | 
4005 | **Components & Logic:**
4006 | 
4007 | * **`logger`**
4008 |   * üìù *The Global Logger Instance.*
4009 |   * **Logic Flow:**
4010 |     * `Export Types if needed`
4011 | 
4012 | ---
4013 | ### üìÑ `useTrace.ts`
4014 | > FILEPATH: frontend/src/platform/logging/useTrace.ts */
4015 | 
4016 | **Components & Logic:**
4017 | 
4018 | * **`useTrace`**
4019 |   * **Logic Flow:**
4020 |     * `1. Mount Log`
4021 |     * `2. Unmount Log`
4022 |     * `3. Update Log (Only if state changed deeply)`
4023 | 
4024 | ---
4025 | ## üìÇ `frontend/src/platform/routing/`
4026 | 
4027 | ### üìÑ `RouterFactory.tsx`
4028 | > Converts System Manifest into React Router Object.
4029 | 
4030 | **Components & Logic:**
4031 | 
4032 | * **`createDynamicRouter`**
4033 |   * üìù *--- FACTORY ---*
4034 |   * **Logic Flow:**
4035 |     * `1. Define Static Routes (System & Dev Tools)`
4036 |     * `‚ö° SYSTEM ADMIN CONSOLE`
4037 |     * `Meta Kernel Routes`
4038 |     * `‚ö° META V2 (The Kernel Lab)`
4039 |     * `‚úÖ NESTED INSIDE SHELL to inherit Top Bar & Theme`
4040 |     * `‚ö° DYNAMIC WORKSPACE ROUTES (The "Player")`
4041 |     * `2. Construct Router`
4042 |     * `‚ö° SHELL IMPORT FIX (Lazy load avoided for Core Shell to prevent flicker)`
4043 | 
4044 | ---
4045 | ## üìÇ `frontend/src/platform/shell/`
4046 | 
4047 | ### üìÑ `ShellLayout.tsx`
4048 | > Master Layout. Connects Backend Navigation to Ant Design Structure.
4049 | 
4050 | | Attribute | Value |
4051 | | :--- | :--- |
4052 | | **security-level** | `LEVEL 9 (UI Safe) */` |
4053 | | **invariant** | `Must gracefully handle empty navigation states (Guest Mode). */` |
4054 | 
4055 | **Components & Logic:**
4056 | 
4057 | * **`ShellLayout`**
4058 |   * **Logic Flow:**
4059 |     * `‚ö° COMMAND-K STATE`
4060 |     * `‚ö° DIAGNOSTIC: Log Mount`
4061 |     * `‚ö° KEYBOARD LISTENER (Discovery Engine)`
4062 |     * `1. DATA PREP (Flatten for Search)`
4063 |     * `‚ö° SEARCH FILTER LOGIC`
4064 |     * `Match Label`
4065 |     * `Match Key`
4066 |     * `‚ö° MATCH SEARCH TAGS (The "Dark Mode" -> "Appearance" Magic)`
4067 |     * `2. NAVIGATION HANDLER`
4068 |     * `A. Intercept Actions`
4069 |     * `B. Standard Navigation`
4070 |     * `User Menu Items`
4071 |     * `Fallbacks if empty`
4072 |     * `‚ö° BUILD SIDEBAR (From DB)`
4073 | 
4074 | ---
4075 | ### üìÑ `Sidebar.tsx`
4076 | > Renders a collapsible data-driven sidebar with integrated branding toggle.
4077 | 
4078 | | Attribute | Value |
4079 | | :--- | :--- |
4080 | | **security-level** | `LEVEL 5 (Presentation) */` |
4081 | 
4082 | **Components & Logic:**
4083 | 
4084 | * **`SidebarProps`**
4085 | * **`Sidebar`**
4086 |   * **Logic Flow:**
4087 |     * `‚ö° HELPER: Recursive Menu Item Builder`
4088 |     * `‚ö° ACTIVE STATE RESOLUTION`
4089 | 
4090 | ---
4091 | ### üìÑ `SidebarWrapper.tsx`
4092 | > Filters the menu structure based on Governance Rules.
4093 | 
4094 | **Components & Logic:**
4095 | 
4096 | * **`useSidebarSecurity`**
4097 |   * **Logic Flow:**
4098 |     * `If manifest isn't loaded yet, show default items (fail open/safe)`
4099 |     * `‚ö° FIX: Defensive Casting. item.id might be a number (DB ID).`
4100 |     * `Always allow System items (SYS) and Root (/)`
4101 |     * `Find config in Manifest`
4102 |     * `If module exists in manifest, obey its switches`
4103 |     * `Recursive check for children (Folders)`
4104 |     * `Optional: Hide empty folders if desired`
4105 |     * `if (item.children.length === 0) return false;`
4106 | 
4107 | ---
4108 | ### üìÑ `ThemeContext.tsx`
4109 | > FILEPATH: frontend/src/platform/shell/ThemeContext.tsx */
4110 | 
4111 | **Components & Logic:**
4112 | 
4113 | * **`ThemeProvider`**
4114 |   * **Logic Flow:**
4115 |     * `1. Initialize State from LocalStorage`
4116 |     * `2. Actions`
4117 |     * `Update HTML attribute for global CSS hooks (e.g. scrollbars)`
4118 |     * `3. Compute Config`
4119 |     * `Helper: Is this a dark theme? (Void, Midnight, Cyberpunk are dark)`
4120 |     * `4. Effects`
4121 | * **`useTheme`**
4122 | 
4123 | ---
4124 | ### üìÑ `ThemePicker.tsx`
4125 | > FILEPATH: frontend/src/platform/shell/ThemePicker.tsx */
4126 | 
4127 | **Components & Logic:**
4128 | 
4129 | * **`ThemePicker`**
4130 | 
4131 | ---
4132 | ### üìÑ `theme.ts`
4133 | > FILEPATH: frontend/src/platform/shell/theme.ts */
4134 | 
4135 | **Components & Logic:**
4136 | 
4137 | * **`ThemePreset`**
4138 |   * üìù *--- TYPES ---*
4139 | * **`PRESET_COLORS`**
4140 |   * **Logic Flow:**
4141 |     * `--- PALETTE DEFINITIONS ---`
4142 |     * `1. VOID (Original Dark)`
4143 |     * `2. POLAR (Original Light)`
4144 |     * `3. MIDNIGHT (Deep Purple/Blue Focus)`
4145 |     * `4. ENTERPRISE (SaaS Standard)`
4146 |     * `5. CYBERPUNK (High Contrast Neon)`
4147 | * **`getThemeConfig`**
4148 |   * **Logic Flow:**
4149 |     * `Override with Preset Specifics`
4150 | 
4151 | ---
4152 | ## üìÇ `frontend/src/platform/ui/`
4153 | 
4154 | ### üìÑ `ProcessView.tsx`
4155 | > A standalone view for executing a specific process instance.
4156 | 
4157 | **Components & Logic:**
4158 | 
4159 | * **`ProcessView`**
4160 |   * **Logic Flow:**
4161 |     * `Hardcoded flow for now, will be dynamic in Level 5`
4162 | 
4163 | ---
4164 | ## üìÇ `frontend/src/platform/ui/animation/`
4165 | 
4166 | ### üìÑ `FadeIn.tsx`
4167 | > Standardized entry animation wrapper.
4168 | 
4169 | **Components & Logic:**
4170 | 
4171 | * **`FadeIn`**
4172 |   * **Logic Flow:**
4173 |     * `‚ö° TELEMETRY: Communicate the transition`
4174 | 
4175 | ---
4176 | ## üìÇ `frontend/src/platform/ui/icons/`
4177 | 
4178 | ### üìÑ `IconFactory.tsx`
4179 | > Converts string tokens into Ant Design Icons.
4180 | 
4181 | **Components & Logic:**
4182 | 
4183 | * **`IconFactory`**
4184 |   * **Logic Flow:**
4185 |     * `1. Pass-through if it's already a React Node (e.g. from static config)`
4186 |     * `2. Fallback for empty/null`
4187 |     * `Return an invisible span to keep layout stable`
4188 |     * `3. Parse "antd:IconName"`
4189 |     * `4. Resolve Component`
4190 |     * `5. Render or Warn`
4191 |     * `Fallback for missing icon`
4192 | 
4193 | ---
4194 | ## üìÇ `frontend/src/platform/ui/layout/`
4195 | 
4196 | ### üìÑ `MasterDetailShell.tsx`
4197 | > FILEPATH: frontend/src/platform/ui/layout/MasterDetailShell.tsx */
4198 | 
4199 | **Components & Logic:**
4200 | 
4201 | * **`MasterDetailShellProps`**
4202 | * **`MasterDetailShell`**
4203 |   * **Logic Flow:**
4204 |     * `1. STATE: Sidebar Collapse (with Persistence)`
4205 |     * `Trigger resize event for charts/grids to adjust`
4206 | 
4207 | ---
4208 | ## üìÇ `frontend/src/platform/ui/list/`
4209 | 
4210 | ### üìÑ `SmartListItem.tsx`
4211 | > FILEPATH: frontend/src/platform/ui/list/SmartListItem.tsx */
4212 | 
4213 | **Components & Logic:**
4214 | 
4215 | * **`SmartListItemProps`**
4216 |   * **Logic Flow:**
4217 |     * `Data`
4218 |     * `Status flags`
4219 |     * `Optional Tags (Full mode only)`
4220 | * **`SmartListItem`**
4221 |   * **Logic Flow:**
4222 |     * `--- MODE A: COMPACT (Dock Style) ---`
4223 |     * `--- MODE B: FULL (List Style) ---`
4224 | 
4225 | ---
4226 | ## üìÇ `frontend/src/platform/ui/widgets/`
4227 | 
4228 | ### üìÑ `ActionButtonWidget.tsx`
4229 | > FILEPATH: frontend/src/platform/ui/widgets/ActionButtonWidget.tsx
4230 | 
4231 | | Attribute | Value |
4232 | | :--- | :--- |
4233 | | **security-level** | `LEVEL 9 (Intent Logging)` |
4234 | | **invariant** | `Click must emit intent telemetry.` |
4235 | | **narrator** | `Logs user interaction and target scope.` |
4236 | 
4237 | **Components & Logic:**
4238 | 
4239 | * **`ActionButtonWidget`**
4240 |   * **Logic Flow:**
4241 |     * `1. Destructure Backend Config`
4242 |     * `Properties defined in DB: "label", "danger", "action_type", "target_scope"`
4243 |     * `2. Handle Interaction`
4244 |     * `‚ö° NARRATOR: Announce Intent`
4245 |     * `‚ö° SIMULATION (Until WizardContext is fully wired)`
4246 |     * `In a real implementation, this would call 'wizard.spawn(target_scope)'`
4247 | 
4248 | ---
4249 | ### üìÑ `DescriptionListWidget.tsx`
4250 | > FILEPATH: frontend/src/platform/ui/widgets/DescriptionListWidget.tsx
4251 | 
4252 | | Attribute | Value |
4253 | | :--- | :--- |
4254 | | **security-level** | `LEVEL 9 (Pure Presentation)` |
4255 | | **invariant** | `Renders key-value pairs or static text strictly.` |
4256 | | **narrator** | `Logs visibility state.` |
4257 | 
4258 | **Components & Logic:**
4259 | 
4260 | * **`DescriptionListWidget`**
4261 |   * **Logic Flow:**
4262 |     * `1. Destructure Backend Config`
4263 |     * `fieldProps comes from the schema (e.g., { "value": "Set...", "column": 2 })`
4264 |     * `2. Resolve Content`
4265 |     * `Value can come from form data (value) or static config (fieldProps.value)`
4266 | 
4267 | ---
4268 | ### üìÑ `SecurePasswordWidget.tsx`
4269 | > Password input with built-in generator, strength meter, and clipboard copy.
4270 | 
4271 | | Attribute | Value |
4272 | | :--- | :--- |
4273 | | **security-level** | `LEVEL 9 (Robust Clipboard)` |
4274 | 
4275 | **Components & Logic:**
4276 | 
4277 | * **`SecurePasswordWidget`**
4278 |   * **Logic Flow:**
4279 |     * `‚ö° ROBUST CLIPBOARD FUNCTION`
4280 |     * `Guarantees copy works even in non-secure contexts (localhost via http)`
4281 |     * `Fallback for non-secure contexts`
4282 | 
4283 | ---
4284 | ### üìÑ `UserSelectorWidget.tsx`
4285 | > Asynchronous dropdown that fetches Users from the Universal Resource API.
4286 | 
4287 | | Attribute | Value |
4288 | | :--- | :--- |
4289 | | **security-level** | `LEVEL 9 (Role Filtered)` |
4290 | 
4291 | **Components & Logic:**
4292 | 
4293 | * **`UserSelectorWidget`**
4294 |   * **Logic Flow:**
4295 |     * `1. Destructure specific props injected by the Backend Registry`
4296 |     * `2. Define the Async Loader`
4297 |     * `Call the Universal Resource API`
4298 |     * `Transform to Ant Design Select options`
4299 | 
4300 | ---
4301 | ## üìÇ `frontend/src/platform/workflow/`
4302 | 
4303 | ### üìÑ `WorkflowActions.tsx`
4304 | > Renders state transition buttons using Backend-provided metadata and Governance rules.
4305 | 
4306 | | Attribute | Value |
4307 | | :--- | :--- |
4308 | | **security-level** | `LEVEL 9 (UI Safe) */` |
4309 | | **invariant** | `Disabled state must be strictly bound to 'allowed' flag. */` |
4310 | | **narrator** | `Traces user interactions with transition buttons. */` |
4311 | 
4312 | **Components & Logic:**
4313 | 
4314 | * **`WorkflowActions`**
4315 |   * **Logic Flow:**
4316 |     * `1. Backend-Driven Metadata (No more guessing by string names)`
4317 |     * `2. The "Dumb UI" Base Component`
4318 |     * `3. ‚ö° UX UPGRADE: Explain WHY it's blocked instead of hiding it`
4319 | 
4320 | ---
4321 | ### üìÑ `WorkflowPlayer.tsx`
4322 | > FILEPATH: frontend/src/platform/workflow/WorkflowPlayer.tsx */
4323 | 
4324 | **Components & Logic:**
4325 | 
4326 | * **`WorkflowPlayer`**
4327 |   * **Logic Flow:**
4328 |     * `Interaction State`
4329 |     * `1. Fetch Options on Mount or Status Change`
4330 |     * `‚ö° GATEWAY: Use standardized base`
4331 |     * `2. Handle Click`
4332 |     * `Check if this event requires a payload (Schema check)`
4333 |     * `Instant Execution`
4334 |     * `3. Execute`
4335 |     * `4. Render Form Fields (Dynamic)`
4336 | 
4337 | ---
4338 | ## üìÇ `frontend/src/platform/workflow/api/`
4339 | 
4340 | ### üìÑ `client.ts`
4341 | > FILEPATH: frontend/src/platform/workflow/api/client.ts */
4342 | 
4343 | **Components & Logic:**
4344 | 
4345 | * **`workflowApi`**
4346 |   * **Logic Flow:**
4347 |     * `‚ö° GATEWAY: Use normalized base + explicit versioning`
4348 | 
4349 | ---
4350 | ## üìÇ `frontend/src/platform/workflow/components/`
4351 | 
4352 | ### üìÑ `WizardPlayer.tsx`
4353 | > Smartly switches between Form-based (Input) and View-based (Grid) modes.
4354 | 
4355 | | Attribute | Value |
4356 | | :--- | :--- |
4357 | | **updated** | `Added Registry Gatekeeper to prevent premature layout calculation.` |
4358 | 
4359 | **Components & Logic:**
4360 | 
4361 | * **`WizardPlayer`**
4362 |   * **Logic Flow:**
4363 |     * `‚ö° REGISTRY ACCESS`
4364 |     * `‚ö° HYBRID DETECTION (MEMOIZED)`
4365 |     * `Only calculate this when the registry is ready to avoid false "Input" classification on fallbacks`
4366 |     * `Categories that REQUIRE a Form Context (User Input)`
4367 |     * `Log decision for debugging`
4368 |     * `logger.whisper("PLAYER", `Detected Input Widget: [${f.name}] (${def.key}) -> Category: ${def.category}`);`
4369 |     * `If we have ANY inputs, it's NOT a view step. It's a Form step.`
4370 |     * `Detect if this is a "Submit" action`
4371 |     * `‚ö° DYNAMIC LABEL LOGIC`
4372 |     * `‚ö° GATEKEEPER: Wait for BOTH logic and registry to be ready`
4373 | 
4374 | ---
4375 | ### üìÑ `WorkflowPlayer.tsx`
4376 | > FILEPATH: frontend/src/platform/workflow/components/WorkflowPlayer.tsx */
4377 | 
4378 | **Components & Logic:**
4379 | 
4380 | * **`WorkflowPlayerProps`**
4381 | * **`WorkflowPlayer`**
4382 |   * **Logic Flow:**
4383 |     * `UI State`
4384 |     * `Check Schema`
4385 |     * `--- RENDERERS ---`
4386 |     * `Simple Widget Mapping (Expandable)`
4387 | 
4388 | ---
4389 | ## üìÇ `frontend/src/platform/workflow/`
4390 | 
4391 | ### üìÑ `index.ts`
4392 | > FILEPATH: frontend/src/platform/workflow/index.ts */
4393 | 
4394 | ---
4395 | ## üìÇ `frontend/src/platform/workflow/logic/`
4396 | 
4397 | ### üìÑ `types.ts`
4398 | > FILEPATH: frontend/src/platform/workflow/logic/types.ts */
4399 | 
4400 | **Components & Logic:**
4401 | 
4402 | * **`TransitionOption`**
4403 |   * üìù *FILEPATH: frontend/src/platform/workflow/logic/types.ts */*
4404 | * **`TransitionResponse`**
4405 | * **`WorkflowState`**
4406 | 
4407 | ---
4408 | ### üìÑ `useWizardLogic.ts`
4409 | > Manages State, Data Collection, and Execution Mode.
4410 | 
4411 | **Components & Logic:**
4412 | 
4413 | * **`useWizardLogic`**
4414 |   * **Logic Flow:**
4415 |     * `1. CONTEXT`
4416 |     * `Treat '/app/' routes as Production environments`
4417 |     * `2. STATE`
4418 |     * `3. BOOT TELEMETRY`
4419 |     * `4. HYDRATION`
4420 |     * `5. FETCH DEFINITION`
4421 |     * `üîß SHIM: POLYFILL CHECK`
4422 |     * `6. INITIALIZATION & RECOVERY`
4423 |     * `Only run if we have data and haven't set a step yet`
4424 |     * `‚ö° RESOLVE INITIAL STEP: Use API initial, or first key, or fallback`
4425 |     * `Verify step still exists in schema`
4426 |     * `Schema changed, draft invalid`
4427 |     * `7. AUTO-SAVE`
4428 |     * `8. TRANSITION ENGINE`
4429 |     * `Merge Data`
4430 |     * `Cleanup`
4431 | 
4432 | ---
4433 | ### üìÑ `useWorkflow.ts`
4434 | > FILEPATH: frontend/src/platform/workflow/logic/useWorkflow.ts */
4435 | 
4436 | **Components & Logic:**
4437 | 
4438 | * **`useWorkflow`**
4439 |   * **Logic Flow:**
4440 |     * `Initial Load`
4441 |     * `Refresh options as state has changed`
4442 | 
4443 | ---
4444 | ## üìÇ `frontend/src/platform/workflow/`
4445 | 
4446 | ### üìÑ `useWorkflow.ts`
4447 | > Determines available actions via Backend Fused Manifest and executes transitions via Dedicated API.
4448 | 
4449 | | Attribute | Value |
4450 | | :--- | :--- |
4451 | | **security-level** | `LEVEL 9 (UI Safe) */` |
4452 | | **narrator** | `Logs API requests, transition attempts, and governance results. */` |
4453 | 
4454 | **Components & Logic:**
4455 | 
4456 | * **`TransitionOption`**
4457 | * **`useWorkflow`**
4458 |   * **Logic Flow:**
4459 |     * `1. Fetch Fused Manifest from Backend (The "Dumb UI" Approach)`
4460 |     * `2. Execute Transition via Specialized API`
4461 |     * `Invalidate the entity data so the UI refreshes`
4462 |     * `‚ö° GOVERNANCE ERROR PARSING`
4463 | 
4464 | ---
4465 | ## üìÇ `frontend/src/platform/workflow/wizard-engine/`
4466 | 
4467 | ### üìÑ `FieldFactory.tsx`
4468 | > Polymorphic Router that converts JSON Schema into React Components.
4469 | 
4470 | | Attribute | Value |
4471 | | :--- | :--- |
4472 | | **architecture** | `LEVEL 10 (Registry-Driven Routing)` |
4473 | | **updated** | `Implemented Category-Based Routing to fix 'SMART_GRID' mismatch.` |
4474 | 
4475 | **Components & Logic:**
4476 | 
4477 | * **`FieldFactory`**
4478 |   * **Logic Flow:**
4479 |     * `‚ö° 1. CONSULT THE REGISTRY (The Source of Truth)`
4480 |     * `This resolves 'SMART_GRID' (Data) -> Widget Definition { category: 'DATA_DISPLAY', ... }`
4481 |     * `‚ö° TELEMETRY: Trace layout decisions`
4482 |     * `‚ö° 2. ROUTING LOGIC (CATEGORY BASED)`
4483 |     * `We route based on the *Category* defined in the DB, not the hardcoded string.`
4484 |     * `--- LAYOUTS (Groups, Tabs, Sections) ---`
4485 |     * `--- DATA GRIDS (Smart Tables) ---`
4486 |     * `P2 Logic: Route all Heavy Tables to SmartGridRenderer`
4487 |     * `This CATCHES 'SMART_GRID', 'PRO_TABLE', 'EDITABLE_TABLE' automatically.`
4488 |     * `--- FEEDBACK (Results, Empty States) ---`
4489 |     * `--- COMPLEX INPUTS (Repeater/Nested) ---`
4490 |     * `Legacy support: Some structures might not be fully migrated to Categories yet`
4491 |     * `--- PRIMITIVES (Atoms) ---`
4492 |     * `Fallback for everything else (Inputs, Selects, etc.)`
4493 | 
4494 | ---
4495 | ## üìÇ `frontend/src/platform/workflow/wizard-engine/hooks/`
4496 | 
4497 | ### üìÑ `useFieldSentinel.ts`
4498 | > FILEPATH: frontend/src/platform/workflow/wizard-engine/hooks/useFieldSentinel.ts */
4499 | 
4500 | **Components & Logic:**
4501 | 
4502 | * **`useFieldSentinel`**
4503 |   * **Logic Flow:**
4504 |     * `1. Detect Async Rules (using the explicit rules array)`
4505 |     * `2. The Global Sniper Logic`
4506 |     * `üîç DEBUG: Inspect Initialization`
4507 |     * `This tells us immediately if the Sentinel correctly identified the async requirement`
4508 |     * `üõ°Ô∏è SAFETY CHECK: Ensure target exists and is an input-like element`
4509 |     * `üéØ SNIPER SCOPE: Does this element belong to us?`
4510 |     * `üîç DEBUG: Why didn't we trigger?`
4511 |     * `logger.trace("SENTINEL", `üìù Input on [${field.name}]`);`
4512 |     * `--- ATTACHMENT ---`
4513 |     * `--- CLEANUP ---`
4514 | 
4515 | ---
4516 | ### üìÑ `useWidgetRegistry.ts`
4517 | > Provides O(1) access to the System's UI Library.
4518 | 
4519 | **Components & Logic:**
4520 | 
4521 | * **`WidgetDefinition`**
4522 | * **`useWidgetRegistry`**
4523 |   * **Logic Flow:**
4524 |     * `1. CONSUME KERNEL CAPABILITIES`
4525 |     * `We get the raw list of widgets from the backend via the Context`
4526 |     * `2. INDEXING (O(n) -> O(1))`
4527 |     * `Convert the array to a Map for instant lookups during rendering`
4528 |     * `üõ°Ô∏è NORMALIZE KEYS: DB keys are UPPERCASE.`
4529 |     * `We force upper here to be safe when looking up 'text_input' vs 'TEXT_INPUT'.`
4530 |     * `‚ö° CONNECTION VERIFICATION`
4531 |     * `Only whisper once to avoid spamming console on re-renders`
4532 |     * `logger.whisper("REGISTRY", `üîó Connected to Kernel. Indexed ${map.size} Widgets.`);`
4533 |     * `3. PUBLIC API`
4534 |     * `Expose the full list for the "Context Browser" or "Palette"`
4535 | 
4536 | ---
4537 | ## üìÇ `frontend/src/platform/workflow/wizard-engine/logic/`
4538 | 
4539 | ### üìÑ `LogicEngine.ts`
4540 | > A lightweight parser for conditional rendering strings (e.g. "host.role == 'admin'").
4541 | 
4542 | | Attribute | Value |
4543 | | :--- | :--- |
4544 | | **security-level** | `LEVEL 9 (Sandboxed Evaluation)` |
4545 | | **invariant** | `Evaluation must never crash the UI, even with invalid syntax.` |
4546 | | **narrator** | `Logs evaluation trace to F12.` |
4547 | 
4548 | **Components & Logic:**
4549 | 
4550 | * **`LogicEngine`**
4551 |   * **Logic Flow:**
4552 |     * `Regex to find "host.xyz" or "formData.xyz"`
4553 |     * `Captures 'xyz'`
4554 |     * `logger.trace("LOGIC", `üîç Analyzed dependencies for "${expression}"`, { deps });`
4555 |     * `1. Trivial Cases`
4556 |     * `2. Prepare Sandbox`
4557 |     * `We map 'host' and 'formData' to the same context for convenience`
4558 |     * `Helper for simple "contains" checks`
4559 |     * `3. Execution`
4560 |     * `üõ°Ô∏è SECURITY: Function constructor is safer than eval(), but still requires`
4561 |     * `strict input sanitization. In a Level 9 system, we'd use a parser (AST).`
4562 |     * `For now, we wrap in a try-catch sandbox.`
4563 |     * `Allow-list check (Basic prevention of window/alert access)`
4564 |     * `logger.trace("LOGIC", `‚ö° Evaluated: "${expression}"`, { result, context_sample: Object.keys(context) });`
4565 |     * `Fail Open or Closed?`
4566 |     * `For visibility (show_if), we fail CLOSED (hide it) to prevent broken UI.`
4567 |     * `For requirements (required_if), we fail OPEN (not required) to prevent blocking.`
4568 | 
4569 | ---
4570 | ## üìÇ `frontend/src/platform/workflow/wizard-engine/renderers/`
4571 | 
4572 | ### üìÑ `ComponentMap.tsx`
4573 | > Maps Backend Keys to Frontend Implementations with Deep Observability.
4574 | 
4575 | | Attribute | Value |
4576 | | :--- | :--- |
4577 | | **security-level** | `LEVEL 9 (Proxy Wrapper)` |
4578 | | **updated** | `Registered 'DESCRIPTION_LIST' and 'ACTION_BUTTON'.` |
4579 | 
4580 | **Components & Logic:**
4581 | 
4582 | * **`COMPONENT_MAP`**
4583 |   * üìù *‚ö° THE MAPPING (Wrapped)*
4584 |   * **Logic Flow:**
4585 |     * `GROUP 1: TEXT`
4586 |     * `GROUP 2: CHOICE`
4587 |     * `GROUP 3: DATE`
4588 |     * `GROUP 4: VISUAL`
4589 |     * `GROUP 5: SECURITY`
4590 |     * `GROUP 6: DOMAIN`
4591 |     * `‚ö° GROUP 7: DATA & ACTIONS (The Missing Pieces)`
4592 | 
4593 | ---
4594 | ### üìÑ `DynamicWidget.tsx`
4595 | > Intelligent wrapper that dehydrates Backend Config and injects Logic Responsiveness.
4596 | 
4597 | | Attribute | Value |
4598 | | :--- | :--- |
4599 | | **security-level** | `LEVEL 9 (Sanitized Merge + Reactive Wrapper)` |
4600 | | **updated** | `Integrated 'DependencyWrapper' to enable 'show_if' and 'disabled_if' logic.` |
4601 | 
4602 | **Components & Logic:**
4603 | 
4604 | * **`DynamicWidget`**
4605 |   * **Logic Flow:**
4606 |     * `1. Get Definition from Backend Registry`
4607 |     * `2. Resolve Physical Component`
4608 |     * `3. Merge Props (Backend Defaults < Runtime Overrides < Logic)`
4609 |     * `Extract defaults from schema if available`
4610 |     * `‚ö° CRITICAL FIX: SANITIZE CUSTOM PROPS`
4611 |     * `We must REMOVE 'rules' from customProps because they contain`
4612 |     * `raw strings (e.g. "validator": "checkUniqueness") which crash`
4613 |     * `the form engine. The Logic Layer (commonProps) owns the rules.`
4614 |     * `Merge nested fieldProps deeply`
4615 |     * `üîç DEEP NARRATOR INSPECTION`
4616 |     * `4. Fallback for Unknowns`
4617 |     * `5. EXTRACT LOGIC PROPS`
4618 |     * `These keys drive the DependencyWrapper and shouldn't necessarily pass to the widget`
4619 |     * `6. RENDER (Wrapped in Logic Engine)`
4620 | 
4621 | ---
4622 | ### üìÑ `EmptyRenderer.tsx`
4623 | > Renders Ant Design Empty component.
4624 | 
4625 | | Attribute | Value |
4626 | | :--- | :--- |
4627 | | **security-level** | `LEVEL 9 (Visual Consistency)` |
4628 | | **invariant** | `Must visually indicate 'No Data'.` |
4629 | | **narrator** | `Silent (Passive UI).` |
4630 | 
4631 | **Components & Logic:**
4632 | 
4633 | * **`EmptyRenderer`**
4634 |   * **Logic Flow:**
4635 |     * `Backend schema: { component: "EMPTY", fieldProps: { description: "No items found" } }`
4636 |     * `Map string image names to AntD constants if needed,`
4637 |     * `otherwise default to standard SIMPLE/PRESENTED logic or allow null.`
4638 | 
4639 | ---
4640 | ### üìÑ `GroupRenderer.tsx`
4641 | > Renders ProFormGroup, ProCard (Section), or ProCard (Tabs).
4642 | 
4643 | | Attribute | Value |
4644 | | :--- | :--- |
4645 | | **security-level** | `LEVEL 9 (Infinite Recursion Safe)` |
4646 | | **invariant** | `Must render children via FieldFactory to maintain Logic capabilities.` |
4647 | | **narrator** | `Logs layout structure.` |
4648 | 
4649 | **Components & Logic:**
4650 | 
4651 | * **`GroupRenderer`**
4652 |   * **Logic Flow:**
4653 |     * `Default to first tab or a generic key if empty`
4654 |     * `1. Validate Structure`
4655 |     * `2. Resolve Children (Recursive Render Helper)`
4656 |     * `Inherit disabled state if parent is disabled`
4657 |     * `3. LAYOUT MODE: TABS`
4658 |     * `4. LAYOUT MODE: SECTION (Card)`
4659 |     * `If it has a label but no specific component type (or explicitly SECTION), treat as a Section`
4660 |     * `5. LAYOUT MODE: INLINE GROUP (Default)`
4661 |     * `ProFormGroup (Visual grouping for alignment, usually horizontal)`
4662 | 
4663 | ---
4664 | ### üìÑ `PrimitiveRenderer.tsx`
4665 | > Delegates rendering to DynamicWidget with Level 9 Props Normalization.
4666 | 
4667 | | Attribute | Value |
4668 | | :--- | :--- |
4669 | | **security-level** | `LEVEL 9 (Data Injection + State Enforcement)` |
4670 | | **updated** | `Integrated 'normalizeProps' to fix the "Locked Email" bug.` |
4671 | 
4672 | **Components & Logic:**
4673 | 
4674 | * **`PrimitiveRenderer`**
4675 |   * **Logic Flow:**
4676 |     * `0. DEFENSIVE: Snapshot rules`
4677 |     * `1. EVENT SENTINEL (Validation Sniper)`
4678 |     * `2. RULE HYDRATION (Async Validator Logic)`
4679 |     * `3. ‚ö° PROPS NORMALIZATION (The Fix)`
4680 |     * `We delegate all prop calculation to the Level 9 Engine.`
4681 |     * `A. Run the Normalizer`
4682 |     * `B. Inject Runtime Bindings (Handlers & Data)`
4683 |     * `‚ö° DATA INJECTION: Support Read-Only widgets reading directly from context`
4684 |     * `‚ö° LOGIC INJECTION: Hydrated Rules & Sentinel`
4685 |     * `‚ö° ASYNC OPTIONS (If request URL exists)`
4686 |     * `4. RENDER`
4687 | 
4688 | ---
4689 | ### üìÑ `ResultRenderer.tsx`
4690 | > Renders a Result page. Allows injecting buttons via 'columns' array.
4691 | 
4692 | | Attribute | Value |
4693 | | :--- | :--- |
4694 | | **security-level** | `LEVEL 9 (Recursion Enabled)` |
4695 | | **invariant** | `Must support all standard AntD status codes (403, 404, 500, success).` |
4696 | | **narrator** | `Logs feedback events.` |
4697 | 
4698 | **Components & Logic:**
4699 | 
4700 | * **`ResultRenderer`**
4701 |   * **Logic Flow:**
4702 |     * `1. Destructure Config`
4703 |     * `Backend schema: { component: "RESULT", fieldProps: { status: "404", title: "Missing" } }`
4704 |     * `2. Telemetry`
4705 |     * `3. Resolve "Extra" (Buttons/Actions)`
4706 |     * `If the schema defines 'columns', we render them in the 'extra' slot of the Result`
4707 |     * `This allows backend-driven "Back to Home" or "Retry" buttons.`
4708 | 
4709 | ---
4710 | ### üìÑ `SmartGridRenderer.tsx`
4711 | > Renders a Server-Side Data Grid with Context-Aware Actions.
4712 | 
4713 | | Attribute | Value |
4714 | | :--- | :--- |
4715 | | **security-level** | `LEVEL 9 (Icon Safe + Dynamic Scope)` |
4716 | | **updated** | `Fixed logic to switch between 'create_flow' and 'edit_flow'. Added key-reset.` |
4717 | 
4718 | **Components & Logic:**
4719 | 
4720 | * **`SmartGridRenderer`**
4721 |   * **Logic Flow:**
4722 |     * `Local State for "Sub-Wizard"`
4723 |     * `1. CONFIGURATION EXTRACTION`
4724 |     * `‚ö° DYNAMIC SCOPE LOGIC`
4725 |     * `We read these from the Backend Schema (passed via 'field')`
4726 |     * `‚ö° CALCULATE ACTIVE SCOPE`
4727 |     * `‚ö° KEY CHANGE: Force remount if ID changes`
4728 | 
4729 | ---
4730 | ### üìÑ `TableRenderer.tsx`
4731 | > Recursive component for rendering arrays of objects.
4732 | 
4733 | **Components & Logic:**
4734 | 
4735 | * **`TableRenderer`**
4736 |   * **Logic Flow:**
4737 |     * `Safety Check: Table must have columns`
4738 |     * `Force smaller width inside tables if not specified`
4739 | 
4740 | ---
4741 | ## üìÇ `frontend/src/platform/workflow/wizard-engine/`
4742 | 
4743 | ### üìÑ `types.ts`
4744 | > FILEPATH: frontend/src/platform/workflow/wizard-engine/types.ts
4745 | 
4746 | | Attribute | Value |
4747 | | :--- | :--- |
4748 | | **security-level** | `LEVEL 9 (Type Safety)` |
4749 | | **updated** | `Added 'formData' to RenderContext for Read-Only binding.` |
4750 | 
4751 | **Components & Logic:**
4752 | 
4753 | * **`WizardFieldSchema`**
4754 |   * üìù *FILEPATH: frontend/src/platform/workflow/wizard-engine/types.ts*
4755 |   * **Logic Flow:**
4756 |     * `Identity`
4757 |     * `State & Visibility`
4758 |     * `Data & Validation`
4759 |     * `Options (Select/Radio)`
4760 |     * `Structure (Nested/Grid)`
4761 |     * `‚ö° NEW: Defines columns for ProTable/SmartGrid components`
4762 |     * `Container Props`
4763 |     * `Extension Bag (for custom props not typed above)`
4764 | * **`WizardStepSchema`**
4765 | * **`RenderContext`**
4766 |   * **Logic Flow:**
4767 |     * `‚ö° DATA INJECTION: Allows widgets to read state without Form binding`
4768 | 
4769 | ---
4770 | ## üìÇ `frontend/src/platform/workflow/wizard-engine/utils/`
4771 | 
4772 | ### üìÑ `propsNormalizer.ts`
4773 | > Translates Backend JSON Schema (snake_case) to Ant Design React Props (camelCase).
4774 | 
4775 | | Attribute | Value |
4776 | | :--- | :--- |
4777 | | **security-level** | `LEVEL 9 (Strict Type Enforcement)` |
4778 | | **invariant** | `Backend State (read_only) must ALWAYS override Component Default State.` |
4779 | | **narrator** | `Silent utility, used by Renderers.` |
4780 | 
4781 | **Components & Logic:**
4782 | 
4783 | * **`normalizeProps`**
4784 |   * üìù *Normalizes backend field schema into strict React props.*
4785 |   * **Logic Flow:**
4786 |     * `1. EXTRACT RAW CONFIG`
4787 |     * `fieldProps bag contains the loose JSON from the DB`
4788 |     * `2. STATE NORMALIZATION (The "Locked Field" Fix)`
4789 |     * `We check ALL possible backend keys for "Read Only" intent.`
4790 |     * `3. LAYOUT NORMALIZATION`
4791 |     * `Map backend layout concepts to AntD Grid/Form props`
4792 |     * `4. CONSTRUCT BASE PROPS`
4793 |     * `Identity`
4794 |     * `Layout`
4795 |     * `Data Binding`
4796 |     * `‚ö° STATE ENFORCEMENT (Level 9 Invariant)`
4797 |     * `We set BOTH 'readonly' (ProForm) and 'disabled' to be safe.`
4798 |     * `For inputs, we also force HTML attributes via 'fieldProps'.`
4799 |     * `Visibility`
4800 |     * `5. COMPONENT-SPECIFIC SAFETY (Edge Cases)`
4801 |     * `Prevent dropdowns from opening if they are read-only`
4802 |     * `6. INJECT RAW PROPS (Low Priority)`
4803 |     * `We merge the remaining raw props, but specific keys above take precedence.`
4804 |     * `This allows the DB to pass 'addonAfter' or 'prefix' seamlessly.`
4805 |     * `‚ö° DEEP MERGE for fieldProps to ensure HTML attributes stick`
4806 |     * `HTML-level enforcement`
4807 | 
4808 | ---
4809 | ## üìÇ `frontend/src/platform/workflow/wizard-engine/wrappers/`
4810 | 
4811 | ### üìÑ `DependencyWrapper.tsx`
4812 | > Wraps widgets to provide Conditional Rendering and disabling logic.
4813 | 
4814 | | Attribute | Value |
4815 | | :--- | :--- |
4816 | | **security-level** | `LEVEL 9 (Reactive Isolation)` |
4817 | | **invariant** | `If 'show_if' evaluates false, children must not be in the DOM.` |
4818 | | **narrator** | `Logs dependency triggers.` |
4819 | 
4820 | **Components & Logic:**
4821 | 
4822 | * **`DependencyWrapper`**
4823 |   * **Logic Flow:**
4824 |     * `1. Calculate what fields to listen to`
4825 |     * `2. If no logic, render children directly (Performance)`
4826 |     * `If static boolean hidden=true, Handle upstream in renderer.`
4827 |     * `This wrapper specifically handles DYNAMIC dependencies.`
4828 |     * `3. Render the Reactor`
4829 |     * `values contains the current state of the dependent fields`
4830 |     * `A. Evaluate Visibility`
4831 |     * `logger.trace("UI", "üëª Hidden by Logic", { showIf, values });`
4832 |     * `B. Evaluate Disabled State`
4833 |     * `C. Render Child`
4834 |     * `We pass the calculated state down if the child is a function`
4835 |     * `If child is a node, we clone it to inject disabled prop if supported,`
4836 |     * `but usually the child is the PrimitiveRenderer which handles its own props.`
4837 |     * `The 'disabled' prop injection here is a fallback.`
4838 | 
4839 | ---

================================================================================

# Source code from: main_prompt.txt
-------------------------------------
   1 | You are "The Sovereign Engineer".
   2 | Supervisor: The Architect (The User).
   3 | Mission: Engineer an Enterprise Operating System (Flodock) using Fractal Architecture.
   4 | Prime Directive: "Invariants are Law. Context is Holy. Narrate Everything."
   5 | if you dont know the complete file path yu want give me a search command I can use in shell script to find the file path for you?
   6 | üõë SECTION 1: THE PRIME DIRECTIVES (Non-Negotiable)
   7 | If you violate these rules, the session is considered failed.
   8 | 
   9 | NO GHOST CODING (The Smart Copy Rule):
  10 | 
  11 | You must NEVER write code for a file without asking the user to provide its latest content first.
  12 | 
  13 | Action: Ask: >> PLEASE SMART COPY: [File/Folder Path]
  14 | 
  15 | NO UNAUTHORIZED EXECUTION:
  16 | 
  17 | You are locked in "Analysis Mode" by default.
  18 | 
  19 | You cannot switch to "Coding Mode" without explicit user approval (e.g., "Approved", "Go ahead").
  20 | 
  21 | MAXIMUM 3 FILES PER RESPONSE:
  22 | 
  23 | To guarantee completeness, you are strictly limited to generating 2 files per response.
  24 | 
  25 | If a task requires more, stop and ask permission to continue.
  26 | 
  27 | COMPLETE CODE ONLY:
  28 | 
  29 | NEVER provide snippets, "rest of code", or placeholders.
  30 | 
  31 | You must generate the ENTIRE file content every time, even for a one-line change.
  32 | 
  33 | FRACTAL ARCHITECTURE ENFORCEMENT:
  34 | 
  35 | Colocation: Code must be organized by FEATURE (/domains/auth/features/login), not by Type (/components).
  36 | 
  37 | No Monoliths: Reject any plan that creates large, coupled files.
  38 | 
  39 | Public API: Every feature folder must have an index.ts (or __init__.py) that exports only the public surface area.
  40 | 
  41 | SIGNAL TELEMETRY (The Narrator):
  42 | 
  43 | No console.log: You must use the logger (Narrator) for all output.
  44 | 
  45 | Syntax: logger.tell("SYSTEM", "User Logged In") or logger.scream("API", "Connection Failed").
  46 | 
  47 | RECURSIVE COMPLIANCE (The Golden Rule):
  48 | 
  49 | No Exceptions for Tools: Any script, map, or utility you generate (e.g., cartographer.py, seed.py) MUST ITSELF strictly obey the Coding Standards.
  50 | 
  51 | Self-Documentation: You cannot enforce rules you do not follow. If you write a tool to parse comments, that tool's methods must have comments.
  52 | 
  53 | üìú SECTION 2: THE FLODOCK CODEX (Coding Standards)
  54 | You must strictly adhere to the Semantic Contract for all code generation. The Cartographer Engine relies on these tags to map the system.
  55 | 
  56 | 1. The Metadata Header (Mandatory)
  57 | Every file (Application OR Script) must begin with this block.
  58 | 
  59 | For TypeScript/React (.ts, .tsx):
  60 | 
  61 | TypeScript
  62 | /* FILEPATH: src/domains/auth/features/login/LoginScreen.tsx */
  63 | /* @file: Login Screen Component */
  64 | /* @role: üñ•Ô∏è Screen (View) */
  65 | /* @author: The Engineer */
  66 | /* @description: Renders the login form and handles submission events. */
  67 | /* @security-level: LEVEL 5 (Presentation) */
  68 | /* @invariant: Submit button must be disabled while 'isAuthenticating' is true. */
  69 | /* @narrator: Logs 'LOGIN_ATTEMPT' events to the console. */
  70 | For Python (.py):
  71 | 
  72 | Python
  73 | # FILEPATH: backend/cartographer.py
  74 | # @file: The Cartographer
  75 | # @role: ‚öôÔ∏è System Tool
  76 | # @author: The Engineer (ansav8@gmail.com)
  77 | # @description: Scans the codebase to generate a semantic atlas.
  78 | # @security-level: LEVEL 9 (Read-Only)
  79 | # @invariant: Must never modify the source code it scans.
  80 | # @narrator: Logs scan progress and parse errors.
  81 | 2. Semantic Method Documentation (Mandatory)
  82 | EVERY exported function, class, or method must have a Docstring/JSDoc that explains WHY it exists.
  83 | 
  84 | Python:
  85 | 
  86 | Python
  87 | def calculate_tax(amount: float) -> float:
  88 |     """
  89 |     @description: Calculates VAT based on 2024 EU Rules.
  90 |     @invariant: Output must never be negative.
  91 |     """
  92 |     return amount * 0.20
  93 | TypeScript:
  94 | 
  95 | TypeScript
  96 | /**
  97 |  * @description: Authenticates the user against the Kernel Registry.
  98 |  * @invariant: Must clear previous session before attempting login.
  99 |  */
 100 | async function login(creds: Credentials): Promise<void> { ... }
 101 | 3. Data Hygiene Protocol
 102 | üü¢ GREEN ZONE (Visuals): Emojis allowed in Logs, UI Labels, Comments.
 103 | 
 104 | üî¥ RED ZONE (Structure): STRICT ASCII ONLY for Database Columns, API Keys, Enums, and File Names.
 105 | 
 106 | Bad: status_üöÄ
 107 | 
 108 | Good: status_active
 109 | 
 110 | üîÑ SECTION 3: THE WORKFLOW LOOP
 111 | You must strictly follow this state machine.
 112 | 
 113 | PHASE A: DIAGNOSIS & SYNC (Default State)
 114 | Analyze: Think about the request from a "Level 9 OS" perspective.
 115 | 
 116 | Context Check: Do you have the latest file content?
 117 | 
 118 | If NO: Output: >> PLEASE SMART COPY: [Paths]
 119 | 
 120 | If YES: Proceed to Phase B.
 121 | 
 122 | Stop: Do not propose a solution yet. Wait for files.
 123 | 
 124 | PHASE B: STRATEGY & APPROVAL
 125 | Review: Analyze the provided code.
 126 | 
 127 | Fractal Audit: Ensure strict feature isolation.
 128 | 
 129 | Plan: Explain the architecture of the change.
 130 | 
 131 | Ask: "Do you approve this plan?"
 132 | 
 133 | PHASE C: EXECUTION (Coding Mode)
 134 | Triggered only after User says "Approved".
 135 | 
 136 | Check Limit: Confirm generation is ‚â§ 2 files.
 137 | 
 138 | Generate: Write COMPLETE code with the Mandatory Header and Semantic Docstrings.
 139 | 
 140 | Verify: Ensure no omissions.
 141 | 
 142 | üìù SECTION 4: MANDATORY OUTPUT FORMATS
 143 | 1. The Code Block
 144 | Always use the correct language syntax for the header.
 145 | 
 146 | TypeScript
 147 | /* FILEPATH: path/to/file.ts */
 148 | /* @file ... */
 149 | ... full code ...
 150 | 2. The Project State Footer (REQUIRED on EVERY response)
 151 | This anchors the session state.
 152 | 
 153 | Plaintext
 154 | [PROJECT STATE BLOCK]
 155 | Task ID: [Unique ID, e.g. P1-S1]
 156 | Feature: [Name]
 157 | Phase: [1-Diagnosis | 2-Strategy | 3-Execution | 4-Verification]
 158 | Status: [üî¥ ANALYSIS | üü° SYNCING | üü¢ CODING]
 159 | Sync Check: [‚úÖ LATEST CODE USED | ‚ö†Ô∏è ASSUMED (VIOLATION)]
 160 | Files Delivered: [X] of [2 Limit]
 161 | Code Integrity: [‚úÖ FULL | ‚ùå TRUNCATED]
 162 | 
 163 | NEXT ACTION MENU (Select & Copy one):
 164 | > [Option 1]: >> APPROVE. Proceed to code generation.
 165 | > [Option 2]: >> PROVIDE FILES. I will paste the content now.
 166 | > [Option 3]: >> REVISE. I disagree with the plan.
================================================================================


================================================================================
# SYSTEM INSTRUCTION: THE "STRICT ARCHITECT" PROTOCOL (v4.0)
================================================================================
SYSTEM INSTRUCTION: THE "LEVEL 5" ENGINEER PROTOCOL (v5.0 - Fractal Edition)
IDENTITY: You are "The Engineer" (ansav8@gmail.com). 
SUPERVISOR: I am "The Architect." 
MISSION: Build an Enterprise Operating System. 
PRIME DIRECTIVE: Translate architectural vision into flawless, fractal, modular code. 

üö´ BANNED: "Quick screens," temporary hacks, and "Layer-Based" folders (e.g., /components, /services).
‚úÖ REQUIRED: "Fractal Feature-Based" Architecture (Colocation of UI, Logic, and State).

üõë SECTION 1: THE PRIME DIRECTIVES (Non-Negotiable)
If you violate these rules, the session is considered failed.

1. NO GHOST CODING (The Smart Copy Rule): 
   You must NEVER write code for a file without asking me to provide its latest content first. 
   * If you need a file, ask: "Please Smart Copy [File/Folder Path]."
   * Prefer requesting FOLDERS (e.g., `src/features/billing`) to get full dependency context.

2. NO UNAUTHORIZED EXECUTION: 
   You are locked in "Analysis Mode" by default. You cannot switch to "Coding Mode" without my explicit "Approved" or "Go ahead" command.

3. MAXIMUM 2 FILES PER RESPONSE (FIRM RULE): 
   To guarantee complete code delivery, you are strictly limited to generating maximum 2 files per response. If a task requires 3+ files, you MUST stop after the second file and ask permission to continue.

4. COMPLETE CODE ONLY: 
   Never provide snippets. You must generate the ENTIRE file content every time, even for a one-line change.

5. FRACTAL ARCHITECTURE ENFORCEMENT:
   You must reject any plan that creates a Monolith. Code must be organized by FEATURE, not by type. 
   (e.g., `features/auth/components` = GOOD. `src/components/auth` = REJECT).

6. ENTERPRISE MODULARITY: 
   Focus on Smart Polling, "Storyteller" Floodgate patterns, and extreme verbosity in logging. Logic must be "Operating System Grade"‚Äîrobust, self-healing, and strictly typed.

üîÑ SECTION 2: THE WORKFLOW LOOP
PHASE A: DIAGNOSIS & SYNC (Default State)
Trigger: I give a task or report a bug. Your Protocol:
   1. Analyze: Think about the problem from a "Level 5 OS" perspective (Security, Scalability, Fractal Modularity).
   2. Context Check: Do you have the latest files? 
      * If NO: List the exact paths and ask: ">> PLEASE SMART COPY: [Paths] or combine"
      * If YES: Proceed to Phase B.
   3. Stop: Do not propose the solution yet. Wait for the files.

PHASE B: STRATEGY & APPROVAL
Trigger: I provide the file contents (via Smart Copy or Paste). Your Protocol:
   1. Review: Analyze the code provided.
   2. Fractal Audit: Ensure the changes respect strict feature isolation (no cross-contamination).
   3. Plan: Explain exactly what you will change and why.
   4. Ask: "Do you approve this plan?"

PHASE C: EXECUTION (Coding Mode)
Trigger: I say "Approved" or use an >> APPROVE command. Your Protocol:
   1. Check Limit: Confirm you are generating ‚â§ 2 files.
   2. Generate: Write the COMPLETE code.
   3. Format: Use the "Mandatory Code Format" below.
   4. Verify: Check for omissions (Green/Red check).

üìù SECTION 3: MANDATORY OUTPUT FORMATS
1. The Code Block Format
(Must be used whenever generating code. CRITICAL: The internal header must use the correct comment syntax for the language).

FILEPATH: /path/to/actual/file.ext

Code snippet

[USE NATIVE COMMENT SYNTAX]
# For Python/Shell/YAML:
# FILEPATH: /path/to/actual/file.ext
# @file ... [Standard Header with Author ansav8@gmail.com] ...

# For HTML/XML:
# For JS/CSS/C/Java:
/* FILEPATH: /path/to/actual/file.ext */
/* @file ... [Standard Header with Author ansav8@gmail.com] ... */

[... FULL COMPLETE CODE - NO OMISSIONS ...]

2. The Project State Footer (REQUIRED on EVERY END OF the message)
This is the anchor that keeps you in sync. You must generate the "Next Action Menu" with specific options I can copy.

Plaintext

[PROJECT STATE BLOCK]
Task ID: [Unique ID, e.g., P1-S2]
Feature: [Name]
Phase: [Phase #] - [Phase Name]
Status: [üî¥ ANALYSIS | üü° SYNCING | üü¢ CODING]
Sync Check: [‚úÖ LATEST CODE USED | ‚ö†Ô∏è ASSUMED (VIOLATION)]
Files Delivered: [X] of [Total Required] (Limit 2 per prompt)
Code Integrity: [‚úÖ FULL / ‚ùå TRUNCATED / ‚ö™ N/A]

NEXT ACTION MENU (Select & Copy one):
> [Option 1]: >> APPROVE [Task ID]. Proceed to code generation.
> [Option 2]: >> CONTINUE. Generate the next batch of files.
> [Option 3]: >> PROVIDE FILES. I will run Smart Copy and paste the content now.
> [Option 4]: >> REVISE [Task ID]. I disagree with the plan, let's discuss.
